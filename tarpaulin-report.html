<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","root","code","nuclaw","src","config.rs"],"content":"//! Configuration for NuClaw\n\nuse std::env;\nuse std::path::PathBuf;\n\npub fn project_root() -\u003e PathBuf {\n    env::current_dir().expect(\"Failed to get current directory\")\n}\n\npub fn store_dir() -\u003e PathBuf {\n    project_root().join(\"store\")\n}\n\npub fn groups_dir() -\u003e PathBuf {\n    project_root().join(\"groups\")\n}\n\npub fn data_dir() -\u003e PathBuf {\n    project_root().join(\"data\")\n}\n\npub fn logs_dir() -\u003e PathBuf {\n    groups_dir().join(\"logs\")\n}\n\npub fn mount_allowlist_path() -\u003e PathBuf {\n    let home = home::home_dir().unwrap_or_else(|| PathBuf::from(\"/Users/user\"));\n    home.join(\".config\")\n        .join(\"nuclaw\")\n        .join(\"mount-allowlist.json\")\n}\n\npub fn assistant_name() -\u003e String {\n    env::var(\"ASSISTANT_NAME\").unwrap_or_else(|_| \"Andy\".to_string())\n}\n\npub fn timezone() -\u003e String {\n    env::var(\"TZ\").unwrap_or_else(|_| \"UTC\".to_string())\n}\n\npub fn ensure_directories() -\u003e std::io::Result\u003c()\u003e {\n    let dirs = [\n        store_dir(),\n        groups_dir(),\n        data_dir(),\n        mount_allowlist_path().parent().unwrap().to_path_buf(),\n    ];\n    for dir in dirs {\n        if !dir.exists() {\n            std::fs::create_dir_all(\u0026dir)?;\n        }\n    }\n    Ok(())\n}\n","traces":[{"line":6,"address":[14152688],"length":1,"stats":{"Line":2}},{"line":7,"address":[12209053],"length":1,"stats":{"Line":2}},{"line":10,"address":[12211520,12211673,12211667],"length":1,"stats":{"Line":2}},{"line":11,"address":[14155270,14155182],"length":1,"stats":{"Line":4}},{"line":14,"address":[12977824,12977973,12977967],"length":1,"stats":{"Line":2}},{"line":15,"address":[14152526,14152614],"length":1,"stats":{"Line":4}},{"line":18,"address":[12211241,12211088,12211235],"length":1,"stats":{"Line":2}},{"line":19,"address":[12211102,12211190],"length":1,"stats":{"Line":4}},{"line":22,"address":[12980128,12980277,12980271],"length":1,"stats":{"Line":1}},{"line":23,"address":[14155014,14154926],"length":1,"stats":{"Line":2}},{"line":26,"address":[12211054,12210528,12211060],"length":1,"stats":{"Line":1}},{"line":27,"address":[12979441],"length":1,"stats":{"Line":1}},{"line":28,"address":[12210600,12210816,12210668],"length":1,"stats":{"Line":3}},{"line":33,"address":[12209120],"length":1,"stats":{"Line":1}},{"line":34,"address":[12896848,12896832],"length":1,"stats":{"Line":3}},{"line":37,"address":[14155088],"length":1,"stats":{"Line":1}},{"line":38,"address":[12211454],"length":1,"stats":{"Line":3}},{"line":41,"address":[14387589],"length":1,"stats":{"Line":1}},{"line":42,"address":[14152855,14153230],"length":1,"stats":{"Line":2}},{"line":43,"address":[12978167],"length":1,"stats":{"Line":1}},{"line":44,"address":[12209232],"length":1,"stats":{"Line":1}},{"line":45,"address":[12209295],"length":1,"stats":{"Line":1}},{"line":46,"address":[14388197],"length":1,"stats":{"Line":3}},{"line":48,"address":[12209775,12210000],"length":1,"stats":{"Line":2}},{"line":49,"address":[12210197,12210077],"length":1,"stats":{"Line":2}},{"line":50,"address":[12210218,12210269],"length":1,"stats":{"Line":0}},{"line":53,"address":[12210113],"length":1,"stats":{"Line":1}}],"covered":26,"coverable":27},{"path":["/","root","code","nuclaw","src","container_runner.rs"],"content":"//! Container Runner - Spawns AI agent containers with isolation\n//!\n//! Supports:\n//! - macOS: Apple Container via `container` CLI\n//! - Linux: Docker via `docker` CLI\n//!\n//! Features:\n//! - Filesystem isolation per group\n//! - IPC namespace isolation\n//! - Configurable timeout\n//! - Output parsing with sentinel markers\n\nuse crate::config::{assistant_name, data_dir, groups_dir, logs_dir};\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, ContainerOutput};\nuse std::fs;\nuse std::path::{Path, PathBuf};\nuse std::process::Command;\nuse tokio::io::{AsyncBufReadExt, AsyncWriteExt, BufReader};\nuse tokio::process::{ChildStdout, Command as AsyncCommand};\nuse tokio::time::{timeout, Duration, Instant};\n\n/// Default container timeout: 5 minutes\nconst DEFAULT_TIMEOUT_MS: u64 = 300_000;\n/// Default max output size: 10MB\nconst DEFAULT_MAX_OUTPUT: usize = 10 * 1024 * 1024;\n/// Sentinel markers for output parsing\nconst OUTPUT_START_MARKER: \u0026str = \"--NANOCLAW_OUTPUT_START--\";\nconst OUTPUT_END_MARKER: \u0026str = \"--NANOCLAW_OUTPUT_END--\";\n\n/// Get container timeout from environment or default\npub fn container_timeout() -\u003e Duration {\n    let timeout_ms = std::env::var(\"CONTAINER_TIMEOUT\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_TIMEOUT_MS);\n    Duration::from_millis(timeout_ms)\n}\n\n/// Get max output size from environment or default\npub fn max_output_size() -\u003e usize {\n    std::env::var(\"CONTAINER_MAX_OUTPUT_SIZE\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_MAX_OUTPUT)\n}\n\n/// Get the container command based on platform\nfn get_container_command() -\u003e \u0026'static str {\n    if cfg!(target_os = \"macos\") {\n        \"container\"\n    } else {\n        \"docker\"\n    }\n}\n\n/// Create IPC directory for a group\npub fn create_group_ipc_directory(group_folder: \u0026str) -\u003e Result\u003cPathBuf\u003e {\n    let ipc_dir = data_dir().join(\"ipc\").join(group_folder);\n    fs::create_dir_all(\u0026ipc_dir).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to create IPC directory: {}\", e),\n    })?;\n    Ok(ipc_dir)\n}\n\n/// Write IPC files for container context\nfn write_ipc_files(group_folder: \u0026str, input: \u0026ContainerInput) -\u003e Result\u003c()\u003e {\n    let ipc_dir = create_group_ipc_directory(group_folder)?;\n\n    // Write current_tasks.json\n    let tasks_path = ipc_dir.join(\"current_tasks.json\");\n    let tasks_data = serde_json::json!({\n        \"tasks\": [{\n            \"id\": input.session_id.clone().unwrap_or_else(|| \"interactive\".to_string()),\n            \"prompt\": input.prompt,\n            \"is_scheduled\": input.is_scheduled_task\n        }]\n    });\n    let tasks_json =\n        serde_json::to_string_pretty(\u0026tasks_data).map_err(|e| NuClawError::FileSystem {\n            message: format!(\"Failed to serialize tasks: {}\", e),\n        })?;\n    fs::write(\u0026tasks_path, tasks_json).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write tasks file: {}\", e),\n    })?;\n\n    // Write available_groups.json\n    let groups_path = ipc_dir.join(\"available_groups.json\");\n    let groups_data = serde_json::json!({\n        \"groups\": {\n            group_folder: {\n                \"name\": group_folder,\n                \"registered\": true\n            }\n        }\n    });\n    let groups_json =\n        serde_json::to_string_pretty(\u0026groups_data).map_err(|e| NuClawError::FileSystem {\n            message: format!(\"Failed to serialize groups: {}\", e),\n        })?;\n    fs::write(\u0026groups_path, groups_json).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write groups file: {}\", e),\n    })?;\n\n    Ok(())\n}\n\n/// Prepare group context directory\nfn prepare_group_context(group_folder: \u0026str) -\u003e Result\u003cPathBuf\u003e {\n    let group_dir = groups_dir().join(group_folder);\n    if !group_dir.exists() {\n        fs::create_dir_all(\u0026group_dir).map_err(|e| NuClawError::FileSystem {\n            message: format!(\"Failed to create group directory: {}\", e),\n        })?;\n    }\n    Ok(group_dir)\n}\n\n/// Run a container with the given input\npub async fn run_container(input: ContainerInput) -\u003e Result\u003cContainerOutput\u003e {\n    let group_folder = \u0026input.group_folder;\n    let group_dir = prepare_group_context(group_folder)?;\n    write_ipc_files(group_folder, \u0026input)?;\n    let (mut cmd, input_path) = build_container_command(\u0026input, \u0026group_dir).await?;\n    let timeout_duration = container_timeout();\n    let output = run_container_with_output(\u0026mut cmd, timeout_duration).await?;\n    let _ = fs::remove_file(\u0026input_path);\n    Ok(output)\n}\n\nasync fn build_container_command(\n    input: \u0026ContainerInput,\n    group_dir: \u0026Path,\n) -\u003e Result\u003c(AsyncCommand, PathBuf)\u003e {\n    let temp_dir = data_dir().join(\"temp\");\n    fs::create_dir_all(\u0026temp_dir).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to create temp directory: {}\", e),\n    })?;\n    let input_path = temp_dir.join(format!(\n        \"input_{}.json\",\n        input\n            .session_id\n            .clone()\n            .unwrap_or_else(|| \"default\".to_string())\n    ));\n    let input_json = serde_json::to_string(input).map_err(|e| NuClawError::Container {\n        message: format!(\"Failed to serialize input: {}\", e),\n    })?;\n    fs::write(\u0026input_path, \u0026input_json).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write input file: {}\", e),\n    })?;\n    let mut cmd = AsyncCommand::new(get_container_command());\n    if cfg!(target_os = \"macos\") {\n        cmd.arg(\"exec\")\n            .arg(\"--workspace\")\n            .arg(group_dir)\n            .arg(\"--input\")\n            .arg(\u0026input_path)\n            .arg(\"--name\")\n            .arg(assistant_name());\n    } else {\n        let image = std::env::var(\"CONTAINER_IMAGE\")\n            .unwrap_or_else(|_| \"anthropic/claude-code:latest\".to_string());\n        cmd.arg(\"run\")\n            .arg(\"--rm\")\n            .arg(\"-v\")\n            .arg(format!(\"{}:/workspace/group\", group_dir.display()))\n            .arg(\"-e\")\n            .arg(\"CLAUDE_CODE_OAUTH_TOKEN\")\n            .arg(\"-e\")\n            .arg(\"ANTHROPIC_API_KEY\")\n            .arg(\"--entrypoint\")\n            .arg(\"/bin/sh\")\n            .arg(image)\n            .arg(\"-c\")\n            .arg(\"cat /workspace/input.json | /usr/local/bin/claude\");\n    }\n    cmd.stdin(std::process::Stdio::piped())\n        .stdout(std::process::Stdio::piped())\n        .stderr(std::process::Stdio::piped());\n    Ok((cmd, input_path))\n}\n\nasync fn run_container_with_output(\n    cmd: \u0026mut AsyncCommand,\n    timeout_duration: Duration,\n) -\u003e Result\u003cContainerOutput\u003e {\n    let mut child = cmd.spawn().map_err(|e| NuClawError::Container {\n        message: format!(\"Failed to spawn container: {}\", e),\n    })?;\n    let start_time = Instant::now();\n    if let Some(mut stdin) = child.stdin.take() {\n        let input_path = data_dir().join(\"temp/input.json\");\n        if input_path.exists() {\n            let input_content = fs::read_to_string(\u0026input_path).unwrap_or_default();\n            stdin\n                .write_all(input_content.as_bytes())\n                .await\n                .map_err(|e| NuClawError::Container {\n                    message: format!(\"Failed to write to stdin: {}\", e),\n                })?;\n        }\n        stdin.shutdown().await.map_err(|e| NuClawError::Container {\n            message: format!(\"Failed to close stdin: {}\", e),\n        })?;\n    }\n    let stdout = child.stdout.take().unwrap();\n    let output_result = timeout(timeout_duration, capture_output(stdout)).await;\n    let exit_status = child.wait().await.map_err(|e| NuClawError::Container {\n        message: format!(\"Failed to wait for container: {}\", e),\n    })?;\n    let duration_ms = start_time.elapsed().as_millis() as i64;\n    match output_result {\n        Ok(output) =\u003e {\n            let output = output?;\n            parse_container_output(\u0026output, exit_status.success(), duration_ms)\n        }\n        Err(_) =\u003e {\n            let _ = child.kill().await;\n            parse_container_output(\"\", false, duration_ms)\n        }\n    }\n}\n\nasync fn capture_output(stdout: ChildStdout) -\u003e Result\u003cString\u003e {\n    let reader = BufReader::new(stdout);\n    let mut lines = reader.lines();\n    let mut output = String::new();\n    let max_size = max_output_size();\n    while let Some(line) = lines.next_line().await.ok().flatten() {\n        if output.len() + line.len() \u003e max_size {\n            output.push_str(\"\\n[OUTPUT TRUNCATED - exceeded max size]\");\n            break;\n        }\n        output.push_str(\u0026line);\n        output.push('\\n');\n    }\n    Ok(output)\n}\n\nfn parse_container_output(\n    output: \u0026str,\n    success: bool,\n    _duration_ms: i64,\n) -\u003e Result\u003cContainerOutput\u003e {\n    if let Some(content) = extract_marked_output(output) {\n        return parse_marked_content(\u0026content, success);\n    }\n    let last_line = output\n        .lines()\n        .rev()\n        .find(|l| !l.trim().is_empty())\n        .unwrap_or(\"\")\n        .trim();\n    if let Ok(parsed) = serde_json::from_str::\u003cContainerOutput\u003e(last_line) {\n        return Ok(parsed);\n    }\n    Ok(ContainerOutput {\n        status: if success {\n            \"success\".to_string()\n        } else {\n            \"error\".to_string()\n        },\n        result: Some(output.to_string()),\n        new_session_id: None,\n        error: if success {\n            None\n        } else {\n            Some(\"Container execution failed\".to_string())\n        },\n    })\n}\n\nfn extract_marked_output(output: \u0026str) -\u003e Option\u003cString\u003e {\n    let start_idx = output.find(OUTPUT_START_MARKER)?;\n    let end_idx = output.find(OUTPUT_END_MARKER)?;\n    if start_idx \u003c end_idx {\n        Some(output[start_idx + OUTPUT_START_MARKER.len()..end_idx].to_string())\n    } else {\n        None\n    }\n}\n\nfn parse_marked_content(content: \u0026str, success: bool) -\u003e Result\u003cContainerOutput\u003e {\n    if let Ok(parsed) = serde_json::from_str::\u003cContainerOutput\u003e(content) {\n        return Ok(parsed);\n    }\n    Ok(ContainerOutput {\n        status: if success {\n            \"success\".to_string()\n        } else {\n            \"error\".to_string()\n        },\n        result: Some(content.to_string()),\n        new_session_id: None,\n        error: if success {\n            None\n        } else {\n            Some(\"Container execution failed\".to_string())\n        },\n    })\n}\n\npub fn ensure_container_system_running() -\u003e Result\u003c()\u003e {\n    let output = Command::new(get_container_command())\n        .args([\"system\", \"status\"])\n        .output();\n    match output {\n        Ok(_) =\u003e Ok(()),\n        Err(_) =\u003e {\n            let output = Command::new(get_container_command())\n                .args([\"system\", \"start\"])\n                .output();\n            match output {\n                Ok(_) =\u003e Ok(()),\n                Err(e) =\u003e Err(NuClawError::Container {\n                    message: format!(\"Failed to start container system: {}\", e),\n                }),\n            }\n        }\n    }\n}\n\npub fn log_container_output(\n    group_folder: \u0026str,\n    session_id: \u0026str,\n    output: \u0026ContainerOutput,\n) -\u003e Result\u003c()\u003e {\n    let log_dir = logs_dir().join(group_folder);\n    fs::create_dir_all(\u0026log_dir).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to create log directory: {}\", e),\n    })?;\n    let timestamp = chrono::Utc::now().format(\"%Y%m%d_%H%M%S\");\n    let log_path = log_dir.join(format!(\"container_{}_{}.log\", session_id, timestamp));\n    let log_data = serde_json::json!({\n        \"timestamp\": chrono::Utc::now().to_rfc3339(),\n        \"group_folder\": group_folder,\n        \"session_id\": session_id,\n        \"status\": output.status,\n        \"result\": output.result,\n        \"error\": output.error,\n        \"new_session_id\": output.new_session_id,\n    });\n    fs::write(\n        \u0026log_path,\n        serde_json::to_string_pretty(\u0026log_data).unwrap_or_default(),\n    )\n    .map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write log file: {}\", e),\n    })?;\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_marked_output() {\n        let output = \"Some prefix\\n--NANOCLAW_OUTPUT_START--\\n{\\\"status\\\": \\\"success\\\", \\\"result\\\": \\\"test\\\"}\\n--NANOCLAW_OUTPUT_END--\\nSome suffix\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_some());\n        assert_eq!(\n            extracted.unwrap(),\n            \"\\n{\\\"status\\\": \\\"success\\\", \\\"result\\\": \\\"test\\\"}\\n\"\n        );\n    }\n\n    #[test]\n    fn test_extract_marked_output_no_markers() {\n        let output = \"No markers here\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_none());\n    }\n\n    #[test]\n    fn test_extract_marked_output_only_start_marker() {\n        let output = \"--NANOCLAW_OUTPUT_START--\\nsome content\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_none());\n    }\n\n    #[test]\n    fn test_extract_marked_output_reversed_markers() {\n        // End marker before start marker should not match\n        let output = \"--NANOCLAW_OUTPUT_END--\\ncontent\\n--NANOCLAW_OUTPUT_START--\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_none());\n    }\n\n    #[test]\n    fn test_extract_marked_output_empty_content() {\n        let output = \"--NANOCLAW_OUTPUT_START----NANOCLAW_OUTPUT_END--\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_some());\n        assert_eq!(extracted.unwrap(), \"\");\n    }\n\n    #[test]\n    fn test_container_timeout_default() {\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n        let timeout = container_timeout();\n        assert_eq!(timeout, Duration::from_millis(DEFAULT_TIMEOUT_MS));\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    }\n\n    #[test]\n    fn test_container_timeout_from_env() {\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n        \n        let original = std::env::var(\"CONTAINER_TIMEOUT\").ok();\n        assert!(original.is_none());\n\n        std::env::set_var(\"CONTAINER_TIMEOUT\", \"60000\");\n        let timeout = container_timeout();\n        assert_eq!(timeout, Duration::from_millis(60000));\n\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    }\n\n    #[test]\n    fn test_container_timeout_invalid_env() {\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n        \n        let original = std::env::var(\"CONTAINER_TIMEOUT\").ok();\n        assert!(original.is_none());\n\n        std::env::set_var(\"CONTAINER_TIMEOUT\", \"invalid\");\n        let timeout = container_timeout();\n        assert_eq!(timeout, Duration::from_millis(DEFAULT_TIMEOUT_MS));\n\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    }\n\n    #[test]\n    fn test_max_output_size_default() {\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n        let max_size = max_output_size();\n        assert_eq!(max_size, DEFAULT_MAX_OUTPUT);\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n    }\n\n    #[test]\n    fn test_max_output_size_from_env() {\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n        \n        let original = std::env::var(\"CONTAINER_MAX_OUTPUT_SIZE\").ok();\n        assert!(original.is_none());\n\n        std::env::set_var(\"CONTAINER_MAX_OUTPUT_SIZE\", \"5242880\");\n        let max_size = max_output_size();\n        assert_eq!(max_size, 5 * 1024 * 1024);\n\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n    }\n\n    #[test]\n    fn test_parse_container_output_json() {\n        let output = r#\"{\"status\": \"success\", \"result\": \"test result\"}\"#;\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let output = result.unwrap();\n        assert_eq!(output.status, \"success\");\n        assert_eq!(output.result, Some(\"test result\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_container_output_with_session_id() {\n        let output = r#\"{\"status\": \"success\", \"result\": \"test\", \"new_session_id\": \"sess_123\"}\"#;\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let output = result.unwrap();\n        assert_eq!(output.status, \"success\");\n        assert_eq!(output.new_session_id, Some(\"sess_123\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_container_output_error() {\n        let output = \"some error output\";\n        let result = parse_container_output(output, false, 100);\n        assert!(result.is_ok());\n        let output = result.unwrap();\n        assert_eq!(output.status, \"error\");\n        assert!(output.error.is_some());\n    }\n\n    #[test]\n    fn test_parse_container_output_marked() {\n        let output = \"prefix\\n--NANOCLAW_OUTPUT_START--\\n{\\\"status\\\": \\\"success\\\", \\\"result\\\": \\\"marked\\\"}\\n--NANOCLAW_OUTPUT_END--\\nsuffix\";\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"marked\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_container_output_empty() {\n        let output = \"\";\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_marked_content_success() {\n        let content = r#\"{\"status\": \"success\", \"result\": \"test output\"}\"#;\n        let result = parse_marked_content(content, true);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"test output\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_marked_content_invalid_json() {\n        let content = \"not valid json\";\n        let result = parse_marked_content(content, true);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"not valid json\".to_string()));\n    }\n\n    #[test]\n    fn test_get_container_command() {\n        // This test just verifies the function doesn't panic\n        let cmd = get_container_command();\n        assert!(!cmd.is_empty());\n        // On Linux it should be \"docker\", on macOS \"container\"\n        assert!(cmd == \"docker\" || cmd == \"container\");\n    }\n\n    #[test]\n    fn test_create_group_ipc_directory() {\n        let result = create_group_ipc_directory(\"test_group_123\");\n        assert!(result.is_ok());\n        let path = result.unwrap();\n        assert!(path.exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026path);\n    }\n\n    #[test]\n    fn test_prepare_group_context() {\n        let result = prepare_group_context(\"test_context_group\");\n        assert!(result.is_ok());\n        let path = result.unwrap();\n        assert!(path.exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026path);\n    }\n\n    #[test]\n    fn test_prepare_group_context_existing() {\n        // First call creates the directory\n        let path1 = prepare_group_context(\"existing_group\").unwrap();\n        // Second call should succeed on existing directory\n        let path2 = prepare_group_context(\"existing_group\").unwrap();\n        assert_eq!(path1, path2);\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026path1);\n    }\n\n    #[test]\n    fn test_write_ipc_files() {\n        let input = ContainerInput {\n            prompt: \"test prompt\".to_string(),\n            session_id: Some(\"test_session\".to_string()),\n            group_folder: \"test_ipc_group\".to_string(),\n            chat_jid: \"test@chat\".to_string(),\n            is_main: true,\n            is_scheduled_task: false,\n        };\n\n        let result = write_ipc_files(\"test_ipc_group\", \u0026input);\n        assert!(result.is_ok());\n\n        // Verify files were created\n        let ipc_dir = create_group_ipc_directory(\"test_ipc_group\").unwrap();\n        assert!(ipc_dir.join(\"current_tasks.json\").exists());\n        assert!(ipc_dir.join(\"available_groups.json\").exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026ipc_dir);\n        let _ = fs::remove_dir_all(groups_dir().join(\"test_ipc_group\"));\n    }\n\n    #[test]\n    fn test_log_container_output() {\n        let output = ContainerOutput {\n            status: \"success\".to_string(),\n            result: Some(\"test result\".to_string()),\n            new_session_id: Some(\"sess_123\".to_string()),\n            error: None,\n        };\n\n        let result = log_container_output(\"test_log_group\", \"test_session\", \u0026output);\n        assert!(result.is_ok());\n\n        // Verify log file was created\n        let log_dir = logs_dir().join(\"test_log_group\");\n        assert!(log_dir.exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026log_dir);\n    }\n\n    #[test]\n    fn test_log_container_output_error() {\n        let output = ContainerOutput {\n            status: \"error\".to_string(),\n            result: None,\n            new_session_id: None,\n            error: Some(\"test error\".to_string()),\n        };\n\n        let result = log_container_output(\"test_log_error_group\", \"test_session\", \u0026output);\n        assert!(result.is_ok());\n\n        // Cleanup\n        let log_dir = logs_dir().join(\"test_log_error_group\");\n        let _ = fs::remove_dir_all(\u0026log_dir);\n    }\n}\n","traces":[{"line":32,"address":[13107984],"length":1,"stats":{"Line":2}},{"line":33,"address":[12408804],"length":1,"stats":{"Line":2}},{"line":35,"address":[15039328],"length":1,"stats":{"Line":6}},{"line":36,"address":[13108063],"length":1,"stats":{"Line":2}},{"line":37,"address":[15039365],"length":1,"stats":{"Line":2}},{"line":41,"address":[13103168],"length":1,"stats":{"Line":2}},{"line":42,"address":[12404116],"length":1,"stats":{"Line":2}},{"line":44,"address":[13103209],"length":1,"stats":{"Line":6}},{"line":45,"address":[13103224],"length":1,"stats":{"Line":2}},{"line":58,"address":[15045872,15046531,15046537],"length":1,"stats":{"Line":2}},{"line":59,"address":[15045915],"length":1,"stats":{"Line":2}},{"line":60,"address":[14818496,14818681,14818739,14818745],"length":1,"stats":{"Line":2}},{"line":61,"address":[13058751,13058683],"length":1,"stats":{"Line":0}},{"line":63,"address":[13115143],"length":1,"stats":{"Line":2}},{"line":67,"address":[12404192,12408513,12408787],"length":1,"stats":{"Line":1}},{"line":68,"address":[15034568],"length":1,"stats":{"Line":1}},{"line":71,"address":[13103595,13103663],"length":1,"stats":{"Line":2}},{"line":72,"address":[13103751,13104469,13104160,13104187,13103860,13107864,13103703,13104692,13104085],"length":1,"stats":{"Line":3}},{"line":74,"address":[12404999,12405063],"length":1,"stats":{"Line":2}},{"line":79,"address":[15036552,15039107,15036742,15036623],"length":1,"stats":{"Line":2}},{"line":81,"address":[14806507,14806575],"length":1,"stats":{"Line":0}},{"line":83,"address":[12875721,12875472,12875715,12875657],"length":1,"stats":{"Line":2}},{"line":84,"address":[13047243,13047311],"length":1,"stats":{"Line":0}},{"line":88,"address":[12406696],"length":1,"stats":{"Line":1}},{"line":89,"address":[13106046,13106184,13106333,13107737,13105893,13105944],"length":1,"stats":{"Line":2}},{"line":97,"address":[13047669,13047488,13047733,13047727],"length":1,"stats":{"Line":2}},{"line":99,"address":[12875839,12875771],"length":1,"stats":{"Line":0}},{"line":101,"address":[12408462,12408309,12408214,12408092],"length":1,"stats":{"Line":2}},{"line":102,"address":[12876111,12876043],"length":1,"stats":{"Line":0}},{"line":105,"address":[15038789],"length":1,"stats":{"Line":1}},{"line":109,"address":[15044570,15044016,15044576],"length":1,"stats":{"Line":1}},{"line":110,"address":[15044059],"length":1,"stats":{"Line":1}},{"line":111,"address":[13112959],"length":1,"stats":{"Line":1}},{"line":112,"address":[12413829,12413712,12413928],"length":1,"stats":{"Line":2}},{"line":113,"address":[14808367,14808299],"length":1,"stats":{"Line":0}},{"line":116,"address":[15044313],"length":1,"stats":{"Line":1}},{"line":120,"address":[12870748,12870898,12872399,12870704,12870941,12873451,12871704],"length":1,"stats":{"Line":0}},{"line":121,"address":[14802144],"length":1,"stats":{"Line":0}},{"line":122,"address":[14802297,14802161,14802959],"length":1,"stats":{"Line":0}},{"line":123,"address":[12871232,12871654,12871312],"length":1,"stats":{"Line":0}},{"line":124,"address":[14802744,14803015,14803674,14802208],"length":1,"stats":{"Line":0}},{"line":125,"address":[12872186,12872268],"length":1,"stats":{"Line":0}},{"line":126,"address":[14803690,14803563,14802229],"length":1,"stats":{"Line":0}},{"line":127,"address":[12873020,12873090],"length":1,"stats":{"Line":0}},{"line":128,"address":[12873122],"length":1,"stats":{"Line":0}},{"line":131,"address":[13114496],"length":1,"stats":{"Line":0}},{"line":135,"address":[14808757,14808853],"length":1,"stats":{"Line":0}},{"line":136,"address":[13051930,13052857,13049617,13049496,13052672,13052915,13052921],"length":1,"stats":{"Line":0}},{"line":137,"address":[13052699,13052767],"length":1,"stats":{"Line":0}},{"line":139,"address":[13049658,13049817],"length":1,"stats":{"Line":0}},{"line":141,"address":[13049756],"length":1,"stats":{"Line":0}},{"line":143,"address":[14809316],"length":1,"stats":{"Line":0}},{"line":144,"address":[13052092,13052080,13049779],"length":1,"stats":{"Line":0}},{"line":146,"address":[12878520,12880275,12880640,12880825,12880889,12878406,12880883,12878346],"length":1,"stats":{"Line":0}},{"line":147,"address":[14811947,14812015],"length":1,"stats":{"Line":0}},{"line":149,"address":[12878621,12881155,12881097,12881161,12878814,12880912,12878708],"length":1,"stats":{"Line":0}},{"line":150,"address":[14812219,14812287],"length":1,"stats":{"Line":0}},{"line":152,"address":[14810131],"length":1,"stats":{"Line":0}},{"line":162,"address":[12878913],"length":1,"stats":{"Line":0}},{"line":163,"address":[12878979,12881184,12881200],"length":1,"stats":{"Line":0}},{"line":164,"address":[12879021],"length":1,"stats":{"Line":0}},{"line":167,"address":[13050852],"length":1,"stats":{"Line":0}},{"line":174,"address":[14810912],"length":1,"stats":{"Line":0}},{"line":178,"address":[12879765,12879832],"length":1,"stats":{"Line":0}},{"line":179,"address":[12879856],"length":1,"stats":{"Line":0}},{"line":180,"address":[13051505],"length":1,"stats":{"Line":0}},{"line":181,"address":[13051582],"length":1,"stats":{"Line":0}},{"line":184,"address":[15045824],"length":1,"stats":{"Line":0}},{"line":188,"address":[12886377,12881781,12886371,12882895,12886128,12881667,12886313,12881480],"length":1,"stats":{"Line":0}},{"line":189,"address":[13058139,13058207],"length":1,"stats":{"Line":0}},{"line":191,"address":[14813198,14813317],"length":1,"stats":{"Line":0}},{"line":192,"address":[12882043],"length":1,"stats":{"Line":0}},{"line":193,"address":[12882139,12882251],"length":1,"stats":{"Line":0}},{"line":194,"address":[14813728],"length":1,"stats":{"Line":0}},{"line":195,"address":[12882566],"length":1,"stats":{"Line":0}},{"line":196,"address":[12883156,12883243,12882634,12883121,12882810],"length":1,"stats":{"Line":0}},{"line":197,"address":[12882651,12882756],"length":1,"stats":{"Line":0}},{"line":198,"address":[12882775,12882988,12882863,12881520],"length":1,"stats":{"Line":0}},{"line":199,"address":[12887187,12887193,12883137,12886944,12887129],"length":1,"stats":{"Line":0}},{"line":200,"address":[14818251,14818319],"length":1,"stats":{"Line":0}},{"line":203,"address":[13058633,13058384,13058627,13054113,13053141,13054858,13058569,13055561,13055232,13054989],"length":1,"stats":{"Line":0}},{"line":204,"address":[13058411,13058479],"length":1,"stats":{"Line":0}},{"line":207,"address":[14813446,14815080],"length":1,"stats":{"Line":0}},{"line":208,"address":[14812842,14815216,14815406,14815122],"length":1,"stats":{"Line":0}},{"line":209,"address":[14817680,14816990,14815751,14815885,14812863,14816195,14815664,14817865,14817929,14817923],"length":1,"stats":{"Line":0}},{"line":210,"address":[12886427,12886495],"length":1,"stats":{"Line":0}},{"line":212,"address":[12884981],"length":1,"stats":{"Line":0}},{"line":213,"address":[14816352],"length":1,"stats":{"Line":0}},{"line":214,"address":[14816421],"length":1,"stats":{"Line":0}},{"line":215,"address":[14816458,14816860],"length":1,"stats":{"Line":0}},{"line":216,"address":[12885463,12885374],"length":1,"stats":{"Line":0}},{"line":219,"address":[12881604,12885107,12885619,12885786],"length":1,"stats":{"Line":0}},{"line":220,"address":[14817312],"length":1,"stats":{"Line":0}},{"line":225,"address":[13103123,13103120],"length":1,"stats":{"Line":0}},{"line":226,"address":[13045516],"length":1,"stats":{"Line":0}},{"line":227,"address":[14805088],"length":1,"stats":{"Line":0}},{"line":228,"address":[13045636],"length":1,"stats":{"Line":0}},{"line":229,"address":[14805259,14805177],"length":1,"stats":{"Line":0}},{"line":230,"address":[12055937],"length":1,"stats":{"Line":0}},{"line":231,"address":[12874401,12874572],"length":1,"stats":{"Line":0}},{"line":232,"address":[12874696],"length":1,"stats":{"Line":0}},{"line":235,"address":[12874739,12874656],"length":1,"stats":{"Line":0}},{"line":236,"address":[14806031],"length":1,"stats":{"Line":0}},{"line":238,"address":[13046192],"length":1,"stats":{"Line":0}},{"line":241,"address":[12414410,12414000,12414404],"length":1,"stats":{"Line":1}},{"line":246,"address":[15044658],"length":1,"stats":{"Line":1}},{"line":247,"address":[12414135,12414367],"length":1,"stats":{"Line":2}},{"line":252,"address":[13049008,13049022],"length":1,"stats":{"Line":3}},{"line":255,"address":[15044850,15045057],"length":1,"stats":{"Line":2}},{"line":256,"address":[13113808],"length":1,"stats":{"Line":1}},{"line":258,"address":[15045539],"length":1,"stats":{"Line":1}},{"line":259,"address":[12414587],"length":1,"stats":{"Line":1}},{"line":260,"address":[15045218],"length":1,"stats":{"Line":1}},{"line":262,"address":[12414593],"length":1,"stats":{"Line":1}},{"line":264,"address":[13113974,13114041],"length":1,"stats":{"Line":2}},{"line":265,"address":[15045369],"length":1,"stats":{"Line":1}},{"line":266,"address":[12414843,12414790],"length":1,"stats":{"Line":2}},{"line":267,"address":[15045422],"length":1,"stats":{"Line":1}},{"line":269,"address":[15045391,15045486],"length":1,"stats":{"Line":2}},{"line":274,"address":[13112304],"length":1,"stats":{"Line":1}},{"line":275,"address":[13112357],"length":1,"stats":{"Line":1}},{"line":276,"address":[12413156],"length":1,"stats":{"Line":1}},{"line":277,"address":[15043819,15043842,15043976],"length":1,"stats":{"Line":3}},{"line":278,"address":[15043918,15043978,15043844],"length":1,"stats":{"Line":2}},{"line":280,"address":[12413253],"length":1,"stats":{"Line":1}},{"line":284,"address":[12412953,12412128,12412981],"length":1,"stats":{"Line":1}},{"line":285,"address":[13111482,13111563],"length":1,"stats":{"Line":2}},{"line":286,"address":[13111591],"length":1,"stats":{"Line":1}},{"line":288,"address":[12412738],"length":1,"stats":{"Line":1}},{"line":289,"address":[12412383],"length":1,"stats":{"Line":1}},{"line":290,"address":[12412417],"length":1,"stats":{"Line":1}},{"line":292,"address":[12412389],"length":1,"stats":{"Line":0}},{"line":294,"address":[13111819,13111752],"length":1,"stats":{"Line":2}},{"line":295,"address":[15043147],"length":1,"stats":{"Line":1}},{"line":296,"address":[15043218,15043165],"length":1,"stats":{"Line":2}},{"line":297,"address":[13111920],"length":1,"stats":{"Line":1}},{"line":299,"address":[15043169,15043264],"length":1,"stats":{"Line":0}},{"line":304,"address":[15047672,15046560,15047607],"length":1,"stats":{"Line":0}},{"line":305,"address":[12415969],"length":1,"stats":{"Line":0}},{"line":306,"address":[13115341],"length":1,"stats":{"Line":0}},{"line":308,"address":[15046818],"length":1,"stats":{"Line":0}},{"line":309,"address":[15046878],"length":1,"stats":{"Line":0}},{"line":311,"address":[15046919,15046852],"length":1,"stats":{"Line":0}},{"line":312,"address":[13115658],"length":1,"stats":{"Line":0}},{"line":314,"address":[15047183],"length":1,"stats":{"Line":0}},{"line":315,"address":[13116004],"length":1,"stats":{"Line":0}},{"line":316,"address":[15047486,15047220],"length":1,"stats":{"Line":0}},{"line":317,"address":[12416615,12416744],"length":1,"stats":{"Line":0}},{"line":324,"address":[13108096,13111245,13111410],"length":1,"stats":{"Line":1}},{"line":329,"address":[15039426],"length":1,"stats":{"Line":1}},{"line":330,"address":[13108392,13108532,13111405],"length":1,"stats":{"Line":1}},{"line":331,"address":[14807823,14807755],"length":1,"stats":{"Line":0}},{"line":333,"address":[12409357],"length":1,"stats":{"Line":1}},{"line":334,"address":[12409509,12409423],"length":1,"stats":{"Line":2}},{"line":335,"address":[13109697,13108944,13108995,13109101,13109169,13109196,13110139,13110362,13111251,13110585,13109478,13109916],"length":1,"stats":{"Line":3}},{"line":336,"address":[15040422,15040362],"length":1,"stats":{"Line":2}},{"line":346,"address":[13110877,13110806],"length":1,"stats":{"Line":2}},{"line":348,"address":[12876905,12876963,12876969,12876720],"length":1,"stats":{"Line":1}},{"line":349,"address":[12876815,12876747],"length":1,"stats":{"Line":0}},{"line":351,"address":[13111081],"length":1,"stats":{"Line":1}}],"covered":71,"coverable":160},{"path":["/","root","code","nuclaw","src","db.rs"],"content":"//! Database module for NuClaw\n//!\n//! Provides SQLite database operations with connection pooling.\n//! Uses r2d2 for connection management and rusqlite for SQLite access.\n\nuse crate::config::store_dir;\nuse crate::error::NuClawError;\nuse r2d2::{Pool, PooledConnection};\nuse r2d2_sqlite::SqliteConnectionManager;\nuse rusqlite::Connection;\nuse std::path::PathBuf;\n\n/// Database configuration\n#[derive(Debug, Clone)]\npub struct DatabaseConfig {\n    /// Maximum pool size\n    pub pool_size: u32,\n    /// Connection timeout in milliseconds\n    pub connection_timeout_ms: u64,\n    /// Database file path\n    pub db_path: PathBuf,\n}\n\nimpl Default for DatabaseConfig {\n    fn default() -\u003e Self {\n        Self {\n            pool_size: std::env::var(\"DB_POOL_SIZE\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(10),\n            connection_timeout_ms: std::env::var(\"DB_CONNECTION_TIMEOUT_MS\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(30000),\n            db_path: store_dir().join(\"nuclaw.db\"),\n        }\n    }\n}\n\n/// Database wrapper with connection pool\n#[derive(Clone, Debug)]\npub struct Database {\n    pool: Pool\u003cSqliteConnectionManager\u003e,\n    config: DatabaseConfig,\n}\n\nimpl Database {\n    /// Create a new Database with default config\n    pub fn new() -\u003e Result\u003cSelf, NuClawError\u003e {\n        Self::with_config(DatabaseConfig::default())\n    }\n\n    /// Create a new Database with custom config\n    pub fn with_config(config: DatabaseConfig) -\u003e Result\u003cSelf, NuClawError\u003e {\n        let manager = SqliteConnectionManager::file(\u0026config.db_path).with_init(|conn| {\n            conn.pragma_update(None, \"foreign_keys\", \"ON\")?;\n            conn.pragma_update(None, \"journal_mode\", \"WAL\")?;\n            conn.pragma_update(None, \"synchronous\", \"NORMAL\")?;\n            Ok(())\n        });\n\n        let pool = Pool::builder()\n            .max_size(config.pool_size)\n            .connection_timeout(std::time::Duration::from_millis(\n                config.connection_timeout_ms,\n            ))\n            .build(manager)\n            .map_err(|e| NuClawError::Database {\n                message: format!(\"Failed to create connection pool: {}\", e),\n            })?;\n\n        let conn = pool.get().map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to get connection: {}\", e),\n        })?;\n        initialize_schema(\u0026conn)?;\n\n        Ok(Database { pool, config })\n    }\n\n    /// Get a connection from the pool\n    pub fn get_connection(\u0026self) -\u003e Result\u003cPooledConnection\u003cSqliteConnectionManager\u003e, NuClawError\u003e {\n        self.pool.get().map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to get connection from pool: {}\", e),\n        })\n    }\n\n    /// Get the database configuration\n    pub fn config(\u0026self) -\u003e \u0026DatabaseConfig {\n        \u0026self.config\n    }\n\n    /// Get pool status\n    pub fn pool_status(\u0026self) -\u003e PoolStatus {\n        let state = self.pool.state();\n        PoolStatus {\n            connections_idle: state.idle_connections,\n            connections_active: state.connections - state.idle_connections,\n            max_size: self.config.pool_size,\n        }\n    }\n}\n\n/// Pool status information\n#[derive(Debug, Clone)]\npub struct PoolStatus {\n    pub connections_idle: u32,\n    pub connections_active: u32,\n    pub max_size: u32,\n}\n\n/// Initialize database schema\nfn initialize_schema(conn: \u0026Connection) -\u003e Result\u003c(), NuClawError\u003e {\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS chats (\n            jid TEXT PRIMARY KEY,\n            name TEXT,\n            last_message_time TEXT\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create chats table: {}\", e),\n    })?;\n\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS messages (\n            id TEXT,\n            chat_jid TEXT,\n            sender TEXT,\n            sender_name TEXT,\n            content TEXT,\n            timestamp TEXT,\n            is_from_me INTEGER DEFAULT 0,\n            PRIMARY KEY (id, chat_jid)\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create messages table: {}\", e),\n    })?;\n\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS scheduled_tasks (\n            id TEXT PRIMARY KEY,\n            group_folder TEXT NOT NULL,\n            chat_jid TEXT NOT NULL,\n            prompt TEXT NOT NULL,\n            schedule_type TEXT NOT NULL,\n            schedule_value TEXT NOT NULL,\n            next_run TEXT,\n            last_run TEXT,\n            last_result TEXT,\n            status TEXT DEFAULT 'active',\n            created_at TEXT NOT NULL,\n            context_mode TEXT DEFAULT 'isolated'\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create scheduled_tasks table: {}\", e),\n    })?;\n\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS task_run_logs (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            task_id TEXT NOT NULL,\n            run_at TEXT NOT NULL,\n            duration_ms INTEGER NOT NULL,\n            status TEXT NOT NULL,\n            result TEXT,\n            error TEXT\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create task_run_logs table: {}\", e),\n    })?;\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs;\n\n    fn test_db_path() -\u003e PathBuf {\n        store_dir().join(\"test_nuclaw.db\")\n    }\n\n    fn cleanup_test_db(path: \u0026PathBuf) {\n        let _ = fs::remove_file(path);\n        let _ = fs::remove_file(path.with_extension(\"db-wal\"));\n        let _ = fs::remove_file(path.with_extension(\"db-shm\"));\n    }\n\n    #[test]\n    fn test_database_new() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 5,\n            connection_timeout_ms: 5000,\n        };\n\n        let result = Database::with_config(config);\n        assert!(\n            result.is_ok(),\n            \"Database should be created successfully: {:?}\",\n            result.err()\n        );\n\n        // Explicit cleanup\n        drop(result);\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_get_connection() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 3,\n            connection_timeout_ms: 5000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n        let conn = db.get_connection();\n        assert!(conn.is_ok(), \"Should get connection from pool\");\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_concurrent_connections() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 5,\n            connection_timeout_ms: 10000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n\n        let mut handles = Vec::new();\n        for _ in 0..5 {\n            let db_clone = db.clone();\n            handles.push(std::thread::spawn(move || db_clone.get_connection()));\n        }\n\n        let results: Vec\u003cResult\u003cPooledConnection\u003cSqliteConnectionManager\u003e, NuClawError\u003e\u003e =\n            handles.into_iter().map(|h| h.join().unwrap()).collect();\n\n        assert_eq!(results.len(), 5);\n        assert!(\n            results.into_iter().all(|r| r.is_ok()),\n            \"All connections should succeed\"\n        );\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_pool_status() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 10,\n            connection_timeout_ms: 5000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n\n        let status = db.pool_status();\n        assert!(\n            status.connections_idle \u003e= 1,\n            \"Should have at least one idle connection\"\n        );\n        assert_eq!(status.max_size, 10);\n\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_database_config_defaults() {\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n\n        let config = DatabaseConfig::default();\n        assert_eq!(config.pool_size, 10);\n        assert_eq!(config.connection_timeout_ms, 30000);\n\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n    }\n\n    #[test]\n    fn test_database_config_from_env() {\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n\n        let original_pool = std::env::var(\"DB_POOL_SIZE\").ok();\n        let original_timeout = std::env::var(\"DB_CONNECTION_TIMEOUT_MS\").ok();\n        assert!(original_pool.is_none());\n        assert!(original_timeout.is_none());\n\n        std::env::set_var(\"DB_POOL_SIZE\", \"20\");\n        std::env::set_var(\"DB_CONNECTION_TIMEOUT_MS\", \"60000\");\n\n        let config = DatabaseConfig::default();\n        assert_eq!(config.pool_size, 20);\n        assert_eq!(config.connection_timeout_ms, 60000);\n\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n    }\n\n    #[test]\n    fn test_schema_initialization() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 3,\n            connection_timeout_ms: 5000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n        let conn = db.get_connection().unwrap();\n\n        let tables: Vec\u003cString\u003e = conn\n            .prepare(\"SELECT name FROM sqlite_master WHERE type='table'\")\n            .unwrap()\n            .query_map([], |row| row.get::\u003c_, String\u003e(0))\n            .unwrap()\n            .collect::\u003cResult\u003cVec\u003cString\u003e, _\u003e\u003e()\n            .unwrap();\n\n        assert!(tables.contains(\u0026\"chats\".to_string()));\n        assert!(tables.contains(\u0026\"messages\".to_string()));\n        assert!(tables.contains(\u0026\"scheduled_tasks\".to_string()));\n        assert!(tables.contains(\u0026\"task_run_logs\".to_string()));\n\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_clone_database() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 3,\n            connection_timeout_ms: 5000,\n        };\n\n        let db1 = Database::with_config(config.clone()).unwrap();\n        let db2 = db1.clone();\n\n        assert!(db1.get_connection().is_ok());\n        assert!(db2.get_connection().is_ok());\n\n        cleanup_test_db(\u0026db_path);\n    }\n}\n","traces":[{"line":25,"address":[13167248,13167666,13167672],"length":1,"stats":{"Line":2}},{"line":27,"address":[12212544],"length":1,"stats":{"Line":2}},{"line":31,"address":[12212655],"length":1,"stats":{"Line":2}},{"line":35,"address":[13167552,13167471],"length":1,"stats":{"Line":4}},{"line":49,"address":[12215584],"length":1,"stats":{"Line":2}},{"line":50,"address":[14159245],"length":1,"stats":{"Line":2}},{"line":54,"address":[13169974,13168688,13170067],"length":1,"stats":{"Line":2}},{"line":55,"address":[14831376],"length":1,"stats":{"Line":10}},{"line":56,"address":[12366318],"length":1,"stats":{"Line":3}},{"line":57,"address":[12366485],"length":1,"stats":{"Line":2}},{"line":58,"address":[12900493],"length":1,"stats":{"Line":2}},{"line":59,"address":[12900673],"length":1,"stats":{"Line":2}},{"line":62,"address":[14159073,14158116,14157802,14157974,14158208],"length":1,"stats":{"Line":6}},{"line":63,"address":[12214216],"length":1,"stats":{"Line":2}},{"line":64,"address":[14157911,14157982],"length":1,"stats":{"Line":4}},{"line":65,"address":[13168931],"length":1,"stats":{"Line":2}},{"line":67,"address":[14158017],"length":1,"stats":{"Line":2}},{"line":68,"address":[12899790,12899552,12899737],"length":1,"stats":{"Line":2}},{"line":69,"address":[12899642,12899574],"length":1,"stats":{"Line":0}},{"line":72,"address":[14158458,14158269,14158337,14159020],"length":1,"stats":{"Line":4}},{"line":73,"address":[12899914,12899846],"length":1,"stats":{"Line":0}},{"line":75,"address":[14158567,14158640],"length":1,"stats":{"Line":4}},{"line":77,"address":[13169750],"length":1,"stats":{"Line":2}},{"line":81,"address":[13170096],"length":1,"stats":{"Line":2}},{"line":82,"address":[14832169,14831984,14832222],"length":1,"stats":{"Line":2}},{"line":83,"address":[14832006,14832074],"length":1,"stats":{"Line":0}},{"line":88,"address":[13170224],"length":1,"stats":{"Line":0}},{"line":93,"address":[12213872],"length":1,"stats":{"Line":1}},{"line":94,"address":[12213904],"length":1,"stats":{"Line":1}},{"line":97,"address":[14157574,14157625],"length":1,"stats":{"Line":1}},{"line":98,"address":[14157609],"length":1,"stats":{"Line":1}},{"line":112,"address":[13167696],"length":1,"stats":{"Line":2}},{"line":113,"address":[14156709,14156807,14156670],"length":1,"stats":{"Line":4}},{"line":121,"address":[14156693],"length":1,"stats":{"Line":2}},{"line":122,"address":[12898486,12898554],"length":1,"stats":{"Line":0}},{"line":125,"address":[13168067,13167949,13167903],"length":1,"stats":{"Line":4}},{"line":138,"address":[12898736,12898921,12898974],"length":1,"stats":{"Line":2}},{"line":139,"address":[12898826,12898758],"length":1,"stats":{"Line":0}},{"line":142,"address":[12213584,12213465,12213417],"length":1,"stats":{"Line":4}},{"line":159,"address":[12899280,12899465,12899518],"length":1,"stats":{"Line":2}},{"line":160,"address":[14830650,14830582],"length":1,"stats":{"Line":0}},{"line":163,"address":[14157279,14157446,14157327],"length":1,"stats":{"Line":4}},{"line":175,"address":[12213657],"length":1,"stats":{"Line":2}},{"line":176,"address":[12899030,12899098],"length":1,"stats":{"Line":0}},{"line":179,"address":[12213842],"length":1,"stats":{"Line":2}}],"covered":37,"coverable":45},{"path":["/","root","code","nuclaw","src","error.rs"],"content":"//! Error handling for NuClaw\n\nuse thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum NuClawError {\n    #[error(\"Database error: {message}\")]\n    Database { message: String },\n\n    #[error(\"Container error: {message}\")]\n    Container { message: String },\n\n    #[error(\"WhatsApp error: {message}\")]\n    WhatsApp { message: String },\n\n    #[error(\"Telegram error: {message}\")]\n    Telegram { message: String },\n\n    #[error(\"Configuration error: {message}\")]\n    Config { message: String },\n\n    #[error(\"File system error: {message}\")]\n    FileSystem { message: String },\n\n    #[error(\"Validation error: {message}\")]\n    Validation { message: String },\n\n    #[error(\"Timeout error: {operation}\")]\n    Timeout { operation: String },\n\n    #[error(\"Authentication error: {message}\")]\n    Auth { message: String },\n\n    #[error(\"Scheduler error: {message}\")]\n    Scheduler { message: String },\n}\n\npub type Result\u003cT\u003e = std::result::Result\u003cT, NuClawError\u003e;\n\nimpl From\u003crusqlite::Error\u003e for NuClawError {\n    fn from(e: rusqlite::Error) -\u003e Self {\n        NuClawError::Database {\n            message: e.to_string(),\n        }\n    }\n}\n\nimpl From\u003cstd::io::Error\u003e for NuClawError {\n    fn from(e: std::io::Error) -\u003e Self {\n        NuClawError::FileSystem {\n            message: e.to_string(),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_error_display() {\n        let err = NuClawError::Database {\n            message: \"test error\".to_string(),\n        };\n        let msg = format!(\"{}\", err);\n        assert!(msg.contains(\"Database error\"));\n        assert!(msg.contains(\"test error\"));\n    }\n\n    #[test]\n    fn test_error_from_sqlite() {\n        let sqlite_err = rusqlite::Error::SqliteFailure(\n            rusqlite::ffi::Error {\n                code: rusqlite::ErrorCode::DatabaseBusy,\n                extended_code: 5,\n            },\n            Some(\"busy\".to_string()),\n        );\n        let err: NuClawError = sqlite_err.into();\n        match err {\n            NuClawError::Database { message } =\u003e {\n                assert!(message.contains(\"busy\"));\n            }\n            _ =\u003e panic!(\"Expected Database error\"),\n        }\n    }\n\n    #[test]\n    fn test_error_from_io() {\n        let io_err = std::io::Error::new(std::io::ErrorKind::NotFound, \"file not found\");\n        let err: NuClawError = io_err.into();\n        match err {\n            NuClawError::FileSystem { message } =\u003e {\n                assert!(message.contains(\"file not found\"));\n            }\n            _ =\u003e panic!(\"Expected FileSystem error\"),\n        }\n    }\n\n    #[test]\n    fn test_all_error_variants() {\n        // Test that all error variants can be created\n        let _ = NuClawError::Database {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Container {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::WhatsApp {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Telegram {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Config {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::FileSystem {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Validation {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Timeout {\n            operation: \"test\".to_string(),\n        };\n        let _ = NuClawError::Auth {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Scheduler {\n            message: \"test\".to_string(),\n        };\n    }\n}\n","traces":[{"line":38,"address":[26010623],"length":1,"stats":{"Line":0}},{"line":40,"address":[27123631],"length":1,"stats":{"Line":0}},{"line":41,"address":[16467023,16465689,16465963,16466769,16467847,16466505,16465425,16466233,16467308,16467575,16468140],"length":1,"stats":{"Line":1}},{"line":43,"address":[25683581],"length":1,"stats":{"Line":1}},{"line":48,"address":[18155602],"length":1,"stats":{"Line":0}},{"line":49,"address":[13059184,13059316,13059322],"length":1,"stats":{"Line":1}},{"line":51,"address":[13059203],"length":1,"stats":{"Line":1}}],"covered":4,"coverable":7},{"path":["/","root","code","nuclaw","src","lib.rs"],"content":"//!\n//! A Rust implementation of NanoClaw project structure.\n//! Features:\n//! - WhatsApp integration via MCP\n//! - Telegram integration via Bot API\n//! - Containerized agent execution\n//! - Scheduled task management\n//! - SQLite persistence\n\npub mod config;\npub mod container_runner;\npub mod db;\npub mod error;\npub mod logging;\npub mod task_scheduler;\npub mod telegram;\npub mod types;\npub mod utils;\npub mod whatsapp;\n\n// Re-exports for convenience\npub use config::ensure_directories;\npub use container_runner::{\n    container_timeout, create_group_ipc_directory, ensure_container_system_running,\n    max_output_size, run_container,\n};\npub use error::{NuClawError, Result};\npub use task_scheduler::TaskScheduler;\n","traces":[],"covered":0,"coverable":0},{"path":["/","root","code","nuclaw","src","logging.rs"],"content":"//! Logging module for NuClaw\n//!\n//! Provides unified logging initialization with support for both\n//! env_logger and tracing integration.\n\nuse log::LevelFilter;\nuse std::sync::OnceLock;\n\n/// Global logging initialization status\nstatic LOG_INIT: OnceLock\u003c()\u003e = OnceLock::new();\n\n/// Logging configuration\n#[derive(Debug, Clone)]\npub struct LoggingConfig {\n    /// Default log level\n    pub level: Level,\n    /// Whether to use JSON formatting\n    pub json_format: bool,\n    /// Whether to include timestamps\n    pub include_timestamp: bool,\n}\n\n/// Log level enumeration\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum Level {\n    /// Trace level (most verbose)\n    Trace,\n    /// Debug level\n    Debug,\n    /// Info level (default)\n    Info,\n    /// Warning level\n    Warn,\n    /// Error level\n    Error,\n    /// Disable logging\n    Off,\n}\n\nimpl Default for LoggingConfig {\n    fn default() -\u003e Self {\n        Self {\n            level: Level::from_env().unwrap_or(Level::Info),\n            json_format: std::env::var(\"NUCLAW_LOG_JSON\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(false),\n            include_timestamp: true,\n        }\n    }\n}\n\nimpl Level {\n    /// Get log level from RUST_LOG environment variable\n    pub fn from_env() -\u003e Option\u003cSelf\u003e {\n        let rust_log = std::env::var(\"RUST_LOG\").ok()?;\n        Self::from_env_str(\u0026rust_log)\n    }\n\n    /// Parse level from string (for env vars)\n    pub fn from_env_str(s: \u0026str) -\u003e Option\u003cSelf\u003e {\n        match s.to_lowercase().as_str() {\n            \"trace\" =\u003e Some(Level::Trace),\n            \"debug\" =\u003e Some(Level::Debug),\n            \"info\" =\u003e Some(Level::Info),\n            \"warn\" | \"warning\" =\u003e Some(Level::Warn),\n            \"error\" =\u003e Some(Level::Error),\n            \"off\" =\u003e Some(Level::Off),\n            _ =\u003e None,\n        }\n    }\n\n    /// Convert to LevelFilter\n    fn to_filter(self) -\u003e LevelFilter {\n        match self {\n            Level::Trace =\u003e LevelFilter::Trace,\n            Level::Debug =\u003e LevelFilter::Debug,\n            Level::Info =\u003e LevelFilter::Info,\n            Level::Warn =\u003e LevelFilter::Warn,\n            Level::Error =\u003e LevelFilter::Error,\n            Level::Off =\u003e LevelFilter::Off,\n        }\n    }\n}\n\n/// Initialize logging with default configuration\npub fn init() {\n    init_with_config(LoggingConfig::default());\n}\n\n/// Initialize logging with custom configuration\npub fn init_with_config(config: LoggingConfig) {\n    // Ensure logging is only initialized once\n    let _ = LOG_INIT.get_or_init(|| {\n        setup_logging(\u0026config);\n    });\n}\n\n/// Setup logging based on configuration\nfn setup_logging(config: \u0026LoggingConfig) {\n    // Set RUST_LOG for env_logger\n    std::env::set_var(\"RUST_LOG\", format!(\"{}\", config.level).to_lowercase());\n\n    // Clone config for the closure\n    let config = config.clone();\n\n    // Initialize env_logger with custom format\n    env_logger::Builder::from_default_env()\n        .format_timestamp(None)\n        .format(move |buf, record| {\n            use std::io::Write;\n\n            let timestamp = if config.include_timestamp {\n                let now = chrono::Utc::now();\n                Some(format!(\"[{}]\", now.to_rfc3339()))\n            } else {\n                None\n            };\n\n            let level = match record.level() {\n                log::Level::Error =\u003e \"ERROR\",\n                log::Level::Warn =\u003e \"WARN\",\n                log::Level::Info =\u003e \"INFO\",\n                log::Level::Debug =\u003e \"DEBUG\",\n                log::Level::Trace =\u003e \"TRACE\",\n            };\n\n            if config.json_format {\n                // JSON format for structured logging\n                let output = serde_json::json!({\n                    \"timestamp\": chrono::Utc::now().to_rfc3339(),\n                    \"level\": level,\n                    \"message\": record.args(),\n                    \"module\": record.module_path().unwrap_or(\"unknown\"),\n                    \"file\": record.file().unwrap_or(\"unknown\"),\n                    \"line\": record.line(),\n                });\n                writeln!(buf, \"{}\", output)\n            } else {\n                // Human-readable format\n                let mut output = String::new();\n                if let Some(ts) = timestamp {\n                    output.push_str(\u0026ts);\n                    output.push(' ');\n                }\n                output.push_str(level);\n                output.push_str(\": \");\n                output.push_str(\u0026format!(\"{}\", record.args()));\n                writeln!(buf, \"{}\", output)\n            }\n        })\n        .filter(None, config.level.to_filter())\n        .init();\n}\n\n/// Check if logging has been initialized\npub fn is_initialized() -\u003e bool {\n    LOG_INIT.get().is_some()\n}\n\n/// Get current log level from environment\npub fn get_log_level() -\u003e Level {\n    Level::from_env().unwrap_or(Level::Info)\n}\n\nimpl std::fmt::Display for Level {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            Level::Trace =\u003e write!(f, \"trace\"),\n            Level::Debug =\u003e write!(f, \"debug\"),\n            Level::Info =\u003e write!(f, \"info\"),\n            Level::Warn =\u003e write!(f, \"warn\"),\n            Level::Error =\u003e write!(f, \"error\"),\n            Level::Off =\u003e write!(f, \"off\"),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_level_from_str() {\n        assert_eq!(Level::from_env_str(\"trace\"), Some(Level::Trace));\n        assert_eq!(Level::from_env_str(\"debug\"), Some(Level::Debug));\n        assert_eq!(Level::from_env_str(\"info\"), Some(Level::Info));\n        assert_eq!(Level::from_env_str(\"warn\"), Some(Level::Warn));\n        assert_eq!(Level::from_env_str(\"warning\"), Some(Level::Warn));\n        assert_eq!(Level::from_env_str(\"error\"), Some(Level::Error));\n        assert_eq!(Level::from_env_str(\"off\"), Some(Level::Off));\n        assert_eq!(Level::from_env_str(\"invalid\"), None);\n    }\n\n    #[test]\n    fn test_level_display() {\n        assert_eq!(format!(\"{}\", Level::Trace), \"trace\");\n        assert_eq!(format!(\"{}\", Level::Debug), \"debug\");\n        assert_eq!(format!(\"{}\", Level::Info), \"info\");\n        assert_eq!(format!(\"{}\", Level::Warn), \"warn\");\n        assert_eq!(format!(\"{}\", Level::Error), \"error\");\n        assert_eq!(format!(\"{}\", Level::Off), \"off\");\n    }\n\n    #[test]\n    fn test_logging_config_defaults() {\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n        let config = LoggingConfig::default();\n        assert!(!config.json_format);\n        assert!(config.include_timestamp);\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n    }\n\n    #[test]\n    fn test_logging_config_from_env() {\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n\n        let original_json = std::env::var(\"NUCLAW_LOG_JSON\").ok();\n        assert!(original_json.is_none());\n\n        std::env::set_var(\"NUCLAW_LOG_JSON\", \"true\");\n        let config = LoggingConfig::default();\n        assert!(config.json_format);\n\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n    }\n\n    #[test]\n    fn test_is_initialized() {\n        // is_initialized() is safe to call even if not initialized\n        let _ = is_initialized();\n    }\n\n    #[test]\n    fn test_get_log_level() {\n        // Save original\n        let original = std::env::var(\"RUST_LOG\").ok();\n\n        std::env::remove_var(\"RUST_LOG\");\n        let level = get_log_level();\n        assert_eq!(level, Level::Info);\n\n        std::env::set_var(\"RUST_LOG\", \"debug\");\n        let level = get_log_level();\n        assert_eq!(level, Level::Debug);\n\n        // Restore\n        match original {\n            Some(v) =\u003e std::env::set_var(\"RUST_LOG\", v),\n            None =\u003e std::env::remove_var(\"RUST_LOG\"),\n        }\n    }\n\n    #[test]\n    fn test_init_with_config() {\n        let config = LoggingConfig {\n            level: Level::Debug,\n            json_format: false,\n            include_timestamp: false,\n        };\n\n        // Should not panic\n        init_with_config(config);\n        assert!(is_initialized());\n    }\n}\n","traces":[{"line":41,"address":[13403920],"length":1,"stats":{"Line":1}},{"line":43,"address":[14376868],"length":1,"stats":{"Line":1}},{"line":44,"address":[14376898],"length":1,"stats":{"Line":1}},{"line":55,"address":[13403784,13403504,13403778],"length":1,"stats":{"Line":1}},{"line":56,"address":[14376455],"length":1,"stats":{"Line":1}},{"line":57,"address":[14376681,14376616],"length":1,"stats":{"Line":2}},{"line":61,"address":[13403481,13402992,13403487],"length":1,"stats":{"Line":1}},{"line":62,"address":[13403098,13403012],"length":1,"stats":{"Line":2}},{"line":63,"address":[14376058,14376124],"length":1,"stats":{"Line":2}},{"line":64,"address":[14376101,14376138,14376177],"length":1,"stats":{"Line":3}},{"line":65,"address":[13403210,13403247,13403286],"length":1,"stats":{"Line":3}},{"line":66,"address":[13403263,13403300],"length":1,"stats":{"Line":2}},{"line":67,"address":[13403366,13403432],"length":1,"stats":{"Line":2}},{"line":68,"address":[14376400,14376387,14376353],"length":1,"stats":{"Line":3}},{"line":69,"address":[14376393],"length":1,"stats":{"Line":1}},{"line":74,"address":[12445472],"length":1,"stats":{"Line":1}},{"line":75,"address":[13403815],"length":1,"stats":{"Line":1}},{"line":76,"address":[12445510],"length":1,"stats":{"Line":0}},{"line":77,"address":[13403857],"length":1,"stats":{"Line":1}},{"line":78,"address":[13403868],"length":1,"stats":{"Line":0}},{"line":79,"address":[12445543],"length":1,"stats":{"Line":0}},{"line":80,"address":[13403890],"length":1,"stats":{"Line":0}},{"line":81,"address":[14376845],"length":1,"stats":{"Line":0}},{"line":87,"address":[14375840],"length":1,"stats":{"Line":0}},{"line":88,"address":[13402900],"length":1,"stats":{"Line":0}},{"line":92,"address":[14375776],"length":1,"stats":{"Line":1}},{"line":94,"address":[12444533],"length":1,"stats":{"Line":2}},{"line":95,"address":[12911157],"length":1,"stats":{"Line":1}},{"line":100,"address":[13402224,13402777,13402771],"length":1,"stats":{"Line":1}},{"line":102,"address":[14375175],"length":1,"stats":{"Line":1}},{"line":105,"address":[14375440],"length":1,"stats":{"Line":1}},{"line":108,"address":[12444216],"length":1,"stats":{"Line":1}},{"line":109,"address":[12444243],"length":1,"stats":{"Line":1}},{"line":110,"address":[14375593],"length":1,"stats":{"Line":1}},{"line":113,"address":[12907335,12907423,12907753],"length":1,"stats":{"Line":0}},{"line":114,"address":[14838705],"length":1,"stats":{"Line":0}},{"line":115,"address":[12907458,12907544],"length":1,"stats":{"Line":0}},{"line":117,"address":[13065253],"length":1,"stats":{"Line":0}},{"line":120,"address":[14839112,14838806],"length":1,"stats":{"Line":0}},{"line":121,"address":[12907869],"length":1,"stats":{"Line":0}},{"line":122,"address":[14839178],"length":1,"stats":{"Line":0}},{"line":123,"address":[13065779],"length":1,"stats":{"Line":0}},{"line":124,"address":[12907956],"length":1,"stats":{"Line":0}},{"line":125,"address":[13065837],"length":1,"stats":{"Line":0}},{"line":128,"address":[14839300],"length":1,"stats":{"Line":0}},{"line":130,"address":[14842257,14840636,14841427,14839328,14841111,14841741,14840324,14841537,14841804,14840851,14841221,14840351,14840905,14840147,14840256],"length":1,"stats":{"Line":0}},{"line":131,"address":[12908957,12909017],"length":1,"stats":{"Line":0}},{"line":133,"address":[13067446,13067388],"length":1,"stats":{"Line":0}},{"line":134,"address":[14841094,14841162],"length":1,"stats":{"Line":0}},{"line":135,"address":[13068011,13067943],"length":1,"stats":{"Line":0}},{"line":136,"address":[13068315,13068251],"length":1,"stats":{"Line":0}},{"line":138,"address":[13068603,13068536],"length":1,"stats":{"Line":0}},{"line":141,"address":[14839313],"length":1,"stats":{"Line":0}},{"line":142,"address":[14839338],"length":1,"stats":{"Line":0}},{"line":143,"address":[12908265,12908143],"length":1,"stats":{"Line":0}},{"line":144,"address":[12908285],"length":1,"stats":{"Line":0}},{"line":146,"address":[12908166],"length":1,"stats":{"Line":0}},{"line":147,"address":[12908364],"length":1,"stats":{"Line":0}},{"line":148,"address":[14839679],"length":1,"stats":{"Line":0}},{"line":149,"address":[14839960],"length":1,"stats":{"Line":0}},{"line":152,"address":[12444345],"length":1,"stats":{"Line":1}},{"line":157,"address":[12444464],"length":1,"stats":{"Line":1}},{"line":158,"address":[12444465],"length":1,"stats":{"Line":1}},{"line":162,"address":[12443840],"length":1,"stats":{"Line":1}},{"line":163,"address":[14375121],"length":1,"stats":{"Line":1}},{"line":167,"address":[14374448],"length":1,"stats":{"Line":1}},{"line":168,"address":[12443195],"length":1,"stats":{"Line":1}},{"line":169,"address":[12443226],"length":1,"stats":{"Line":1}},{"line":170,"address":[14374549],"length":1,"stats":{"Line":1}},{"line":171,"address":[12443312],"length":1,"stats":{"Line":1}},{"line":172,"address":[12443355],"length":1,"stats":{"Line":1}},{"line":173,"address":[12443401],"length":1,"stats":{"Line":1}},{"line":174,"address":[12443447],"length":1,"stats":{"Line":1}}],"covered":40,"coverable":73},{"path":["/","root","code","nuclaw","src","main.rs"],"content":"//!\n//! A Rust implementation of NanoClaw project structure.\n//! Features:\n//! - WhatsApp integration via MCP\n//! - Telegram integration via Bot API\n//! - Containerized agent execution\n//! - Scheduled task management\n//! - SQLite persistence\n\nuse nuclaw::config;\nuse nuclaw::container_runner::{self, ensure_container_system_running};\nuse nuclaw::db;\nuse nuclaw::error::{NuClawError, Result};\nuse nuclaw::logging;\nuse nuclaw::task_scheduler::TaskScheduler;\nuse nuclaw::telegram;\nuse nuclaw::whatsapp;\n\nuse structopt::StructOpt;\nuse tokio::signal;\nuse tracing::info;\n\n#[derive(StructOpt, Debug)]\nstruct Args {\n    #[structopt(long)]\n    auth: bool,\n\n    #[structopt(long)]\n    scheduler: bool,\n\n    #[structopt(long)]\n    whatsapp: bool,\n\n    #[structopt(long)]\n    telegram: bool,\n}\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c()\u003e {\n    let args = Args::from_args();\n\n    // Initialize logging\n    logging::init();\n\n    info!(\"Starting NuClaw v1.0.0\");\n    info!(\"This is a Rust port of NanoClaw\");\n\n    // Ensure directories exist\n    config::ensure_directories().map_err(|e| NuClawError::FileSystem {\n        message: e.to_string(),\n    })?;\n\n    // Initialize database\n    let db = db::Database::new().map_err(|e| NuClawError::Database {\n        message: e.to_string(),\n    })?;\n    info!(\"Database initialized successfully\");\n\n    // Handle different modes\n    if args.scheduler {\n        // Run task scheduler\n        run_scheduler(db).await?;\n    } else if args.whatsapp {\n        // Run WhatsApp bot\n        run_whatsapp_bot(db).await?;\n    } else if args.telegram {\n        // Run Telegram bot\n        run_telegram_bot(db).await?;\n    } else if args.auth {\n        // Show authentication QR code\n        run_auth_flow().await?;\n    } else {\n        // Default: run main application with all features\n        run_main_application(db).await?;\n    }\n\n    Ok(())\n}\n\n/// Run the main application with all features\nasync fn run_main_application(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Running main application...\");\n\n    // Ensure container system is running\n    ensure_container_system_running().ok();\n\n    // Setup signal handlers for graceful shutdown\n    let (shutdown_tx, mut shutdown_rx) = tokio::sync::mpsc::channel::\u003c()\u003e(1);\n\n    // Clone db for the scheduler\n    let scheduler_db = db.clone();\n\n    // Run scheduler in background\n    let scheduler_handle = tokio::spawn(async move {\n        let mut scheduler = TaskScheduler::new(scheduler_db);\n        let _ = scheduler.run().await;\n    });\n\n    // Run WhatsApp bot in background\n    let _whatsapp_handle = tokio::spawn(async move {\n        loop {\n            tokio::time::sleep(tokio::time::Duration::from_secs(60)).await;\n        }\n    });\n\n    info!(\"NuClaw is running. Press Ctrl+C to stop.\");\n\n    // Wait for shutdown signal\n    tokio::select! {\n        _ = signal::ctrl_c() =\u003e {\n            info!(\"Received shutdown signal...\");\n        }\n        _ = shutdown_rx.recv() =\u003e {\n            info!(\"Received shutdown signal...\");\n        }\n    }\n\n    // Graceful shutdown\n    let _ = shutdown_tx.send(()).await;\n    scheduler_handle.abort();\n\n    info!(\"NuClaw shutdown complete.\");\n    Ok(())\n}\n\n/// Run the task scheduler\nasync fn run_scheduler(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Starting task scheduler...\");\n\n    let mut scheduler = TaskScheduler::new(db);\n    scheduler.run().await?;\n\n    Ok(())\n}\n\n/// Run the WhatsApp bot\nasync fn run_whatsapp_bot(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Starting WhatsApp bot...\");\n\n    // Check if WhatsApp MCP is configured\n    if std::env::var(\"WHATSAPP_MCP_URL\").is_err() {\n        info!(\"WHATSAPP_MCP_URL not set. Run with --auth to set up authentication.\");\n        info!(\"Then start the WhatsApp MCP server and run with --whatsapp.\");\n        return Ok(());\n    }\n\n    // Create WhatsApp client\n    let mut client = whatsapp::WhatsAppClient::new(db);\n\n    // Connect to WhatsApp\n    client.connect().await?;\n    info!(\"Connected to WhatsApp\");\n\n    // Start message listener\n    client.start_message_listener().await;\n\n    Ok(())\n}\n\n/// Run the authentication flow\nasync fn run_auth_flow() -\u003e Result\u003c()\u003e {\n    info!(\"Starting authentication flow...\");\n\n    whatsapp::start_auth_flow().await;\n    info!(\"Use WHATSAPP_MCP_URL to configure WhatsApp connection\");\n\n    Ok(())\n}\n\n/// Run the Telegram bot\nasync fn run_telegram_bot(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Starting Telegram bot...\");\n\n    // Check if Telegram bot token is configured\n    if std::env::var(\"TELEGRAM_BOT_TOKEN\").is_err() {\n        info!(\"TELEGRAM_BOT_TOKEN not set. Configure it to use Telegram bot.\");\n        info!(\"Usage:\");\n        info!(\"  export TELEGRAM_BOT_TOKEN=your_bot_token\");\n        info!(\"  export TELEGRAM_WEBHOOK_URL=https://your-domain.com\");\n        info!(\"  ./nuclaw --telegram\");\n        return Ok(());\n    }\n\n    // Create Telegram client\n    let mut client = telegram::TelegramClient::new(db)?;\n\n    // Connect to Telegram\n    client.connect().await?;\n    info!(\"Connected to Telegram\");\n\n    // Start webhook server\n    client.start_webhook_server().await?;\n\n    Ok(())\n}\n","traces":[{"line":39,"address":[12382272,12382691,12382697],"length":1,"stats":{"Line":0}},{"line":40,"address":[12319465,12319666],"length":1,"stats":{"Line":0}},{"line":43,"address":[12319687],"length":1,"stats":{"Line":0}},{"line":45,"address":[12319698,12320137],"length":1,"stats":{"Line":0}},{"line":46,"address":[12320099,12320927,12321322],"length":1,"stats":{"Line":0}},{"line":49,"address":[12322215,12327560,12321293,12327424,12322121,12327499,12327554,12324584],"length":1,"stats":{"Line":0}},{"line":50,"address":[12327442],"length":1,"stats":{"Line":0}},{"line":54,"address":[12327658,12322326,12322425,12327584,12327708,12322252,12324568],"length":1,"stats":{"Line":0}},{"line":55,"address":[12327602],"length":1,"stats":{"Line":0}},{"line":57,"address":[12322638,12322558,12323030],"length":1,"stats":{"Line":0}},{"line":60,"address":[12323004,12325008],"length":1,"stats":{"Line":0}},{"line":62,"address":[12324702,12325045,12319516,12324504,12323782],"length":1,"stats":{"Line":0}},{"line":63,"address":[12323762,12325390],"length":1,"stats":{"Line":0}},{"line":65,"address":[12324424,12319537,12325395,12323868,12325084],"length":1,"stats":{"Line":0}},{"line":66,"address":[12323848,12325714],"length":1,"stats":{"Line":0}},{"line":68,"address":[12234272],"length":1,"stats":{"Line":0}},{"line":69,"address":[12326038,12323934,12326362],"length":1,"stats":{"Line":0}},{"line":71,"address":[12324095,12319579,12326043,12324192,12325732],"length":1,"stats":{"Line":0}},{"line":74,"address":[12234310],"length":1,"stats":{"Line":0}},{"line":77,"address":[12325018],"length":1,"stats":{"Line":0}},{"line":81,"address":[12382193,12382176],"length":1,"stats":{"Line":0}},{"line":82,"address":[12307470,12308012,12307617],"length":1,"stats":{"Line":0}},{"line":85,"address":[12307983,12308803],"length":1,"stats":{"Line":0}},{"line":88,"address":[12308810],"length":1,"stats":{"Line":0}},{"line":91,"address":[12308881],"length":1,"stats":{"Line":0}},{"line":94,"address":[12308956,12318027,12317392,12317503,12317545,12317731,12317417],"length":1,"stats":{"Line":0}},{"line":95,"address":[12317457],"length":1,"stats":{"Line":0}},{"line":96,"address":[12229697],"length":1,"stats":{"Line":0}},{"line":100,"address":[12316929,12316754,12316656,12316734,12316681,12309195,12309081,12317052],"length":1,"stats":{"Line":0}},{"line":102,"address":[12316747,12316977,12316715,12316772],"length":1,"stats":{"Line":0}},{"line":106,"address":[12309198,12309278,12309690],"length":1,"stats":{"Line":0}},{"line":109,"address":[12311619,12312904],"length":1,"stats":{"Line":0}},{"line":119,"address":[12235662],"length":1,"stats":{"Line":0}},{"line":120,"address":[12314415],"length":1,"stats":{"Line":0}},{"line":122,"address":[12314426,12314872],"length":1,"stats":{"Line":0}},{"line":123,"address":[12314835],"length":1,"stats":{"Line":0}},{"line":127,"address":[12382001,12381984],"length":1,"stats":{"Line":0}},{"line":128,"address":[12284625,12284751,12285213],"length":1,"stats":{"Line":0}},{"line":130,"address":[12285125],"length":1,"stats":{"Line":0}},{"line":131,"address":[12234772],"length":1,"stats":{"Line":0}},{"line":133,"address":[12286416],"length":1,"stats":{"Line":0}},{"line":137,"address":[12305656,12299696,12299758,12299884,12299927,12303992],"length":1,"stats":{"Line":0}},{"line":138,"address":[12300410,12300003,12299856],"length":1,"stats":{"Line":0}},{"line":141,"address":[12300369,12301201],"length":1,"stats":{"Line":0}},{"line":142,"address":[12301567,12302006],"length":1,"stats":{"Line":0}},{"line":143,"address":[12303186,12301968,12302796],"length":1,"stats":{"Line":0}},{"line":144,"address":[12303162],"length":1,"stats":{"Line":0}},{"line":148,"address":[12301321],"length":1,"stats":{"Line":0}},{"line":151,"address":[12235359],"length":1,"stats":{"Line":0}},{"line":152,"address":[12304800,12304358],"length":1,"stats":{"Line":0}},{"line":155,"address":[12235378],"length":1,"stats":{"Line":0}},{"line":157,"address":[12305968],"length":1,"stats":{"Line":0}},{"line":161,"address":[12281091,12283823,12281040,12280928,12280975,12282449],"length":1,"stats":{"Line":0}},{"line":162,"address":[12281012,12281136,12281530],"length":1,"stats":{"Line":0}},{"line":164,"address":[12282483,12281502,12282320,12281070],"length":1,"stats":{"Line":0}},{"line":165,"address":[12283138,12282648],"length":1,"stats":{"Line":0}},{"line":167,"address":[12283064],"length":1,"stats":{"Line":0}},{"line":171,"address":[12297366,12295176,12287186,12287229,12287053,12286976],"length":1,"stats":{"Line":0}},{"line":172,"address":[12287305,12287158,12287712],"length":1,"stats":{"Line":0}},{"line":175,"address":[12288503,12287671],"length":1,"stats":{"Line":0}},{"line":176,"address":[12289169,12289608],"length":1,"stats":{"Line":0}},{"line":177,"address":[12289570,12290398,12290802],"length":1,"stats":{"Line":0}},{"line":178,"address":[12290764,12291592,12291996],"length":1,"stats":{"Line":0}},{"line":179,"address":[12291958,12293190,12292786],"length":1,"stats":{"Line":0}},{"line":180,"address":[12294370,12293152,12293980],"length":1,"stats":{"Line":0}},{"line":181,"address":[12294346],"length":1,"stats":{"Line":0}},{"line":185,"address":[12288623,12288763,12289147],"length":1,"stats":{"Line":0}},{"line":188,"address":[12235023],"length":1,"stats":{"Line":0}},{"line":189,"address":[12296029,12295542],"length":1,"stats":{"Line":0}},{"line":192,"address":[12235042],"length":1,"stats":{"Line":0}},{"line":194,"address":[12297169],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":71},{"path":["/","root","code","nuclaw","src","task_scheduler.rs"],"content":"//! Task Scheduler - Runs scheduled tasks in isolated containers\n//!\n//! Supports three schedule types:\n//! - `cron`: Cron expression (e.g., \"0 9 * * *\" for daily at 9am)\n//! - `interval`: Fixed interval in milliseconds (e.g., \"3600000\" for 1 hour)\n//! - `once`: Single execution at specific timestamp\n//!\n//! Features:\n//! - Persistent task storage in SQLite\n//! - Task run logging\n//! - Concurrent task execution\n//! - Graceful shutdown\n\nuse crate::config::timezone;\nuse crate::container_runner::{log_container_output, run_container};\nuse crate::db::Database;\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, ContainerOutput, ScheduledTask};\nuse chrono::{DateTime, Utc};\nuse cron::Schedule;\nuse std::str::FromStr;\nuse tokio::sync::mpsc;\nuse tokio::time::{interval, Duration, MissedTickBehavior};\n\n/// Default poll interval: 60 seconds\nconst DEFAULT_POLL_INTERVAL_SECS: u64 = 60;\n/// Max concurrent tasks\nconst MAX_CONCURRENT_TASKS: usize = 4;\n/// Default task timeout: 10 minutes\nconst DEFAULT_TASK_TIMEOUT_SECS: u64 = 600;\n\n/// Get poll interval from environment or default\npub fn poll_interval() -\u003e Duration {\n    let interval_secs = std::env::var(\"SCHEDULER_POLL_INTERVAL\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_POLL_INTERVAL_SECS);\n    Duration::from_secs(interval_secs)\n}\n\n/// Get task timeout from environment or default\npub fn task_timeout() -\u003e Duration {\n    let timeout_secs = std::env::var(\"TASK_TIMEOUT\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_TASK_TIMEOUT_SECS);\n    Duration::from_secs(timeout_secs)\n}\n\n/// Task scheduler state\n#[derive(Clone)]\npub struct TaskScheduler {\n    db: Database,\n    poll_interval: Duration,\n    task_timeout: Duration,\n}\n\nimpl TaskScheduler {\n    /// Create a new task scheduler\n    pub fn new(db: Database) -\u003e Self {\n        Self {\n            db,\n            poll_interval: poll_interval(),\n            task_timeout: task_timeout(),\n        }\n    }\n\n    /// Run the scheduler loop\n    pub async fn run(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let (shutdown_tx, mut shutdown_rx) = mpsc::channel::\u003c()\u003e(1);\n\n        let mut interval = interval(self.poll_interval);\n        interval.set_missed_tick_behavior(MissedTickBehavior::Skip);\n\n        tracing::info!(\n            \"Task scheduler started with poll interval: {:?}\",\n            self.poll_interval\n        );\n\n        loop {\n            tokio::select! {\n                _ = interval.tick() =\u003e {\n                    if let Err(e) = self.poll_and_execute_tasks().await {\n                        tracing::error!(\"Error executing tasks: {}\", e);\n                    }\n                }\n                _ = shutdown_rx.recv() =\u003e {\n                    tracing::info!(\"Task scheduler shutting down\");\n                    break;\n                }\n                _ = shutdown_tx.closed() =\u003e {\n                    break;\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Poll for due tasks and execute them\n    async fn poll_and_execute_tasks(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let now = Utc::now().to_rfc3339();\n\n        // Load active tasks that are due\n        let tasks = self.load_due_tasks(\u0026now).await?;\n\n        if tasks.is_empty() {\n            tracing::debug!(\"No tasks due for execution\");\n            return Ok(());\n        }\n\n        tracing::info!(\"Found {} tasks due for execution\", tasks.len());\n\n        // Execute tasks concurrently with limit\n        let mut handles = Vec::new();\n        for task in tasks {\n            // Check if we've reached max concurrent tasks\n            while handles.len() \u003e= MAX_CONCURRENT_TASKS {\n                // Wait for at least one to complete\n                let _ = tokio::join!(handles.remove(0));\n            }\n\n            let mut scheduler = TaskScheduler::new(self.db.clone());\n            let handle = tokio::spawn(async move {\n                let result = scheduler.execute_single_task(\u0026task).await;\n                (task.id.clone(), result)\n            });\n            handles.push(handle);\n        }\n\n        // Wait for remaining tasks\n        for handle in handles {\n            let (task_id, result) = handle.await.map_err(|e| NuClawError::Scheduler {\n                message: format!(\"Task execution panic: {}\", e),\n            })?;\n\n            if let Err(e) = \u0026result {\n                tracing::error!(\"Task {} failed: {}\", task_id, e);\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Execute a single task\n    async fn execute_single_task(\u0026mut self, task: \u0026ScheduledTask) -\u003e Result\u003c()\u003e {\n        tracing::info!(\"Executing task: {} (group: {})\", task.id, task.group_folder);\n\n        let start_time = chrono::Utc::now();\n\n        // Verify task is still active (may have been paused/cancelled)\n        let current_task =\n            self.load_task(\u0026task.id)\n                .await?\n                .ok_or_else(|| NuClawError::Scheduler {\n                    message: format!(\"Task {} not found\", task.id),\n                })?;\n\n        if current_task.status != \"active\" {\n            tracing::info!(\"Task {} is no longer active, skipping\", task.id);\n            return Ok(());\n        }\n\n        // Create container input\n        let session_id = format!(\"scheduled_{}\", task.id);\n        let input = ContainerInput {\n            prompt: task.prompt.clone(),\n            session_id: Some(session_id.clone()),\n            group_folder: task.group_folder.clone(),\n            chat_jid: task.chat_jid.clone(),\n            is_main: false,\n            is_scheduled_task: true,\n        };\n\n        // Execute container with timeout\n        let result = tokio::time::timeout(self.task_timeout, run_container(input)).await;\n\n        let end_time = chrono::Utc::now();\n        let duration_ms = (end_time - start_time).num_milliseconds();\n\n        // Process result and log\n        match result {\n            Ok(Ok(output)) =\u003e {\n                // Log successful execution\n                self.log_task_run(task, \u0026output, duration_ms, \"success\")\n                    .await?;\n\n                // Log to file\n                let _ = log_container_output(\u0026task.group_folder, \u0026session_id, \u0026output);\n\n                // Calculate next run time\n                if task.schedule_type == \"once\" {\n                    // Single execution task - mark as completed\n                    self.mark_task_completed(\u0026task.id).await?;\n                } else {\n                    // Recurring task - calculate next run\n                    if let Some(next_run) = self.calculate_next_run(task) {\n                        self.update_next_run(\u0026task.id, \u0026next_run).await?;\n                    }\n                }\n            }\n            Ok(Err(e)) =\u003e {\n                // Container execution failed\n                let output = ContainerOutput {\n                    status: \"error\".to_string(),\n                    result: None,\n                    new_session_id: None,\n                    error: Some(e.to_string()),\n                };\n                self.log_task_run(task, \u0026output, duration_ms, \"error\")\n                    .await?;\n                self.mark_task_failed(\u0026task.id).await?;\n            }\n            Err(_) =\u003e {\n                // Timeout\n                let output = ContainerOutput {\n                    status: \"timeout\".to_string(),\n                    result: None,\n                    new_session_id: None,\n                    error: Some(\"Task execution timed out\".to_string()),\n                };\n                self.log_task_run(task, \u0026output, duration_ms, \"timeout\")\n                    .await?;\n                self.mark_task_failed(\u0026task.id).await?;\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Calculate next run time for a task\n    pub fn calculate_next_run(\u0026self, task: \u0026ScheduledTask) -\u003e Option\u003cString\u003e {\n        match task.schedule_type.as_str() {\n            \"cron\" =\u003e self.calculate_next_cron_run(task.schedule_value.clone()),\n            \"interval\" =\u003e self.calculate_next_interval_run(task.schedule_value.clone()),\n            \"once\" =\u003e None,\n            _ =\u003e None,\n        }\n    }\n\n    /// Calculate next run time from cron expression\n    fn calculate_next_cron_run(\u0026self, cron_expr: String) -\u003e Option\u003cString\u003e {\n        let _tz = timezone();\n        match Schedule::from_str(\u0026cron_expr) {\n            Ok(schedule) =\u003e {\n                // Get next run in the specified timezone\n                let next = schedule.after(\u0026chrono::Utc::now()).next()?;\n                Some(next.to_rfc3339())\n            }\n            Err(e) =\u003e {\n                tracing::error!(\"Invalid cron expression '{}': {}\", cron_expr, e);\n                None\n            }\n        }\n    }\n\n    /// Calculate next run time from interval\n    fn calculate_next_interval_run(\u0026self, interval_str: String) -\u003e Option\u003cString\u003e {\n        let millis: i64 = interval_str.parse().ok()?;\n        let next_run = chrono::Utc::now() + chrono::Duration::milliseconds(millis);\n        Some(next_run.to_rfc3339())\n    }\n\n    /// Load tasks that are due for execution\n    async fn load_due_tasks(\u0026self, now: \u0026str) -\u003e Result\u003cVec\u003cScheduledTask\u003e\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        let mut stmt = conn\n            .prepare(\n                \"SELECT id, group_folder, chat_jid, prompt, schedule_type, schedule_value,\n                    next_run, last_run, last_result, status, created_at, context_mode\n             FROM scheduled_tasks\n             WHERE status = 'active'\n               AND (next_run IS NULL OR next_run \u003c= ?)\n             ORDER BY next_run ASC\",\n            )\n            .map_err(|e| NuClawError::Database {\n                message: format!(\"Failed to prepare statement: {}\", e),\n            })?;\n\n        let tasks: rusqlite::Result\u003cVec\u003cScheduledTask\u003e\u003e = stmt\n            .query_map([now], |row| {\n                Ok(ScheduledTask {\n                    id: row.get(0)?,\n                    group_folder: row.get(1)?,\n                    chat_jid: row.get(2)?,\n                    prompt: row.get(3)?,\n                    schedule_type: row.get(4)?,\n                    schedule_value: row.get(5)?,\n                    next_run: row.get(6)?,\n                    last_run: row.get(7)?,\n                    last_result: row.get(8)?,\n                    status: row.get(9)?,\n                    created_at: row.get(10)?,\n                    context_mode: row.get(11)?,\n                })\n            })?\n            .collect();\n\n        tasks.map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to load tasks: {}\", e),\n        })\n    }\n\n    /// Load a single task by ID\n    async fn load_task(\u0026self, task_id: \u0026str) -\u003e Result\u003cOption\u003cScheduledTask\u003e\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        let mut stmt = conn\n            .prepare(\n                \"SELECT id, group_folder, chat_jid, prompt, schedule_type, schedule_value,\n                    next_run, last_run, last_result, status, created_at, context_mode\n             FROM scheduled_tasks WHERE id = ?\",\n            )\n            .map_err(|e| NuClawError::Database {\n                message: format!(\"Failed to prepare statement: {}\", e),\n            })?;\n\n        stmt.query_row([task_id], |row| {\n            Ok(ScheduledTask {\n                id: row.get(0)?,\n                group_folder: row.get(1)?,\n                chat_jid: row.get(2)?,\n                prompt: row.get(3)?,\n                schedule_type: row.get(4)?,\n                schedule_value: row.get(5)?,\n                next_run: row.get(6)?,\n                last_run: row.get(7)?,\n                last_result: row.get(8)?,\n                status: row.get(9)?,\n                created_at: row.get(10)?,\n                context_mode: row.get(11)?,\n            })\n        })\n        .map(Some)\n        .or_else(|e| {\n            if e == rusqlite::Error::QueryReturnedNoRows {\n                Ok(None)\n            } else {\n                Err(NuClawError::Database {\n                    message: format!(\"Failed to load task: {}\", e),\n                })\n            }\n        })\n    }\n\n    /// Log a task run\n    async fn log_task_run(\n        \u0026self,\n        task: \u0026ScheduledTask,\n        output: \u0026ContainerOutput,\n        duration_ms: i64,\n        run_status: \u0026str,\n    ) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        let now = chrono::Utc::now().to_rfc3339();\n\n        conn.execute(\n            \"INSERT INTO task_run_logs (task_id, run_at, duration_ms, status, result, error)\n             VALUES (?, ?, ?, ?, ?, ?)\",\n            rusqlite::params![\n                task.id,\n                now,\n                duration_ms,\n                run_status,\n                output.result.clone().unwrap_or_default(),\n                output.error.clone().unwrap_or_default(),\n            ],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to log task run: {}\", e),\n        })?;\n\n        // Update last_run and last_result\n        let last_result = if output.status == \"success\" {\n            output.result.clone()\n        } else {\n            output.error.clone()\n        };\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET last_run = ?, last_result = ? WHERE id = ?\",\n            rusqlite::params![now, last_result, task.id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to update task: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Update next run time for a task\n    async fn update_next_run(\u0026self, task_id: \u0026str, next_run: \u0026str) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET next_run = ? WHERE id = ?\",\n            [next_run, task_id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to update next run: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Mark a task as completed (for once-type tasks)\n    async fn mark_task_completed(\u0026self, task_id: \u0026str) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET status = 'completed', next_run = NULL WHERE id = ?\",\n            [task_id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to mark task completed: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Mark a task as failed\n    async fn mark_task_failed(\u0026self, task_id: \u0026str) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET status = 'failed' WHERE id = ?\",\n            [task_id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to mark task failed: {}\", e),\n        })?;\n\n        Ok(())\n    }\n}\n\n/// Parse cron expression and get next run time\npub fn parse_cron_expression(expr: \u0026str) -\u003e Result\u003cSchedule\u003e {\n    Schedule::from_str(expr).map_err(|e| NuClawError::Scheduler {\n        message: format!(\"Invalid cron expression '{}': {}\", expr, e),\n    })\n}\n\n/// Get next run time from schedule\npub fn get_next_run_time(schedule: \u0026Schedule) -\u003e DateTime\u003cUtc\u003e {\n    schedule\n        .after(\u0026chrono::Utc::now())\n        .next()\n        .unwrap_or_else(chrono::Utc::now)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_cron_expression() {\n        // Use 6-field format with seconds (cron crate standard)\n        let result = parse_cron_expression(\"0 0 9 * * *\");\n        assert!(result.is_ok(), \"Expected valid cron expression\");\n    }\n\n    #[test]\n    fn test_parse_cron_expression_with_seconds() {\n        let result = parse_cron_expression(\"0 0 0 9 * * *\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_parse_invalid_cron() {\n        let result = parse_cron_expression(\"invalid cron\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_parse_empty_cron() {\n        let result = parse_cron_expression(\"\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_get_next_run_time() {\n        let schedule = parse_cron_expression(\"0 0 9 * * *\").unwrap();\n        let next = get_next_run_time(\u0026schedule);\n        let now = chrono::Utc::now();\n        // Next run should be in the future\n        assert!(next \u003e= now);\n    }\n\n    #[test]\n    fn test_calculate_interval_next_run() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let next = scheduler.calculate_next_interval_run(\"3600000\".to_string());\n        assert!(next.is_some());\n        // Should be approximately 1 hour from now\n        let next_time: DateTime\u003cUtc\u003e = DateTime::from_str(\u0026next.unwrap()).unwrap();\n        let now = chrono::Utc::now();\n        let diff = next_time.signed_duration_since(now).num_seconds();\n        // Allow some tolerance\n        assert!(diff \u003e= 3590 \u0026\u0026 diff \u003c= 3610);\n    }\n\n    #[test]\n    fn test_calculate_interval_next_run_invalid() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let next = scheduler.calculate_next_interval_run(\"not_a_number\".to_string());\n        assert!(next.is_none());\n    }\n\n    #[test]\n    fn test_calculate_interval_next_run_zero() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let next = scheduler.calculate_next_interval_run(\"0\".to_string());\n        assert!(next.is_some());\n        // Should be essentially now\n        let next_time: DateTime\u003cUtc\u003e = DateTime::from_str(\u0026next.unwrap()).unwrap();\n        let now = chrono::Utc::now();\n        let diff = next_time.signed_duration_since(now).num_seconds();\n        assert!(diff \u003c= 1);\n    }\n\n    #[test]\n    fn test_calculate_next_cron_run() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let task = ScheduledTask {\n            id: \"test\".to_string(),\n            group_folder: \"test\".to_string(),\n            chat_jid: \"test\".to_string(),\n            prompt: \"test\".to_string(),\n            schedule_type: \"cron\".to_string(),\n            schedule_value: \"0 0 9 * * *\".to_string(),\n            next_run: None,\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: chrono::Utc::now().to_rfc3339(),\n            context_mode: \"isolated\".to_string(),\n        };\n        let next = scheduler.calculate_next_run(\u0026task);\n        assert!(next.is_some());\n    }\n\n    #[test]\n    fn test_calculate_next_run_once() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let task = ScheduledTask {\n            id: \"test\".to_string(),\n            group_folder: \"test\".to_string(),\n            chat_jid: \"test\".to_string(),\n            prompt: \"test\".to_string(),\n            schedule_type: \"once\".to_string(),\n            schedule_value: \"2025-01-01T00:00:00Z\".to_string(),\n            next_run: None,\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: chrono::Utc::now().to_rfc3339(),\n            context_mode: \"isolated\".to_string(),\n        };\n        let next = scheduler.calculate_next_run(\u0026task);\n        assert!(next.is_none());\n    }\n\n    #[test]\n    fn test_calculate_next_run_invalid_type() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let task = ScheduledTask {\n            id: \"test\".to_string(),\n            group_folder: \"test\".to_string(),\n            chat_jid: \"test\".to_string(),\n            prompt: \"test\".to_string(),\n            schedule_type: \"unknown\".to_string(),\n            schedule_value: \"value\".to_string(),\n            next_run: None,\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: chrono::Utc::now().to_rfc3339(),\n            context_mode: \"isolated\".to_string(),\n        };\n        let next = scheduler.calculate_next_run(\u0026task);\n        assert!(next.is_none());\n    }\n\n    #[test]\n    fn test_poll_interval_default() {\n        let interval = poll_interval();\n        assert_eq!(interval, Duration::from_secs(DEFAULT_POLL_INTERVAL_SECS));\n    }\n\n    #[test]\n    fn test_poll_interval_from_env() {\n        // Save original\n        let original = std::env::var(\"SCHEDULER_POLL_INTERVAL\").ok();\n\n        std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", \"120\");\n        let interval = poll_interval();\n        assert_eq!(interval, Duration::from_secs(120));\n\n        // Restore\n        match original {\n            Some(val) =\u003e std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", val),\n            None =\u003e std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\"),\n        }\n    }\n\n    #[test]\n    fn test_poll_interval_invalid_env() {\n        // Save original\n        let original = std::env::var(\"SCHEDULER_POLL_INTERVAL\").ok();\n\n        std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", \"invalid\");\n        let interval = poll_interval();\n        // Should fall back to default\n        assert_eq!(interval, Duration::from_secs(DEFAULT_POLL_INTERVAL_SECS));\n\n        // Restore\n        match original {\n            Some(val) =\u003e std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", val),\n            None =\u003e std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\"),\n        }\n    }\n\n    #[test]\n    fn test_task_timeout_default() {\n        let timeout = task_timeout();\n        assert_eq!(timeout, Duration::from_secs(DEFAULT_TASK_TIMEOUT_SECS));\n    }\n\n    #[test]\n    fn test_task_timeout_from_env() {\n        // Save original\n        let original = std::env::var(\"TASK_TIMEOUT\").ok();\n\n        std::env::set_var(\"TASK_TIMEOUT\", \"300\");\n        let timeout = task_timeout();\n        assert_eq!(timeout, Duration::from_secs(300));\n\n        // Restore\n        match original {\n            Some(val) =\u003e std::env::set_var(\"TASK_TIMEOUT\", val),\n            None =\u003e std::env::remove_var(\"TASK_TIMEOUT\"),\n        }\n    }\n\n    #[test]\n    fn test_task_scheduler_new() {\n        let db = Database::new().unwrap();\n        let scheduler = TaskScheduler::new(db);\n        // Just verify it was created\n        assert_eq!(scheduler.poll_interval, poll_interval());\n        assert_eq!(scheduler.task_timeout, task_timeout());\n    }\n\n    #[test]\n    fn test_scheduler_clone() {\n        let db = Database::new().unwrap();\n        let scheduler = TaskScheduler::new(db);\n        let _cloned = scheduler.clone();\n        // Clone should work without panic\n    }\n}\n","traces":[{"line":33,"address":[14860864],"length":1,"stats":{"Line":2}},{"line":34,"address":[13136564],"length":1,"stats":{"Line":2}},{"line":36,"address":[12574064,12574073],"length":1,"stats":{"Line":6}},{"line":37,"address":[14860943],"length":1,"stats":{"Line":2}},{"line":38,"address":[13136657],"length":1,"stats":{"Line":2}},{"line":42,"address":[14857104],"length":1,"stats":{"Line":2}},{"line":43,"address":[14857108],"length":1,"stats":{"Line":2}},{"line":45,"address":[12552272,12552281],"length":1,"stats":{"Line":6}},{"line":46,"address":[14857183],"length":1,"stats":{"Line":2}},{"line":47,"address":[12925925],"length":1,"stats":{"Line":2}},{"line":60,"address":[14860544,14860753],"length":1,"stats":{"Line":1}},{"line":63,"address":[14860587],"length":1,"stats":{"Line":1}},{"line":64,"address":[12929383],"length":1,"stats":{"Line":1}},{"line":69,"address":[12929512,12929504],"length":1,"stats":{"Line":0}},{"line":70,"address":[12555492,12555666],"length":1,"stats":{"Line":0}},{"line":72,"address":[12592262],"length":1,"stats":{"Line":0}},{"line":73,"address":[14487039],"length":1,"stats":{"Line":0}},{"line":75,"address":[14487541,14487096],"length":1,"stats":{"Line":0}},{"line":81,"address":[12595566],"length":1,"stats":{"Line":0}},{"line":97,"address":[14491663],"length":1,"stats":{"Line":0}},{"line":101,"address":[12544672,12544542,12544480,12544629,12544693,12544722,12545047,12548500],"length":1,"stats":{"Line":0}},{"line":102,"address":[14476049,14475887],"length":1,"stats":{"Line":0}},{"line":105,"address":[14479748,14476361,14476194,14475939,14476080],"length":1,"stats":{"Line":0}},{"line":107,"address":[12582407,12582341],"length":1,"stats":{"Line":0}},{"line":108,"address":[14478944,14476865,14478554],"length":1,"stats":{"Line":0}},{"line":109,"address":[14478920],"length":1,"stats":{"Line":0}},{"line":112,"address":[12582413,12582479,12582874],"length":1,"stats":{"Line":0}},{"line":115,"address":[12582853],"length":1,"stats":{"Line":0}},{"line":116,"address":[12549330,12547068,12547177,12549269],"length":1,"stats":{"Line":0}},{"line":118,"address":[12586189,12585728],"length":1,"stats":{"Line":0}},{"line":120,"address":[14318930],"length":1,"stats":{"Line":0}},{"line":123,"address":[12549028,12548965],"length":1,"stats":{"Line":0}},{"line":124,"address":[12553106,12549063,12553325,12553056,12553816,12553906,12553172],"length":1,"stats":{"Line":0}},{"line":125,"address":[14484426,14484636,14484527,14484479],"length":1,"stats":{"Line":0}},{"line":126,"address":[14484859,14484928],"length":1,"stats":{"Line":0}},{"line":128,"address":[12586034],"length":1,"stats":{"Line":0}},{"line":132,"address":[12552103,12549441,12549566],"length":1,"stats":{"Line":0}},{"line":133,"address":[14475981,14483612,14481251,14481663,14483982,14483929,14483433,14483744,14481282,14481563],"length":1,"stats":{"Line":0}},{"line":134,"address":[14483766,14483834],"length":1,"stats":{"Line":0}},{"line":137,"address":[14481842],"length":1,"stats":{"Line":0}},{"line":138,"address":[12587415,12587322],"length":1,"stats":{"Line":0}},{"line":142,"address":[12588890],"length":1,"stats":{"Line":0}},{"line":146,"address":[14461822,14461693,14461970,14462012,14461928,14461886,14461865,14461949,14463768,14465493,14461991,14462041,14461907,14461616],"length":1,"stats":{"Line":0}},{"line":147,"address":[12530810,12530511,12531212],"length":1,"stats":{"Line":0}},{"line":149,"address":[12531184],"length":1,"stats":{"Line":0}},{"line":152,"address":[12570288,12569742,12570163,12572835,12569627,12570364,12570047,12570087,12572923],"length":1,"stats":{"Line":0}},{"line":154,"address":[12567932,12569810,12569727,12569866,12570057,12570131],"length":1,"stats":{"Line":0}},{"line":155,"address":[12542352,12542492,12532926],"length":1,"stats":{"Line":0}},{"line":156,"address":[12579977],"length":1,"stats":{"Line":0}},{"line":159,"address":[12533260,12533181],"length":1,"stats":{"Line":0}},{"line":160,"address":[12533308,12534616,12534226],"length":1,"stats":{"Line":0}},{"line":161,"address":[12571884],"length":1,"stats":{"Line":0}},{"line":165,"address":[12570647,12570582],"length":1,"stats":{"Line":0}},{"line":167,"address":[12570762],"length":1,"stats":{"Line":0}},{"line":168,"address":[12570851,12570926],"length":1,"stats":{"Line":0}},{"line":169,"address":[14464930],"length":1,"stats":{"Line":0}},{"line":170,"address":[12571040],"length":1,"stats":{"Line":0}},{"line":176,"address":[14461873,14465362,14465235,14466929],"length":1,"stats":{"Line":0}},{"line":178,"address":[14467323],"length":1,"stats":{"Line":0}},{"line":179,"address":[14467423],"length":1,"stats":{"Line":0}},{"line":182,"address":[12536324,12536402],"length":1,"stats":{"Line":0}},{"line":183,"address":[12536531],"length":1,"stats":{"Line":0}},{"line":185,"address":[12538088,12536632,12538138,12538225,12539181,12536768],"length":1,"stats":{"Line":0}},{"line":186,"address":[12021068],"length":1,"stats":{"Line":0}},{"line":189,"address":[14469550],"length":1,"stats":{"Line":0}},{"line":192,"address":[12539548,12538467],"length":1,"stats":{"Line":0}},{"line":194,"address":[12575740,12576208,12567995,12576368,12576681],"length":1,"stats":{"Line":0}},{"line":197,"address":[12575704,12575796],"length":1,"stats":{"Line":0}},{"line":198,"address":[12385782],"length":1,"stats":{"Line":0}},{"line":202,"address":[12536446],"length":1,"stats":{"Line":0}},{"line":205,"address":[14467761],"length":1,"stats":{"Line":0}},{"line":208,"address":[12537001,12536915],"length":1,"stats":{"Line":0}},{"line":210,"address":[12577467,12577338,12577400,12574531,12574407,12577692],"length":1,"stats":{"Line":0}},{"line":211,"address":[12021131],"length":1,"stats":{"Line":0}},{"line":212,"address":[12577727,12578082,12568058,12577508],"length":1,"stats":{"Line":0}},{"line":217,"address":[12573628],"length":1,"stats":{"Line":0}},{"line":220,"address":[12574747,12574656],"length":1,"stats":{"Line":0}},{"line":222,"address":[14472898,14468961,14469097,14472570,14472520,14472657],"length":1,"stats":{"Line":0}},{"line":223,"address":[12021173],"length":1,"stats":{"Line":0}},{"line":224,"address":[12542100,12541422,12530740,12541657],"length":1,"stats":{"Line":0}},{"line":228,"address":[12539931],"length":1,"stats":{"Line":0}},{"line":232,"address":[12926192],"length":1,"stats":{"Line":1}},{"line":233,"address":[14857514],"length":1,"stats":{"Line":1}},{"line":234,"address":[13133342,13133283],"length":1,"stats":{"Line":2}},{"line":235,"address":[12926290,12926407],"length":1,"stats":{"Line":1}},{"line":236,"address":[14857645],"length":1,"stats":{"Line":1}},{"line":242,"address":[12928801,12927394,12926592],"length":1,"stats":{"Line":1}},{"line":243,"address":[12926631],"length":1,"stats":{"Line":1}},{"line":244,"address":[13133722,13133802],"length":1,"stats":{"Line":2}},{"line":245,"address":[14858200],"length":1,"stats":{"Line":1}},{"line":247,"address":[14858202,14858265],"length":1,"stats":{"Line":2}},{"line":248,"address":[14858463],"length":1,"stats":{"Line":1}},{"line":250,"address":[12926829],"length":1,"stats":{"Line":0}},{"line":251,"address":[13134455,13133881,13134848],"length":1,"stats":{"Line":0}},{"line":252,"address":[12927819],"length":1,"stats":{"Line":0}},{"line":258,"address":[14860096,14860523],"length":1,"stats":{"Line":1}},{"line":259,"address":[14860202,14860134],"length":1,"stats":{"Line":2}},{"line":260,"address":[12929063],"length":1,"stats":{"Line":1}},{"line":261,"address":[14860419],"length":1,"stats":{"Line":1}},{"line":265,"address":[12926050,12926032],"length":1,"stats":{"Line":0}},{"line":266,"address":[14448854,14450041,14448765],"length":1,"stats":{"Line":0}},{"line":269,"address":[14448738,14458816,14458890,14458940],"length":1,"stats":{"Line":0}},{"line":270,"address":[12527554],"length":1,"stats":{"Line":0}},{"line":273,"address":[12517804,12517894,12517688,12518759],"length":1,"stats":{"Line":0}},{"line":282,"address":[14450080,14449057,14450318,14450265],"length":1,"stats":{"Line":0}},{"line":283,"address":[14450170,14450102],"length":1,"stats":{"Line":0}},{"line":286,"address":[12556016,12555908],"length":1,"stats":{"Line":0}},{"line":287,"address":[12555793,12557120,12561825,12561819],"length":1,"stats":{"Line":0}},{"line":288,"address":[12560591],"length":1,"stats":{"Line":0}},{"line":289,"address":[12519390],"length":1,"stats":{"Line":0}},{"line":290,"address":[12557373,12557460],"length":1,"stats":{"Line":0}},{"line":291,"address":[14451261,14451186],"length":1,"stats":{"Line":0}},{"line":292,"address":[12520287,12520212],"length":1,"stats":{"Line":0}},{"line":293,"address":[14451873,14451798],"length":1,"stats":{"Line":0}},{"line":294,"address":[12520824,12520899],"length":1,"stats":{"Line":0}},{"line":295,"address":[14452485,14452410],"length":1,"stats":{"Line":0}},{"line":296,"address":[12521436,12521511],"length":1,"stats":{"Line":0}},{"line":297,"address":[14453022,14453097],"length":1,"stats":{"Line":0}},{"line":298,"address":[14453403,14453328],"length":1,"stats":{"Line":0}},{"line":299,"address":[12522354,12522429],"length":1,"stats":{"Line":0}},{"line":300,"address":[14454015,14453940],"length":1,"stats":{"Line":0}},{"line":305,"address":[12519310,12519257,12518428,12519072],"length":1,"stats":{"Line":0}},{"line":306,"address":[14450374,14450442],"length":1,"stats":{"Line":0}},{"line":311,"address":[14860834,14860816],"length":1,"stats":{"Line":0}},{"line":312,"address":[12600589,12600658,12601392],"length":1,"stats":{"Line":0}},{"line":315,"address":[14496752,14496826,14496876,14495370],"length":1,"stats":{"Line":0}},{"line":316,"address":[12565490],"length":1,"stats":{"Line":0}},{"line":319,"address":[14495600,14495716,14495806],"length":1,"stats":{"Line":0}},{"line":325,"address":[12573977,12574030,12564409,12573792],"length":1,"stats":{"Line":0}},{"line":326,"address":[14505094,14505162],"length":1,"stats":{"Line":0}},{"line":329,"address":[12570440,12565616,12564733,12570434],"length":1,"stats":{"Line":0}},{"line":330,"address":[12569206],"length":1,"stats":{"Line":0}},{"line":331,"address":[12565646],"length":1,"stats":{"Line":0}},{"line":332,"address":[12601661,12601748],"length":1,"stats":{"Line":0}},{"line":333,"address":[12566162,12566237],"length":1,"stats":{"Line":0}},{"line":334,"address":[12602336,12602249],"length":1,"stats":{"Line":0}},{"line":335,"address":[12566774,12566849],"length":1,"stats":{"Line":0}},{"line":336,"address":[14498435,14498360],"length":1,"stats":{"Line":0}},{"line":337,"address":[12603131,12603218],"length":1,"stats":{"Line":0}},{"line":338,"address":[14498972,14499047],"length":1,"stats":{"Line":0}},{"line":339,"address":[12603719,12603806],"length":1,"stats":{"Line":0}},{"line":340,"address":[14499659,14499584],"length":1,"stats":{"Line":0}},{"line":341,"address":[12568685,12568610],"length":1,"stats":{"Line":0}},{"line":342,"address":[12604688,12604601],"length":1,"stats":{"Line":0}},{"line":345,"address":[14496108],"length":1,"stats":{"Line":0}},{"line":346,"address":[12565024,12564855,12565444],"length":1,"stats":{"Line":0}},{"line":347,"address":[12565190,12565052,12565118],"length":1,"stats":{"Line":0}},{"line":348,"address":[12565160],"length":1,"stats":{"Line":0}},{"line":350,"address":[12609872],"length":1,"stats":{"Line":0}},{"line":351,"address":[12565128,12565195],"length":1,"stats":{"Line":0}},{"line":358,"address":[13132960],"length":1,"stats":{"Line":0}},{"line":365,"address":[12516516,12514937,12514848],"length":1,"stats":{"Line":0}},{"line":368,"address":[12552673,12554691,12554576,12554642],"length":1,"stats":{"Line":0}},{"line":369,"address":[12554599],"length":1,"stats":{"Line":0}},{"line":372,"address":[12515107,12515044],"length":1,"stats":{"Line":0}},{"line":374,"address":[12515630,12515134,12515717,12515514],"length":1,"stats":{"Line":0}},{"line":377,"address":[14446643],"length":1,"stats":{"Line":0}},{"line":382,"address":[14446484],"length":1,"stats":{"Line":0}},{"line":383,"address":[12515259,12515326],"length":1,"stats":{"Line":0}},{"line":386,"address":[14446883,14447840,14448078,14448025],"length":1,"stats":{"Line":0}},{"line":387,"address":[12554806,12554742],"length":1,"stats":{"Line":0}},{"line":391,"address":[14447093],"length":1,"stats":{"Line":0}},{"line":392,"address":[14447154,14447203],"length":1,"stats":{"Line":0}},{"line":394,"address":[12515846,12515897],"length":1,"stats":{"Line":0}},{"line":397,"address":[12516057,12516129,12516216,12515899],"length":1,"stats":{"Line":0}},{"line":399,"address":[12515987],"length":1,"stats":{"Line":0}},{"line":401,"address":[12553898,12554320,12554554,12554501],"length":1,"stats":{"Line":0}},{"line":402,"address":[12517066,12516998],"length":1,"stats":{"Line":0}},{"line":405,"address":[12554037],"length":1,"stats":{"Line":0}},{"line":409,"address":[13133104,13133132],"length":1,"stats":{"Line":0}},{"line":410,"address":[14459312,14459223,14459867],"length":1,"stats":{"Line":0}},{"line":413,"address":[12527916,12528748,12528624,12528698],"length":1,"stats":{"Line":0}},{"line":414,"address":[14459922],"length":1,"stats":{"Line":0}},{"line":417,"address":[14459540,14459426,14459693,14459606],"length":1,"stats":{"Line":0}},{"line":419,"address":[12528228],"length":1,"stats":{"Line":0}},{"line":421,"address":[12528299,12528768,12528953,12529006],"length":1,"stats":{"Line":0}},{"line":422,"address":[14460070,14460138],"length":1,"stats":{"Line":0}},{"line":425,"address":[14459743],"length":1,"stats":{"Line":0}},{"line":429,"address":[12543222,12543320,12544025,12544033,12543347,12543184],"length":1,"stats":{"Line":0}},{"line":430,"address":[12580381,12580943,12580450],"length":1,"stats":{"Line":0}},{"line":433,"address":[12581347,12581298,12580358,12581232],"length":1,"stats":{"Line":0}},{"line":434,"address":[12544082],"length":1,"stats":{"Line":0}},{"line":437,"address":[12580560,12580781,12580714,12580640],"length":1,"stats":{"Line":0}},{"line":439,"address":[12580624],"length":1,"stats":{"Line":0}},{"line":441,"address":[12580976,12580691,12581157,12581210],"length":1,"stats":{"Line":0}},{"line":442,"address":[12581062,12580998],"length":1,"stats":{"Line":0}},{"line":445,"address":[12543907],"length":1,"stats":{"Line":0}},{"line":449,"address":[12926162,12926144],"length":1,"stats":{"Line":0}},{"line":450,"address":[12567263,12566701,12566770],"length":1,"stats":{"Line":0}},{"line":453,"address":[12567362,12567411,12566678,12567296],"length":1,"stats":{"Line":0}},{"line":454,"address":[12530210],"length":1,"stats":{"Line":0}},{"line":457,"address":[12567101,12566960,12566880,12567034],"length":1,"stats":{"Line":0}},{"line":459,"address":[14460824],"length":1,"stats":{"Line":0}},{"line":461,"address":[14461385,14461200,14461438,14460879],"length":1,"stats":{"Line":0}},{"line":462,"address":[14461290,14461222],"length":1,"stats":{"Line":0}},{"line":465,"address":[14461043],"length":1,"stats":{"Line":0}},{"line":470,"address":[13136784],"length":1,"stats":{"Line":2}},{"line":471,"address":[14861114],"length":1,"stats":{"Line":6}},{"line":472,"address":[12574335,12574254],"length":1,"stats":{"Line":4}},{"line":477,"address":[12929696],"length":1,"stats":{"Line":1}},{"line":479,"address":[12929719],"length":1,"stats":{"Line":1}},{"line":481,"address":[12929771],"length":1,"stats":{"Line":1}}],"covered":34,"coverable":202},{"path":["/","root","code","nuclaw","src","telegram.rs"],"content":"//! Telegram Integration for NuClaw\n//!\n//! Provides Telegram Bot connectivity via Bot API with webhook support.\n//! Follows OpenClaw Telegram specification for message handling.\n\nuse crate::config::{assistant_name, data_dir};\nuse crate::container_runner::run_container;\nuse crate::db::Database;\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, NewMessage, RegisteredGroup, RouterState};\nuse crate::utils::json::{load_json, save_json};\nuse axum::routing::{get, post};\nuse axum::Json;\nuse axum::Router;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::net::SocketAddr;\nuse std::sync::Arc;\nuse tokio::sync::Mutex;\nuse tokio::time::{timeout, Duration};\nuse tracing::{debug, error, info};\n\n/// Default text chunk limit: 4000 characters\nconst DEFAULT_TEXT_CHUNK_LIMIT: usize = 4000;\n\n/// DM policy enumeration\n#[derive(Debug, Clone, Copy, PartialEq, Serialize, Deserialize)]\npub enum DMPolicy {\n    #[serde(rename = \"pairing\")]\n    Pairing,\n    #[serde(rename = \"allowlist\")]\n    Allowlist,\n    #[serde(rename = \"open\")]\n    Open,\n    #[serde(rename = \"disabled\")]\n    Disabled,\n}\n\n/// Group policy enumeration\n#[derive(Debug, Clone, Copy, PartialEq, Serialize, Deserialize)]\npub enum GroupPolicy {\n    #[serde(rename = \"open\")]\n    Open,\n    #[serde(rename = \"allowlist\")]\n    Allowlist,\n    #[serde(rename = \"disabled\")]\n    Disabled,\n}\n\n/// Telegram Update object (Telegram Bot API)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramUpdate {\n    pub update_id: i64,\n    pub message: Option\u003cTelegramMessage\u003e,\n    pub edited_message: Option\u003cTelegramMessage\u003e,\n}\n\n/// Telegram User object\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramUser {\n    pub id: i64,\n    pub is_bot: bool,\n    pub first_name: String,\n    pub last_name: Option\u003cString\u003e,\n    pub username: Option\u003cString\u003e,\n}\n\n/// Telegram Chat object\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramChat {\n    pub id: i64,\n    #[serde(rename = \"type\")]\n    pub chat_type: String,\n    pub title: Option\u003cString\u003e,\n}\n\n/// Telegram Message object\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramMessage {\n    pub message_id: i64,\n    pub from: Option\u003cTelegramUser\u003e,\n    pub chat: TelegramChat,\n    pub date: i64,\n    pub text: Option\u003cString\u003e,\n}\n\n/// Telegram client state\npub struct TelegramClient {\n    /// API URL\n    api_url: String,\n    /// Webhook path\n    webhook_path: String,\n    /// DM policy\n    dm_policy: DMPolicy,\n    /// Group policy\n    group_policy: GroupPolicy,\n    /// Text chunk limit\n    text_chunk_limit: usize,\n    /// Allowed group IDs\n    allowed_groups: Vec\u003cString\u003e,\n    /// Reference to registered groups\n    registered_groups: HashMap\u003cString, RegisteredGroup\u003e,\n    /// Router state for message deduplication\n    router_state: RouterState,\n    /// Database connection\n    db: Database,\n    /// Assistant name for trigger detection\n    assistant_name: String,\n}\n\nimpl TelegramClient {\n    /// Create a new Telegram client\n    pub fn new(db: Database) -\u003e Result\u003cSelf\u003e {\n        let bot_token = std::env::var(\"TELEGRAM_BOT_TOKEN\").map_err(|_| NuClawError::Config {\n            message: \"TELEGRAM_BOT_TOKEN not set\".to_string(),\n        })?;\n\n        let api_url = format!(\"https://api.telegram.org/bot{}\", bot_token);\n\n        Ok(Self {\n            api_url,\n            webhook_path: std::env::var(\"TELEGRAM_WEBHOOK_PATH\")\n                .unwrap_or_else(|_| \"telegram-webhook\".to_string()),\n            dm_policy: DMPolicy::from_str(\n                \u0026std::env::var(\"TELEGRAM_DM_POLICY\").unwrap_or_else(|_| \"pairing\".to_string()),\n            ),\n            group_policy: GroupPolicy::from_str(\n                \u0026std::env::var(\"TELEGRAM_GROUP_POLICY\").unwrap_or_else(|_| \"allowlist\".to_string()),\n            ),\n            text_chunk_limit: std::env::var(\"TELEGRAM_TEXT_CHUNK_LIMIT\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(DEFAULT_TEXT_CHUNK_LIMIT),\n            allowed_groups: std::env::var(\"TELEGRAM_WHITELIST_GROUPS\")\n                .ok()\n                .map(|s| s.split(',').map(|v| v.trim().to_string()).collect())\n                .unwrap_or_default(),\n            registered_groups: load_registered_groups(),\n            router_state: load_router_state(),\n            db,\n            assistant_name: assistant_name(),\n        })\n    }\n\n    /// Connect to Telegram\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to Telegram...\");\n\n        // Check webhook URL\n        let webhook_url = std::env::var(\"TELEGRAM_WEBHOOK_URL\").ok();\n\n        if let Some(url) = webhook_url {\n            self.set_webhook(\u0026url).await?;\n            info!(\"Webhook set to: {}\", url);\n        } else {\n            info!(\"No webhook URL configured, using polling mode\");\n        }\n\n        Ok(())\n    }\n\n    /// Set webhook URL\n    async fn set_webhook(\u0026self, url: \u0026str) -\u003e Result\u003c()\u003e {\n        let full_url = format!(\"{}/webhook/{}\", url, self.webhook_path);\n        let response = reqwest::Client::new()\n            .post(format!(\"{}/setWebhook\", self.api_url))\n            .json(\u0026serde_json::json!({ \"url\": full_url }))\n            .send()\n            .await\n            .map_err(|e| NuClawError::Telegram {\n                message: format!(\"Failed to set webhook: {}\", e),\n            })?;\n\n        if response.status() != 200 {\n            return Err(NuClawError::Telegram {\n                message: format!(\n                    \"Webhook setup failed: {}\",\n                    response.text().await.unwrap_or_default()\n                ),\n            });\n        }\n\n        Ok(())\n    }\n\n    /// Start webhook server\n    pub async fn start_webhook_server(self) -\u003e Result\u003c()\u003e {\n        let addr: SocketAddr = std::env::var(\"TELEGRAM_WEBHOOK_BIND\")\n            .unwrap_or_else(|_| \"0.0.0.0:8787\".to_string())\n            .parse()\n            .map_err(|_| NuClawError::Config {\n                message: \"Invalid TELEGRAM_WEBHOOK_BIND\".to_string(),\n            })?;\n\n        let client = Arc::new(Mutex::new(self));\n        let webhook_path = client.lock().await.webhook_path.clone();\n\n        let app = Router::new()\n            .route(\u0026format!(\"/{}\", webhook_path), post(handle_telegram_webhook))\n            .route(\"/health\", get(health_check))\n            .with_state(client.clone());\n\n        info!(\"Starting Telegram webhook server on {}\", addr);\n\n        let listener =\n            tokio::net::TcpListener::bind(\u0026addr)\n                .await\n                .map_err(|e| NuClawError::Telegram {\n                    message: format!(\"Failed to bind to {}: {}\", addr, e),\n                })?;\n\n        axum::serve(listener, app)\n            .await\n            .map_err(|e| NuClawError::Telegram {\n                message: format!(\"Webhook server error: {}\", e),\n            })?;\n\n        Ok(())\n    }\n\n    /// Handle a Telegram update\n    pub async fn handle_update(\u0026mut self, update: \u0026TelegramUpdate) -\u003e Result\u003cOption\u003cString\u003e\u003e {\n        let message = match \u0026update.message {\n            Some(msg) =\u003e msg,\n            None =\u003e {\n                debug!(\"Received update without message, skipping\");\n                return Ok(None);\n            }\n        };\n\n        let new_message = self.parse_telegram_message(message).await?;\n        self.handle_message(\u0026new_message).await\n    }\n\n    /// Parse Telegram message to unified format\n    async fn parse_telegram_message(\u0026self, msg: \u0026TelegramMessage) -\u003e Result\u003cNewMessage\u003e {\n        let sender = msg\n            .from\n            .as_ref()\n            .map(|u| u.id.to_string())\n            .unwrap_or_default();\n        let sender_name = msg\n            .from\n            .as_ref()\n            .map(|u| {\n                if let Some(username) = \u0026u.username {\n                    username.clone()\n                } else {\n                    u.first_name.clone()\n                }\n            })\n            .unwrap_or_else(|| \"Unknown\".to_string());\n\n        let chat_jid = format!(\"telegram:group:{}\", msg.chat.id);\n\n        let content = msg.text.clone().unwrap_or_else(|| \"\".to_string());\n\n        Ok(NewMessage {\n            id: msg.message_id.to_string(),\n            chat_jid,\n            sender,\n            sender_name,\n            content,\n            timestamp: msg.date.to_string(),\n        })\n    }\n\n    /// Handle a single message\n    pub async fn handle_message(\u0026mut self, msg: \u0026NewMessage) -\u003e Result\u003cOption\u003cString\u003e\u003e {\n        if self.is_duplicate_message(msg).await {\n            debug!(\"Skipping duplicate message: {}\", msg.id);\n            return Ok(None);\n        }\n\n        self.update_router_state(msg).await;\n        self.store_message(msg).await?;\n\n        // Check if it's a private message\n        if msg.chat_jid.starts_with(\"telegram:group:-\") || !msg.chat_jid.contains(\":group:\") {\n            if !self.check_dm_policy(\u0026msg.sender).await? {\n                debug!(\"Message from unauthorized user: {}\", msg.sender);\n                return Ok(None);\n            }\n        }\n\n        // Check if registered group\n        if !self.is_allowed_group(\u0026msg.chat_jid).await? {\n            debug!(\"Message from unregistered group: {}\", msg.chat_jid);\n            return Ok(None);\n        }\n\n        let (_, content) = match self.extract_trigger(\u0026msg.content).await {\n            Some((_, c)) =\u003e (String::new(), c),\n            None =\u003e return Ok(None),\n        };\n\n        info!(\n            \"Received message from {}: {}\",\n            msg.sender_name,\n            truncate(\u0026content, 50)\n        );\n\n        let group_folder =\n            self.get_group_folder(\u0026msg.chat_jid)\n                .await\n                .ok_or_else(|| NuClawError::Telegram {\n                    message: format!(\"Group not found: {}\", msg.chat_jid),\n                })?;\n\n        let session_id = format!(\"telegram_{}\", msg.id);\n        let input = ContainerInput {\n            prompt: content,\n            session_id: Some(session_id.clone()),\n            group_folder,\n            chat_jid: msg.chat_jid.clone(),\n            is_main: true,\n            is_scheduled_task: false,\n        };\n\n        let result = timeout(Duration::from_secs(300), run_container(input)).await;\n\n        match result {\n            Ok(Ok(output)) =\u003e {\n                if let Some(response) = output.result {\n                    let chat_id = self.extract_chat_id(\u0026msg.chat_jid)?;\n                    self.send_message(\u0026chat_id.to_string(), \u0026response).await?;\n                    return Ok(Some(response));\n                }\n            }\n            Ok(Err(e)) =\u003e {\n                error!(\"Container error: {}\", e);\n                let chat_id = self.extract_chat_id(\u0026msg.chat_jid)?;\n                self.send_message(\u0026chat_id.to_string(), \u0026format!(\"Error: {}\", e))\n                    .await?;\n            }\n            Err(_) =\u003e {\n                error!(\"Container timeout\");\n                let chat_id = self.extract_chat_id(\u0026msg.chat_jid)?;\n                self.send_message(\u0026chat_id.to_string(), \"Sorry, the request timed out.\")\n                    .await?;\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Send a message to a chat\n    pub async fn send_message(\u0026self, chat_id: \u0026str, text: \u0026str) -\u003e Result\u003c()\u003e {\n        let cid: i64 = chat_id.parse().map_err(|_| NuClawError::Telegram {\n            message: format!(\"Invalid chat_id: {}\", chat_id),\n        })?;\n\n        let chunks = self.chunk_text(text);\n\n        for chunk in chunks {\n            let payload = serde_json::json!({\n                \"chat_id\": cid,\n                \"text\": chunk,\n                \"parse_mode\": \"HTML\"\n            });\n\n            let response = reqwest::Client::new()\n                .post(\u0026format!(\"{}/sendMessage\", self.api_url))\n                .json(\u0026payload)\n                .timeout(Duration::from_secs(30))\n                .send()\n                .await\n                .map_err(|e| NuClawError::Telegram {\n                    message: format!(\"Failed to send message: {}\", e),\n                })?;\n\n            if !response.status().is_success() {\n                let error = response.text().await.unwrap_or_default();\n                return Err(NuClawError::Telegram {\n                    message: format!(\"Failed to send message: {}\", error),\n                });\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Chunk text into smaller pieces\n    fn chunk_text(\u0026self, text: \u0026str) -\u003e Vec\u003cString\u003e {\n        if text.len() \u003c= self.text_chunk_limit {\n            return vec![text.to_string()];\n        }\n\n        let mut chunks = Vec::new();\n        let mut current = String::new();\n\n        for paragraph in text.split(\"\\n\\n\") {\n            if current.len() + paragraph.len() + 2 \u003e self.text_chunk_limit {\n                if !current.is_empty() {\n                    chunks.push(current);\n                }\n                current = paragraph.to_string();\n            } else {\n                if !current.is_empty() {\n                    current.push_str(\"\\n\\n\");\n                }\n                current.push_str(paragraph);\n            }\n        }\n\n        if !current.is_empty() {\n            chunks.push(current);\n        }\n\n        chunks\n    }\n\n    /// Check DM policy\n    async fn check_dm_policy(\u0026self, _user_id: \u0026str) -\u003e Result\u003cbool\u003e {\n        match self.dm_policy {\n            DMPolicy::Disabled =\u003e Ok(false),\n            DMPolicy::Open =\u003e Ok(true),\n            DMPolicy::Allowlist | DMPolicy::Pairing =\u003e {\n                // Allow for now (can be extended with database check)\n                Ok(true)\n            }\n        }\n    }\n\n    /// Check if group is allowed\n    async fn is_allowed_group(\u0026self, chat_jid: \u0026str) -\u003e Result\u003cbool\u003e {\n        match self.group_policy {\n            GroupPolicy::Disabled =\u003e Ok(false),\n            GroupPolicy::Open =\u003e Ok(true),\n            GroupPolicy::Allowlist =\u003e {\n                // Extract chat_id from jid\n                if let Some(chat_id) = chat_jid.strip_prefix(\"telegram:group:\") {\n                    let result = self\n                        .allowed_groups\n                        .iter()\n                        .any(|g| g == chat_id || g == \u0026format!(\"-{}\", chat_id));\n                    Ok(result)\n                } else {\n                    Ok(false)\n                }\n            }\n        }\n    }\n\n    /// Get group folder for a chat JID\n    async fn get_group_folder(\u0026self, jid: \u0026str) -\u003e Option\u003cString\u003e {\n        self.registered_groups.get(jid).map(|g| g.folder.clone())\n    }\n\n    /// Extract chat ID from jid\n    fn extract_chat_id(\u0026self, jid: \u0026str) -\u003e Result\u003cString\u003e {\n        jid.strip_prefix(\"telegram:group:\")\n            .map(|s| s.to_string())\n            .ok_or_else(|| NuClawError::Telegram {\n                message: format!(\"Invalid telegram jid format: {}\", jid),\n            })\n    }\n\n    /// Check if message is duplicate\n    async fn is_duplicate_message(\u0026self, msg: \u0026NewMessage) -\u003e bool {\n        let last_timestamp = \u0026self.router_state.last_timestamp;\n        let last_agent = self.router_state.last_agent_timestamp.get(\u0026msg.chat_jid);\n\n        if last_timestamp == \u0026msg.timestamp {\n            return true;\n        }\n\n        if let Some(agent_ts) = last_agent {\n            if agent_ts == \u0026msg.timestamp {\n                return true;\n            }\n        }\n\n        false\n    }\n\n    /// Update router state after processing\n    async fn update_router_state(\u0026mut self, msg: \u0026NewMessage) {\n        self.router_state.last_timestamp = msg.timestamp.clone();\n        self.router_state\n            .last_agent_timestamp\n            .insert(msg.chat_jid.clone(), msg.timestamp.clone());\n\n        let state_path = data_dir().join(\"router_state.json\");\n        let _ = save_json(\u0026state_path, \u0026self.router_state);\n    }\n\n    /// Store message in database\n    async fn store_message(\u0026self, msg: \u0026NewMessage) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"INSERT OR REPLACE INTO messages (id, chat_jid, sender, sender_name, content, timestamp, is_from_me)\n             VALUES (?, ?, ?, ?, ?, ?, ?)\",\n            rusqlite::params![\n                msg.id,\n                msg.chat_jid,\n                msg.sender,\n                msg.sender_name,\n                msg.content,\n                msg.timestamp,\n                if msg.id.starts_with(\"self\") { 1 } else { 0 },\n            ],\n        ).map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to store message: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Extract trigger and content from message\n    async fn extract_trigger(\u0026self, content: \u0026str) -\u003e Option\u003c(String, String)\u003e {\n        let trigger_pattern = format!(\"@{}\", self.assistant_name);\n\n        if let Some(idx) = content.find(\u0026trigger_pattern) {\n            let after = \u0026content[idx + trigger_pattern.len()..];\n            let c = after.trim().to_string();\n            return Some((trigger_pattern, c));\n        }\n\n        None\n    }\n}\n\n// Webhook handler\nasync fn handle_telegram_webhook(\n    client: axum::extract::State\u003cArc\u003cMutex\u003cTelegramClient\u003e\u003e\u003e,\n    Json(update): Json\u003cTelegramUpdate\u003e,\n) -\u003e \u0026'static str {\n    let mut client = client.lock().await;\n    if let Err(e) = client.handle_update(\u0026update).await {\n        error!(\"Failed to handle telegram update: {}\", e);\n    }\n    \"OK\"\n}\n\nasync fn health_check() -\u003e \u0026'static str {\n    \"OK\"\n}\n\n// Helper functions\n\n/// Load router state from file\npub fn load_router_state() -\u003e RouterState {\n    let state_path = data_dir().join(\"router_state.json\");\n    load_json(\n        \u0026state_path,\n        RouterState {\n            last_timestamp: String::new(),\n            last_agent_timestamp: HashMap::new(),\n        },\n    )\n}\n\n/// Load registered groups from file\npub fn load_registered_groups() -\u003e HashMap\u003cString, RegisteredGroup\u003e {\n    let path = data_dir().join(\"registered_groups.json\");\n    load_json(\u0026path, HashMap::new())\n}\n\n/// Helper to truncate strings\nfn truncate(s: \u0026str, max_len: usize) -\u003e String {\n    if s.len() \u003c= max_len {\n        s.to_string()\n    } else {\n        format!(\"{}...\", \u0026s[..max_len - 3])\n    }\n}\n\n// Trait implementations for enums\n\nimpl DMPolicy {\n    pub fn from_str(s: \u0026str) -\u003e Self {\n        match s.to_lowercase().as_str() {\n            \"pairing\" =\u003e DMPolicy::Pairing,\n            \"allowlist\" =\u003e DMPolicy::Allowlist,\n            \"open\" =\u003e DMPolicy::Open,\n            \"disabled\" =\u003e DMPolicy::Disabled,\n            _ =\u003e DMPolicy::Pairing,\n        }\n    }\n}\n\nimpl GroupPolicy {\n    pub fn from_str(s: \u0026str) -\u003e Self {\n        match s.to_lowercase().as_str() {\n            \"open\" =\u003e GroupPolicy::Open,\n            \"allowlist\" =\u003e GroupPolicy::Allowlist,\n            \"disabled\" =\u003e GroupPolicy::Disabled,\n            _ =\u003e GroupPolicy::Allowlist,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_telegram_update() {\n        let json = r#\"{\n            \"update_id\": 123,\n            \"message\": {\n                \"message_id\": 456,\n                \"from\": {\"id\": 789, \"is_bot\": false, \"first_name\": \"Test\"},\n                \"chat\": {\"id\": -100123, \"type\": \"supergroup\", \"title\": \"Test Group\"},\n                \"date\": 1234567890,\n                \"text\": \"@Andy hello\"\n            }\n        }\"#;\n\n        let update: TelegramUpdate = serde_json::from_str(json).unwrap();\n        assert_eq!(update.update_id, 123);\n        assert!(update.message.is_some());\n    }\n\n    #[test]\n    fn test_extract_trigger_telegram() {\n        let client = TelegramClient {\n            api_url: \"https://api.telegram.org/bottest\".to_string(),\n            webhook_path: \"webhook\".to_string(),\n            dm_policy: DMPolicy::Pairing,\n            group_policy: GroupPolicy::Allowlist,\n            text_chunk_limit: 4000,\n            allowed_groups: vec![],\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let result = std::thread::spawn(move || {\n            let rt = tokio::runtime::Runtime::new().unwrap();\n            rt.block_on(client.extract_trigger(\"@Andy hello world\"))\n        })\n        .join()\n        .unwrap();\n\n        assert!(result.is_some());\n        let (trigger, content) = result.unwrap();\n        assert_eq!(trigger, \"@Andy\");\n        assert_eq!(content, \"hello world\");\n    }\n\n    #[test]\n    fn test_dm_policy_from_str() {\n        assert_eq!(DMPolicy::from_str(\"pairing\"), DMPolicy::Pairing);\n        assert_eq!(DMPolicy::from_str(\"allowlist\"), DMPolicy::Allowlist);\n        assert_eq!(DMPolicy::from_str(\"open\"), DMPolicy::Open);\n        assert_eq!(DMPolicy::from_str(\"disabled\"), DMPolicy::Disabled);\n        assert_eq!(DMPolicy::from_str(\"unknown\"), DMPolicy::Pairing);\n    }\n\n    #[test]\n    fn test_group_policy_from_str() {\n        assert_eq!(GroupPolicy::from_str(\"open\"), GroupPolicy::Open);\n        assert_eq!(GroupPolicy::from_str(\"allowlist\"), GroupPolicy::Allowlist);\n        assert_eq!(GroupPolicy::from_str(\"disabled\"), GroupPolicy::Disabled);\n        assert_eq!(GroupPolicy::from_str(\"unknown\"), GroupPolicy::Allowlist);\n    }\n\n    #[test]\n    fn test_text_chunking_short() {\n        let client = TelegramClient {\n            api_url: \"https://api.telegram.org/bottest\".to_string(),\n            webhook_path: \"webhook\".to_string(),\n            dm_policy: DMPolicy::Open,\n            group_policy: GroupPolicy::Open,\n            text_chunk_limit: 4000,\n            allowed_groups: vec![],\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let chunks = client.chunk_text(\"short text\");\n        assert_eq!(chunks.len(), 1);\n        assert_eq!(chunks[0], \"short text\");\n    }\n\n    #[test]\n    fn test_text_chunking_long() {\n        let client = TelegramClient {\n            api_url: \"https://api.telegram.org/bottest\".to_string(),\n            webhook_path: \"webhook\".to_string(),\n            dm_policy: DMPolicy::Open,\n            group_policy: GroupPolicy::Open,\n            text_chunk_limit: 50,\n            allowed_groups: vec![],\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        // Create a text longer than 50 characters with multiple paragraphs\n        let long_text = \"This is paragraph one that is longer than fifty characters.\\n\\nThis is paragraph two that is also quite long and should create multiple chunks.\\n\\nThis is the third paragraph to ensure we have enough content.\";\n        let chunks = client.chunk_text(long_text);\n        assert!(\n            chunks.len() \u003e 1,\n            \"Expected multiple chunks but got {:?}\",\n            chunks\n        );\n    }\n}\n","traces":[{"line":113,"address":[12359440,12361409,12361529],"length":1,"stats":{"Line":0}},{"line":114,"address":[14075590,14075678,14075797],"length":1,"stats":{"Line":0}},{"line":115,"address":[14292402],"length":1,"stats":{"Line":0}},{"line":118,"address":[14075957,14075889],"length":1,"stats":{"Line":0}},{"line":120,"address":[12543677],"length":1,"stats":{"Line":0}},{"line":121,"address":[14076057],"length":1,"stats":{"Line":0}},{"line":122,"address":[14076089],"length":1,"stats":{"Line":0}},{"line":123,"address":[12176032,12176048],"length":1,"stats":{"Line":0}},{"line":124,"address":[12360255],"length":1,"stats":{"Line":0}},{"line":125,"address":[12542958,12542886],"length":1,"stats":{"Line":0}},{"line":127,"address":[12360414],"length":1,"stats":{"Line":0}},{"line":128,"address":[12360270],"length":1,"stats":{"Line":0}},{"line":130,"address":[12360429],"length":1,"stats":{"Line":0}},{"line":131,"address":[14076588],"length":1,"stats":{"Line":0}},{"line":132,"address":[12543295],"length":1,"stats":{"Line":0}},{"line":133,"address":[14076654],"length":1,"stats":{"Line":0}},{"line":134,"address":[12360546],"length":1,"stats":{"Line":0}},{"line":135,"address":[12360577],"length":1,"stats":{"Line":0}},{"line":136,"address":[12543416],"length":1,"stats":{"Line":0}},{"line":137,"address":[14076759],"length":1,"stats":{"Line":0}},{"line":138,"address":[12360658],"length":1,"stats":{"Line":0}},{"line":139,"address":[14076849],"length":1,"stats":{"Line":0}},{"line":140,"address":[12543562],"length":1,"stats":{"Line":0}},{"line":141,"address":[12543613],"length":1,"stats":{"Line":0}},{"line":146,"address":[12344896,12347868,12345105,12345054,12349573,12344958],"length":1,"stats":{"Line":0}},{"line":147,"address":[14292770,14293305,14292898],"length":1,"stats":{"Line":0}},{"line":150,"address":[12346356,12345520],"length":1,"stats":{"Line":0}},{"line":152,"address":[14294131],"length":1,"stats":{"Line":0}},{"line":153,"address":[12345084,12346577,12346451,12347902],"length":1,"stats":{"Line":0}},{"line":154,"address":[12348230,12348652],"length":1,"stats":{"Line":0}},{"line":156,"address":[12178454,12179052,12178662],"length":1,"stats":{"Line":0}},{"line":159,"address":[14294804],"length":1,"stats":{"Line":0}},{"line":163,"address":[12358770,12358752],"length":1,"stats":{"Line":0}},{"line":164,"address":[12129088,12129248],"length":1,"stats":{"Line":0}},{"line":165,"address":[12130271,12129495,12129395,12130536,12130600,12130667],"length":1,"stats":{"Line":0}},{"line":166,"address":[14244334,14244259],"length":1,"stats":{"Line":0}},{"line":167,"address":[12129718,12129807,12130303,12129877],"length":1,"stats":{"Line":0}},{"line":169,"address":[12420783],"length":1,"stats":{"Line":0}},{"line":170,"address":[12299193,12299008,12299257,12297593,12299251],"length":1,"stats":{"Line":0}},{"line":171,"address":[12299035,12299103],"length":1,"stats":{"Line":0}},{"line":174,"address":[12297962],"length":1,"stats":{"Line":0}},{"line":175,"address":[14246594],"length":1,"stats":{"Line":0}},{"line":176,"address":[12298660],"length":1,"stats":{"Line":0}},{"line":178,"address":[12057730],"length":1,"stats":{"Line":0}},{"line":183,"address":[14245783],"length":1,"stats":{"Line":0}},{"line":187,"address":[12359344,12359361],"length":1,"stats":{"Line":0}},{"line":188,"address":[12167626,12168023,12167969,12167831],"length":1,"stats":{"Line":0}},{"line":189,"address":[12173648,12167793,12173632],"length":1,"stats":{"Line":0}},{"line":191,"address":[12341574,12335713,12341520],"length":1,"stats":{"Line":0}},{"line":192,"address":[12341541],"length":1,"stats":{"Line":0}},{"line":195,"address":[14283692],"length":1,"stats":{"Line":0}},{"line":196,"address":[12168385,12167690,12168300,12168563],"length":1,"stats":{"Line":0}},{"line":198,"address":[12337208,12337428,12337266,12336789,12337350,12336875,12337608,12337535],"length":1,"stats":{"Line":0}},{"line":199,"address":[12337100,12339287,12339248,12337274,12336808,12336883,12337224,12339222],"length":1,"stats":{"Line":0}},{"line":200,"address":[12339230,12336816,12337436,12337290,12337366,12339295,12337309,12339174],"length":1,"stats":{"Line":0}},{"line":201,"address":[14286982,14285196,14286889,14285355,14287047,14285222,14285309,14286947,14284568],"length":1,"stats":{"Line":0}},{"line":203,"address":[14285437,14285882],"length":1,"stats":{"Line":0}},{"line":205,"address":[12339673,12339086,12338102,12339586,12340057,12339478],"length":1,"stats":{"Line":0}},{"line":207,"address":[14286863,14286795,14287270,14283231,14287065],"length":1,"stats":{"Line":0}},{"line":208,"address":[14288971,14287296,14288977,14288672,14288913],"length":1,"stats":{"Line":0}},{"line":209,"address":[12173151,12173070],"length":1,"stats":{"Line":0}},{"line":212,"address":[14287565,14287756,14288074,14288161,14288377,14288011],"length":1,"stats":{"Line":0}},{"line":213,"address":[12172154,12172342,12167732,12172035,12172092],"length":1,"stats":{"Line":0}},{"line":214,"address":[12341248,12341433,12340311,12341491,12341497],"length":1,"stats":{"Line":0}},{"line":215,"address":[14289019,14289087],"length":1,"stats":{"Line":0}},{"line":218,"address":[14288206],"length":1,"stats":{"Line":0}},{"line":222,"address":[14075005,14074992],"length":1,"stats":{"Line":0}},{"line":223,"address":[12304343],"length":1,"stats":{"Line":0}},{"line":224,"address":[12304457],"length":1,"stats":{"Line":0}},{"line":226,"address":[12137433,12137889,12137351],"length":1,"stats":{"Line":0}},{"line":227,"address":[14252683],"length":1,"stats":{"Line":0}},{"line":231,"address":[12304465,12304407,12306576,12305845,12305978],"length":1,"stats":{"Line":0}},{"line":232,"address":[12422258],"length":1,"stats":{"Line":0}},{"line":236,"address":[12542253,12542240],"length":1,"stats":{"Line":0}},{"line":237,"address":[14289924],"length":1,"stats":{"Line":0}},{"line":240,"address":[12343728,12343712,12342279],"length":1,"stats":{"Line":0}},{"line":242,"address":[14290073],"length":1,"stats":{"Line":0}},{"line":245,"address":[12342403,12343808],"length":1,"stats":{"Line":0}},{"line":246,"address":[12175767],"length":1,"stats":{"Line":0}},{"line":247,"address":[12343891],"length":1,"stats":{"Line":0}},{"line":249,"address":[14291652],"length":1,"stats":{"Line":0}},{"line":252,"address":[14291420,14290166,14291408],"length":1,"stats":{"Line":0}},{"line":254,"address":[12174458,12174538],"length":1,"stats":{"Line":0}},{"line":256,"address":[12343772,12343760,12342734,12342659],"length":1,"stats":{"Line":0}},{"line":258,"address":[12343074],"length":1,"stats":{"Line":0}},{"line":259,"address":[12342781],"length":1,"stats":{"Line":0}},{"line":260,"address":[12174841],"length":1,"stats":{"Line":0}},{"line":261,"address":[12342893],"length":1,"stats":{"Line":0}},{"line":262,"address":[12342927],"length":1,"stats":{"Line":0}},{"line":263,"address":[14290708],"length":1,"stats":{"Line":0}},{"line":264,"address":[12343004],"length":1,"stats":{"Line":0}},{"line":269,"address":[12309091,12308848,12309218,12309134,12309239,12309281,12311408,12309176,12309302,12309197,12309155,12309323,12308955,12309508,12309352,12309260],"length":1,"stats":{"Line":0}},{"line":270,"address":[14257286,14256805,14257138,14256865],"length":1,"stats":{"Line":0}},{"line":271,"address":[14257545,14257697,14258153],"length":1,"stats":{"Line":0}},{"line":272,"address":[12310319],"length":1,"stats":{"Line":0}},{"line":275,"address":[14256886,14257573,14257518,14259166],"length":1,"stats":{"Line":0}},{"line":276,"address":[12144420,12144283,12141879,12145195],"length":1,"stats":{"Line":0}},{"line":279,"address":[14259850,14260046],"length":1,"stats":{"Line":0}},{"line":280,"address":[12145208,12145067,12141900,12144879,12147117],"length":1,"stats":{"Line":0}},{"line":281,"address":[12313436,12312945],"length":1,"stats":{"Line":0}},{"line":282,"address":[14261090],"length":1,"stats":{"Line":0}},{"line":287,"address":[14354726],"length":1,"stats":{"Line":0}},{"line":288,"address":[12315444,12314899,12314988],"length":1,"stats":{"Line":0}},{"line":289,"address":[12315354],"length":1,"stats":{"Line":0}},{"line":292,"address":[12141942,12148961,12149688,12149102,12147503],"length":1,"stats":{"Line":0}},{"line":293,"address":[12149540,12149410],"length":1,"stats":{"Line":0}},{"line":294,"address":[12316917],"length":1,"stats":{"Line":0}},{"line":297,"address":[14266572,14265574,14265064,14266126,14265147],"length":1,"stats":{"Line":0}},{"line":303,"address":[14267467,14268747,14266967,14267554,14265521,14267021,14267378],"length":1,"stats":{"Line":0}},{"line":305,"address":[12060528],"length":1,"stats":{"Line":0}},{"line":306,"address":[12162320,12152196,12162464],"length":1,"stats":{"Line":0}},{"line":307,"address":[14278441],"length":1,"stats":{"Line":0}},{"line":310,"address":[12320005,12319926],"length":1,"stats":{"Line":0}},{"line":313,"address":[12152724,12152646],"length":1,"stats":{"Line":0}},{"line":315,"address":[12152795],"length":1,"stats":{"Line":0}},{"line":320,"address":[14268282,14268397,14257012,14268790],"length":1,"stats":{"Line":0}},{"line":322,"address":[12153879,12153950],"length":1,"stats":{"Line":0}},{"line":323,"address":[14269331],"length":1,"stats":{"Line":0}},{"line":324,"address":[12321615],"length":1,"stats":{"Line":0}},{"line":325,"address":[14270198,14269582,14269438],"length":1,"stats":{"Line":0}},{"line":326,"address":[14269894,14269805,14269932,14274598,14275163,14257033],"length":1,"stats":{"Line":0}},{"line":327,"address":[12159554],"length":1,"stats":{"Line":0}},{"line":330,"address":[12321526],"length":1,"stats":{"Line":0}},{"line":331,"address":[14269292,14271055,14270628],"length":1,"stats":{"Line":0}},{"line":332,"address":[14272814,14271002,14271998],"length":1,"stats":{"Line":0}},{"line":333,"address":[12157400,12156885,12157088,12160416,12160349,12160287,12157362,12156970],"length":1,"stats":{"Line":0}},{"line":334,"address":[12060591,12061651,12061711],"length":1,"stats":{"Line":0}},{"line":337,"address":[12325535,12321447,12325108],"length":1,"stats":{"Line":0}},{"line":338,"address":[12158662,12157866,12159147],"length":1,"stats":{"Line":0}},{"line":339,"address":[12328536,12326737,12326670,12326497,12326583,12328486,12328623],"length":1,"stats":{"Line":0}},{"line":340,"address":[12424905,12423596],"length":1,"stats":{"Line":0}},{"line":344,"address":[12322707],"length":1,"stats":{"Line":0}},{"line":348,"address":[12299342,12299280,12299567,12300067,12299596,12302917,12299524],"length":1,"stats":{"Line":0}},{"line":349,"address":[12132586,12136880,12132903,12132696,12137024,12132441],"length":1,"stats":{"Line":0}},{"line":350,"address":[12304049],"length":1,"stats":{"Line":0}},{"line":353,"address":[14247589],"length":1,"stats":{"Line":0}},{"line":355,"address":[14248997,14247612,14247702],"length":1,"stats":{"Line":0}},{"line":356,"address":[14250696,14249787,14249077,14249232,14249120,14249718,14249158,14249460,14249534],"length":1,"stats":{"Line":0}},{"line":362,"address":[12302876,12302755,12300315,12300508,12302260,12300421,12302340],"length":1,"stats":{"Line":0}},{"line":363,"address":[12302424,12302358],"length":1,"stats":{"Line":0}},{"line":364,"address":[12302679,12302613],"length":1,"stats":{"Line":0}},{"line":365,"address":[12302644,12302389,12302692,12302287,12302570,12302708,12302763,12302895],"length":1,"stats":{"Line":0}},{"line":367,"address":[12302837,12300101,12302890,12299554,12300135,12300325],"length":1,"stats":{"Line":0}},{"line":368,"address":[14248138,14251488,14251737,14251731,14251673],"length":1,"stats":{"Line":0}},{"line":369,"address":[12303771,12303839],"length":1,"stats":{"Line":0}},{"line":372,"address":[14248529],"length":1,"stats":{"Line":0}},{"line":373,"address":[12421288],"length":1,"stats":{"Line":0}},{"line":374,"address":[14251312],"length":1,"stats":{"Line":0}},{"line":375,"address":[12303468,12303397],"length":1,"stats":{"Line":0}},{"line":380,"address":[14249103],"length":1,"stats":{"Line":0}},{"line":384,"address":[12540080,12541352,12541358],"length":1,"stats":{"Line":1}},{"line":385,"address":[14073432],"length":1,"stats":{"Line":1}},{"line":386,"address":[12541398,12540237],"length":1,"stats":{"Line":1}},{"line":389,"address":[12540187],"length":1,"stats":{"Line":1}},{"line":390,"address":[12357372],"length":1,"stats":{"Line":1}},{"line":392,"address":[14073691,14073613],"length":1,"stats":{"Line":2}},{"line":393,"address":[12357752,12358387,12357985],"length":1,"stats":{"Line":3}},{"line":394,"address":[12358133,12358217],"length":1,"stats":{"Line":2}},{"line":395,"address":[12541155,12541059],"length":1,"stats":{"Line":2}},{"line":397,"address":[12358392,12358321,12358300,12358411],"length":1,"stats":{"Line":3}},{"line":399,"address":[12540950,12540984],"length":1,"stats":{"Line":0}},{"line":400,"address":[12541042,12540990],"length":1,"stats":{"Line":0}},{"line":402,"address":[12358199,12358208],"length":1,"stats":{"Line":0}},{"line":406,"address":[12540611],"length":1,"stats":{"Line":1}},{"line":407,"address":[14074051,14073924],"length":1,"stats":{"Line":2}},{"line":410,"address":[14073996],"length":1,"stats":{"Line":1}},{"line":414,"address":[12331213,12331406,12331184],"length":1,"stats":{"Line":0}},{"line":415,"address":[12163554],"length":1,"stats":{"Line":0}},{"line":416,"address":[12331333],"length":1,"stats":{"Line":0}},{"line":417,"address":[12163605],"length":1,"stats":{"Line":0}},{"line":420,"address":[14279045],"length":1,"stats":{"Line":0}},{"line":426,"address":[12359232,12359250],"length":1,"stats":{"Line":0}},{"line":427,"address":[12165306],"length":1,"stats":{"Line":0}},{"line":428,"address":[12165430],"length":1,"stats":{"Line":0}},{"line":429,"address":[14280850],"length":1,"stats":{"Line":0}},{"line":432,"address":[14281066,14281186,14281316,14280882],"length":1,"stats":{"Line":0}},{"line":433,"address":[12333539,12333397,12333488],"length":1,"stats":{"Line":0}},{"line":436,"address":[12165881,12165776,12165856],"length":1,"stats":{"Line":0}},{"line":437,"address":[12333551],"length":1,"stats":{"Line":0}},{"line":439,"address":[12333422],"length":1,"stats":{"Line":0}},{"line":446,"address":[12359202,12359184],"length":1,"stats":{"Line":0}},{"line":447,"address":[12332880,12332697,12332774,12332896],"length":1,"stats":{"Line":0}},{"line":451,"address":[12541856],"length":1,"stats":{"Line":0}},{"line":452,"address":[12541885],"length":1,"stats":{"Line":0}},{"line":453,"address":[14279168,14279190],"length":1,"stats":{"Line":0}},{"line":454,"address":[12541931],"length":1,"stats":{"Line":0}},{"line":455,"address":[12163737],"length":1,"stats":{"Line":0}},{"line":460,"address":[14075453,14075440],"length":1,"stats":{"Line":0}},{"line":461,"address":[14282654],"length":1,"stats":{"Line":0}},{"line":462,"address":[12167146,12167236],"length":1,"stats":{"Line":0}},{"line":464,"address":[12335021],"length":1,"stats":{"Line":0}},{"line":465,"address":[12167315],"length":1,"stats":{"Line":0}},{"line":468,"address":[14282851,14282809],"length":1,"stats":{"Line":0}},{"line":469,"address":[12335117,12335162],"length":1,"stats":{"Line":0}},{"line":470,"address":[14282912],"length":1,"stats":{"Line":0}},{"line":474,"address":[12167371],"length":1,"stats":{"Line":0}},{"line":478,"address":[12333964,12334086,12334792,12334059,12333936,12334764],"length":1,"stats":{"Line":0}},{"line":479,"address":[12166390,12166279,12166370],"length":1,"stats":{"Line":0}},{"line":480,"address":[12166469,12166615],"length":1,"stats":{"Line":0}},{"line":482,"address":[12166478,12166501,12166644,12166998,12166572],"length":1,"stats":{"Line":0}},{"line":484,"address":[12166683],"length":1,"stats":{"Line":0}},{"line":485,"address":[14282384],"length":1,"stats":{"Line":0}},{"line":489,"address":[12307394,12308384,12307232,12307273,12307367,12308392],"length":1,"stats":{"Line":0}},{"line":490,"address":[12308390,12307460,12307341,12307549],"length":1,"stats":{"Line":0}},{"line":493,"address":[12308828,12308778,12308704,12307433],"length":1,"stats":{"Line":0}},{"line":494,"address":[14256466],"length":1,"stats":{"Line":0}},{"line":497,"address":[14255951,14255792,14255410,14255864],"length":1,"stats":{"Line":0}},{"line":500,"address":[12140674,12140491],"length":1,"stats":{"Line":0}},{"line":507,"address":[12140551],"length":1,"stats":{"Line":0}},{"line":510,"address":[12141190,12141254],"length":1,"stats":{"Line":0}},{"line":513,"address":[12141001],"length":1,"stats":{"Line":0}},{"line":517,"address":[12359136,12359154],"length":1,"stats":{"Line":4}},{"line":518,"address":[14279625,14279525],"length":1,"stats":{"Line":2}},{"line":520,"address":[12331991,12332074],"length":1,"stats":{"Line":2}},{"line":521,"address":[12332195,12332133],"length":1,"stats":{"Line":2}},{"line":522,"address":[14280044],"length":1,"stats":{"Line":1}},{"line":523,"address":[14280090],"length":1,"stats":{"Line":1}},{"line":526,"address":[12164439],"length":1,"stats":{"Line":0}},{"line":531,"address":[14078544],"length":1,"stats":{"Line":0}},{"line":535,"address":[12351086,12351353,12351179,12351037],"length":1,"stats":{"Line":0}},{"line":536,"address":[12419257],"length":1,"stats":{"Line":0}},{"line":537,"address":[12184356,12184244,12184747],"length":1,"stats":{"Line":0}},{"line":542,"address":[14243660,14243618,14243600],"length":1,"stats":{"Line":0}},{"line":549,"address":[12544799,12544352,12544793],"length":1,"stats":{"Line":0}},{"line":550,"address":[12361617],"length":1,"stats":{"Line":0}},{"line":552,"address":[14077928],"length":1,"stats":{"Line":0}},{"line":553,"address":[12544674],"length":1,"stats":{"Line":0}},{"line":554,"address":[14077973],"length":1,"stats":{"Line":0}},{"line":555,"address":[12361852],"length":1,"stats":{"Line":0}},{"line":561,"address":[12362392,12362080,12362386],"length":1,"stats":{"Line":0}},{"line":562,"address":[12362097],"length":1,"stats":{"Line":0}},{"line":563,"address":[14078408],"length":1,"stats":{"Line":0}},{"line":567,"address":[12545584],"length":1,"stats":{"Line":0}},{"line":568,"address":[14079064],"length":1,"stats":{"Line":0}},{"line":569,"address":[12362994],"length":1,"stats":{"Line":0}},{"line":571,"address":[12362956,12363019],"length":1,"stats":{"Line":0}},{"line":578,"address":[12362839,12362496,12362833],"length":1,"stats":{"Line":1}},{"line":579,"address":[12362602,12362516],"length":1,"stats":{"Line":2}},{"line":580,"address":[14078746,14078812],"length":1,"stats":{"Line":2}},{"line":581,"address":[14078823,14078862,14078789],"length":1,"stats":{"Line":3}},{"line":582,"address":[14078912,14078839,14078873],"length":1,"stats":{"Line":3}},{"line":583,"address":[14078923,14078889,14078936],"length":1,"stats":{"Line":3}},{"line":584,"address":[14078929],"length":1,"stats":{"Line":1}},{"line":590,"address":[12357199,12356912,12357205],"length":1,"stats":{"Line":1}},{"line":591,"address":[12357018,12356932],"length":1,"stats":{"Line":2}},{"line":592,"address":[12357034,12357100],"length":1,"stats":{"Line":2}},{"line":593,"address":[12357150,12357077,12357111],"length":1,"stats":{"Line":3}},{"line":594,"address":[12357174,12357127,12357161],"length":1,"stats":{"Line":3}},{"line":595,"address":[12357167],"length":1,"stats":{"Line":1}}],"covered":32,"coverable":249},{"path":["/","root","code","nuclaw","src","types.rs"],"content":"//! Core types for NuClaw\n\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RegisteredGroup {\n    pub name: String,\n    pub folder: String,\n    pub trigger: String,\n    pub added_at: String,\n}\n\n#[derive(Debug, Clone, Default, Serialize, Deserialize)]\npub struct Session(HashMap\u003cString, String\u003e);\n\nimpl Session {\n    pub fn new() -\u003e Self {\n        Self(HashMap::new())\n    }\n\n    pub fn len(\u0026self) -\u003e usize {\n        self.0.len()\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ScheduledTask {\n    pub id: String,\n    pub group_folder: String,\n    pub chat_jid: String,\n    pub prompt: String,\n    pub schedule_type: String,\n    pub schedule_value: String,\n    pub context_mode: String,\n    pub next_run: Option\u003cString\u003e,\n    pub last_run: Option\u003cString\u003e,\n    pub last_result: Option\u003cString\u003e,\n    pub status: String,\n    pub created_at: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TaskRunLog {\n    pub task_id: String,\n    pub run_at: String,\n    pub duration_ms: i64,\n    pub status: String,\n    pub result: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct NewMessage {\n    pub id: String,\n    pub chat_jid: String,\n    pub sender: String,\n    pub sender_name: String,\n    pub content: String,\n    pub timestamp: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ChatInfo {\n    pub jid: String,\n    pub name: String,\n    pub last_message_time: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ContainerInput {\n    pub prompt: String,\n    pub session_id: Option\u003cString\u003e,\n    pub group_folder: String,\n    pub chat_jid: String,\n    pub is_main: bool,\n    pub is_scheduled_task: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ContainerOutput {\n    pub status: String,\n    pub result: Option\u003cString\u003e,\n    pub new_session_id: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct RouterState {\n    pub last_timestamp: String,\n    pub last_agent_timestamp: HashMap\u003cString, String\u003e,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_registered_group() {\n        let group = RegisteredGroup {\n            name: \"Test Group\".to_string(),\n            folder: \"test_group\".to_string(),\n            trigger: \"@Andy\".to_string(),\n            added_at: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(group.name, \"Test Group\");\n        assert_eq!(group.folder, \"test_group\");\n    }\n\n    #[test]\n    fn test_session() {\n        let mut session = Session::new();\n        session.0.insert(\"key1\".to_string(), \"value1\".to_string());\n        assert_eq!(session.len(), 1);\n    }\n\n    #[test]\n    fn test_scheduled_task() {\n        let task = ScheduledTask {\n            id: \"task_1\".to_string(),\n            group_folder: \"group_1\".to_string(),\n            chat_jid: \"chat_1\".to_string(),\n            prompt: \"test prompt\".to_string(),\n            schedule_type: \"cron\".to_string(),\n            schedule_value: \"0 0 9 * * *\".to_string(),\n            context_mode: \"isolated\".to_string(),\n            next_run: Some(\"2025-01-01T09:00:00Z\".to_string()),\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(task.schedule_type, \"cron\");\n        assert_eq!(task.status, \"active\");\n    }\n\n    #[test]\n    fn test_container_input() {\n        let input = ContainerInput {\n            prompt: \"test\".to_string(),\n            session_id: Some(\"sess_123\".to_string()),\n            group_folder: \"group_1\".to_string(),\n            chat_jid: \"chat_1\".to_string(),\n            is_main: true,\n            is_scheduled_task: false,\n        };\n        assert!(input.session_id.is_some());\n        assert!(input.is_main);\n    }\n\n    #[test]\n    fn test_container_output() {\n        let output = ContainerOutput {\n            status: \"success\".to_string(),\n            result: Some(\"result\".to_string()),\n            new_session_id: Some(\"new_sess\".to_string()),\n            error: None,\n        };\n        assert_eq!(output.status, \"success\");\n        assert!(output.result.is_some());\n        assert!(output.error.is_none());\n    }\n\n    #[test]\n    fn test_router_state() {\n        let mut state = RouterState::default();\n        state.last_timestamp = \"2025-01-01T00:00:00Z\".to_string();\n        state\n            .last_agent_timestamp\n            .insert(\"chat_1\".to_string(), \"2025-01-01T00:00:00Z\".to_string());\n        assert_eq!(state.last_agent_timestamp.len(), 1);\n    }\n\n    #[test]\n    fn test_new_message() {\n        let msg = NewMessage {\n            id: \"msg_1\".to_string(),\n            chat_jid: \"chat_1\".to_string(),\n            sender: \"user_1\".to_string(),\n            sender_name: \"Test User\".to_string(),\n            content: \"Hello\".to_string(),\n            timestamp: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(msg.content, \"Hello\");\n    }\n\n    #[test]\n    fn test_task_run_log() {\n        let log = TaskRunLog {\n            task_id: \"task_1\".to_string(),\n            run_at: \"2025-01-01T00:00:00Z\".to_string(),\n            duration_ms: 1000,\n            status: \"success\".to_string(),\n            result: Some(\"ok\".to_string()),\n            error: None,\n        };\n        assert_eq!(log.duration_ms, 1000);\n    }\n\n    #[test]\n    fn test_chat_info() {\n        let info = ChatInfo {\n            jid: \"chat_1\".to_string(),\n            name: \"Test Chat\".to_string(),\n            last_message_time: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(info.name, \"Test Chat\");\n    }\n}\n","traces":[{"line":18,"address":[12225344],"length":1,"stats":{"Line":1}},{"line":19,"address":[12225358],"length":1,"stats":{"Line":1}},{"line":22,"address":[12225328],"length":1,"stats":{"Line":1}},{"line":23,"address":[12225333],"length":1,"stats":{"Line":1}}],"covered":4,"coverable":4},{"path":["/","root","code","nuclaw","src","utils.rs"],"content":"//! Utilities for NuClaw\n\nuse serde::{Deserialize, Serialize};\nuse std::fs::{File, OpenOptions};\nuse std::io::{Read, Write};\nuse std::path::Path;\n\npub mod json {\n    use super::*;\n\n    pub fn load_json\u003cT\u003e(path: \u0026Path, default: T) -\u003e T\n    where\n        T: for\u003c'de\u003e Deserialize\u003c'de\u003e + Default,\n    {\n        if !path.exists() {\n            return default;\n        }\n\n        match File::open(path) {\n            Ok(mut file) =\u003e {\n                let mut contents = String::new();\n                if file.read_to_string(\u0026mut contents).is_ok() {\n                    serde_json::from_str(\u0026contents).unwrap_or(default)\n                } else {\n                    default\n                }\n            }\n            Err(_) =\u003e default,\n        }\n    }\n\n    pub fn save_json\u003cT\u003e(path: \u0026Path, data: \u0026T) -\u003e std::io::Result\u003c()\u003e\n    where\n        T: Serialize,\n    {\n        if let Some(parent) = path.parent() {\n            std::fs::create_dir_all(parent)?;\n        }\n\n        let json = serde_json::to_string_pretty(data)?;\n        let mut file = OpenOptions::new()\n            .write(true)\n            .create(true)\n            .truncate(true)\n            .open(path)?;\n        file.write_all(json.as_bytes())?;\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::json::{load_json, save_json};\n    use std::fs;\n    use std::path::PathBuf;\n    use tempfile::tempdir;\n\n    #[derive(Debug, Default, serde::Deserialize, serde::Serialize, Clone)]\n    struct TestData {\n        name: String,\n        value: i32,\n    }\n\n    fn test_dir() -\u003e PathBuf {\n        tempdir().unwrap().into_path()\n    }\n\n    fn cleanup(path: \u0026PathBuf) {\n        let _ = fs::remove_file(path);\n    }\n\n    #[test]\n    fn test_save_json() {\n        let dir = test_dir();\n        let path = dir.join(\"test.json\");\n\n        let data = TestData {\n            name: \"test\".to_string(),\n            value: 42,\n        };\n\n        let result = save_json(\u0026path, \u0026data);\n        assert!(result.is_ok());\n        assert!(path.exists());\n\n        cleanup(\u0026path);\n    }\n\n    #[test]\n    fn test_load_json_existing() {\n        let dir = test_dir();\n        let path = dir.join(\"test.json\");\n\n        let data = TestData {\n            name: \"test\".to_string(),\n            value: 42,\n        };\n        save_json(\u0026path, \u0026data).unwrap();\n\n        let loaded: TestData = load_json(\u0026path, TestData::default());\n        assert_eq!(loaded.name, \"test\");\n        assert_eq!(loaded.value, 42);\n\n        cleanup(\u0026path);\n    }\n\n    #[test]\n    fn test_load_json_nonexistent() {\n        let dir = test_dir();\n        let path = dir.join(\"nonexistent.json\");\n\n        let default = TestData {\n            name: \"default\".to_string(),\n            value: 0,\n        };\n\n        let loaded: TestData = load_json(\u0026path, default.clone());\n        assert_eq!(loaded.name, \"default\");\n        assert_eq!(loaded.value, 0);\n    }\n\n    #[test]\n    fn test_load_json_invalid() {\n        let dir = test_dir();\n        let path = dir.join(\"invalid.json\");\n\n        fs::write(\u0026path, \"not valid json\").unwrap();\n\n        let default = TestData {\n            name: \"default\".to_string(),\n            value: 0,\n        };\n\n        let loaded: TestData = load_json(\u0026path, default.clone());\n        assert_eq!(loaded.name, \"default\");\n        assert_eq!(loaded.value, 0);\n\n        cleanup(\u0026path);\n    }\n\n    #[test]\n    fn test_save_json_creates_parent() {\n        let dir = test_dir();\n        let path = dir.join(\"subdir\").join(\"nested.json\");\n\n        let data = TestData {\n            name: \"nested\".to_string(),\n            value: 100,\n        };\n\n        let result = save_json(\u0026path, \u0026data);\n        assert!(result.is_ok());\n        assert!(path.exists());\n\n        let _ = fs::remove_dir_all(dir);\n    }\n}\n","traces":[{"line":11,"address":[14162144,14162966,14162064,14161264,14162922,14162108],"length":1,"stats":{"Line":1}},{"line":15,"address":[12364360,12365240,12364288,12365168],"length":1,"stats":{"Line":2}},{"line":16,"address":[12365256,12364376],"length":1,"stats":{"Line":1}},{"line":19,"address":[14161446,14162355,14161475,14162326],"length":1,"stats":{"Line":2}},{"line":20,"address":[12365360,12364480],"length":1,"stats":{"Line":1}},{"line":21,"address":[14161533,14162413],"length":1,"stats":{"Line":1}},{"line":22,"address":[14162461,14161660,14161581,14162540],"length":1,"stats":{"Line":2}},{"line":23,"address":[12367765,12368588,12369452],"length":1,"stats":{"Line":1}},{"line":25,"address":[14161798,14162678],"length":1,"stats":{"Line":0}},{"line":28,"address":[14162377,14161497],"length":1,"stats":{"Line":0}},{"line":32,"address":[12366923,12366941,12365968],"length":1,"stats":{"Line":1}},{"line":36,"address":[12366014],"length":1,"stats":{"Line":1}},{"line":37,"address":[14163124,14163252],"length":1,"stats":{"Line":1}},{"line":40,"address":[12366137,12366256],"length":1,"stats":{"Line":1}},{"line":41,"address":[12366518,12366576,12366934,12366364],"length":1,"stats":{"Line":2}},{"line":45,"address":[12366499,12366560],"length":1,"stats":{"Line":1}},{"line":46,"address":[12366631,12366880,12366702],"length":1,"stats":{"Line":2}},{"line":47,"address":[12366829],"length":1,"stats":{"Line":1}}],"covered":16,"coverable":18},{"path":["/","root","code","nuclaw","src","whatsapp.rs"],"content":"//! WhatsApp Integration for NuClaw\n//!\n//! Provides WhatsApp connectivity via external WhatsApp MCP Server or HTTP API.\n\nuse crate::config::{assistant_name, data_dir, store_dir};\nuse crate::container_runner::run_container;\nuse crate::db::Database;\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, NewMessage, RegisteredGroup, RouterState};\nuse crate::utils::json::{load_json, save_json};\nuse std::collections::HashMap;\nuse tokio::time::{timeout, Duration};\nuse tracing::{debug, error, info};\n\n/// Default WhatsApp poll interval: 2 seconds\nconst DEFAULT_WHATSAPP_POLL_INTERVAL_MS: u64 = 2000;\n\n/// WhatsApp client state\npub struct WhatsAppClient {\n    /// Connection status\n    pub connected: bool,\n    /// Last QR code for authentication\n    pub last_qr: Option\u003cString\u003e,\n    /// Reference to registered groups\n    registered_groups: HashMap\u003cString, RegisteredGroup\u003e,\n    /// Router state for message deduplication\n    router_state: RouterState,\n    /// Database connection\n    db: Database,\n    /// Assistant name for trigger detection\n    assistant_name: String,\n}\n\nimpl WhatsAppClient {\n    /// Create a new WhatsApp client\n    pub fn new(db: Database) -\u003e Self {\n        Self {\n            connected: false,\n            last_qr: None,\n            registered_groups: load_registered_groups(),\n            router_state: load_router_state(),\n            db,\n            assistant_name: assistant_name(),\n        }\n    }\n\n    /// Connect to WhatsApp\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to WhatsApp...\");\n\n        // Check if we need authentication\n        if self.needs_authentication().await? {\n            info!(\"Authentication required, generating QR code...\");\n            self.request_qr_code().await?;\n        } else {\n            info!(\"Using cached authentication\");\n            self.connected = true;\n        }\n\n        Ok(())\n    }\n\n    /// Check if authentication is needed\n    async fn needs_authentication(\u0026self) -\u003e Result\u003cbool\u003e {\n        let creds_path = store_dir().join(\"auth\").join(\"creds.json\");\n\n        // If creds file exists and is valid, no auth needed\n        if creds_path.exists() {\n            if let Ok(metadata) = std::fs::metadata(\u0026creds_path) {\n                let modified = metadata\n                    .modified()\n                    .unwrap_or(std::time::SystemTime::UNIX_EPOCH);\n                let duration = modified.elapsed().unwrap_or(std::time::Duration::ZERO);\n                if duration.as_secs() \u003c 24 * 60 * 60 {\n                    return Ok(false);\n                }\n            }\n        }\n\n        Ok(true)\n    }\n\n    /// Request QR code for authentication\n    async fn request_qr_code(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let mcp_url = get_mcp_url()?;\n\n        let response = reqwest::Client::new()\n            .post(\u0026format!(\"{}/auth/qr\", mcp_url))\n            .timeout(Duration::from_secs(30))\n            .send()\n            .await\n            .map_err(|e| NuClawError::WhatsApp {\n                message: format!(\"Failed to request QR code: {}\", e),\n            })?;\n\n        if response.status() == 200 {\n            let qr_data: serde_json::Value =\n                response.json().await.map_err(|e| NuClawError::WhatsApp {\n                    message: format!(\"Failed to parse QR response: {}\", e),\n                })?;\n\n            if let Some(qr) = qr_data.get(\"qr\").and_then(|v| v.as_str()) {\n                self.last_qr = Some(qr.to_string());\n                info!(\"QR code received (display in terminal)\");\n                info!(\"Scan with WhatsApp to authenticate\");\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Start listening for messages\n    pub async fn start_message_listener(\u0026mut self) {\n        let mut interval =\n            tokio::time::interval(Duration::from_millis(DEFAULT_WHATSAPP_POLL_INTERVAL_MS));\n\n        info!(\"Starting message listener...\");\n\n        loop {\n            interval.tick().await;\n\n            if let Err(e) = self.poll_messages().await {\n                error!(\"Error polling messages: {}\", e);\n            }\n        }\n    }\n\n    /// Poll for new messages\n    async fn poll_messages(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let mcp_url = get_mcp_url()?;\n\n        let response = reqwest::Client::new()\n            .get(\u0026format!(\"{}/messages\", mcp_url))\n            .timeout(Duration::from_secs(30))\n            .send()\n            .await\n            .map_err(|e| NuClawError::WhatsApp {\n                message: format!(\"Failed to poll messages: {}\", e),\n            })?;\n\n        if response.status() == 200 {\n            let messages: Vec\u003cNewMessage\u003e =\n                response.json().await.map_err(|e| NuClawError::WhatsApp {\n                    message: format!(\"Failed to parse messages: {}\", e),\n                })?;\n\n            for msg in messages {\n                self.handle_message(\u0026msg).await?;\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Handle a single message\n    pub async fn handle_message(\u0026mut self, msg: \u0026NewMessage) -\u003e Result\u003cOption\u003cString\u003e\u003e {\n        if self.is_duplicate_message(msg).await {\n            debug!(\"Skipping duplicate message: {}\", msg.id);\n            return Ok(None);\n        }\n\n        self.update_router_state(msg).await;\n        self.store_message(msg).await?;\n\n        if !self.is_registered_group(\u0026msg.chat_jid).await {\n            debug!(\"Message from unregistered group: {}\", msg.chat_jid);\n            return Ok(None);\n        }\n\n        let (_, content) = match self.extract_trigger(\u0026msg.content).await {\n            Some((_, c)) =\u003e (String::new(), c),\n            None =\u003e return Ok(None),\n        };\n\n        info!(\n            \"Received message from {}: {}\",\n            msg.sender,\n            truncate(\u0026content, 50)\n        );\n\n        let group_folder =\n            self.get_group_folder(\u0026msg.chat_jid)\n                .await\n                .ok_or_else(|| NuClawError::WhatsApp {\n                    message: format!(\"Group not found: {}\", msg.chat_jid),\n                })?;\n\n        let session_id = format!(\"whatsapp_{}\", msg.id);\n        let input = ContainerInput {\n            prompt: content,\n            session_id: Some(session_id.clone()),\n            group_folder,\n            chat_jid: msg.chat_jid.clone(),\n            is_main: msg.chat_jid.ends_with(\"@s.whatsapp.net\"),\n            is_scheduled_task: false,\n        };\n\n        let result = timeout(Duration::from_secs(300), run_container(input)).await;\n\n        match result {\n            Ok(Ok(output)) =\u003e {\n                if let Some(response) = output.result {\n                    self.send_message(\u0026msg.chat_jid, \u0026response).await?;\n                    return Ok(Some(response));\n                }\n            }\n            Ok(Err(e)) =\u003e {\n                error!(\"Container error: {}\", e);\n                self.send_message(\u0026msg.chat_jid, \u0026format!(\"Error: {}\", e))\n                    .await?;\n            }\n            Err(_) =\u003e {\n                error!(\"Container timeout\");\n                self.send_message(\u0026msg.chat_jid, \"Sorry, the request timed out.\")\n                    .await?;\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Send a message\n    pub async fn send_message(\u0026self, jid: \u0026str, content: \u0026str) -\u003e Result\u003c()\u003e {\n        let mcp_url = get_mcp_url()?;\n\n        let payload = serde_json::json!({\n            \"jid\": jid,\n            \"message\": content,\n        });\n\n        let response = reqwest::Client::new()\n            .post(\u0026format!(\"{}/messages/send\", mcp_url))\n            .json(\u0026payload)\n            .timeout(Duration::from_secs(30))\n            .send()\n            .await\n            .map_err(|e| NuClawError::WhatsApp {\n                message: format!(\"Failed to send message: {}\", e),\n            })?;\n\n        if !response.status().is_success() {\n            return Err(NuClawError::WhatsApp {\n                message: format!(\"Failed to send message: status {}\", response.status()),\n            });\n        }\n\n        Ok(())\n    }\n\n    /// Check if message is duplicate\n    async fn is_duplicate_message(\u0026self, msg: \u0026NewMessage) -\u003e bool {\n        let last_timestamp = \u0026self.router_state.last_timestamp;\n        let last_agent = self.router_state.last_agent_timestamp.get(\u0026msg.chat_jid);\n\n        if last_timestamp == \u0026msg.timestamp {\n            return true;\n        }\n\n        if let Some(agent_ts) = last_agent {\n            if agent_ts == \u0026msg.timestamp {\n                return true;\n            }\n        }\n\n        false\n    }\n\n    /// Update router state after processing\n    async fn update_router_state(\u0026mut self, msg: \u0026NewMessage) {\n        self.router_state.last_timestamp = msg.timestamp.clone();\n        self.router_state\n            .last_agent_timestamp\n            .insert(msg.chat_jid.clone(), msg.timestamp.clone());\n\n        let state_path = data_dir().join(\"router_state.json\");\n        let _ = save_json(\u0026state_path, \u0026self.router_state);\n    }\n\n    /// Store message in database\n    async fn store_message(\u0026self, msg: \u0026NewMessage) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"INSERT OR REPLACE INTO messages (id, chat_jid, sender, sender_name, content, timestamp, is_from_me)\n             VALUES (?, ?, ?, ?, ?, ?, ?)\",\n            rusqlite::params![\n                msg.id,\n                msg.chat_jid,\n                msg.sender,\n                msg.sender_name,\n                msg.content,\n                msg.timestamp,\n                if msg.id.starts_with(\"self\") { 1 } else { 0 },\n            ],\n        ).map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to store message: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Check if a chat is a registered group\n    async fn is_registered_group(\u0026self, jid: \u0026str) -\u003e bool {\n        self.registered_groups.contains_key(jid)\n    }\n\n    /// Get group folder for a chat JID\n    async fn get_group_folder(\u0026self, jid: \u0026str) -\u003e Option\u003cString\u003e {\n        self.registered_groups.get(jid).map(|g| g.folder.clone())\n    }\n\n    /// Extract trigger and content from message\n    async fn extract_trigger(\u0026self, content: \u0026str) -\u003e Option\u003c(String, String)\u003e {\n        let trigger_pattern = format!(\"@{}\", self.assistant_name);\n\n        if let Some(idx) = content.find(\u0026trigger_pattern) {\n            let after = \u0026content[idx + trigger_pattern.len()..];\n            let c = after.trim().to_string();\n            return Some((trigger_pattern, c));\n        }\n\n        None\n    }\n}\n\n// Helper functions\n\n/// Get WhatsApp MCP URL from environment\nfn get_mcp_url() -\u003e Result\u003cString\u003e {\n    std::env::var(\"WHATSAPP_MCP_URL\").map_err(|_| NuClawError::Config {\n        message: \"WHATSAPP_MCP_URL not set\".to_string(),\n    })\n}\n\n/// Load router state from file\npub fn load_router_state() -\u003e RouterState {\n    let state_path = data_dir().join(\"router_state.json\");\n    load_json(\n        \u0026state_path,\n        RouterState {\n            last_timestamp: String::new(),\n            last_agent_timestamp: HashMap::new(),\n        },\n    )\n}\n\n/// Load registered groups from file\npub fn load_registered_groups() -\u003e HashMap\u003cString, RegisteredGroup\u003e {\n    let path = data_dir().join(\"registered_groups.json\");\n    load_json(\u0026path, HashMap::new())\n}\n\n/// Start the authentication flow\npub async fn start_auth_flow() {\n    let auth_path = store_dir().join(\"auth\");\n    std::fs::create_dir_all(\u0026auth_path).ok();\n    info!(\"Use WHATSAPP_MCP_URL to configure WhatsApp connection\");\n}\n\n/// Helper to truncate strings\nfn truncate(s: \u0026str, max_len: usize) -\u003e String {\n    if s.len() \u003c= max_len {\n        s.to_string()\n    } else {\n        format!(\"{}...\", \u0026s[..max_len - 3])\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_truncate_short() {\n        assert_eq!(truncate(\"hello\", 10), \"hello\");\n    }\n\n    #[test]\n    fn test_truncate_long() {\n        assert_eq!(truncate(\"hello world\", 8), \"hello...\");\n    }\n\n    #[test]\n    fn test_extract_trigger_with_at() {\n        let client = WhatsAppClient {\n            connected: false,\n            last_qr: None,\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let result = tokio::runtime::Runtime::new()\n            .unwrap()\n            .block_on(client.extract_trigger(\"@Andy hello world\"));\n\n        assert!(result.is_some());\n        let (trigger, content) = result.unwrap();\n        assert_eq!(trigger, \"@Andy\");\n        assert_eq!(content, \"hello world\");\n    }\n\n    #[test]\n    fn test_extract_trigger_without_at() {\n        let client = WhatsAppClient {\n            connected: false,\n            last_qr: None,\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let result = tokio::runtime::Runtime::new()\n            .unwrap()\n            .block_on(client.extract_trigger(\"hello world\"));\n\n        assert!(result.is_none());\n    }\n}\n","traces":[{"line":36,"address":[12940759,12940272,12940724],"length":1,"stats":{"Line":0}},{"line":40,"address":[12612522],"length":1,"stats":{"Line":0}},{"line":41,"address":[14871662],"length":1,"stats":{"Line":0}},{"line":43,"address":[12612672],"length":1,"stats":{"Line":0}},{"line":48,"address":[14872080,14872088],"length":1,"stats":{"Line":0}},{"line":49,"address":[12717709,12717302,12717156],"length":1,"stats":{"Line":0}},{"line":52,"address":[13037056,13033784,13034663,13032956,13032494,13033884,13036658],"length":1,"stats":{"Line":0}},{"line":53,"address":[12720242,12720649,12718996],"length":1,"stats":{"Line":0}},{"line":54,"address":[12721346,12721857,12720616,12721533,12717235],"length":1,"stats":{"Line":0}},{"line":56,"address":[14650248,14650314,14650711],"length":1,"stats":{"Line":0}},{"line":57,"address":[13034652],"length":1,"stats":{"Line":0}},{"line":60,"address":[12720218],"length":1,"stats":{"Line":0}},{"line":64,"address":[14642847,14642800,14642950,14642920,14644055,14644027],"length":1,"stats":{"Line":0}},{"line":65,"address":[12711621,12711717],"length":1,"stats":{"Line":0}},{"line":68,"address":[13027428],"length":1,"stats":{"Line":0}},{"line":69,"address":[14643551,14643426],"length":1,"stats":{"Line":0}},{"line":70,"address":[12712382],"length":1,"stats":{"Line":0}},{"line":72,"address":[13027718],"length":1,"stats":{"Line":0}},{"line":73,"address":[12712397],"length":1,"stats":{"Line":0}},{"line":74,"address":[13027845],"length":1,"stats":{"Line":0}},{"line":75,"address":[14643886],"length":1,"stats":{"Line":0}},{"line":80,"address":[12712104],"length":1,"stats":{"Line":0}},{"line":84,"address":[14634413,14634442,14634370,14634224,14634286,14635366,14635510],"length":1,"stats":{"Line":0}},{"line":85,"address":[14634481,14634351,14635425],"length":1,"stats":{"Line":0}},{"line":87,"address":[14635770,14634759,14634669,14635302,14635718,14635857,14635109],"length":1,"stats":{"Line":0}},{"line":88,"address":[14634843,14634777,14635021],"length":1,"stats":{"Line":0}},{"line":89,"address":[14635117,14635344,14635056,14634986,14634808,14635034,14634700],"length":1,"stats":{"Line":0}},{"line":91,"address":[12064111],"length":1,"stats":{"Line":0}},{"line":92,"address":[14640393,14640329,14640144,14635743,14640387],"length":1,"stats":{"Line":0}},{"line":93,"address":[14640171,14640239],"length":1,"stats":{"Line":0}},{"line":96,"address":[13020322],"length":1,"stats":{"Line":0}},{"line":97,"address":[12427186],"length":1,"stats":{"Line":0}},{"line":99,"address":[14640763,14640831],"length":1,"stats":{"Line":0}},{"line":102,"address":[12708521,12705677,12708512,12705768],"length":1,"stats":{"Line":0}},{"line":103,"address":[12705890,12706000,12705939],"length":1,"stats":{"Line":0}},{"line":104,"address":[13021540,13021979],"length":1,"stats":{"Line":0}},{"line":105,"address":[12707349,12706517],"length":1,"stats":{"Line":0}},{"line":109,"address":[13020407],"length":1,"stats":{"Line":0}},{"line":113,"address":[12712816,12712862,12713003,12712974,12712942,12714364,12716004],"length":1,"stats":{"Line":0}},{"line":114,"address":[12713065,12712920],"length":1,"stats":{"Line":0}},{"line":117,"address":[13028921,13028431,13028514],"length":1,"stats":{"Line":0}},{"line":120,"address":[14645665,14644241,14647374,14647290,14644824],"length":1,"stats":{"Line":0}},{"line":122,"address":[14647602,14644262,14645699,14645730],"length":1,"stats":{"Line":0}},{"line":123,"address":[14646463,14646068,14645989],"length":1,"stats":{"Line":0}},{"line":129,"address":[12612080,12612088],"length":1,"stats":{"Line":0}},{"line":130,"address":[12677695,12677852,12678785],"length":1,"stats":{"Line":0}},{"line":132,"address":[12679226,12678040,12678478,12679139,12678650,12678132,12679084],"length":1,"stats":{"Line":0}},{"line":133,"address":[14609682,14609432,14609498],"length":1,"stats":{"Line":0}},{"line":134,"address":[12678431,12678486,12678698,12678073,12678367,12678183,12678415],"length":1,"stats":{"Line":0}},{"line":136,"address":[12678611,12679094,12678907,12678672,12677747],"length":1,"stats":{"Line":0}},{"line":137,"address":[14613427,14613369,14613433,14610392,14613184],"length":1,"stats":{"Line":0}},{"line":138,"address":[12681999,12681931],"length":1,"stats":{"Line":0}},{"line":141,"address":[12679500,12681389],"length":1,"stats":{"Line":0}},{"line":142,"address":[12059515],"length":1,"stats":{"Line":0}},{"line":144,"address":[14612939,14613007],"length":1,"stats":{"Line":0}},{"line":147,"address":[12997165,12996560,12996374,12996492],"length":1,"stats":{"Line":0}},{"line":148,"address":[12996644,12996902,12997258,12993833,12997390,12996617],"length":1,"stats":{"Line":0}},{"line":152,"address":[12679573],"length":1,"stats":{"Line":0}},{"line":156,"address":[14615056,14615133,14615417,14615459,14615354,14615480,14615269,14615312,14615438,14615396,14615509,14615375,14615665,14617565,14615333],"length":1,"stats":{"Line":0}},{"line":157,"address":[13000247,12999799,13000123,12999855],"length":1,"stats":{"Line":0}},{"line":158,"address":[14616110,14615958,14616566],"length":1,"stats":{"Line":0}},{"line":159,"address":[12685196],"length":1,"stats":{"Line":0}},{"line":162,"address":[12425403],"length":1,"stats":{"Line":0}},{"line":163,"address":[14617921,14615341,14617772,14618478],"length":1,"stats":{"Line":0}},{"line":165,"address":[12687211,12686983,12684082],"length":1,"stats":{"Line":0}},{"line":166,"address":[13003167,13003712,13003256],"length":1,"stats":{"Line":0}},{"line":167,"address":[13003622],"length":1,"stats":{"Line":0}},{"line":170,"address":[14615383,14620205,14618751,14620361,14620959],"length":1,"stats":{"Line":0}},{"line":171,"address":[12689401,12689531],"length":1,"stats":{"Line":0}},{"line":172,"address":[14620728],"length":1,"stats":{"Line":0}},{"line":175,"address":[14622193,14621131,14622639,14621214,14621641],"length":1,"stats":{"Line":0}},{"line":181,"address":[14623088,14625008,14623445,14623621,14621588,14623034,14623534],"length":1,"stats":{"Line":0}},{"line":183,"address":[14356783],"length":1,"stats":{"Line":0}},{"line":184,"address":[12700544,12700688,12692223],"length":1,"stats":{"Line":0}},{"line":185,"address":[12700569],"length":1,"stats":{"Line":0}},{"line":188,"address":[12692536,12692457],"length":1,"stats":{"Line":0}},{"line":191,"address":[13008419,13008341],"length":1,"stats":{"Line":0}},{"line":193,"address":[13008490],"length":1,"stats":{"Line":0}},{"line":194,"address":[12693004,12692913],"length":1,"stats":{"Line":0}},{"line":198,"address":[14356808],"length":1,"stats":{"Line":0}},{"line":200,"address":[13009768,13009839],"length":1,"stats":{"Line":0}},{"line":201,"address":[12694312],"length":1,"stats":{"Line":0}},{"line":202,"address":[13009968],"length":1,"stats":{"Line":0}},{"line":203,"address":[13000002,13013792,13014293,13010047,13010210],"length":1,"stats":{"Line":0}},{"line":204,"address":[12698566],"length":1,"stats":{"Line":0}},{"line":207,"address":[14625531],"length":1,"stats":{"Line":0}},{"line":208,"address":[12695170,12694273,12695597],"length":1,"stats":{"Line":0}},{"line":209,"address":[12696880,12696556,12695544,12696826,12699290,12699427,12699340],"length":1,"stats":{"Line":0}},{"line":210,"address":[14356858,14357786],"length":1,"stats":{"Line":0}},{"line":212,"address":[14631186],"length":1,"stats":{"Line":0}},{"line":213,"address":[14625452,14628656,14628229],"length":1,"stats":{"Line":0}},{"line":214,"address":[13015247,13015309,13015376,13013730,13015495,13012907,13013671],"length":1,"stats":{"Line":0}},{"line":215,"address":[12425603],"length":1,"stats":{"Line":0}},{"line":219,"address":[14626273],"length":1,"stats":{"Line":0}},{"line":223,"address":[12939824,12939852],"length":1,"stats":{"Line":0}},{"line":224,"address":[12676059,12674394,12674285],"length":1,"stats":{"Line":0}},{"line":226,"address":[12676015,12674976,12674748,12675044,12674677,12674587,12674639],"length":1,"stats":{"Line":0}},{"line":231,"address":[12992417,12991339,12991414,12992481,12991971,12991809,12992548],"length":1,"stats":{"Line":0}},{"line":232,"address":[12675345,12675411],"length":1,"stats":{"Line":0}},{"line":233,"address":[12991671,12991733],"length":1,"stats":{"Line":0}},{"line":234,"address":[14606902,14606966,14607021,14606560,14606831,14606950,14607224,14606656],"length":1,"stats":{"Line":0}},{"line":236,"address":[12058839],"length":1,"stats":{"Line":0}},{"line":237,"address":[12993509,12993573,12993328,12992458,12993567],"length":1,"stats":{"Line":0}},{"line":238,"address":[12677307,12677375],"length":1,"stats":{"Line":0}},{"line":241,"address":[12676732],"length":1,"stats":{"Line":0}},{"line":242,"address":[12676988],"length":1,"stats":{"Line":0}},{"line":243,"address":[14608074,14608125],"length":1,"stats":{"Line":0}},{"line":247,"address":[12992862],"length":1,"stats":{"Line":0}},{"line":251,"address":[12612413,12612400],"length":1,"stats":{"Line":0}},{"line":252,"address":[13026590],"length":1,"stats":{"Line":0}},{"line":253,"address":[13026595,13026685],"length":1,"stats":{"Line":0}},{"line":255,"address":[14642598],"length":1,"stats":{"Line":0}},{"line":256,"address":[14642672],"length":1,"stats":{"Line":0}},{"line":259,"address":[14642684,14642642],"length":1,"stats":{"Line":0}},{"line":260,"address":[12711459,12711414],"length":1,"stats":{"Line":0}},{"line":261,"address":[14642745],"length":1,"stats":{"Line":0}},{"line":265,"address":[13026820],"length":1,"stats":{"Line":0}},{"line":269,"address":[12612368,12612381],"length":1,"stats":{"Line":0}},{"line":270,"address":[12710359,12710450,12710466],"length":1,"stats":{"Line":0}},{"line":271,"address":[13026081,13025935],"length":1,"stats":{"Line":0}},{"line":273,"address":[12710646,12710552,12710575,12710697,12711080],"length":1,"stats":{"Line":0}},{"line":275,"address":[14642033],"length":1,"stats":{"Line":0}},{"line":276,"address":[12710954],"length":1,"stats":{"Line":0}},{"line":280,"address":[12612125,12612112],"length":1,"stats":{"Line":0}},{"line":281,"address":[12998313,12998189,12998382,12999187],"length":1,"stats":{"Line":0}},{"line":284,"address":[12683484,12682374,12683434,12683360],"length":1,"stats":{"Line":0}},{"line":285,"address":[14614658],"length":1,"stats":{"Line":0}},{"line":288,"address":[12682989,12683148,12682607,12683061],"length":1,"stats":{"Line":0}},{"line":291,"address":[14613952,14614135],"length":1,"stats":{"Line":0}},{"line":298,"address":[12998612],"length":1,"stats":{"Line":0}},{"line":301,"address":[12999382,12999446],"length":1,"stats":{"Line":0}},{"line":304,"address":[14614478],"length":1,"stats":{"Line":0}},{"line":308,"address":[12710048,12710067,12710170,12710220,12710149],"length":1,"stats":{"Line":0}},{"line":309,"address":[13025519],"length":1,"stats":{"Line":0}},{"line":313,"address":[12940080,12940098],"length":1,"stats":{"Line":0}},{"line":314,"address":[13025303,13025408,13025392,13025225],"length":1,"stats":{"Line":0}},{"line":318,"address":[12612210,12612192],"length":1,"stats":{"Line":4}},{"line":319,"address":[12702133,12702230],"length":1,"stats":{"Line":2}},{"line":321,"address":[12702423,12702340],"length":1,"stats":{"Line":2}},{"line":322,"address":[14633762,14633824],"length":1,"stats":{"Line":2}},{"line":323,"address":[12702649],"length":1,"stats":{"Line":1}},{"line":324,"address":[13018195],"length":1,"stats":{"Line":1}},{"line":327,"address":[13018004],"length":1,"stats":{"Line":1}},{"line":334,"address":[12939760],"length":1,"stats":{"Line":0}},{"line":335,"address":[12939774],"length":1,"stats":{"Line":0}},{"line":336,"address":[12990098],"length":1,"stats":{"Line":0}},{"line":341,"address":[14872565,14872571,14872112],"length":1,"stats":{"Line":0}},{"line":342,"address":[12940849],"length":1,"stats":{"Line":0}},{"line":344,"address":[12613188],"length":1,"stats":{"Line":0}},{"line":345,"address":[14872442],"length":1,"stats":{"Line":0}},{"line":346,"address":[14872357],"length":1,"stats":{"Line":0}},{"line":347,"address":[12613248],"length":1,"stats":{"Line":0}},{"line":353,"address":[14872904,14872898,14872592],"length":1,"stats":{"Line":0}},{"line":354,"address":[12613483],"length":1,"stats":{"Line":0}},{"line":355,"address":[12941512],"length":1,"stats":{"Line":0}},{"line":359,"address":[14872096],"length":1,"stats":{"Line":0}},{"line":360,"address":[13038188,13038105],"length":1,"stats":{"Line":0}},{"line":361,"address":[14654447],"length":1,"stats":{"Line":0}},{"line":362,"address":[14654493,14654911],"length":1,"stats":{"Line":0}},{"line":366,"address":[12941648],"length":1,"stats":{"Line":1}},{"line":367,"address":[12941720],"length":1,"stats":{"Line":1}},{"line":368,"address":[12941778],"length":1,"stats":{"Line":1}},{"line":370,"address":[12941740,12941803],"length":1,"stats":{"Line":2}}],"covered":11,"coverable":163},{"path":["/","root","code","nuclaw","tests","integration_tests.rs"],"content":"//! Integration tests for NuClaw\n//!\n//! These tests verify the interaction between components.\n\nuse nuclaw::config;\nuse nuclaw::error::Result;\nuse std::fs;\n\n/// Test that required directories are created\n#[test]\nfn test_directory_creation() {\n    // Ensure directories exist\n    config::ensure_directories().expect(\"Failed to create directories\");\n\n    // Verify directories were created\n    assert!(config::store_dir().exists(), \"Store directory should exist\");\n    assert!(config::data_dir().exists(), \"Data directory should exist\");\n    assert!(\n        config::groups_dir().exists(),\n        \"Groups directory should exist\"\n    );\n}\n\n/// Test database initialization\n#[test]\nfn test_database_initialization() {\n    use nuclaw::db::Database;\n\n    // Ensure directories exist first\n    config::ensure_directories().expect(\"Failed to create directories\");\n\n    // Initialize database\n    let db = Database::new().expect(\"Failed to create database\");\n\n    // Verify we can get a connection\n    let conn = db.get_connection().expect(\"Failed to get connection\");\n\n    // Verify tables exist by running a simple query\n    let tables: rusqlite::Result\u003cVec\u003cString\u003e\u003e = conn\n        .prepare(\"SELECT name FROM sqlite_master WHERE type='table'\")\n        .expect(\"Failed to prepare statement\")\n        .query_map([], |row| row.get::\u003c_, String\u003e(0))\n        .expect(\"Failed to query tables\")\n        .collect();\n\n    let tables = tables.expect(\"Failed to collect results\");\n\n    assert!(\n        tables.contains(\u0026\"chats\".to_string()),\n        \"chats table should exist\"\n    );\n    assert!(\n        tables.contains(\u0026\"messages\".to_string()),\n        \"messages table should exist\"\n    );\n    assert!(\n        tables.contains(\u0026\"scheduled_tasks\".to_string()),\n        \"scheduled_tasks table should exist\"\n    );\n    assert!(\n        tables.contains(\u0026\"task_run_logs\".to_string()),\n        \"task_run_logs table should exist\"\n    );\n}\n\n/// Test container timeout configuration\n#[test]\nfn test_container_timeout_configuration() {\n    use std::time::Duration;\n\n    // Save original\n    let original = std::env::var(\"CONTAINER_TIMEOUT\").ok();\n\n    // Test default\n    std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    let timeout = nuclaw::container_runner::container_timeout();\n    assert_eq!(timeout, Duration::from_millis(300_000));\n\n    // Test custom value\n    std::env::set_var(\"CONTAINER_TIMEOUT\", \"60000\");\n    let timeout = nuclaw::container_runner::container_timeout();\n    assert_eq!(timeout, Duration::from_millis(60_000));\n\n    // Restore\n    match original {\n        Some(val) =\u003e std::env::set_var(\"CONTAINER_TIMEOUT\", val),\n        None =\u003e std::env::remove_var(\"CONTAINER_TIMEOUT\"),\n    }\n}\n\n/// Test scheduler configuration\n#[test]\nfn test_scheduler_configuration() {\n    use nuclaw::task_scheduler::{poll_interval, task_timeout};\n    use std::time::Duration;\n\n    // Save originals\n    let original_poll = std::env::var(\"SCHEDULER_POLL_INTERVAL\").ok();\n    let original_timeout = std::env::var(\"TASK_TIMEOUT\").ok();\n\n    // Test defaults\n    std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\");\n    std::env::remove_var(\"TASK_TIMEOUT\");\n    assert_eq!(poll_interval(), Duration::from_secs(60));\n    assert_eq!(task_timeout(), Duration::from_secs(600));\n\n    // Test custom values\n    std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", \"30\");\n    std::env::set_var(\"TASK_TIMEOUT\", \"300\");\n    assert_eq!(poll_interval(), Duration::from_secs(30));\n    assert_eq!(task_timeout(), Duration::from_secs(300));\n\n    // Restore\n    match original_poll {\n        Some(val) =\u003e std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", val),\n        None =\u003e std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\"),\n    }\n    match original_timeout {\n        Some(val) =\u003e std::env::set_var(\"TASK_TIMEOUT\", val),\n        None =\u003e std::env::remove_var(\"TASK_TIMEOUT\"),\n    }\n}\n\n/// Test database operations\n#[test]\nfn test_database_operations() {\n    use nuclaw::db::Database;\n    use rusqlite::params;\n\n    config::ensure_directories().expect(\"Failed to create directories\");\n    let db = Database::new().expect(\"Failed to create database\");\n    let conn = db.get_connection().expect(\"Failed to get connection\");\n\n    // Insert a test message\n    conn.execute(\n        \"INSERT OR REPLACE INTO messages (id, chat_jid, sender, sender_name, content, timestamp, is_from_me)\n         VALUES (?, ?, ?, ?, ?, ?, ?)\",\n        params![\n            \"test_msg_1\",\n            \"test@chat\",\n            \"sender1\",\n            \"Test Sender\",\n            \"Test message content\",\n            \"2025-01-01T00:00:00Z\",\n            0,\n        ],\n    ).expect(\"Failed to insert message\");\n\n    // Query the message back\n    let content: String = conn\n        .query_row(\n            \"SELECT content FROM messages WHERE id = ?\",\n            [\"test_msg_1\"],\n            |row| row.get(0),\n        )\n        .expect(\"Failed to query message\");\n\n    assert_eq!(content, \"Test message content\");\n\n    // Clean up\n    conn.execute(\"DELETE FROM messages WHERE id = ?\", [\"test_msg_1\"])\n        .expect(\"Failed to delete test message\");\n}\n\n/// Test group context isolation\n#[test]\nfn test_group_context_isolation() {\n    use nuclaw::container_runner::create_group_ipc_directory;\n\n    config::ensure_directories().expect(\"Failed to create directories\");\n\n    // Create IPC directories for different groups\n    let group1 = create_group_ipc_directory(\"test_group_1\").expect(\"Failed to create group 1\");\n    let group2 = create_group_ipc_directory(\"test_group_2\").expect(\"Failed to create group 2\");\n\n    // Verify they are different paths\n    assert_ne!(group1, group2);\n\n    // Create files in each directory\n    fs::write(group1.join(\"test.txt\"), \"group1\").expect(\"Failed to write to group1\");\n    fs::write(group2.join(\"test.txt\"), \"group2\").expect(\"Failed to write to group2\");\n\n    // Verify isolation\n    let content1 = fs::read_to_string(group1.join(\"test.txt\")).expect(\"Failed to read group1\");\n    let content2 = fs::read_to_string(group2.join(\"test.txt\")).expect(\"Failed to read group2\");\n\n    assert_eq!(content1, \"group1\");\n    assert_eq!(content2, \"group2\");\n\n    // Cleanup\n    let _ = fs::remove_dir_all(\u0026group1);\n    let _ = fs::remove_dir_all(\u0026group2);\n}\n\n/// Test cron expression parsing with various formats\n#[test]\nfn test_cron_expression_variations() {\n    use nuclaw::task_scheduler::parse_cron_expression;\n\n    // Standard 6-field cron (with seconds)\n    assert!(parse_cron_expression(\"0 0 9 * * *\").is_ok());\n    assert!(parse_cron_expression(\"0 0 0 1 * *\").is_ok()); // First day of month\n    assert!(parse_cron_expression(\"0 0 12 * * 1-5\").is_ok()); // Weekdays at noon\n\n    // Invalid expressions\n    assert!(parse_cron_expression(\"\").is_err());\n    assert!(parse_cron_expression(\"invalid\").is_err());\n    assert!(parse_cron_expression(\"* * *\").is_err()); // Too few fields\n}\n\n/// Test error handling for missing database\n#[test]\n#[ignore = \"May interfere with other tests\"]\nfn test_database_error_handling() {\n    // This test is ignored by default as it manipulates environment\n    // It would test error handling when database cannot be opened\n}\n\n/// Test configuration loading from environment\n#[test]\nfn test_environment_configuration() {\n    use nuclaw::config::assistant_name;\n\n    // Save originals\n    let original_name = std::env::var(\"ASSISTANT_NAME\").ok();\n\n    // Test assistant name default\n    std::env::remove_var(\"ASSISTANT_NAME\");\n    assert_eq!(assistant_name(), \"Andy\");\n\n    // Test custom assistant name\n    std::env::set_var(\"ASSISTANT_NAME\", \"Bob\");\n    assert_eq!(assistant_name(), \"Bob\");\n\n    // Restore\n    match original_name {\n        Some(val) =\u003e std::env::set_var(\"ASSISTANT_NAME\", val),\n        None =\u003e std::env::remove_var(\"ASSISTANT_NAME\"),\n    }\n}\n\n/// Test max output size configuration\n#[test]\nfn test_max_output_size_configuration() {\n    use nuclaw::container_runner::max_output_size;\n\n    // Save original\n    let original = std::env::var(\"CONTAINER_MAX_OUTPUT_SIZE\").ok();\n\n    // Test default\n    std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n    let size = max_output_size();\n    assert_eq!(size, 10 * 1024 * 1024); // 10MB default\n\n    // Test custom value\n    std::env::set_var(\"CONTAINER_MAX_OUTPUT_SIZE\", \"5242880\");\n    let size = max_output_size();\n    assert_eq!(size, 5 * 1024 * 1024); // 5MB\n\n    // Restore\n    match original {\n        Some(val) =\u003e std::env::set_var(\"CONTAINER_MAX_OUTPUT_SIZE\", val),\n        None =\u003e std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\"),\n    }\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","root","code","nuclaw","src","config.rs"],"content":"//! Configuration for NuClaw\n\nuse std::env;\nuse std::path::PathBuf;\n\npub fn project_root() -\u003e PathBuf {\n    env::current_dir().expect(\"Failed to get current directory\")\n}\n\npub fn store_dir() -\u003e PathBuf {\n    project_root().join(\"store\")\n}\n\npub fn groups_dir() -\u003e PathBuf {\n    project_root().join(\"groups\")\n}\n\npub fn data_dir() -\u003e PathBuf {\n    project_root().join(\"data\")\n}\n\npub fn logs_dir() -\u003e PathBuf {\n    groups_dir().join(\"logs\")\n}\n\npub fn mount_allowlist_path() -\u003e PathBuf {\n    let home = home::home_dir().unwrap_or_else(|| PathBuf::from(\"/Users/user\"));\n    home.join(\".config\")\n        .join(\"nuclaw\")\n        .join(\"mount-allowlist.json\")\n}\n\npub fn assistant_name() -\u003e String {\n    env::var(\"ASSISTANT_NAME\").unwrap_or_else(|_| \"Andy\".to_string())\n}\n\npub fn timezone() -\u003e String {\n    env::var(\"TZ\").unwrap_or_else(|_| \"UTC\".to_string())\n}\n\npub fn ensure_directories() -\u003e std::io::Result\u003c()\u003e {\n    let dirs = [\n        store_dir(),\n        groups_dir(),\n        data_dir(),\n        mount_allowlist_path().parent().unwrap().to_path_buf(),\n    ];\n    for dir in dirs {\n        if !dir.exists() {\n            std::fs::create_dir_all(\u0026dir)?;\n        }\n    }\n    Ok(())\n}\n","traces":[{"line":6,"address":[12597504],"length":1,"stats":{"Line":2}},{"line":7,"address":[12209053],"length":1,"stats":{"Line":2}},{"line":10,"address":[12211673,12211667,12211520],"length":1,"stats":{"Line":2}},{"line":11,"address":[12599986,12599912],"length":1,"stats":{"Line":4}},{"line":14,"address":[14152659,14152512,14152665],"length":1,"stats":{"Line":2}},{"line":15,"address":[12597442,12597368],"length":1,"stats":{"Line":4}},{"line":18,"address":[12211088,12211241,12211235],"length":1,"stats":{"Line":2}},{"line":19,"address":[12211102,12211190],"length":1,"stats":{"Line":4}},{"line":22,"address":[14155065,14155059,14154912],"length":1,"stats":{"Line":1}},{"line":23,"address":[12599672,12599746],"length":1,"stats":{"Line":2}},{"line":26,"address":[12211060,12210528,12211054],"length":1,"stats":{"Line":1}},{"line":27,"address":[14154193],"length":1,"stats":{"Line":1}},{"line":28,"address":[12210600,12210816,12210668],"length":1,"stats":{"Line":3}},{"line":33,"address":[12209120],"length":1,"stats":{"Line":1}},{"line":34,"address":[12896848,12896832],"length":1,"stats":{"Line":3}},{"line":37,"address":[12599808],"length":1,"stats":{"Line":1}},{"line":38,"address":[12211454],"length":1,"stats":{"Line":3}},{"line":41,"address":[16132261],"length":1,"stats":{"Line":1}},{"line":42,"address":[12597671,12598026],"length":1,"stats":{"Line":2}},{"line":43,"address":[14152863],"length":1,"stats":{"Line":1}},{"line":44,"address":[12209232],"length":1,"stats":{"Line":1}},{"line":45,"address":[12209295],"length":1,"stats":{"Line":1}},{"line":46,"address":[16132869],"length":1,"stats":{"Line":3}},{"line":48,"address":[12209775,12210000],"length":1,"stats":{"Line":2}},{"line":49,"address":[12210077,12210197],"length":1,"stats":{"Line":2}},{"line":50,"address":[12210269,12210218],"length":1,"stats":{"Line":0}},{"line":53,"address":[12210113],"length":1,"stats":{"Line":1}}],"covered":26,"coverable":27},{"path":["/","root","code","nuclaw","src","container_runner.rs"],"content":"//! Container Runner - Spawns AI agent containers with isolation\n//!\n//! Supports:\n//! - macOS: Apple Container via `container` CLI\n//! - Linux: Docker via `docker` CLI\n//!\n//! Features:\n//! - Filesystem isolation per group\n//! - IPC namespace isolation\n//! - Configurable timeout\n//! - Output parsing with sentinel markers\n\nuse crate::config::{assistant_name, data_dir, groups_dir, logs_dir};\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, ContainerOutput};\nuse std::fs;\nuse std::path::{Path, PathBuf};\nuse std::process::Command;\nuse tokio::io::{AsyncBufReadExt, AsyncWriteExt, BufReader};\nuse tokio::process::{ChildStdout, Command as AsyncCommand};\nuse tokio::time::{timeout, Duration, Instant};\n\n/// Default container timeout: 5 minutes\nconst DEFAULT_TIMEOUT_MS: u64 = 300_000;\n/// Default max output size: 10MB\nconst DEFAULT_MAX_OUTPUT: usize = 10 * 1024 * 1024;\n/// Sentinel markers for output parsing\nconst OUTPUT_START_MARKER: \u0026str = \"--NANOCLAW_OUTPUT_START--\";\nconst OUTPUT_END_MARKER: \u0026str = \"--NANOCLAW_OUTPUT_END--\";\n\n/// Get container timeout from environment or default\npub fn container_timeout() -\u003e Duration {\n    let timeout_ms = std::env::var(\"CONTAINER_TIMEOUT\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_TIMEOUT_MS);\n    Duration::from_millis(timeout_ms)\n}\n\n/// Get max output size from environment or default\npub fn max_output_size() -\u003e usize {\n    std::env::var(\"CONTAINER_MAX_OUTPUT_SIZE\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_MAX_OUTPUT)\n}\n\n/// Get the container command based on platform\nfn get_container_command() -\u003e \u0026'static str {\n    if cfg!(target_os = \"macos\") {\n        \"container\"\n    } else {\n        \"docker\"\n    }\n}\n\n/// Create IPC directory for a group\npub fn create_group_ipc_directory(group_folder: \u0026str) -\u003e Result\u003cPathBuf\u003e {\n    let ipc_dir = data_dir().join(\"ipc\").join(group_folder);\n    fs::create_dir_all(\u0026ipc_dir).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to create IPC directory: {}\", e),\n    })?;\n    Ok(ipc_dir)\n}\n\n/// Write IPC files for container context\nfn write_ipc_files(group_folder: \u0026str, input: \u0026ContainerInput) -\u003e Result\u003c()\u003e {\n    let ipc_dir = create_group_ipc_directory(group_folder)?;\n\n    // Write current_tasks.json\n    let tasks_path = ipc_dir.join(\"current_tasks.json\");\n    let tasks_data = serde_json::json!({\n        \"tasks\": [{\n            \"id\": input.session_id.clone().unwrap_or_else(|| \"interactive\".to_string()),\n            \"prompt\": input.prompt,\n            \"is_scheduled\": input.is_scheduled_task\n        }]\n    });\n    let tasks_json =\n        serde_json::to_string_pretty(\u0026tasks_data).map_err(|e| NuClawError::FileSystem {\n            message: format!(\"Failed to serialize tasks: {}\", e),\n        })?;\n    fs::write(\u0026tasks_path, tasks_json).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write tasks file: {}\", e),\n    })?;\n\n    // Write available_groups.json\n    let groups_path = ipc_dir.join(\"available_groups.json\");\n    let groups_data = serde_json::json!({\n        \"groups\": {\n            group_folder: {\n                \"name\": group_folder,\n                \"registered\": true\n            }\n        }\n    });\n    let groups_json =\n        serde_json::to_string_pretty(\u0026groups_data).map_err(|e| NuClawError::FileSystem {\n            message: format!(\"Failed to serialize groups: {}\", e),\n        })?;\n    fs::write(\u0026groups_path, groups_json).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write groups file: {}\", e),\n    })?;\n\n    Ok(())\n}\n\n/// Prepare group context directory\nfn prepare_group_context(group_folder: \u0026str) -\u003e Result\u003cPathBuf\u003e {\n    let group_dir = groups_dir().join(group_folder);\n    if !group_dir.exists() {\n        fs::create_dir_all(\u0026group_dir).map_err(|e| NuClawError::FileSystem {\n            message: format!(\"Failed to create group directory: {}\", e),\n        })?;\n    }\n    Ok(group_dir)\n}\n\n/// Run a container with the given input\npub async fn run_container(input: ContainerInput) -\u003e Result\u003cContainerOutput\u003e {\n    let group_folder = \u0026input.group_folder;\n    let group_dir = prepare_group_context(group_folder)?;\n    write_ipc_files(group_folder, \u0026input)?;\n    let (mut cmd, input_path) = build_container_command(\u0026input, \u0026group_dir).await?;\n    let timeout_duration = container_timeout();\n    let output = run_container_with_output(\u0026mut cmd, timeout_duration).await?;\n    let _ = fs::remove_file(\u0026input_path);\n    Ok(output)\n}\n\nasync fn build_container_command(\n    input: \u0026ContainerInput,\n    group_dir: \u0026Path,\n) -\u003e Result\u003c(AsyncCommand, PathBuf)\u003e {\n    let temp_dir = data_dir().join(\"temp\");\n    fs::create_dir_all(\u0026temp_dir).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to create temp directory: {}\", e),\n    })?;\n    let input_path = temp_dir.join(format!(\n        \"input_{}.json\",\n        input\n            .session_id\n            .clone()\n            .unwrap_or_else(|| \"default\".to_string())\n    ));\n    let input_json = serde_json::to_string(input).map_err(|e| NuClawError::Container {\n        message: format!(\"Failed to serialize input: {}\", e),\n    })?;\n    fs::write(\u0026input_path, \u0026input_json).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write input file: {}\", e),\n    })?;\n    let mut cmd = AsyncCommand::new(get_container_command());\n    if cfg!(target_os = \"macos\") {\n        cmd.arg(\"exec\")\n            .arg(\"--workspace\")\n            .arg(group_dir)\n            .arg(\"--input\")\n            .arg(\u0026input_path)\n            .arg(\"--name\")\n            .arg(assistant_name());\n    } else {\n        let image = std::env::var(\"CONTAINER_IMAGE\")\n            .unwrap_or_else(|_| \"anthropic/claude-code:latest\".to_string());\n        cmd.arg(\"run\")\n            .arg(\"--rm\")\n            .arg(\"-v\")\n            .arg(format!(\"{}:/workspace/group\", group_dir.display()))\n            .arg(\"-e\")\n            .arg(\"CLAUDE_CODE_OAUTH_TOKEN\")\n            .arg(\"-e\")\n            .arg(\"ANTHROPIC_API_KEY\")\n            .arg(\"--entrypoint\")\n            .arg(\"/bin/sh\")\n            .arg(image)\n            .arg(\"-c\")\n            .arg(\"cat /workspace/input.json | /usr/local/bin/claude\");\n    }\n    cmd.stdin(std::process::Stdio::piped())\n        .stdout(std::process::Stdio::piped())\n        .stderr(std::process::Stdio::piped());\n    Ok((cmd, input_path))\n}\n\nasync fn run_container_with_output(\n    cmd: \u0026mut AsyncCommand,\n    timeout_duration: Duration,\n) -\u003e Result\u003cContainerOutput\u003e {\n    let mut child = cmd.spawn().map_err(|e| NuClawError::Container {\n        message: format!(\"Failed to spawn container: {}\", e),\n    })?;\n    let start_time = Instant::now();\n    if let Some(mut stdin) = child.stdin.take() {\n        let input_path = data_dir().join(\"temp/input.json\");\n        if input_path.exists() {\n            let input_content = fs::read_to_string(\u0026input_path).unwrap_or_default();\n            stdin\n                .write_all(input_content.as_bytes())\n                .await\n                .map_err(|e| NuClawError::Container {\n                    message: format!(\"Failed to write to stdin: {}\", e),\n                })?;\n        }\n        stdin.shutdown().await.map_err(|e| NuClawError::Container {\n            message: format!(\"Failed to close stdin: {}\", e),\n        })?;\n    }\n    let stdout = child.stdout.take().unwrap();\n    let output_result = timeout(timeout_duration, capture_output(stdout)).await;\n    let exit_status = child.wait().await.map_err(|e| NuClawError::Container {\n        message: format!(\"Failed to wait for container: {}\", e),\n    })?;\n    let duration_ms = start_time.elapsed().as_millis() as i64;\n    match output_result {\n        Ok(output) =\u003e {\n            let output = output?;\n            parse_container_output(\u0026output, exit_status.success(), duration_ms)\n        }\n        Err(_) =\u003e {\n            let _ = child.kill().await;\n            parse_container_output(\"\", false, duration_ms)\n        }\n    }\n}\n\nasync fn capture_output(stdout: ChildStdout) -\u003e Result\u003cString\u003e {\n    let reader = BufReader::new(stdout);\n    let mut lines = reader.lines();\n    let mut output = String::new();\n    let max_size = max_output_size();\n    while let Some(line) = lines.next_line().await.ok().flatten() {\n        if output.len() + line.len() \u003e max_size {\n            output.push_str(\"\\n[OUTPUT TRUNCATED - exceeded max size]\");\n            break;\n        }\n        output.push_str(\u0026line);\n        output.push('\\n');\n    }\n    Ok(output)\n}\n\nfn parse_container_output(\n    output: \u0026str,\n    success: bool,\n    _duration_ms: i64,\n) -\u003e Result\u003cContainerOutput\u003e {\n    if let Some(content) = extract_marked_output(output) {\n        return parse_marked_content(\u0026content, success);\n    }\n    let last_line = output\n        .lines()\n        .rev()\n        .find(|l| !l.trim().is_empty())\n        .unwrap_or(\"\")\n        .trim();\n    if let Ok(parsed) = serde_json::from_str::\u003cContainerOutput\u003e(last_line) {\n        return Ok(parsed);\n    }\n    Ok(ContainerOutput {\n        status: if success {\n            \"success\".to_string()\n        } else {\n            \"error\".to_string()\n        },\n        result: Some(output.to_string()),\n        new_session_id: None,\n        error: if success {\n            None\n        } else {\n            Some(\"Container execution failed\".to_string())\n        },\n    })\n}\n\nfn extract_marked_output(output: \u0026str) -\u003e Option\u003cString\u003e {\n    let start_idx = output.find(OUTPUT_START_MARKER)?;\n    let end_idx = output.find(OUTPUT_END_MARKER)?;\n    if start_idx \u003c end_idx {\n        Some(output[start_idx + OUTPUT_START_MARKER.len()..end_idx].to_string())\n    } else {\n        None\n    }\n}\n\nfn parse_marked_content(content: \u0026str, success: bool) -\u003e Result\u003cContainerOutput\u003e {\n    if let Ok(parsed) = serde_json::from_str::\u003cContainerOutput\u003e(content) {\n        return Ok(parsed);\n    }\n    Ok(ContainerOutput {\n        status: if success {\n            \"success\".to_string()\n        } else {\n            \"error\".to_string()\n        },\n        result: Some(content.to_string()),\n        new_session_id: None,\n        error: if success {\n            None\n        } else {\n            Some(\"Container execution failed\".to_string())\n        },\n    })\n}\n\npub fn ensure_container_system_running() -\u003e Result\u003c()\u003e {\n    let output = Command::new(get_container_command())\n        .args([\"system\", \"status\"])\n        .output();\n    match output {\n        Ok(_) =\u003e Ok(()),\n        Err(_) =\u003e {\n            let output = Command::new(get_container_command())\n                .args([\"system\", \"start\"])\n                .output();\n            match output {\n                Ok(_) =\u003e Ok(()),\n                Err(e) =\u003e Err(NuClawError::Container {\n                    message: format!(\"Failed to start container system: {}\", e),\n                }),\n            }\n        }\n    }\n}\n\npub fn log_container_output(\n    group_folder: \u0026str,\n    session_id: \u0026str,\n    output: \u0026ContainerOutput,\n) -\u003e Result\u003c()\u003e {\n    let log_dir = logs_dir().join(group_folder);\n    fs::create_dir_all(\u0026log_dir).map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to create log directory: {}\", e),\n    })?;\n    let timestamp = chrono::Utc::now().format(\"%Y%m%d_%H%M%S\");\n    let log_path = log_dir.join(format!(\"container_{}_{}.log\", session_id, timestamp));\n    let log_data = serde_json::json!({\n        \"timestamp\": chrono::Utc::now().to_rfc3339(),\n        \"group_folder\": group_folder,\n        \"session_id\": session_id,\n        \"status\": output.status,\n        \"result\": output.result,\n        \"error\": output.error,\n        \"new_session_id\": output.new_session_id,\n    });\n    fs::write(\n        \u0026log_path,\n        serde_json::to_string_pretty(\u0026log_data).unwrap_or_default(),\n    )\n    .map_err(|e| NuClawError::FileSystem {\n        message: format!(\"Failed to write log file: {}\", e),\n    })?;\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_marked_output() {\n        let output = \"Some prefix\\n--NANOCLAW_OUTPUT_START--\\n{\\\"status\\\": \\\"success\\\", \\\"result\\\": \\\"test\\\"}\\n--NANOCLAW_OUTPUT_END--\\nSome suffix\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_some());\n        assert_eq!(\n            extracted.unwrap(),\n            \"\\n{\\\"status\\\": \\\"success\\\", \\\"result\\\": \\\"test\\\"}\\n\"\n        );\n    }\n\n    #[test]\n    fn test_extract_marked_output_no_markers() {\n        let output = \"No markers here\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_none());\n    }\n\n    #[test]\n    fn test_extract_marked_output_only_start_marker() {\n        let output = \"--NANOCLAW_OUTPUT_START--\\nsome content\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_none());\n    }\n\n    #[test]\n    fn test_extract_marked_output_reversed_markers() {\n        // End marker before start marker should not match\n        let output = \"--NANOCLAW_OUTPUT_END--\\ncontent\\n--NANOCLAW_OUTPUT_START--\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_none());\n    }\n\n    #[test]\n    fn test_extract_marked_output_empty_content() {\n        let output = \"--NANOCLAW_OUTPUT_START----NANOCLAW_OUTPUT_END--\";\n        let extracted = extract_marked_output(output);\n        assert!(extracted.is_some());\n        assert_eq!(extracted.unwrap(), \"\");\n    }\n\n    #[test]\n    fn test_container_timeout_default() {\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n        let timeout = container_timeout();\n        assert_eq!(timeout, Duration::from_millis(DEFAULT_TIMEOUT_MS));\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    }\n\n    #[test]\n    fn test_container_timeout_from_env() {\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n        \n        let original = std::env::var(\"CONTAINER_TIMEOUT\").ok();\n        assert!(original.is_none());\n\n        std::env::set_var(\"CONTAINER_TIMEOUT\", \"60000\");\n        let timeout = container_timeout();\n        assert_eq!(timeout, Duration::from_millis(60000));\n\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    }\n\n    #[test]\n    fn test_container_timeout_invalid_env() {\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n        \n        let original = std::env::var(\"CONTAINER_TIMEOUT\").ok();\n        assert!(original.is_none());\n\n        std::env::set_var(\"CONTAINER_TIMEOUT\", \"invalid\");\n        let timeout = container_timeout();\n        assert_eq!(timeout, Duration::from_millis(DEFAULT_TIMEOUT_MS));\n\n        std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    }\n\n    #[test]\n    fn test_max_output_size_default() {\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n        let max_size = max_output_size();\n        assert_eq!(max_size, DEFAULT_MAX_OUTPUT);\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n    }\n\n    #[test]\n    fn test_max_output_size_from_env() {\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n        \n        let original = std::env::var(\"CONTAINER_MAX_OUTPUT_SIZE\").ok();\n        assert!(original.is_none());\n\n        std::env::set_var(\"CONTAINER_MAX_OUTPUT_SIZE\", \"5242880\");\n        let max_size = max_output_size();\n        assert_eq!(max_size, 5 * 1024 * 1024);\n\n        std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n    }\n\n    #[test]\n    fn test_parse_container_output_json() {\n        let output = r#\"{\"status\": \"success\", \"result\": \"test result\"}\"#;\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let output = result.unwrap();\n        assert_eq!(output.status, \"success\");\n        assert_eq!(output.result, Some(\"test result\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_container_output_with_session_id() {\n        let output = r#\"{\"status\": \"success\", \"result\": \"test\", \"new_session_id\": \"sess_123\"}\"#;\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let output = result.unwrap();\n        assert_eq!(output.status, \"success\");\n        assert_eq!(output.new_session_id, Some(\"sess_123\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_container_output_error() {\n        let output = \"some error output\";\n        let result = parse_container_output(output, false, 100);\n        assert!(result.is_ok());\n        let output = result.unwrap();\n        assert_eq!(output.status, \"error\");\n        assert!(output.error.is_some());\n    }\n\n    #[test]\n    fn test_parse_container_output_marked() {\n        let output = \"prefix\\n--NANOCLAW_OUTPUT_START--\\n{\\\"status\\\": \\\"success\\\", \\\"result\\\": \\\"marked\\\"}\\n--NANOCLAW_OUTPUT_END--\\nsuffix\";\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"marked\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_container_output_empty() {\n        let output = \"\";\n        let result = parse_container_output(output, true, 100);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_marked_content_success() {\n        let content = r#\"{\"status\": \"success\", \"result\": \"test output\"}\"#;\n        let result = parse_marked_content(content, true);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"test output\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_marked_content_invalid_json() {\n        let content = \"not valid json\";\n        let result = parse_marked_content(content, true);\n        assert!(result.is_ok());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.status, \"success\");\n        assert_eq!(parsed.result, Some(\"not valid json\".to_string()));\n    }\n\n    #[test]\n    fn test_get_container_command() {\n        // This test just verifies the function doesn't panic\n        let cmd = get_container_command();\n        assert!(!cmd.is_empty());\n        // On Linux it should be \"docker\", on macOS \"container\"\n        assert!(cmd == \"docker\" || cmd == \"container\");\n    }\n\n    #[test]\n    fn test_create_group_ipc_directory() {\n        let result = create_group_ipc_directory(\"test_group_123\");\n        assert!(result.is_ok());\n        let path = result.unwrap();\n        assert!(path.exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026path);\n    }\n\n    #[test]\n    fn test_prepare_group_context() {\n        let result = prepare_group_context(\"test_context_group\");\n        assert!(result.is_ok());\n        let path = result.unwrap();\n        assert!(path.exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026path);\n    }\n\n    #[test]\n    fn test_prepare_group_context_existing() {\n        // First call creates the directory\n        let path1 = prepare_group_context(\"existing_group\").unwrap();\n        // Second call should succeed on existing directory\n        let path2 = prepare_group_context(\"existing_group\").unwrap();\n        assert_eq!(path1, path2);\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026path1);\n    }\n\n    #[test]\n    fn test_write_ipc_files() {\n        let input = ContainerInput {\n            prompt: \"test prompt\".to_string(),\n            session_id: Some(\"test_session\".to_string()),\n            group_folder: \"test_ipc_group\".to_string(),\n            chat_jid: \"test@chat\".to_string(),\n            is_main: true,\n            is_scheduled_task: false,\n        };\n\n        let result = write_ipc_files(\"test_ipc_group\", \u0026input);\n        assert!(result.is_ok());\n\n        // Verify files were created\n        let ipc_dir = create_group_ipc_directory(\"test_ipc_group\").unwrap();\n        assert!(ipc_dir.join(\"current_tasks.json\").exists());\n        assert!(ipc_dir.join(\"available_groups.json\").exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026ipc_dir);\n        let _ = fs::remove_dir_all(groups_dir().join(\"test_ipc_group\"));\n    }\n\n    #[test]\n    fn test_log_container_output() {\n        let output = ContainerOutput {\n            status: \"success\".to_string(),\n            result: Some(\"test result\".to_string()),\n            new_session_id: Some(\"sess_123\".to_string()),\n            error: None,\n        };\n\n        let result = log_container_output(\"test_log_group\", \"test_session\", \u0026output);\n        assert!(result.is_ok());\n\n        // Verify log file was created\n        let log_dir = logs_dir().join(\"test_log_group\");\n        assert!(log_dir.exists());\n\n        // Cleanup\n        let _ = fs::remove_dir_all(\u0026log_dir);\n    }\n\n    #[test]\n    fn test_log_container_output_error() {\n        let output = ContainerOutput {\n            status: \"error\".to_string(),\n            result: None,\n            new_session_id: None,\n            error: Some(\"test error\".to_string()),\n        };\n\n        let result = log_container_output(\"test_log_error_group\", \"test_session\", \u0026output);\n        assert!(result.is_ok());\n\n        // Cleanup\n        let log_dir = logs_dir().join(\"test_log_error_group\");\n        let _ = fs::remove_dir_all(\u0026log_dir);\n    }\n}\n","traces":[{"line":32,"address":[13107984],"length":1,"stats":{"Line":2}},{"line":33,"address":[15039268],"length":1,"stats":{"Line":2}},{"line":35,"address":[12039040],"length":1,"stats":{"Line":6}},{"line":36,"address":[13108063],"length":1,"stats":{"Line":2}},{"line":37,"address":[12039073],"length":1,"stats":{"Line":2}},{"line":41,"address":[13103168],"length":1,"stats":{"Line":2}},{"line":42,"address":[15034452],"length":1,"stats":{"Line":2}},{"line":44,"address":[13103209],"length":1,"stats":{"Line":6}},{"line":45,"address":[13103224],"length":1,"stats":{"Line":2}},{"line":58,"address":[12046095,12046101,12045456],"length":1,"stats":{"Line":2}},{"line":59,"address":[12045512],"length":1,"stats":{"Line":2}},{"line":60,"address":[12676121,12675936,12676179,12676185],"length":1,"stats":{"Line":2}},{"line":61,"address":[14818591,14818523],"length":1,"stats":{"Line":0}},{"line":63,"address":[13115143],"length":1,"stats":{"Line":2}},{"line":67,"address":[15034528,15039237,15038963],"length":1,"stats":{"Line":1}},{"line":68,"address":[12034408],"length":1,"stats":{"Line":1}},{"line":71,"address":[13103595,13103663],"length":1,"stats":{"Line":2}},{"line":72,"address":[13104469,13103703,13107864,13103860,13104160,13104692,13104187,13104085,13103751],"length":1,"stats":{"Line":3}},{"line":74,"address":[14806444,14806432],"length":1,"stats":{"Line":2}},{"line":79,"address":[12665285,12665279,12665221,12665040],"length":1,"stats":{"Line":2}},{"line":81,"address":[12665067,12665131],"length":1,"stats":{"Line":0}},{"line":83,"address":[12875472,12875715,12875657,12875721],"length":1,"stats":{"Line":2}},{"line":84,"address":[14806847,14806779],"length":1,"stats":{"Line":0}},{"line":88,"address":[15037106],"length":1,"stats":{"Line":1}},{"line":89,"address":[13107737,13105893,13106184,13105944,13106046,13106333],"length":1,"stats":{"Line":2}},{"line":97,"address":[14807209,14807273,14807267,14807024],"length":1,"stats":{"Line":2}},{"line":99,"address":[12875839,12875771],"length":1,"stats":{"Line":0}},{"line":101,"address":[14807296,14807481,14807545,14807539],"length":1,"stats":{"Line":2}},{"line":102,"address":[12876043,12876111],"length":1,"stats":{"Line":0}},{"line":105,"address":[12038515],"length":1,"stats":{"Line":1}},{"line":109,"address":[12043616,12044150,12044156],"length":1,"stats":{"Line":1}},{"line":110,"address":[12043669],"length":1,"stats":{"Line":1}},{"line":111,"address":[13112959],"length":1,"stats":{"Line":1}},{"line":112,"address":[14808457,14808521,14808515,14808272],"length":1,"stats":{"Line":2}},{"line":113,"address":[12666111,12666043],"length":1,"stats":{"Line":0}},{"line":116,"address":[12043905],"length":1,"stats":{"Line":1}},{"line":120,"address":[12873451,12870898,12870704,12870748,12871704,12870941,12872399],"length":1,"stats":{"Line":0}},{"line":121,"address":[12660064],"length":1,"stats":{"Line":0}},{"line":122,"address":[12660221,12660839,12660081],"length":1,"stats":{"Line":0}},{"line":123,"address":[12871232,12871312,12871654],"length":1,"stats":{"Line":0}},{"line":124,"address":[12660128,12660636,12661514,12660891],"length":1,"stats":{"Line":0}},{"line":125,"address":[12872268,12872186],"length":1,"stats":{"Line":0}},{"line":126,"address":[11693086],"length":1,"stats":{"Line":0}},{"line":127,"address":[12873090,12873020],"length":1,"stats":{"Line":0}},{"line":128,"address":[12873122],"length":1,"stats":{"Line":0}},{"line":131,"address":[13114496],"length":1,"stats":{"Line":0}},{"line":135,"address":[12666509,12666593],"length":1,"stats":{"Line":0}},{"line":136,"address":[14811891,14811833,14811609,14809028,14811648,14811897,14809169],"length":1,"stats":{"Line":0}},{"line":137,"address":[14811743,14811675],"length":1,"stats":{"Line":0}},{"line":139,"address":[14809377,14809214],"length":1,"stats":{"Line":0}},{"line":141,"address":[14809312],"length":1,"stats":{"Line":0}},{"line":143,"address":[12667040],"length":1,"stats":{"Line":0}},{"line":144,"address":[14812588,14809335,14812576],"length":1,"stats":{"Line":0}},{"line":146,"address":[12880825,12878520,12880889,12880883,12880275,12880640,12878406,12878346],"length":1,"stats":{"Line":0}},{"line":147,"address":[12669499,12669435],"length":1,"stats":{"Line":0}},{"line":149,"address":[12880912,12881097,12878621,12881161,12878814,12878708,12881155],"length":1,"stats":{"Line":0}},{"line":150,"address":[12669707,12669775],"length":1,"stats":{"Line":0}},{"line":152,"address":[12667815],"length":1,"stats":{"Line":0}},{"line":162,"address":[12878913],"length":1,"stats":{"Line":0}},{"line":163,"address":[12881200,12878979,12881184],"length":1,"stats":{"Line":0}},{"line":164,"address":[12879021],"length":1,"stats":{"Line":0}},{"line":167,"address":[14810475],"length":1,"stats":{"Line":0}},{"line":174,"address":[12668537],"length":1,"stats":{"Line":0}},{"line":178,"address":[12879765,12879832],"length":1,"stats":{"Line":0}},{"line":179,"address":[12879856],"length":1,"stats":{"Line":0}},{"line":180,"address":[14811180],"length":1,"stats":{"Line":0}},{"line":181,"address":[14811261],"length":1,"stats":{"Line":0}},{"line":184,"address":[12045408],"length":1,"stats":{"Line":0}},{"line":188,"address":[12882895,12881480,12886371,12886313,12881781,12881667,12886128,12886377],"length":1,"stats":{"Line":0}},{"line":189,"address":[14817435,14817503],"length":1,"stats":{"Line":0}},{"line":191,"address":[12670905,12670786],"length":1,"stats":{"Line":0}},{"line":192,"address":[12882043],"length":1,"stats":{"Line":0}},{"line":193,"address":[12882139,12882251],"length":1,"stats":{"Line":0}},{"line":194,"address":[12671312],"length":1,"stats":{"Line":0}},{"line":195,"address":[12882566],"length":1,"stats":{"Line":0}},{"line":196,"address":[12882810,12882634,12883121,12883156,12883243],"length":1,"stats":{"Line":0}},{"line":197,"address":[12882756,12882651],"length":1,"stats":{"Line":0}},{"line":198,"address":[12882775,12882863,12882988,12881520],"length":1,"stats":{"Line":0}},{"line":199,"address":[12887129,12883137,12887187,12886944,12887193],"length":1,"stats":{"Line":0}},{"line":200,"address":[12674943,12674875],"length":1,"stats":{"Line":0}},{"line":203,"address":[14814733,14814594,14818195,14818201,14814988,14818137,14812821,14817952,14813809,14815341],"length":1,"stats":{"Line":0}},{"line":204,"address":[14817979,14818047],"length":1,"stats":{"Line":0}},{"line":207,"address":[12671030,12672600],"length":1,"stats":{"Line":0}},{"line":208,"address":[11656538],"length":1,"stats":{"Line":0}},{"line":209,"address":[12675305,12670463,12674446,12673373,12675363,12673152,12673239,12673675,12675369,12675120],"length":1,"stats":{"Line":0}},{"line":210,"address":[12886495,12886427],"length":1,"stats":{"Line":0}},{"line":212,"address":[12884981],"length":1,"stats":{"Line":0}},{"line":213,"address":[12673828],"length":1,"stats":{"Line":0}},{"line":214,"address":[12673897],"length":1,"stats":{"Line":0}},{"line":215,"address":[12673950,12674324],"length":1,"stats":{"Line":0}},{"line":216,"address":[12885374,12885463],"length":1,"stats":{"Line":0}},{"line":219,"address":[12885107,12885786,12885619,12881604],"length":1,"stats":{"Line":0}},{"line":220,"address":[12674753],"length":1,"stats":{"Line":0}},{"line":225,"address":[13103120,13103123],"length":1,"stats":{"Line":0}},{"line":226,"address":[14804975],"length":1,"stats":{"Line":0}},{"line":227,"address":[12662892],"length":1,"stats":{"Line":0}},{"line":228,"address":[14805116],"length":1,"stats":{"Line":0}},{"line":229,"address":[12662973,12663051],"length":1,"stats":{"Line":0}},{"line":230,"address":[14805267,14805324,14805026,14805352,14806072],"length":1,"stats":{"Line":0}},{"line":231,"address":[12874572,12874401],"length":1,"stats":{"Line":0}},{"line":232,"address":[12874696],"length":1,"stats":{"Line":0}},{"line":235,"address":[12874656,12874739],"length":1,"stats":{"Line":0}},{"line":236,"address":[12663791],"length":1,"stats":{"Line":0}},{"line":238,"address":[14805708],"length":1,"stats":{"Line":0}},{"line":241,"address":[15045005,15044999,15044592],"length":1,"stats":{"Line":1}},{"line":246,"address":[12044242],"length":1,"stats":{"Line":1}},{"line":247,"address":[15044962,15044727],"length":1,"stats":{"Line":2}},{"line":252,"address":[14808558,14808544],"length":1,"stats":{"Line":3}},{"line":255,"address":[12044432,12044638],"length":1,"stats":{"Line":2}},{"line":256,"address":[13113808],"length":1,"stats":{"Line":1}},{"line":258,"address":[12045118],"length":1,"stats":{"Line":1}},{"line":259,"address":[15045184],"length":1,"stats":{"Line":1}},{"line":260,"address":[12044797],"length":1,"stats":{"Line":1}},{"line":262,"address":[15045190],"length":1,"stats":{"Line":1}},{"line":264,"address":[13114041,13113974],"length":1,"stats":{"Line":2}},{"line":265,"address":[12044948],"length":1,"stats":{"Line":1}},{"line":266,"address":[15045440,15045387],"length":1,"stats":{"Line":2}},{"line":267,"address":[12045001],"length":1,"stats":{"Line":1}},{"line":269,"address":[12044970,12045065],"length":1,"stats":{"Line":2}},{"line":274,"address":[13112304],"length":1,"stats":{"Line":1}},{"line":275,"address":[13112357],"length":1,"stats":{"Line":1}},{"line":276,"address":[15043732],"length":1,"stats":{"Line":1}},{"line":277,"address":[12043442,12043576,12043419],"length":1,"stats":{"Line":3}},{"line":278,"address":[12043578,12043444,12043518],"length":1,"stats":{"Line":2}},{"line":280,"address":[15043829],"length":1,"stats":{"Line":1}},{"line":284,"address":[15042704,15043532,15043560],"length":1,"stats":{"Line":1}},{"line":285,"address":[13111563,13111482],"length":1,"stats":{"Line":2}},{"line":286,"address":[13111591],"length":1,"stats":{"Line":1}},{"line":288,"address":[15043317],"length":1,"stats":{"Line":1}},{"line":289,"address":[15042962],"length":1,"stats":{"Line":1}},{"line":290,"address":[15042996],"length":1,"stats":{"Line":1}},{"line":292,"address":[15042968],"length":1,"stats":{"Line":0}},{"line":294,"address":[13111819,13111752],"length":1,"stats":{"Line":2}},{"line":295,"address":[12042744],"length":1,"stats":{"Line":1}},{"line":296,"address":[12042762,12042815],"length":1,"stats":{"Line":2}},{"line":297,"address":[13111920],"length":1,"stats":{"Line":1}},{"line":299,"address":[12042766,12042861],"length":1,"stats":{"Line":0}},{"line":304,"address":[12047203,12047142,12046128],"length":1,"stats":{"Line":0}},{"line":305,"address":[15046577],"length":1,"stats":{"Line":0}},{"line":306,"address":[13115341],"length":1,"stats":{"Line":0}},{"line":308,"address":[12046370],"length":1,"stats":{"Line":0}},{"line":309,"address":[12046426],"length":1,"stats":{"Line":0}},{"line":311,"address":[12046474,12046404],"length":1,"stats":{"Line":0}},{"line":312,"address":[13115658],"length":1,"stats":{"Line":0}},{"line":314,"address":[12046722],"length":1,"stats":{"Line":0}},{"line":315,"address":[13116004],"length":1,"stats":{"Line":0}},{"line":316,"address":[12047025,12046759],"length":1,"stats":{"Line":0}},{"line":317,"address":[15047252,15047381],"length":1,"stats":{"Line":0}},{"line":324,"address":[13111245,13108096,13111410],"length":1,"stats":{"Line":1}},{"line":329,"address":[12039138],"length":1,"stats":{"Line":1}},{"line":330,"address":[13111405,13108532,13108392],"length":1,"stats":{"Line":1}},{"line":331,"address":[12665499,12665567],"length":1,"stats":{"Line":0}},{"line":333,"address":[15039841],"length":1,"stats":{"Line":1}},{"line":334,"address":[15039993,15039907],"length":1,"stats":{"Line":2}},{"line":335,"address":[13109478,13108995,13110362,13110139,13111251,13109196,13109916,13109101,13109697,13108944,13109169,13110585],"length":1,"stats":{"Line":3}},{"line":336,"address":[12040046,12040122],"length":1,"stats":{"Line":2}},{"line":346,"address":[13110806,13110877],"length":1,"stats":{"Line":2}},{"line":348,"address":[12876905,12876963,12876720,12876969],"length":1,"stats":{"Line":1}},{"line":349,"address":[12876747,12876815],"length":1,"stats":{"Line":0}},{"line":351,"address":[13111081],"length":1,"stats":{"Line":1}}],"covered":71,"coverable":160},{"path":["/","root","code","nuclaw","src","db.rs"],"content":"//! Database module for NuClaw\n//!\n//! Provides SQLite database operations with connection pooling.\n//! Uses r2d2 for connection management and rusqlite for SQLite access.\n\nuse crate::config::store_dir;\nuse crate::error::NuClawError;\nuse r2d2::{Pool, PooledConnection};\nuse r2d2_sqlite::SqliteConnectionManager;\nuse rusqlite::Connection;\nuse std::path::PathBuf;\n\n/// Database configuration\n#[derive(Debug, Clone)]\npub struct DatabaseConfig {\n    /// Maximum pool size\n    pub pool_size: u32,\n    /// Connection timeout in milliseconds\n    pub connection_timeout_ms: u64,\n    /// Database file path\n    pub db_path: PathBuf,\n}\n\nimpl Default for DatabaseConfig {\n    fn default() -\u003e Self {\n        Self {\n            pool_size: std::env::var(\"DB_POOL_SIZE\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(10),\n            connection_timeout_ms: std::env::var(\"DB_CONNECTION_TIMEOUT_MS\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(30000),\n            db_path: store_dir().join(\"nuclaw.db\"),\n        }\n    }\n}\n\n/// Database wrapper with connection pool\n#[derive(Clone, Debug)]\npub struct Database {\n    pool: Pool\u003cSqliteConnectionManager\u003e,\n    config: DatabaseConfig,\n}\n\nimpl Database {\n    /// Create a new Database with default config\n    pub fn new() -\u003e Result\u003cSelf, NuClawError\u003e {\n        Self::with_config(DatabaseConfig::default())\n    }\n\n    /// Create a new Database with custom config\n    pub fn with_config(config: DatabaseConfig) -\u003e Result\u003cSelf, NuClawError\u003e {\n        let manager = SqliteConnectionManager::file(\u0026config.db_path).with_init(|conn| {\n            conn.pragma_update(None, \"foreign_keys\", \"ON\")?;\n            conn.pragma_update(None, \"journal_mode\", \"WAL\")?;\n            conn.pragma_update(None, \"synchronous\", \"NORMAL\")?;\n            Ok(())\n        });\n\n        let pool = Pool::builder()\n            .max_size(config.pool_size)\n            .connection_timeout(std::time::Duration::from_millis(\n                config.connection_timeout_ms,\n            ))\n            .build(manager)\n            .map_err(|e| NuClawError::Database {\n                message: format!(\"Failed to create connection pool: {}\", e),\n            })?;\n\n        let conn = pool.get().map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to get connection: {}\", e),\n        })?;\n        initialize_schema(\u0026conn)?;\n\n        Ok(Database { pool, config })\n    }\n\n    /// Get a connection from the pool\n    pub fn get_connection(\u0026self) -\u003e Result\u003cPooledConnection\u003cSqliteConnectionManager\u003e, NuClawError\u003e {\n        self.pool.get().map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to get connection from pool: {}\", e),\n        })\n    }\n\n    /// Get the database configuration\n    pub fn config(\u0026self) -\u003e \u0026DatabaseConfig {\n        \u0026self.config\n    }\n\n    /// Get pool status\n    pub fn pool_status(\u0026self) -\u003e PoolStatus {\n        let state = self.pool.state();\n        PoolStatus {\n            connections_idle: state.idle_connections,\n            connections_active: state.connections - state.idle_connections,\n            max_size: self.config.pool_size,\n        }\n    }\n}\n\n/// Pool status information\n#[derive(Debug, Clone)]\npub struct PoolStatus {\n    pub connections_idle: u32,\n    pub connections_active: u32,\n    pub max_size: u32,\n}\n\n/// Initialize database schema\nfn initialize_schema(conn: \u0026Connection) -\u003e Result\u003c(), NuClawError\u003e {\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS chats (\n            jid TEXT PRIMARY KEY,\n            name TEXT,\n            last_message_time TEXT\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create chats table: {}\", e),\n    })?;\n\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS messages (\n            id TEXT,\n            chat_jid TEXT,\n            sender TEXT,\n            sender_name TEXT,\n            content TEXT,\n            timestamp TEXT,\n            is_from_me INTEGER DEFAULT 0,\n            PRIMARY KEY (id, chat_jid)\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create messages table: {}\", e),\n    })?;\n\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS scheduled_tasks (\n            id TEXT PRIMARY KEY,\n            group_folder TEXT NOT NULL,\n            chat_jid TEXT NOT NULL,\n            prompt TEXT NOT NULL,\n            schedule_type TEXT NOT NULL,\n            schedule_value TEXT NOT NULL,\n            next_run TEXT,\n            last_run TEXT,\n            last_result TEXT,\n            status TEXT DEFAULT 'active',\n            created_at TEXT NOT NULL,\n            context_mode TEXT DEFAULT 'isolated'\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create scheduled_tasks table: {}\", e),\n    })?;\n\n    conn.execute(\n        \"CREATE TABLE IF NOT EXISTS task_run_logs (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            task_id TEXT NOT NULL,\n            run_at TEXT NOT NULL,\n            duration_ms INTEGER NOT NULL,\n            status TEXT NOT NULL,\n            result TEXT,\n            error TEXT\n        )\",\n        [],\n    )\n    .map_err(|e| NuClawError::Database {\n        message: format!(\"Failed to create task_run_logs table: {}\", e),\n    })?;\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs;\n\n    fn test_db_path() -\u003e PathBuf {\n        store_dir().join(\"test_nuclaw.db\")\n    }\n\n    fn cleanup_test_db(path: \u0026PathBuf) {\n        let _ = fs::remove_file(path);\n        let _ = fs::remove_file(path.with_extension(\"db-wal\"));\n        let _ = fs::remove_file(path.with_extension(\"db-shm\"));\n    }\n\n    #[test]\n    fn test_database_new() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 5,\n            connection_timeout_ms: 5000,\n        };\n\n        let result = Database::with_config(config);\n        assert!(\n            result.is_ok(),\n            \"Database should be created successfully: {:?}\",\n            result.err()\n        );\n\n        // Explicit cleanup\n        drop(result);\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_get_connection() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 3,\n            connection_timeout_ms: 5000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n        let conn = db.get_connection();\n        assert!(conn.is_ok(), \"Should get connection from pool\");\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_concurrent_connections() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 5,\n            connection_timeout_ms: 10000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n\n        let mut handles = Vec::new();\n        for _ in 0..5 {\n            let db_clone = db.clone();\n            handles.push(std::thread::spawn(move || db_clone.get_connection()));\n        }\n\n        let results: Vec\u003cResult\u003cPooledConnection\u003cSqliteConnectionManager\u003e, NuClawError\u003e\u003e =\n            handles.into_iter().map(|h| h.join().unwrap()).collect();\n\n        assert_eq!(results.len(), 5);\n        assert!(\n            results.into_iter().all(|r| r.is_ok()),\n            \"All connections should succeed\"\n        );\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_pool_status() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 10,\n            connection_timeout_ms: 5000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n\n        let status = db.pool_status();\n        assert!(\n            status.connections_idle \u003e= 1,\n            \"Should have at least one idle connection\"\n        );\n        assert_eq!(status.max_size, 10);\n\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_database_config_defaults() {\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n\n        let config = DatabaseConfig::default();\n        assert_eq!(config.pool_size, 10);\n        assert_eq!(config.connection_timeout_ms, 30000);\n\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n    }\n\n    #[test]\n    fn test_database_config_from_env() {\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n\n        let original_pool = std::env::var(\"DB_POOL_SIZE\").ok();\n        let original_timeout = std::env::var(\"DB_CONNECTION_TIMEOUT_MS\").ok();\n        assert!(original_pool.is_none());\n        assert!(original_timeout.is_none());\n\n        std::env::set_var(\"DB_POOL_SIZE\", \"20\");\n        std::env::set_var(\"DB_CONNECTION_TIMEOUT_MS\", \"60000\");\n\n        let config = DatabaseConfig::default();\n        assert_eq!(config.pool_size, 20);\n        assert_eq!(config.connection_timeout_ms, 60000);\n\n        std::env::remove_var(\"DB_POOL_SIZE\");\n        std::env::remove_var(\"DB_CONNECTION_TIMEOUT_MS\");\n    }\n\n    #[test]\n    fn test_schema_initialization() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 3,\n            connection_timeout_ms: 5000,\n        };\n\n        let db = Database::with_config(config).unwrap();\n        let conn = db.get_connection().unwrap();\n\n        let tables: Vec\u003cString\u003e = conn\n            .prepare(\"SELECT name FROM sqlite_master WHERE type='table'\")\n            .unwrap()\n            .query_map([], |row| row.get::\u003c_, String\u003e(0))\n            .unwrap()\n            .collect::\u003cResult\u003cVec\u003cString\u003e, _\u003e\u003e()\n            .unwrap();\n\n        assert!(tables.contains(\u0026\"chats\".to_string()));\n        assert!(tables.contains(\u0026\"messages\".to_string()));\n        assert!(tables.contains(\u0026\"scheduled_tasks\".to_string()));\n        assert!(tables.contains(\u0026\"task_run_logs\".to_string()));\n\n        cleanup_test_db(\u0026db_path);\n    }\n\n    #[test]\n    fn test_clone_database() {\n        let db_path = test_db_path();\n        cleanup_test_db(\u0026db_path);\n\n        let config = DatabaseConfig {\n            db_path: db_path.clone(),\n            pool_size: 3,\n            connection_timeout_ms: 5000,\n        };\n\n        let db1 = Database::with_config(config.clone()).unwrap();\n        let db2 = db1.clone();\n\n        assert!(db1.get_connection().is_ok());\n        assert!(db2.get_connection().is_ok());\n\n        cleanup_test_db(\u0026db_path);\n    }\n}\n","traces":[{"line":25,"address":[14156612,14156606,14156176],"length":1,"stats":{"Line":2}},{"line":27,"address":[12212544],"length":1,"stats":{"Line":2}},{"line":31,"address":[12212655],"length":1,"stats":{"Line":2}},{"line":35,"address":[14156394,14156492],"length":1,"stats":{"Line":4}},{"line":49,"address":[12215584],"length":1,"stats":{"Line":2}},{"line":50,"address":[12786573],"length":1,"stats":{"Line":2}},{"line":54,"address":[14157648,14159116,14159014],"length":1,"stats":{"Line":2}},{"line":55,"address":[12785203,12785094],"length":1,"stats":{"Line":10}},{"line":56,"address":[14831422],"length":1,"stats":{"Line":4}},{"line":57,"address":[14831590],"length":1,"stats":{"Line":4}},{"line":58,"address":[12900493],"length":1,"stats":{"Line":4}},{"line":59,"address":[12900673],"length":1,"stats":{"Line":2}},{"line":62,"address":[12785382,12785226,12785528,12786412,12785600],"length":1,"stats":{"Line":6}},{"line":63,"address":[12214216],"length":1,"stats":{"Line":2}},{"line":64,"address":[12785406,12785319],"length":1,"stats":{"Line":4}},{"line":65,"address":[14157907],"length":1,"stats":{"Line":2}},{"line":67,"address":[12785421],"length":1,"stats":{"Line":2}},{"line":68,"address":[12899552,12899737,12899790],"length":1,"stats":{"Line":2}},{"line":69,"address":[12899574,12899642],"length":1,"stats":{"Line":0}},{"line":72,"address":[12786364,12785834,12785737,12785673],"length":1,"stats":{"Line":4}},{"line":73,"address":[12899846,12899914],"length":1,"stats":{"Line":0}},{"line":75,"address":[12786004,12785939],"length":1,"stats":{"Line":4}},{"line":77,"address":[14158778],"length":1,"stats":{"Line":2}},{"line":81,"address":[14159152],"length":1,"stats":{"Line":2}},{"line":82,"address":[12786505],"length":1,"stats":{"Line":2}},{"line":83,"address":[12001190,12001126],"length":1,"stats":{"Line":0}},{"line":88,"address":[14159296],"length":1,"stats":{"Line":0}},{"line":93,"address":[12213872],"length":1,"stats":{"Line":1}},{"line":94,"address":[12213904],"length":1,"stats":{"Line":1}},{"line":97,"address":[12785048,12784997],"length":1,"stats":{"Line":1}},{"line":98,"address":[12785032],"length":1,"stats":{"Line":1}},{"line":112,"address":[14156640],"length":1,"stats":{"Line":2}},{"line":113,"address":[12784244,12784110,12784147],"length":1,"stats":{"Line":4}},{"line":121,"address":[11999216,11999450,11999397],"length":1,"stats":{"Line":2}},{"line":122,"address":[12898486,12898554],"length":1,"stats":{"Line":0}},{"line":125,"address":[14156851,14156899,14157018],"length":1,"stats":{"Line":4}},{"line":138,"address":[12898736,12898921,12898974],"length":1,"stats":{"Line":2}},{"line":139,"address":[12898758,12898826],"length":1,"stats":{"Line":0}},{"line":142,"address":[12213417,12213584,12213465],"length":1,"stats":{"Line":4}},{"line":159,"address":[12899518,12899280,12899465],"length":1,"stats":{"Line":2}},{"line":160,"address":[11999814,11999750],"length":1,"stats":{"Line":0}},{"line":163,"address":[12784753,12784707,12784871],"length":1,"stats":{"Line":4}},{"line":175,"address":[12213657],"length":1,"stats":{"Line":2}},{"line":176,"address":[12899030,12899098],"length":1,"stats":{"Line":0}},{"line":179,"address":[12213842],"length":1,"stats":{"Line":2}}],"covered":37,"coverable":45},{"path":["/","root","code","nuclaw","src","error.rs"],"content":"//! Error handling for NuClaw\n\nuse thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum NuClawError {\n    #[error(\"Database error: {message}\")]\n    Database { message: String },\n\n    #[error(\"Container error: {message}\")]\n    Container { message: String },\n\n    #[error(\"WhatsApp error: {message}\")]\n    WhatsApp { message: String },\n\n    #[error(\"Telegram error: {message}\")]\n    Telegram { message: String },\n\n    #[error(\"Configuration error: {message}\")]\n    Config { message: String },\n\n    #[error(\"File system error: {message}\")]\n    FileSystem { message: String },\n\n    #[error(\"Validation error: {message}\")]\n    Validation { message: String },\n\n    #[error(\"Timeout error: {operation}\")]\n    Timeout { operation: String },\n\n    #[error(\"Authentication error: {message}\")]\n    Auth { message: String },\n\n    #[error(\"Scheduler error: {message}\")]\n    Scheduler { message: String },\n}\n\npub type Result\u003cT\u003e = std::result::Result\u003cT, NuClawError\u003e;\n\nimpl From\u003crusqlite::Error\u003e for NuClawError {\n    fn from(e: rusqlite::Error) -\u003e Self {\n        NuClawError::Database {\n            message: e.to_string(),\n        }\n    }\n}\n\nimpl From\u003cstd::io::Error\u003e for NuClawError {\n    fn from(e: std::io::Error) -\u003e Self {\n        NuClawError::FileSystem {\n            message: e.to_string(),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_error_display() {\n        let err = NuClawError::Database {\n            message: \"test error\".to_string(),\n        };\n        let msg = format!(\"{}\", err);\n        assert!(msg.contains(\"Database error\"));\n        assert!(msg.contains(\"test error\"));\n    }\n\n    #[test]\n    fn test_error_from_sqlite() {\n        let sqlite_err = rusqlite::Error::SqliteFailure(\n            rusqlite::ffi::Error {\n                code: rusqlite::ErrorCode::DatabaseBusy,\n                extended_code: 5,\n            },\n            Some(\"busy\".to_string()),\n        );\n        let err: NuClawError = sqlite_err.into();\n        match err {\n            NuClawError::Database { message } =\u003e {\n                assert!(message.contains(\"busy\"));\n            }\n            _ =\u003e panic!(\"Expected Database error\"),\n        }\n    }\n\n    #[test]\n    fn test_error_from_io() {\n        let io_err = std::io::Error::new(std::io::ErrorKind::NotFound, \"file not found\");\n        let err: NuClawError = io_err.into();\n        match err {\n            NuClawError::FileSystem { message } =\u003e {\n                assert!(message.contains(\"file not found\"));\n            }\n            _ =\u003e panic!(\"Expected FileSystem error\"),\n        }\n    }\n\n    #[test]\n    fn test_all_error_variants() {\n        // Test that all error variants can be created\n        let _ = NuClawError::Database {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Container {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::WhatsApp {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Telegram {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Config {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::FileSystem {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Validation {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Timeout {\n            operation: \"test\".to_string(),\n        };\n        let _ = NuClawError::Auth {\n            message: \"test\".to_string(),\n        };\n        let _ = NuClawError::Scheduler {\n            message: \"test\".to_string(),\n        };\n    }\n}\n","traces":[{"line":38,"address":[19745053,19745167,19745010,19745203],"length":1,"stats":{"Line":0}},{"line":40,"address":[26097871],"length":1,"stats":{"Line":0}},{"line":41,"address":[14990751,14990624],"length":1,"stats":{"Line":0}},{"line":43,"address":[25227680],"length":1,"stats":{"Line":0}},{"line":48,"address":[16224322],"length":1,"stats":{"Line":0}},{"line":49,"address":[13059184,13059322,13059316],"length":1,"stats":{"Line":0}},{"line":51,"address":[13059203],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","root","code","nuclaw","src","lib.rs"],"content":"//!\n//! A Rust implementation of NanoClaw project structure.\n//! Features:\n//! - WhatsApp integration via MCP\n//! - Telegram integration via Bot API\n//! - Containerized agent execution\n//! - Scheduled task management\n//! - SQLite persistence\n\npub mod config;\npub mod container_runner;\npub mod db;\npub mod error;\npub mod logging;\npub mod task_scheduler;\npub mod telegram;\npub mod types;\npub mod utils;\npub mod whatsapp;\n\n// Re-exports for convenience\npub use config::ensure_directories;\npub use container_runner::{\n    container_timeout, create_group_ipc_directory, ensure_container_system_running,\n    max_output_size, run_container,\n};\npub use error::{NuClawError, Result};\npub use task_scheduler::TaskScheduler;\n","traces":[],"covered":0,"coverable":0},{"path":["/","root","code","nuclaw","src","logging.rs"],"content":"//! Logging module for NuClaw\n//!\n//! Provides unified logging initialization with support for both\n//! env_logger and tracing integration.\n\nuse log::LevelFilter;\nuse std::sync::OnceLock;\n\n/// Global logging initialization status\nstatic LOG_INIT: OnceLock\u003c()\u003e = OnceLock::new();\n\n/// Logging configuration\n#[derive(Debug, Clone)]\npub struct LoggingConfig {\n    /// Default log level\n    pub level: Level,\n    /// Whether to use JSON formatting\n    pub json_format: bool,\n    /// Whether to include timestamps\n    pub include_timestamp: bool,\n}\n\n/// Log level enumeration\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum Level {\n    /// Trace level (most verbose)\n    Trace,\n    /// Debug level\n    Debug,\n    /// Info level (default)\n    Info,\n    /// Warning level\n    Warn,\n    /// Error level\n    Error,\n    /// Disable logging\n    Off,\n}\n\nimpl Default for LoggingConfig {\n    fn default() -\u003e Self {\n        Self {\n            level: Level::from_env().unwrap_or(Level::Info),\n            json_format: std::env::var(\"NUCLAW_LOG_JSON\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(false),\n            include_timestamp: true,\n        }\n    }\n}\n\nimpl Level {\n    /// Get log level from RUST_LOG environment variable\n    pub fn from_env() -\u003e Option\u003cSelf\u003e {\n        let rust_log = std::env::var(\"RUST_LOG\").ok()?;\n        Self::from_env_str(\u0026rust_log)\n    }\n\n    /// Parse level from string (for env vars)\n    pub fn from_env_str(s: \u0026str) -\u003e Option\u003cSelf\u003e {\n        match s.to_lowercase().as_str() {\n            \"trace\" =\u003e Some(Level::Trace),\n            \"debug\" =\u003e Some(Level::Debug),\n            \"info\" =\u003e Some(Level::Info),\n            \"warn\" | \"warning\" =\u003e Some(Level::Warn),\n            \"error\" =\u003e Some(Level::Error),\n            \"off\" =\u003e Some(Level::Off),\n            _ =\u003e None,\n        }\n    }\n\n    /// Convert to LevelFilter\n    fn to_filter(self) -\u003e LevelFilter {\n        match self {\n            Level::Trace =\u003e LevelFilter::Trace,\n            Level::Debug =\u003e LevelFilter::Debug,\n            Level::Info =\u003e LevelFilter::Info,\n            Level::Warn =\u003e LevelFilter::Warn,\n            Level::Error =\u003e LevelFilter::Error,\n            Level::Off =\u003e LevelFilter::Off,\n        }\n    }\n}\n\n/// Initialize logging with default configuration\npub fn init() {\n    init_with_config(LoggingConfig::default());\n}\n\n/// Initialize logging with custom configuration\npub fn init_with_config(config: LoggingConfig) {\n    // Ensure logging is only initialized once\n    let _ = LOG_INIT.get_or_init(|| {\n        setup_logging(\u0026config);\n    });\n}\n\n/// Setup logging based on configuration\nfn setup_logging(config: \u0026LoggingConfig) {\n    // Set RUST_LOG for env_logger\n    std::env::set_var(\"RUST_LOG\", format!(\"{}\", config.level).to_lowercase());\n\n    // Clone config for the closure\n    let config = config.clone();\n\n    // Initialize env_logger with custom format\n    env_logger::Builder::from_default_env()\n        .format_timestamp(None)\n        .format(move |buf, record| {\n            use std::io::Write;\n\n            let timestamp = if config.include_timestamp {\n                let now = chrono::Utc::now();\n                Some(format!(\"[{}]\", now.to_rfc3339()))\n            } else {\n                None\n            };\n\n            let level = match record.level() {\n                log::Level::Error =\u003e \"ERROR\",\n                log::Level::Warn =\u003e \"WARN\",\n                log::Level::Info =\u003e \"INFO\",\n                log::Level::Debug =\u003e \"DEBUG\",\n                log::Level::Trace =\u003e \"TRACE\",\n            };\n\n            if config.json_format {\n                // JSON format for structured logging\n                let output = serde_json::json!({\n                    \"timestamp\": chrono::Utc::now().to_rfc3339(),\n                    \"level\": level,\n                    \"message\": record.args(),\n                    \"module\": record.module_path().unwrap_or(\"unknown\"),\n                    \"file\": record.file().unwrap_or(\"unknown\"),\n                    \"line\": record.line(),\n                });\n                writeln!(buf, \"{}\", output)\n            } else {\n                // Human-readable format\n                let mut output = String::new();\n                if let Some(ts) = timestamp {\n                    output.push_str(\u0026ts);\n                    output.push(' ');\n                }\n                output.push_str(level);\n                output.push_str(\": \");\n                output.push_str(\u0026format!(\"{}\", record.args()));\n                writeln!(buf, \"{}\", output)\n            }\n        })\n        .filter(None, config.level.to_filter())\n        .init();\n}\n\n/// Check if logging has been initialized\npub fn is_initialized() -\u003e bool {\n    LOG_INIT.get().is_some()\n}\n\n/// Get current log level from environment\npub fn get_log_level() -\u003e Level {\n    Level::from_env().unwrap_or(Level::Info)\n}\n\nimpl std::fmt::Display for Level {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            Level::Trace =\u003e write!(f, \"trace\"),\n            Level::Debug =\u003e write!(f, \"debug\"),\n            Level::Info =\u003e write!(f, \"info\"),\n            Level::Warn =\u003e write!(f, \"warn\"),\n            Level::Error =\u003e write!(f, \"error\"),\n            Level::Off =\u003e write!(f, \"off\"),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_level_from_str() {\n        assert_eq!(Level::from_env_str(\"trace\"), Some(Level::Trace));\n        assert_eq!(Level::from_env_str(\"debug\"), Some(Level::Debug));\n        assert_eq!(Level::from_env_str(\"info\"), Some(Level::Info));\n        assert_eq!(Level::from_env_str(\"warn\"), Some(Level::Warn));\n        assert_eq!(Level::from_env_str(\"warning\"), Some(Level::Warn));\n        assert_eq!(Level::from_env_str(\"error\"), Some(Level::Error));\n        assert_eq!(Level::from_env_str(\"off\"), Some(Level::Off));\n        assert_eq!(Level::from_env_str(\"invalid\"), None);\n    }\n\n    #[test]\n    fn test_level_display() {\n        assert_eq!(format!(\"{}\", Level::Trace), \"trace\");\n        assert_eq!(format!(\"{}\", Level::Debug), \"debug\");\n        assert_eq!(format!(\"{}\", Level::Info), \"info\");\n        assert_eq!(format!(\"{}\", Level::Warn), \"warn\");\n        assert_eq!(format!(\"{}\", Level::Error), \"error\");\n        assert_eq!(format!(\"{}\", Level::Off), \"off\");\n    }\n\n    #[test]\n    fn test_logging_config_defaults() {\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n        let config = LoggingConfig::default();\n        assert!(!config.json_format);\n        assert!(config.include_timestamp);\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n    }\n\n    #[test]\n    fn test_logging_config_from_env() {\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n\n        let original_json = std::env::var(\"NUCLAW_LOG_JSON\").ok();\n        assert!(original_json.is_none());\n\n        std::env::set_var(\"NUCLAW_LOG_JSON\", \"true\");\n        let config = LoggingConfig::default();\n        assert!(config.json_format);\n\n        std::env::remove_var(\"NUCLAW_LOG_JSON\");\n    }\n\n    #[test]\n    fn test_is_initialized() {\n        // is_initialized() is safe to call even if not initialized\n        let _ = is_initialized();\n    }\n\n    #[test]\n    fn test_get_log_level() {\n        // Save original\n        let original = std::env::var(\"RUST_LOG\").ok();\n\n        std::env::remove_var(\"RUST_LOG\");\n        let level = get_log_level();\n        assert_eq!(level, Level::Info);\n\n        std::env::set_var(\"RUST_LOG\", \"debug\");\n        let level = get_log_level();\n        assert_eq!(level, Level::Debug);\n\n        // Restore\n        match original {\n            Some(v) =\u003e std::env::set_var(\"RUST_LOG\", v),\n            None =\u003e std::env::remove_var(\"RUST_LOG\"),\n        }\n    }\n\n    #[test]\n    fn test_init_with_config() {\n        let config = LoggingConfig {\n            level: Level::Debug,\n            json_format: false,\n            include_timestamp: false,\n        };\n\n        // Should not panic\n        init_with_config(config);\n        assert!(is_initialized());\n    }\n}\n","traces":[{"line":41,"address":[14376864],"length":1,"stats":{"Line":1}},{"line":43,"address":[13018340],"length":1,"stats":{"Line":1}},{"line":44,"address":[13018362],"length":1,"stats":{"Line":1}},{"line":55,"address":[14376727,14376733,14376448],"length":1,"stats":{"Line":1}},{"line":56,"address":[13017927],"length":1,"stats":{"Line":1}},{"line":57,"address":[13018087,13018152],"length":1,"stats":{"Line":2}},{"line":61,"address":[14376431,14376425,14375936],"length":1,"stats":{"Line":1}},{"line":62,"address":[14376042,14375956],"length":1,"stats":{"Line":2}},{"line":63,"address":[13017596,13017530],"length":1,"stats":{"Line":2}},{"line":64,"address":[13017649,13017573,13017610],"length":1,"stats":{"Line":3}},{"line":65,"address":[14376230,14376154,14376191],"length":1,"stats":{"Line":3}},{"line":66,"address":[14376244,14376207],"length":1,"stats":{"Line":2}},{"line":67,"address":[14376310,14376376],"length":1,"stats":{"Line":2}},{"line":68,"address":[13017872,13017825,13017859],"length":1,"stats":{"Line":3}},{"line":69,"address":[13017865],"length":1,"stats":{"Line":1}},{"line":74,"address":[12445472],"length":1,"stats":{"Line":1}},{"line":75,"address":[14376759],"length":1,"stats":{"Line":1}},{"line":76,"address":[12445510],"length":1,"stats":{"Line":0}},{"line":77,"address":[14376801],"length":1,"stats":{"Line":1}},{"line":78,"address":[14376812],"length":1,"stats":{"Line":0}},{"line":79,"address":[12445543],"length":1,"stats":{"Line":0}},{"line":80,"address":[14376834],"length":1,"stats":{"Line":0}},{"line":81,"address":[13018317],"length":1,"stats":{"Line":0}},{"line":87,"address":[13017312],"length":1,"stats":{"Line":0}},{"line":88,"address":[14375844],"length":1,"stats":{"Line":0}},{"line":92,"address":[13017248],"length":1,"stats":{"Line":1}},{"line":94,"address":[12444533],"length":1,"stats":{"Line":2}},{"line":95,"address":[12911157],"length":1,"stats":{"Line":1}},{"line":100,"address":[14375152,14375711,14375717],"length":1,"stats":{"Line":1}},{"line":102,"address":[13016663],"length":1,"stats":{"Line":1}},{"line":105,"address":[13016920],"length":1,"stats":{"Line":1}},{"line":108,"address":[12444216],"length":1,"stats":{"Line":1}},{"line":109,"address":[12444243],"length":1,"stats":{"Line":1}},{"line":110,"address":[12679728,12680802,12683504],"length":1,"stats":{"Line":1}},{"line":113,"address":[12907335,12907423,12907753],"length":1,"stats":{"Line":0}},{"line":114,"address":[12679873],"length":1,"stats":{"Line":0}},{"line":115,"address":[12907544,12907458],"length":1,"stats":{"Line":0}},{"line":117,"address":[14838677],"length":1,"stats":{"Line":0}},{"line":120,"address":[12679970,12680276],"length":1,"stats":{"Line":0}},{"line":121,"address":[12907869],"length":1,"stats":{"Line":0}},{"line":122,"address":[12680342],"length":1,"stats":{"Line":0}},{"line":123,"address":[14839207],"length":1,"stats":{"Line":0}},{"line":124,"address":[12907956],"length":1,"stats":{"Line":0}},{"line":125,"address":[14839265],"length":1,"stats":{"Line":0}},{"line":128,"address":[12680464],"length":1,"stats":{"Line":0}},{"line":130,"address":[12681781,12682678,12681500,12680492,12681420,12682370,12682552,12682937,12681311,12681507,12682858,12683362,12681992,12682062,12682244],"length":1,"stats":{"Line":0}},{"line":131,"address":[12909017,12908957],"length":1,"stats":{"Line":0}},{"line":133,"address":[14840839,14840897],"length":1,"stats":{"Line":0}},{"line":134,"address":[12682227,12682295],"length":1,"stats":{"Line":0}},{"line":135,"address":[14841410,14841478],"length":1,"stats":{"Line":0}},{"line":136,"address":[14841726,14841790],"length":1,"stats":{"Line":0}},{"line":138,"address":[14842019,14842090],"length":1,"stats":{"Line":0}},{"line":141,"address":[12680477],"length":1,"stats":{"Line":0}},{"line":142,"address":[12680502],"length":1,"stats":{"Line":0}},{"line":143,"address":[12908265,12908143],"length":1,"stats":{"Line":0}},{"line":144,"address":[12908285],"length":1,"stats":{"Line":0}},{"line":146,"address":[12908166],"length":1,"stats":{"Line":0}},{"line":147,"address":[12908364],"length":1,"stats":{"Line":0}},{"line":148,"address":[12680843],"length":1,"stats":{"Line":0}},{"line":149,"address":[12681124],"length":1,"stats":{"Line":0}},{"line":152,"address":[12444345],"length":1,"stats":{"Line":1}},{"line":157,"address":[12444464],"length":1,"stats":{"Line":1}},{"line":158,"address":[12444465],"length":1,"stats":{"Line":1}},{"line":162,"address":[12443840],"length":1,"stats":{"Line":1}},{"line":163,"address":[13016609],"length":1,"stats":{"Line":1}},{"line":167,"address":[13015936],"length":1,"stats":{"Line":1}},{"line":168,"address":[12443195],"length":1,"stats":{"Line":1}},{"line":169,"address":[12443226],"length":1,"stats":{"Line":1}},{"line":170,"address":[13016037],"length":1,"stats":{"Line":1}},{"line":171,"address":[12443312],"length":1,"stats":{"Line":1}},{"line":172,"address":[12443355],"length":1,"stats":{"Line":1}},{"line":173,"address":[12443401],"length":1,"stats":{"Line":1}},{"line":174,"address":[12443447],"length":1,"stats":{"Line":1}}],"covered":40,"coverable":73},{"path":["/","root","code","nuclaw","src","main.rs"],"content":"//!\n//! A Rust implementation of NanoClaw project structure.\n//! Features:\n//! - WhatsApp integration via MCP\n//! - Telegram integration via Bot API\n//! - Containerized agent execution\n//! - Scheduled task management\n//! - SQLite persistence\n\nuse nuclaw::config;\nuse nuclaw::container_runner::{self, ensure_container_system_running};\nuse nuclaw::db;\nuse nuclaw::error::{NuClawError, Result};\nuse nuclaw::logging;\nuse nuclaw::task_scheduler::TaskScheduler;\nuse nuclaw::telegram;\nuse nuclaw::whatsapp;\n\nuse structopt::StructOpt;\nuse tokio::signal;\nuse tracing::info;\n\n#[derive(StructOpt, Debug)]\nstruct Args {\n    #[structopt(long)]\n    auth: bool,\n\n    #[structopt(long)]\n    scheduler: bool,\n\n    #[structopt(long)]\n    whatsapp: bool,\n\n    #[structopt(long)]\n    telegram: bool,\n}\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c()\u003e {\n    let args = Args::from_args();\n\n    // Initialize logging\n    logging::init();\n\n    info!(\"Starting NuClaw v1.0.0\");\n    info!(\"This is a Rust port of NanoClaw\");\n\n    // Ensure directories exist\n    config::ensure_directories().map_err(|e| NuClawError::FileSystem {\n        message: e.to_string(),\n    })?;\n\n    // Initialize database\n    let db = db::Database::new().map_err(|e| NuClawError::Database {\n        message: e.to_string(),\n    })?;\n    info!(\"Database initialized successfully\");\n\n    // Handle different modes\n    if args.scheduler {\n        // Run task scheduler\n        run_scheduler(db).await?;\n    } else if args.whatsapp {\n        // Run WhatsApp bot\n        run_whatsapp_bot(db).await?;\n    } else if args.telegram {\n        // Run Telegram bot\n        run_telegram_bot(db).await?;\n    } else if args.auth {\n        // Show authentication QR code\n        run_auth_flow().await?;\n    } else {\n        // Default: run main application with all features\n        run_main_application(db).await?;\n    }\n\n    Ok(())\n}\n\n/// Run the main application with all features\nasync fn run_main_application(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Running main application...\");\n\n    // Ensure container system is running\n    ensure_container_system_running().ok();\n\n    // Setup signal handlers for graceful shutdown\n    let (shutdown_tx, mut shutdown_rx) = tokio::sync::mpsc::channel::\u003c()\u003e(1);\n\n    // Clone db for the scheduler\n    let scheduler_db = db.clone();\n\n    // Run scheduler in background\n    let scheduler_handle = tokio::spawn(async move {\n        let mut scheduler = TaskScheduler::new(scheduler_db);\n        let _ = scheduler.run().await;\n    });\n\n    // Run WhatsApp bot in background\n    let _whatsapp_handle = tokio::spawn(async move {\n        loop {\n            tokio::time::sleep(tokio::time::Duration::from_secs(60)).await;\n        }\n    });\n\n    info!(\"NuClaw is running. Press Ctrl+C to stop.\");\n\n    // Wait for shutdown signal\n    tokio::select! {\n        _ = signal::ctrl_c() =\u003e {\n            info!(\"Received shutdown signal...\");\n        }\n        _ = shutdown_rx.recv() =\u003e {\n            info!(\"Received shutdown signal...\");\n        }\n    }\n\n    // Graceful shutdown\n    let _ = shutdown_tx.send(()).await;\n    scheduler_handle.abort();\n\n    info!(\"NuClaw shutdown complete.\");\n    Ok(())\n}\n\n/// Run the task scheduler\nasync fn run_scheduler(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Starting task scheduler...\");\n\n    let mut scheduler = TaskScheduler::new(db);\n    scheduler.run().await?;\n\n    Ok(())\n}\n\n/// Run the WhatsApp bot\nasync fn run_whatsapp_bot(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Starting WhatsApp bot...\");\n\n    // Check if WhatsApp MCP is configured\n    if std::env::var(\"WHATSAPP_MCP_URL\").is_err() {\n        info!(\"WHATSAPP_MCP_URL not set. Run with --auth to set up authentication.\");\n        info!(\"Then start the WhatsApp MCP server and run with --whatsapp.\");\n        return Ok(());\n    }\n\n    // Create WhatsApp client\n    let mut client = whatsapp::WhatsAppClient::new(db);\n\n    // Connect to WhatsApp\n    client.connect().await?;\n    info!(\"Connected to WhatsApp\");\n\n    // Start message listener\n    client.start_message_listener().await;\n\n    Ok(())\n}\n\n/// Run the authentication flow\nasync fn run_auth_flow() -\u003e Result\u003c()\u003e {\n    info!(\"Starting authentication flow...\");\n\n    whatsapp::start_auth_flow().await;\n    info!(\"Use WHATSAPP_MCP_URL to configure WhatsApp connection\");\n\n    Ok(())\n}\n\n/// Run the Telegram bot\nasync fn run_telegram_bot(db: db::Database) -\u003e Result\u003c()\u003e {\n    info!(\"Starting Telegram bot...\");\n\n    // Check if Telegram bot token is configured\n    if std::env::var(\"TELEGRAM_BOT_TOKEN\").is_err() {\n        info!(\"TELEGRAM_BOT_TOKEN not set. Configure it to use Telegram bot.\");\n        info!(\"Usage:\");\n        info!(\"  export TELEGRAM_BOT_TOKEN=your_bot_token\");\n        info!(\"  export TELEGRAM_WEBHOOK_URL=https://your-domain.com\");\n        info!(\"  ./nuclaw --telegram\");\n        return Ok(());\n    }\n\n    // Create Telegram client\n    let mut client = telegram::TelegramClient::new(db)?;\n\n    // Connect to Telegram\n    client.connect().await?;\n    info!(\"Connected to Telegram\");\n\n    // Start webhook server\n    client.start_webhook_server().await?;\n\n    Ok(())\n}\n","traces":[{"line":39,"address":[12382697,12382691,12382272],"length":1,"stats":{"Line":0}},{"line":40,"address":[12319666,12319465],"length":1,"stats":{"Line":0}},{"line":43,"address":[12319687],"length":1,"stats":{"Line":0}},{"line":45,"address":[12319698,12320137],"length":1,"stats":{"Line":0}},{"line":46,"address":[12320099,12321322,12320927],"length":1,"stats":{"Line":0}},{"line":49,"address":[12324584,12322215,12327554,12327499,12321293,12322121,12327560,12327424],"length":1,"stats":{"Line":0}},{"line":50,"address":[12327442],"length":1,"stats":{"Line":0}},{"line":54,"address":[12322425,12327658,12324568,12322326,12327584,12327708,12322252],"length":1,"stats":{"Line":0}},{"line":55,"address":[12327602],"length":1,"stats":{"Line":0}},{"line":57,"address":[12323030,12322558,12322638],"length":1,"stats":{"Line":0}},{"line":60,"address":[12323004,12325008],"length":1,"stats":{"Line":0}},{"line":62,"address":[12324702,12319516,12323782,12324504,12325045],"length":1,"stats":{"Line":0}},{"line":63,"address":[12325390,12323762],"length":1,"stats":{"Line":0}},{"line":65,"address":[12319537,12325084,12323868,12324424,12325395],"length":1,"stats":{"Line":0}},{"line":66,"address":[12323848,12325714],"length":1,"stats":{"Line":0}},{"line":68,"address":[12234272],"length":1,"stats":{"Line":0}},{"line":69,"address":[12326038,12323934,12326362],"length":1,"stats":{"Line":0}},{"line":71,"address":[12319579,12324095,12325732,12324192,12326043],"length":1,"stats":{"Line":0}},{"line":74,"address":[12234310],"length":1,"stats":{"Line":0}},{"line":77,"address":[12325018],"length":1,"stats":{"Line":0}},{"line":81,"address":[12382176,12382193],"length":1,"stats":{"Line":0}},{"line":82,"address":[12308012,12307470,12307617],"length":1,"stats":{"Line":0}},{"line":85,"address":[12308803,12307983],"length":1,"stats":{"Line":0}},{"line":88,"address":[12308810],"length":1,"stats":{"Line":0}},{"line":91,"address":[12308881],"length":1,"stats":{"Line":0}},{"line":94,"address":[12318027,12308956,12317417,12317503,12317392,12317545,12317731],"length":1,"stats":{"Line":0}},{"line":95,"address":[12317457],"length":1,"stats":{"Line":0}},{"line":96,"address":[12229697],"length":1,"stats":{"Line":0}},{"line":100,"address":[12309081,12316681,12316754,12316656,12317052,12316734,12316929,12309195],"length":1,"stats":{"Line":0}},{"line":102,"address":[12316977,12316772,12316715,12316747],"length":1,"stats":{"Line":0}},{"line":106,"address":[12309690,12309278,12309198],"length":1,"stats":{"Line":0}},{"line":109,"address":[12310552],"length":1,"stats":{"Line":0}},{"line":119,"address":[12235662],"length":1,"stats":{"Line":0}},{"line":120,"address":[12314415],"length":1,"stats":{"Line":0}},{"line":122,"address":[12314426,12314872],"length":1,"stats":{"Line":0}},{"line":123,"address":[12314835],"length":1,"stats":{"Line":0}},{"line":127,"address":[12381984,12382001],"length":1,"stats":{"Line":0}},{"line":128,"address":[12284751,12284625,12285213],"length":1,"stats":{"Line":0}},{"line":130,"address":[12285125],"length":1,"stats":{"Line":0}},{"line":131,"address":[12234772],"length":1,"stats":{"Line":0}},{"line":133,"address":[12286416],"length":1,"stats":{"Line":0}},{"line":137,"address":[12299927,12305656,12299696,12303992,12299758,12299884],"length":1,"stats":{"Line":0}},{"line":138,"address":[12300410,12300003,12299856],"length":1,"stats":{"Line":0}},{"line":141,"address":[12301201,12300369],"length":1,"stats":{"Line":0}},{"line":142,"address":[12302006,12301567],"length":1,"stats":{"Line":0}},{"line":143,"address":[12303186,12301968,12302796],"length":1,"stats":{"Line":0}},{"line":144,"address":[12303162],"length":1,"stats":{"Line":0}},{"line":148,"address":[12301321],"length":1,"stats":{"Line":0}},{"line":151,"address":[12235359],"length":1,"stats":{"Line":0}},{"line":152,"address":[12304358,12304800],"length":1,"stats":{"Line":0}},{"line":155,"address":[12235378],"length":1,"stats":{"Line":0}},{"line":157,"address":[12305968],"length":1,"stats":{"Line":0}},{"line":161,"address":[12280928,12281091,12283823,12280975,12281040,12282449],"length":1,"stats":{"Line":0}},{"line":162,"address":[12281530,12281136,12281012],"length":1,"stats":{"Line":0}},{"line":164,"address":[12281070,12281502,12282320,12282483],"length":1,"stats":{"Line":0}},{"line":165,"address":[12282648,12283138],"length":1,"stats":{"Line":0}},{"line":167,"address":[12283064],"length":1,"stats":{"Line":0}},{"line":171,"address":[12286976,12287186,12295176,12287229,12297366,12287053],"length":1,"stats":{"Line":0}},{"line":172,"address":[12287305,12287158,12287712],"length":1,"stats":{"Line":0}},{"line":175,"address":[12287671,12288503],"length":1,"stats":{"Line":0}},{"line":176,"address":[12289608,12289169],"length":1,"stats":{"Line":0}},{"line":177,"address":[12290398,12290802,12289570],"length":1,"stats":{"Line":0}},{"line":178,"address":[12290764,12291592,12291996],"length":1,"stats":{"Line":0}},{"line":179,"address":[12293190,12291958,12292786],"length":1,"stats":{"Line":0}},{"line":180,"address":[12293152,12293980,12294370],"length":1,"stats":{"Line":0}},{"line":181,"address":[12294346],"length":1,"stats":{"Line":0}},{"line":185,"address":[12289147,12288763,12288623],"length":1,"stats":{"Line":0}},{"line":188,"address":[12235023],"length":1,"stats":{"Line":0}},{"line":189,"address":[12295542,12296029],"length":1,"stats":{"Line":0}},{"line":192,"address":[12235042],"length":1,"stats":{"Line":0}},{"line":194,"address":[12297169],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":71},{"path":["/","root","code","nuclaw","src","task_scheduler.rs"],"content":"//! Task Scheduler - Runs scheduled tasks in isolated containers\n//!\n//! Supports three schedule types:\n//! - `cron`: Cron expression (e.g., \"0 9 * * *\" for daily at 9am)\n//! - `interval`: Fixed interval in milliseconds (e.g., \"3600000\" for 1 hour)\n//! - `once`: Single execution at specific timestamp\n//!\n//! Features:\n//! - Persistent task storage in SQLite\n//! - Task run logging\n//! - Concurrent task execution\n//! - Graceful shutdown\n\nuse crate::config::timezone;\nuse crate::container_runner::{log_container_output, run_container};\nuse crate::db::Database;\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, ContainerOutput, ScheduledTask};\nuse chrono::{DateTime, Utc};\nuse cron::Schedule;\nuse std::str::FromStr;\nuse tokio::sync::mpsc;\nuse tokio::time::{interval, Duration, MissedTickBehavior};\n\n/// Default poll interval: 60 seconds\nconst DEFAULT_POLL_INTERVAL_SECS: u64 = 60;\n/// Max concurrent tasks\nconst MAX_CONCURRENT_TASKS: usize = 4;\n/// Default task timeout: 10 minutes\nconst DEFAULT_TASK_TIMEOUT_SECS: u64 = 600;\n\n/// Get poll interval from environment or default\npub fn poll_interval() -\u003e Duration {\n    let interval_secs = std::env::var(\"SCHEDULER_POLL_INTERVAL\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_POLL_INTERVAL_SECS);\n    Duration::from_secs(interval_secs)\n}\n\n/// Get task timeout from environment or default\npub fn task_timeout() -\u003e Duration {\n    let timeout_secs = std::env::var(\"TASK_TIMEOUT\")\n        .ok()\n        .and_then(|v| v.parse().ok())\n        .unwrap_or(DEFAULT_TASK_TIMEOUT_SECS);\n    Duration::from_secs(timeout_secs)\n}\n\n/// Task scheduler state\n#[derive(Clone)]\npub struct TaskScheduler {\n    db: Database,\n    poll_interval: Duration,\n    task_timeout: Duration,\n}\n\nimpl TaskScheduler {\n    /// Create a new task scheduler\n    pub fn new(db: Database) -\u003e Self {\n        Self {\n            db,\n            poll_interval: poll_interval(),\n            task_timeout: task_timeout(),\n        }\n    }\n\n    /// Run the scheduler loop\n    pub async fn run(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let (shutdown_tx, mut shutdown_rx) = mpsc::channel::\u003c()\u003e(1);\n\n        let mut interval = interval(self.poll_interval);\n        interval.set_missed_tick_behavior(MissedTickBehavior::Skip);\n\n        tracing::info!(\n            \"Task scheduler started with poll interval: {:?}\",\n            self.poll_interval\n        );\n\n        loop {\n            tokio::select! {\n                _ = interval.tick() =\u003e {\n                    if let Err(e) = self.poll_and_execute_tasks().await {\n                        tracing::error!(\"Error executing tasks: {}\", e);\n                    }\n                }\n                _ = shutdown_rx.recv() =\u003e {\n                    tracing::info!(\"Task scheduler shutting down\");\n                    break;\n                }\n                _ = shutdown_tx.closed() =\u003e {\n                    break;\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Poll for due tasks and execute them\n    async fn poll_and_execute_tasks(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let now = Utc::now().to_rfc3339();\n\n        // Load active tasks that are due\n        let tasks = self.load_due_tasks(\u0026now).await?;\n\n        if tasks.is_empty() {\n            tracing::debug!(\"No tasks due for execution\");\n            return Ok(());\n        }\n\n        tracing::info!(\"Found {} tasks due for execution\", tasks.len());\n\n        // Execute tasks concurrently with limit\n        let mut handles = Vec::new();\n        for task in tasks {\n            // Check if we've reached max concurrent tasks\n            while handles.len() \u003e= MAX_CONCURRENT_TASKS {\n                // Wait for at least one to complete\n                let _ = tokio::join!(handles.remove(0));\n            }\n\n            let mut scheduler = TaskScheduler::new(self.db.clone());\n            let handle = tokio::spawn(async move {\n                let result = scheduler.execute_single_task(\u0026task).await;\n                (task.id.clone(), result)\n            });\n            handles.push(handle);\n        }\n\n        // Wait for remaining tasks\n        for handle in handles {\n            let (task_id, result) = handle.await.map_err(|e| NuClawError::Scheduler {\n                message: format!(\"Task execution panic: {}\", e),\n            })?;\n\n            if let Err(e) = \u0026result {\n                tracing::error!(\"Task {} failed: {}\", task_id, e);\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Execute a single task\n    async fn execute_single_task(\u0026mut self, task: \u0026ScheduledTask) -\u003e Result\u003c()\u003e {\n        tracing::info!(\"Executing task: {} (group: {})\", task.id, task.group_folder);\n\n        let start_time = chrono::Utc::now();\n\n        // Verify task is still active (may have been paused/cancelled)\n        let current_task =\n            self.load_task(\u0026task.id)\n                .await?\n                .ok_or_else(|| NuClawError::Scheduler {\n                    message: format!(\"Task {} not found\", task.id),\n                })?;\n\n        if current_task.status != \"active\" {\n            tracing::info!(\"Task {} is no longer active, skipping\", task.id);\n            return Ok(());\n        }\n\n        // Create container input\n        let session_id = format!(\"scheduled_{}\", task.id);\n        let input = ContainerInput {\n            prompt: task.prompt.clone(),\n            session_id: Some(session_id.clone()),\n            group_folder: task.group_folder.clone(),\n            chat_jid: task.chat_jid.clone(),\n            is_main: false,\n            is_scheduled_task: true,\n        };\n\n        // Execute container with timeout\n        let result = tokio::time::timeout(self.task_timeout, run_container(input)).await;\n\n        let end_time = chrono::Utc::now();\n        let duration_ms = (end_time - start_time).num_milliseconds();\n\n        // Process result and log\n        match result {\n            Ok(Ok(output)) =\u003e {\n                // Log successful execution\n                self.log_task_run(task, \u0026output, duration_ms, \"success\")\n                    .await?;\n\n                // Log to file\n                let _ = log_container_output(\u0026task.group_folder, \u0026session_id, \u0026output);\n\n                // Calculate next run time\n                if task.schedule_type == \"once\" {\n                    // Single execution task - mark as completed\n                    self.mark_task_completed(\u0026task.id).await?;\n                } else {\n                    // Recurring task - calculate next run\n                    if let Some(next_run) = self.calculate_next_run(task) {\n                        self.update_next_run(\u0026task.id, \u0026next_run).await?;\n                    }\n                }\n            }\n            Ok(Err(e)) =\u003e {\n                // Container execution failed\n                let output = ContainerOutput {\n                    status: \"error\".to_string(),\n                    result: None,\n                    new_session_id: None,\n                    error: Some(e.to_string()),\n                };\n                self.log_task_run(task, \u0026output, duration_ms, \"error\")\n                    .await?;\n                self.mark_task_failed(\u0026task.id).await?;\n            }\n            Err(_) =\u003e {\n                // Timeout\n                let output = ContainerOutput {\n                    status: \"timeout\".to_string(),\n                    result: None,\n                    new_session_id: None,\n                    error: Some(\"Task execution timed out\".to_string()),\n                };\n                self.log_task_run(task, \u0026output, duration_ms, \"timeout\")\n                    .await?;\n                self.mark_task_failed(\u0026task.id).await?;\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Calculate next run time for a task\n    pub fn calculate_next_run(\u0026self, task: \u0026ScheduledTask) -\u003e Option\u003cString\u003e {\n        match task.schedule_type.as_str() {\n            \"cron\" =\u003e self.calculate_next_cron_run(task.schedule_value.clone()),\n            \"interval\" =\u003e self.calculate_next_interval_run(task.schedule_value.clone()),\n            \"once\" =\u003e None,\n            _ =\u003e None,\n        }\n    }\n\n    /// Calculate next run time from cron expression\n    fn calculate_next_cron_run(\u0026self, cron_expr: String) -\u003e Option\u003cString\u003e {\n        let _tz = timezone();\n        match Schedule::from_str(\u0026cron_expr) {\n            Ok(schedule) =\u003e {\n                // Get next run in the specified timezone\n                let next = schedule.after(\u0026chrono::Utc::now()).next()?;\n                Some(next.to_rfc3339())\n            }\n            Err(e) =\u003e {\n                tracing::error!(\"Invalid cron expression '{}': {}\", cron_expr, e);\n                None\n            }\n        }\n    }\n\n    /// Calculate next run time from interval\n    fn calculate_next_interval_run(\u0026self, interval_str: String) -\u003e Option\u003cString\u003e {\n        let millis: i64 = interval_str.parse().ok()?;\n        let next_run = chrono::Utc::now() + chrono::Duration::milliseconds(millis);\n        Some(next_run.to_rfc3339())\n    }\n\n    /// Load tasks that are due for execution\n    async fn load_due_tasks(\u0026self, now: \u0026str) -\u003e Result\u003cVec\u003cScheduledTask\u003e\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        let mut stmt = conn\n            .prepare(\n                \"SELECT id, group_folder, chat_jid, prompt, schedule_type, schedule_value,\n                    next_run, last_run, last_result, status, created_at, context_mode\n             FROM scheduled_tasks\n             WHERE status = 'active'\n               AND (next_run IS NULL OR next_run \u003c= ?)\n             ORDER BY next_run ASC\",\n            )\n            .map_err(|e| NuClawError::Database {\n                message: format!(\"Failed to prepare statement: {}\", e),\n            })?;\n\n        let tasks: rusqlite::Result\u003cVec\u003cScheduledTask\u003e\u003e = stmt\n            .query_map([now], |row| {\n                Ok(ScheduledTask {\n                    id: row.get(0)?,\n                    group_folder: row.get(1)?,\n                    chat_jid: row.get(2)?,\n                    prompt: row.get(3)?,\n                    schedule_type: row.get(4)?,\n                    schedule_value: row.get(5)?,\n                    next_run: row.get(6)?,\n                    last_run: row.get(7)?,\n                    last_result: row.get(8)?,\n                    status: row.get(9)?,\n                    created_at: row.get(10)?,\n                    context_mode: row.get(11)?,\n                })\n            })?\n            .collect();\n\n        tasks.map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to load tasks: {}\", e),\n        })\n    }\n\n    /// Load a single task by ID\n    async fn load_task(\u0026self, task_id: \u0026str) -\u003e Result\u003cOption\u003cScheduledTask\u003e\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        let mut stmt = conn\n            .prepare(\n                \"SELECT id, group_folder, chat_jid, prompt, schedule_type, schedule_value,\n                    next_run, last_run, last_result, status, created_at, context_mode\n             FROM scheduled_tasks WHERE id = ?\",\n            )\n            .map_err(|e| NuClawError::Database {\n                message: format!(\"Failed to prepare statement: {}\", e),\n            })?;\n\n        stmt.query_row([task_id], |row| {\n            Ok(ScheduledTask {\n                id: row.get(0)?,\n                group_folder: row.get(1)?,\n                chat_jid: row.get(2)?,\n                prompt: row.get(3)?,\n                schedule_type: row.get(4)?,\n                schedule_value: row.get(5)?,\n                next_run: row.get(6)?,\n                last_run: row.get(7)?,\n                last_result: row.get(8)?,\n                status: row.get(9)?,\n                created_at: row.get(10)?,\n                context_mode: row.get(11)?,\n            })\n        })\n        .map(Some)\n        .or_else(|e| {\n            if e == rusqlite::Error::QueryReturnedNoRows {\n                Ok(None)\n            } else {\n                Err(NuClawError::Database {\n                    message: format!(\"Failed to load task: {}\", e),\n                })\n            }\n        })\n    }\n\n    /// Log a task run\n    async fn log_task_run(\n        \u0026self,\n        task: \u0026ScheduledTask,\n        output: \u0026ContainerOutput,\n        duration_ms: i64,\n        run_status: \u0026str,\n    ) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        let now = chrono::Utc::now().to_rfc3339();\n\n        conn.execute(\n            \"INSERT INTO task_run_logs (task_id, run_at, duration_ms, status, result, error)\n             VALUES (?, ?, ?, ?, ?, ?)\",\n            rusqlite::params![\n                task.id,\n                now,\n                duration_ms,\n                run_status,\n                output.result.clone().unwrap_or_default(),\n                output.error.clone().unwrap_or_default(),\n            ],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to log task run: {}\", e),\n        })?;\n\n        // Update last_run and last_result\n        let last_result = if output.status == \"success\" {\n            output.result.clone()\n        } else {\n            output.error.clone()\n        };\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET last_run = ?, last_result = ? WHERE id = ?\",\n            rusqlite::params![now, last_result, task.id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to update task: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Update next run time for a task\n    async fn update_next_run(\u0026self, task_id: \u0026str, next_run: \u0026str) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET next_run = ? WHERE id = ?\",\n            [next_run, task_id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to update next run: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Mark a task as completed (for once-type tasks)\n    async fn mark_task_completed(\u0026self, task_id: \u0026str) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET status = 'completed', next_run = NULL WHERE id = ?\",\n            [task_id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to mark task completed: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Mark a task as failed\n    async fn mark_task_failed(\u0026self, task_id: \u0026str) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"UPDATE scheduled_tasks SET status = 'failed' WHERE id = ?\",\n            [task_id],\n        )\n        .map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to mark task failed: {}\", e),\n        })?;\n\n        Ok(())\n    }\n}\n\n/// Parse cron expression and get next run time\npub fn parse_cron_expression(expr: \u0026str) -\u003e Result\u003cSchedule\u003e {\n    Schedule::from_str(expr).map_err(|e| NuClawError::Scheduler {\n        message: format!(\"Invalid cron expression '{}': {}\", expr, e),\n    })\n}\n\n/// Get next run time from schedule\npub fn get_next_run_time(schedule: \u0026Schedule) -\u003e DateTime\u003cUtc\u003e {\n    schedule\n        .after(\u0026chrono::Utc::now())\n        .next()\n        .unwrap_or_else(chrono::Utc::now)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_cron_expression() {\n        // Use 6-field format with seconds (cron crate standard)\n        let result = parse_cron_expression(\"0 0 9 * * *\");\n        assert!(result.is_ok(), \"Expected valid cron expression\");\n    }\n\n    #[test]\n    fn test_parse_cron_expression_with_seconds() {\n        let result = parse_cron_expression(\"0 0 0 9 * * *\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_parse_invalid_cron() {\n        let result = parse_cron_expression(\"invalid cron\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_parse_empty_cron() {\n        let result = parse_cron_expression(\"\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_get_next_run_time() {\n        let schedule = parse_cron_expression(\"0 0 9 * * *\").unwrap();\n        let next = get_next_run_time(\u0026schedule);\n        let now = chrono::Utc::now();\n        // Next run should be in the future\n        assert!(next \u003e= now);\n    }\n\n    #[test]\n    fn test_calculate_interval_next_run() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let next = scheduler.calculate_next_interval_run(\"3600000\".to_string());\n        assert!(next.is_some());\n        // Should be approximately 1 hour from now\n        let next_time: DateTime\u003cUtc\u003e = DateTime::from_str(\u0026next.unwrap()).unwrap();\n        let now = chrono::Utc::now();\n        let diff = next_time.signed_duration_since(now).num_seconds();\n        // Allow some tolerance\n        assert!(diff \u003e= 3590 \u0026\u0026 diff \u003c= 3610);\n    }\n\n    #[test]\n    fn test_calculate_interval_next_run_invalid() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let next = scheduler.calculate_next_interval_run(\"not_a_number\".to_string());\n        assert!(next.is_none());\n    }\n\n    #[test]\n    fn test_calculate_interval_next_run_zero() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let next = scheduler.calculate_next_interval_run(\"0\".to_string());\n        assert!(next.is_some());\n        // Should be essentially now\n        let next_time: DateTime\u003cUtc\u003e = DateTime::from_str(\u0026next.unwrap()).unwrap();\n        let now = chrono::Utc::now();\n        let diff = next_time.signed_duration_since(now).num_seconds();\n        assert!(diff \u003c= 1);\n    }\n\n    #[test]\n    fn test_calculate_next_cron_run() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let task = ScheduledTask {\n            id: \"test\".to_string(),\n            group_folder: \"test\".to_string(),\n            chat_jid: \"test\".to_string(),\n            prompt: \"test\".to_string(),\n            schedule_type: \"cron\".to_string(),\n            schedule_value: \"0 0 9 * * *\".to_string(),\n            next_run: None,\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: chrono::Utc::now().to_rfc3339(),\n            context_mode: \"isolated\".to_string(),\n        };\n        let next = scheduler.calculate_next_run(\u0026task);\n        assert!(next.is_some());\n    }\n\n    #[test]\n    fn test_calculate_next_run_once() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let task = ScheduledTask {\n            id: \"test\".to_string(),\n            group_folder: \"test\".to_string(),\n            chat_jid: \"test\".to_string(),\n            prompt: \"test\".to_string(),\n            schedule_type: \"once\".to_string(),\n            schedule_value: \"2025-01-01T00:00:00Z\".to_string(),\n            next_run: None,\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: chrono::Utc::now().to_rfc3339(),\n            context_mode: \"isolated\".to_string(),\n        };\n        let next = scheduler.calculate_next_run(\u0026task);\n        assert!(next.is_none());\n    }\n\n    #[test]\n    fn test_calculate_next_run_invalid_type() {\n        let scheduler = TaskScheduler::new(Database::new().unwrap());\n        let task = ScheduledTask {\n            id: \"test\".to_string(),\n            group_folder: \"test\".to_string(),\n            chat_jid: \"test\".to_string(),\n            prompt: \"test\".to_string(),\n            schedule_type: \"unknown\".to_string(),\n            schedule_value: \"value\".to_string(),\n            next_run: None,\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: chrono::Utc::now().to_rfc3339(),\n            context_mode: \"isolated\".to_string(),\n        };\n        let next = scheduler.calculate_next_run(\u0026task);\n        assert!(next.is_none());\n    }\n\n    #[test]\n    fn test_poll_interval_default() {\n        let interval = poll_interval();\n        assert_eq!(interval, Duration::from_secs(DEFAULT_POLL_INTERVAL_SECS));\n    }\n\n    #[test]\n    fn test_poll_interval_from_env() {\n        // Save original\n        let original = std::env::var(\"SCHEDULER_POLL_INTERVAL\").ok();\n\n        std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", \"120\");\n        let interval = poll_interval();\n        assert_eq!(interval, Duration::from_secs(120));\n\n        // Restore\n        match original {\n            Some(val) =\u003e std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", val),\n            None =\u003e std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\"),\n        }\n    }\n\n    #[test]\n    fn test_poll_interval_invalid_env() {\n        // Save original\n        let original = std::env::var(\"SCHEDULER_POLL_INTERVAL\").ok();\n\n        std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", \"invalid\");\n        let interval = poll_interval();\n        // Should fall back to default\n        assert_eq!(interval, Duration::from_secs(DEFAULT_POLL_INTERVAL_SECS));\n\n        // Restore\n        match original {\n            Some(val) =\u003e std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", val),\n            None =\u003e std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\"),\n        }\n    }\n\n    #[test]\n    fn test_task_timeout_default() {\n        let timeout = task_timeout();\n        assert_eq!(timeout, Duration::from_secs(DEFAULT_TASK_TIMEOUT_SECS));\n    }\n\n    #[test]\n    fn test_task_timeout_from_env() {\n        // Save original\n        let original = std::env::var(\"TASK_TIMEOUT\").ok();\n\n        std::env::set_var(\"TASK_TIMEOUT\", \"300\");\n        let timeout = task_timeout();\n        assert_eq!(timeout, Duration::from_secs(300));\n\n        // Restore\n        match original {\n            Some(val) =\u003e std::env::set_var(\"TASK_TIMEOUT\", val),\n            None =\u003e std::env::remove_var(\"TASK_TIMEOUT\"),\n        }\n    }\n\n    #[test]\n    fn test_task_scheduler_new() {\n        let db = Database::new().unwrap();\n        let scheduler = TaskScheduler::new(db);\n        // Just verify it was created\n        assert_eq!(scheduler.poll_interval, poll_interval());\n        assert_eq!(scheduler.task_timeout, task_timeout());\n    }\n\n    #[test]\n    fn test_scheduler_clone() {\n        let db = Database::new().unwrap();\n        let scheduler = TaskScheduler::new(db);\n        let _cloned = scheduler.clone();\n        // Clone should work without panic\n    }\n}\n","traces":[{"line":33,"address":[12752992],"length":1,"stats":{"Line":2}},{"line":34,"address":[12929588],"length":1,"stats":{"Line":2}},{"line":36,"address":[12234864,12234873],"length":1,"stats":{"Line":6}},{"line":37,"address":[12753067],"length":1,"stats":{"Line":2}},{"line":38,"address":[12929685],"length":1,"stats":{"Line":2}},{"line":42,"address":[12749280],"length":1,"stats":{"Line":2}},{"line":43,"address":[12749284],"length":1,"stats":{"Line":2}},{"line":45,"address":[12176832,12176841],"length":1,"stats":{"Line":6}},{"line":46,"address":[12925903],"length":1,"stats":{"Line":2}},{"line":47,"address":[12925925],"length":1,"stats":{"Line":2}},{"line":60,"address":[12929264,12929473],"length":1,"stats":{"Line":1}},{"line":63,"address":[12752731],"length":1,"stats":{"Line":1}},{"line":64,"address":[12752799],"length":1,"stats":{"Line":1}},{"line":69,"address":[12555603,12555422,12555531,12555360,12555574,12557182,12558928],"length":1,"stats":{"Line":0}},{"line":70,"address":[12216644,12216814],"length":1,"stats":{"Line":0}},{"line":72,"address":[14486954],"length":1,"stats":{"Line":0}},{"line":73,"address":[12216903],"length":1,"stats":{"Line":0}},{"line":75,"address":[14487096,14487541],"length":1,"stats":{"Line":0}},{"line":81,"address":[14489303,14488829,14488908],"length":1,"stats":{"Line":0}},{"line":97,"address":[12221420],"length":1,"stats":{"Line":0}},{"line":101,"address":[12206149,12206487,12205936,12206085,12205998,12209888,12206178,12206128],"length":1,"stats":{"Line":0}},{"line":102,"address":[12544769,12544607],"length":1,"stats":{"Line":0}},{"line":105,"address":[12387631],"length":1,"stats":{"Line":0}},{"line":107,"address":[14476761,14476831],"length":1,"stats":{"Line":0}},{"line":108,"address":[12208666,12207001,12209056],"length":1,"stats":{"Line":0}},{"line":109,"address":[12209032],"length":1,"stats":{"Line":0}},{"line":112,"address":[14476903,14477302,14476837],"length":1,"stats":{"Line":0}},{"line":115,"address":[14477277],"length":1,"stats":{"Line":0}},{"line":116,"address":[12549269,12549330,12547068,12547177],"length":1,"stats":{"Line":0}},{"line":118,"address":[14480685,14480200],"length":1,"stats":{"Line":0}},{"line":120,"address":[12548514,12548991,12548545,12549753,12548893,12549615,12544680],"length":1,"stats":{"Line":0}},{"line":123,"address":[12548965,12549028],"length":1,"stats":{"Line":0}},{"line":124,"address":[12553172,12553056,12553906,12549063,12553325,12553106,12553816],"length":1,"stats":{"Line":0}},{"line":125,"address":[12553247,12553146,12553199,12553356],"length":1,"stats":{"Line":0}},{"line":126,"address":[12553579,12553648],"length":1,"stats":{"Line":0}},{"line":128,"address":[14480522],"length":1,"stats":{"Line":0}},{"line":132,"address":[12210781,12210902,12213359],"length":1,"stats":{"Line":0}},{"line":133,"address":[12213580,12213409,12213930,12211306,12213877,12206157,12211279,12213696,12211587,12211663],"length":1,"stats":{"Line":0}},{"line":134,"address":[12552554,12552486],"length":1,"stats":{"Line":0}},{"line":137,"address":[12211838],"length":1,"stats":{"Line":0}},{"line":138,"address":[14481987,14481886],"length":1,"stats":{"Line":0}},{"line":142,"address":[14483482],"length":1,"stats":{"Line":0}},{"line":146,"address":[12749920,12749933],"length":1,"stats":{"Line":0}},{"line":147,"address":[12530511,12530810,12531212],"length":1,"stats":{"Line":0}},{"line":149,"address":[12531184],"length":1,"stats":{"Line":0}},{"line":152,"address":[14466919,14464232,14463551,14464019,14463991,14464115,14463674,14466831,14464328],"length":1,"stats":{"Line":0}},{"line":154,"address":[14316962],"length":1,"stats":{"Line":0}},{"line":155,"address":[12542492,12542352,12532926],"length":1,"stats":{"Line":0}},{"line":156,"address":[14473657],"length":1,"stats":{"Line":0}},{"line":159,"address":[12533181,12533260],"length":1,"stats":{"Line":0}},{"line":160,"address":[12196078,12196468,12195176],"length":1,"stats":{"Line":0}},{"line":161,"address":[14465872],"length":1,"stats":{"Line":0}},{"line":165,"address":[14464554,14464619],"length":1,"stats":{"Line":0}},{"line":167,"address":[14464734],"length":1,"stats":{"Line":0}},{"line":168,"address":[14464823,14464898],"length":1,"stats":{"Line":0}},{"line":169,"address":[12195518],"length":1,"stats":{"Line":0}},{"line":170,"address":[14465012],"length":1,"stats":{"Line":0}},{"line":176,"address":[12385707],"length":1,"stats":{"Line":0}},{"line":178,"address":[12536043],"length":1,"stats":{"Line":0}},{"line":179,"address":[12197975],"length":1,"stats":{"Line":0}},{"line":182,"address":[12536402,12536324],"length":1,"stats":{"Line":0}},{"line":183,"address":[12198359],"length":1,"stats":{"Line":0}},{"line":185,"address":[12198584,12199914,12198460,12199981,12199852,12200893],"length":1,"stats":{"Line":0}},{"line":186,"address":[14468013,14468081,14469208,14461894,14469400,14469473],"length":1,"stats":{"Line":0}},{"line":189,"address":[12200022],"length":1,"stats":{"Line":0}},{"line":192,"address":[12538467,12539548],"length":1,"stats":{"Line":0}},{"line":194,"address":[14469840,14470316,14470500,14470833,14461915],"length":1,"stats":{"Line":0}},{"line":197,"address":[14469896,14469800],"length":1,"stats":{"Line":0}},{"line":198,"address":[11658758],"length":1,"stats":{"Line":0}},{"line":202,"address":[12536446],"length":1,"stats":{"Line":0}},{"line":205,"address":[12198309],"length":1,"stats":{"Line":0}},{"line":208,"address":[12198723,12198805],"length":1,"stats":{"Line":0}},{"line":210,"address":[14471655,14468579,14468443,14471568,14471896,14471518],"length":1,"stats":{"Line":0}},{"line":211,"address":[14468544,14471358,14471550,14461957,14468612,14471623],"length":1,"stats":{"Line":0}},{"line":212,"address":[14461978,14471935,14471700,14472318],"length":1,"stats":{"Line":0}},{"line":217,"address":[14467640],"length":1,"stats":{"Line":0}},{"line":220,"address":[14468708,14468799],"length":1,"stats":{"Line":0}},{"line":222,"address":[12199593,12202832,12202961,12203186,12199469,12202894],"length":1,"stats":{"Line":0}},{"line":223,"address":[14472552,14469062,14469130,14461999,14472360,14472625],"length":1,"stats":{"Line":0}},{"line":224,"address":[12203636,12192660,12203002,12203221],"length":1,"stats":{"Line":0}},{"line":228,"address":[12539931],"length":1,"stats":{"Line":0}},{"line":232,"address":[12926192],"length":1,"stats":{"Line":1}},{"line":233,"address":[12749690],"length":1,"stats":{"Line":1}},{"line":234,"address":[14857539,14857598],"length":1,"stats":{"Line":2}},{"line":235,"address":[12749863,12749746],"length":1,"stats":{"Line":1}},{"line":236,"address":[12749821],"length":1,"stats":{"Line":1}},{"line":242,"address":[12926592,12928801,12927394],"length":1,"stats":{"Line":1}},{"line":243,"address":[12926631],"length":1,"stats":{"Line":1}},{"line":244,"address":[14858062,14857982],"length":1,"stats":{"Line":2}},{"line":245,"address":[12750372],"length":1,"stats":{"Line":1}},{"line":247,"address":[12750374,12750461],"length":1,"stats":{"Line":2}},{"line":248,"address":[12927183],"length":1,"stats":{"Line":1}},{"line":250,"address":[12750281],"length":1,"stats":{"Line":0}},{"line":251,"address":[14858141,14858731,14859124],"length":1,"stats":{"Line":0}},{"line":252,"address":[12927819],"length":1,"stats":{"Line":0}},{"line":258,"address":[12752667,12752256],"length":1,"stats":{"Line":1}},{"line":259,"address":[12928854,12928922],"length":1,"stats":{"Line":2}},{"line":260,"address":[12752495],"length":1,"stats":{"Line":1}},{"line":261,"address":[12752583],"length":1,"stats":{"Line":1}},{"line":265,"address":[12517419,12517286,12517248,12518766,12517392,12518707],"length":1,"stats":{"Line":0}},{"line":266,"address":[12517574,12518761,12517485],"length":1,"stats":{"Line":0}},{"line":269,"address":[12527610,12527536,12527660,12517458],"length":1,"stats":{"Line":0}},{"line":270,"address":[12181047],"length":1,"stats":{"Line":0}},{"line":273,"address":[12180979,12180150,12179960,12180080],"length":1,"stats":{"Line":0}},{"line":282,"address":[12181168,12180057,12181349,12181402],"length":1,"stats":{"Line":0}},{"line":283,"address":[12518822,12518890],"length":1,"stats":{"Line":0}},{"line":286,"address":[14449484,14449612],"length":1,"stats":{"Line":0}},{"line":287,"address":[14455464,14455458,14450624,14449381],"length":1,"stats":{"Line":0}},{"line":288,"address":[14454230],"length":1,"stats":{"Line":0}},{"line":289,"address":[12519390],"length":1,"stats":{"Line":0}},{"line":290,"address":[14450955,14450880],"length":1,"stats":{"Line":0}},{"line":291,"address":[12182314,12182227],"length":1,"stats":{"Line":0}},{"line":292,"address":[12520212,12520287],"length":1,"stats":{"Line":0}},{"line":293,"address":[12182815,12182902],"length":1,"stats":{"Line":0}},{"line":294,"address":[12520824,12520899],"length":1,"stats":{"Line":0}},{"line":295,"address":[12521205,12521130],"length":1,"stats":{"Line":0}},{"line":296,"address":[12183784,12183697],"length":1,"stats":{"Line":0}},{"line":297,"address":[12184078,12183991],"length":1,"stats":{"Line":0}},{"line":298,"address":[12184285,12184372],"length":1,"stats":{"Line":0}},{"line":299,"address":[12184579,12184666],"length":1,"stats":{"Line":0}},{"line":300,"address":[12184960,12184873],"length":1,"stats":{"Line":0}},{"line":305,"address":[12519072,12519310,12518428,12519257],"length":1,"stats":{"Line":0}},{"line":306,"address":[12181446,12181510],"length":1,"stats":{"Line":0}},{"line":311,"address":[12224950,12225934,12225071,12224912,12225954,12225044],"length":1,"stats":{"Line":0}},{"line":312,"address":[14496264,14495486,14495397],"length":1,"stats":{"Line":0}},{"line":315,"address":[12234082,12225126,12234016,12234131],"length":1,"stats":{"Line":0}},{"line":316,"address":[12565490],"length":1,"stats":{"Line":0}},{"line":319,"address":[12564526,12564320,12564436],"length":1,"stats":{"Line":0}},{"line":325,"address":[12573977,12564409,12574030,12573792],"length":1,"stats":{"Line":0}},{"line":326,"address":[12234694,12234630],"length":1,"stats":{"Line":0}},{"line":329,"address":[12230667,12225721,12230673,12225984],"length":1,"stats":{"Line":0}},{"line":330,"address":[12229439],"length":1,"stats":{"Line":0}},{"line":331,"address":[12565646],"length":1,"stats":{"Line":0}},{"line":332,"address":[14497136,14497211],"length":1,"stats":{"Line":0}},{"line":333,"address":[12566237,12566162],"length":1,"stats":{"Line":0}},{"line":334,"address":[14497823,14497748],"length":1,"stats":{"Line":0}},{"line":335,"address":[12566774,12566849],"length":1,"stats":{"Line":0}},{"line":336,"address":[12227397,12227484],"length":1,"stats":{"Line":0}},{"line":337,"address":[14498741,14498666],"length":1,"stats":{"Line":0}},{"line":338,"address":[12228072,12227985],"length":1,"stats":{"Line":0}},{"line":339,"address":[14499278,14499353],"length":1,"stats":{"Line":0}},{"line":340,"address":[12228573,12228660],"length":1,"stats":{"Line":0}},{"line":341,"address":[12568685,12568610],"length":1,"stats":{"Line":0}},{"line":342,"address":[14500196,14500271],"length":1,"stats":{"Line":0}},{"line":345,"address":[12225828],"length":1,"stats":{"Line":0}},{"line":346,"address":[12565444,12564855,12565024],"length":1,"stats":{"Line":0}},{"line":347,"address":[12234254,12234188,12234322],"length":1,"stats":{"Line":0}},{"line":348,"address":[12565160],"length":1,"stats":{"Line":0}},{"line":350,"address":[14496580],"length":1,"stats":{"Line":0}},{"line":351,"address":[12565195,12565128],"length":1,"stats":{"Line":0}},{"line":358,"address":[14857216],"length":1,"stats":{"Line":0}},{"line":365,"address":[12177325,12177256,12178836],"length":1,"stats":{"Line":0}},{"line":368,"address":[14448186,14448236,14446101,14448112],"length":1,"stats":{"Line":0}},{"line":369,"address":[14448130],"length":1,"stats":{"Line":0}},{"line":372,"address":[12515107,12515044],"length":1,"stats":{"Line":0}},{"line":374,"address":[12178069,12178002,12177878,12177518],"length":1,"stats":{"Line":0}},{"line":377,"address":[12515363],"length":1,"stats":{"Line":0}},{"line":382,"address":[12515204],"length":1,"stats":{"Line":0}},{"line":383,"address":[12515326,12515259],"length":1,"stats":{"Line":0}},{"line":386,"address":[12516798,12515603,12516560,12516745],"length":1,"stats":{"Line":0}},{"line":387,"address":[14447862,14447930],"length":1,"stats":{"Line":0}},{"line":391,"address":[12515813],"length":1,"stats":{"Line":0}},{"line":392,"address":[12515874,12515923],"length":1,"stats":{"Line":0}},{"line":394,"address":[12178194,12178245],"length":1,"stats":{"Line":0}},{"line":397,"address":[12178548,12178401,12178481,12178255],"length":1,"stats":{"Line":0}},{"line":399,"address":[12178331],"length":1,"stats":{"Line":0}},{"line":401,"address":[14447382,14448441,14448494,14448256],"length":1,"stats":{"Line":0}},{"line":402,"address":[12178966,12178902],"length":1,"stats":{"Line":0}},{"line":405,"address":[14447549],"length":1,"stats":{"Line":0}},{"line":409,"address":[14458960,14459157,14459130,14459869,14458998,14459861],"length":1,"stats":{"Line":0}},{"line":410,"address":[12189999,12190587,12190068],"length":1,"stats":{"Line":0}},{"line":413,"address":[12189976,12190946,12190995,12190880],"length":1,"stats":{"Line":0}},{"line":414,"address":[12528642],"length":1,"stats":{"Line":0}},{"line":417,"address":[12528326,12528413,12528260,12528146],"length":1,"stats":{"Line":0}},{"line":419,"address":[12528228],"length":1,"stats":{"Line":0}},{"line":421,"address":[12528299,12528768,12529006,12528953],"length":1,"stats":{"Line":0}},{"line":422,"address":[12190646,12190710],"length":1,"stats":{"Line":0}},{"line":425,"address":[12528463],"length":1,"stats":{"Line":0}},{"line":429,"address":[12204704,12205497,12204742,12204863,12204836,12205505],"length":1,"stats":{"Line":0}},{"line":430,"address":[14474693,14474782,14475311],"length":1,"stats":{"Line":0}},{"line":433,"address":[14475418,14475344,14475468,14474666],"length":1,"stats":{"Line":0}},{"line":434,"address":[12544082],"length":1,"stats":{"Line":0}},{"line":437,"address":[14475137,14474984,14474896,14475050],"length":1,"stats":{"Line":0}},{"line":439,"address":[14474968],"length":1,"stats":{"Line":0}},{"line":441,"address":[14475488,14475023,14475673,14475726],"length":1,"stats":{"Line":0}},{"line":442,"address":[14475578,14475510],"length":1,"stats":{"Line":0}},{"line":445,"address":[12543907],"length":1,"stats":{"Line":0}},{"line":449,"address":[12191024,12191817,12191825,12191156,12191062,12191183],"length":1,"stats":{"Line":0}},{"line":450,"address":[14460638,14461167,14460549],"length":1,"stats":{"Line":0}},{"line":453,"address":[14461472,14461546,14460522,14461596],"length":1,"stats":{"Line":0}},{"line":454,"address":[12530210],"length":1,"stats":{"Line":0}},{"line":457,"address":[14460906,14460752,14460840,14460993],"length":1,"stats":{"Line":0}},{"line":459,"address":[12529544],"length":1,"stats":{"Line":0}},{"line":461,"address":[12192000,12192181,12191571,12192234],"length":1,"stats":{"Line":0}},{"line":462,"address":[12530010,12529942],"length":1,"stats":{"Line":0}},{"line":465,"address":[12529763],"length":1,"stats":{"Line":0}},{"line":470,"address":[14861088],"length":1,"stats":{"Line":2}},{"line":471,"address":[12929834],"length":1,"stats":{"Line":6}},{"line":472,"address":[12574254,12574335],"length":1,"stats":{"Line":4}},{"line":477,"address":[12929696],"length":1,"stats":{"Line":1}},{"line":479,"address":[12929719],"length":1,"stats":{"Line":1}},{"line":481,"address":[12929771],"length":1,"stats":{"Line":1}}],"covered":34,"coverable":202},{"path":["/","root","code","nuclaw","src","telegram.rs"],"content":"//! Telegram Integration for NuClaw\n//!\n//! Provides Telegram Bot connectivity via Bot API with webhook support.\n//! Follows OpenClaw Telegram specification for message handling.\n\nuse crate::config::{assistant_name, data_dir};\nuse crate::container_runner::run_container;\nuse crate::db::Database;\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, NewMessage, RegisteredGroup, RouterState};\nuse crate::utils::json::{load_json, save_json};\nuse axum::routing::{get, post};\nuse axum::Json;\nuse axum::Router;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::net::SocketAddr;\nuse std::sync::Arc;\nuse tokio::sync::Mutex;\nuse tokio::time::{timeout, Duration};\nuse tracing::{debug, error, info};\n\n/// Default text chunk limit: 4000 characters\nconst DEFAULT_TEXT_CHUNK_LIMIT: usize = 4000;\n\n/// DM policy enumeration\n#[derive(Debug, Clone, Copy, PartialEq, Serialize, Deserialize)]\npub enum DMPolicy {\n    #[serde(rename = \"pairing\")]\n    Pairing,\n    #[serde(rename = \"allowlist\")]\n    Allowlist,\n    #[serde(rename = \"open\")]\n    Open,\n    #[serde(rename = \"disabled\")]\n    Disabled,\n}\n\n/// Group policy enumeration\n#[derive(Debug, Clone, Copy, PartialEq, Serialize, Deserialize)]\npub enum GroupPolicy {\n    #[serde(rename = \"open\")]\n    Open,\n    #[serde(rename = \"allowlist\")]\n    Allowlist,\n    #[serde(rename = \"disabled\")]\n    Disabled,\n}\n\n/// Telegram Update object (Telegram Bot API)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramUpdate {\n    pub update_id: i64,\n    pub message: Option\u003cTelegramMessage\u003e,\n    pub edited_message: Option\u003cTelegramMessage\u003e,\n}\n\n/// Telegram User object\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramUser {\n    pub id: i64,\n    pub is_bot: bool,\n    pub first_name: String,\n    pub last_name: Option\u003cString\u003e,\n    pub username: Option\u003cString\u003e,\n}\n\n/// Telegram Chat object\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramChat {\n    pub id: i64,\n    #[serde(rename = \"type\")]\n    pub chat_type: String,\n    pub title: Option\u003cString\u003e,\n}\n\n/// Telegram Message object\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TelegramMessage {\n    pub message_id: i64,\n    pub from: Option\u003cTelegramUser\u003e,\n    pub chat: TelegramChat,\n    pub date: i64,\n    pub text: Option\u003cString\u003e,\n}\n\n/// Telegram client state\npub struct TelegramClient {\n    /// API URL\n    api_url: String,\n    /// Webhook path\n    webhook_path: String,\n    /// DM policy\n    dm_policy: DMPolicy,\n    /// Group policy\n    group_policy: GroupPolicy,\n    /// Text chunk limit\n    text_chunk_limit: usize,\n    /// Allowed group IDs\n    allowed_groups: Vec\u003cString\u003e,\n    /// Reference to registered groups\n    registered_groups: HashMap\u003cString, RegisteredGroup\u003e,\n    /// Router state for message deduplication\n    router_state: RouterState,\n    /// Database connection\n    db: Database,\n    /// Assistant name for trigger detection\n    assistant_name: String,\n}\n\nimpl TelegramClient {\n    /// Create a new Telegram client\n    pub fn new(db: Database) -\u003e Result\u003cSelf\u003e {\n        let bot_token = std::env::var(\"TELEGRAM_BOT_TOKEN\").map_err(|_| NuClawError::Config {\n            message: \"TELEGRAM_BOT_TOKEN not set\".to_string(),\n        })?;\n\n        let api_url = format!(\"https://api.telegram.org/bot{}\", bot_token);\n\n        Ok(Self {\n            api_url,\n            webhook_path: std::env::var(\"TELEGRAM_WEBHOOK_PATH\")\n                .unwrap_or_else(|_| \"telegram-webhook\".to_string()),\n            dm_policy: DMPolicy::from_str(\n                \u0026std::env::var(\"TELEGRAM_DM_POLICY\").unwrap_or_else(|_| \"pairing\".to_string()),\n            ),\n            group_policy: GroupPolicy::from_str(\n                \u0026std::env::var(\"TELEGRAM_GROUP_POLICY\").unwrap_or_else(|_| \"allowlist\".to_string()),\n            ),\n            text_chunk_limit: std::env::var(\"TELEGRAM_TEXT_CHUNK_LIMIT\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(DEFAULT_TEXT_CHUNK_LIMIT),\n            allowed_groups: std::env::var(\"TELEGRAM_WHITELIST_GROUPS\")\n                .ok()\n                .map(|s| s.split(',').map(|v| v.trim().to_string()).collect())\n                .unwrap_or_default(),\n            registered_groups: load_registered_groups(),\n            router_state: load_router_state(),\n            db,\n            assistant_name: assistant_name(),\n        })\n    }\n\n    /// Connect to Telegram\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to Telegram...\");\n\n        // Check webhook URL\n        let webhook_url = std::env::var(\"TELEGRAM_WEBHOOK_URL\").ok();\n\n        if let Some(url) = webhook_url {\n            self.set_webhook(\u0026url).await?;\n            info!(\"Webhook set to: {}\", url);\n        } else {\n            info!(\"No webhook URL configured, using polling mode\");\n        }\n\n        Ok(())\n    }\n\n    /// Set webhook URL\n    async fn set_webhook(\u0026self, url: \u0026str) -\u003e Result\u003c()\u003e {\n        let full_url = format!(\"{}/webhook/{}\", url, self.webhook_path);\n        let response = reqwest::Client::new()\n            .post(format!(\"{}/setWebhook\", self.api_url))\n            .json(\u0026serde_json::json!({ \"url\": full_url }))\n            .send()\n            .await\n            .map_err(|e| NuClawError::Telegram {\n                message: format!(\"Failed to set webhook: {}\", e),\n            })?;\n\n        if response.status() != 200 {\n            return Err(NuClawError::Telegram {\n                message: format!(\n                    \"Webhook setup failed: {}\",\n                    response.text().await.unwrap_or_default()\n                ),\n            });\n        }\n\n        Ok(())\n    }\n\n    /// Start webhook server\n    pub async fn start_webhook_server(self) -\u003e Result\u003c()\u003e {\n        let addr: SocketAddr = std::env::var(\"TELEGRAM_WEBHOOK_BIND\")\n            .unwrap_or_else(|_| \"0.0.0.0:8787\".to_string())\n            .parse()\n            .map_err(|_| NuClawError::Config {\n                message: \"Invalid TELEGRAM_WEBHOOK_BIND\".to_string(),\n            })?;\n\n        let client = Arc::new(Mutex::new(self));\n        let webhook_path = client.lock().await.webhook_path.clone();\n\n        let app = Router::new()\n            .route(\u0026format!(\"/{}\", webhook_path), post(handle_telegram_webhook))\n            .route(\"/health\", get(health_check))\n            .with_state(client.clone());\n\n        info!(\"Starting Telegram webhook server on {}\", addr);\n\n        let listener =\n            tokio::net::TcpListener::bind(\u0026addr)\n                .await\n                .map_err(|e| NuClawError::Telegram {\n                    message: format!(\"Failed to bind to {}: {}\", addr, e),\n                })?;\n\n        axum::serve(listener, app)\n            .await\n            .map_err(|e| NuClawError::Telegram {\n                message: format!(\"Webhook server error: {}\", e),\n            })?;\n\n        Ok(())\n    }\n\n    /// Handle a Telegram update\n    pub async fn handle_update(\u0026mut self, update: \u0026TelegramUpdate) -\u003e Result\u003cOption\u003cString\u003e\u003e {\n        let message = match \u0026update.message {\n            Some(msg) =\u003e msg,\n            None =\u003e {\n                debug!(\"Received update without message, skipping\");\n                return Ok(None);\n            }\n        };\n\n        let new_message = self.parse_telegram_message(message).await?;\n        self.handle_message(\u0026new_message).await\n    }\n\n    /// Parse Telegram message to unified format\n    async fn parse_telegram_message(\u0026self, msg: \u0026TelegramMessage) -\u003e Result\u003cNewMessage\u003e {\n        let sender = msg\n            .from\n            .as_ref()\n            .map(|u| u.id.to_string())\n            .unwrap_or_default();\n        let sender_name = msg\n            .from\n            .as_ref()\n            .map(|u| {\n                if let Some(username) = \u0026u.username {\n                    username.clone()\n                } else {\n                    u.first_name.clone()\n                }\n            })\n            .unwrap_or_else(|| \"Unknown\".to_string());\n\n        let chat_jid = format!(\"telegram:group:{}\", msg.chat.id);\n\n        let content = msg.text.clone().unwrap_or_else(|| \"\".to_string());\n\n        Ok(NewMessage {\n            id: msg.message_id.to_string(),\n            chat_jid,\n            sender,\n            sender_name,\n            content,\n            timestamp: msg.date.to_string(),\n        })\n    }\n\n    /// Handle a single message\n    pub async fn handle_message(\u0026mut self, msg: \u0026NewMessage) -\u003e Result\u003cOption\u003cString\u003e\u003e {\n        if self.is_duplicate_message(msg).await {\n            debug!(\"Skipping duplicate message: {}\", msg.id);\n            return Ok(None);\n        }\n\n        self.update_router_state(msg).await;\n        self.store_message(msg).await?;\n\n        // Check if it's a private message\n        if msg.chat_jid.starts_with(\"telegram:group:-\") || !msg.chat_jid.contains(\":group:\") {\n            if !self.check_dm_policy(\u0026msg.sender).await? {\n                debug!(\"Message from unauthorized user: {}\", msg.sender);\n                return Ok(None);\n            }\n        }\n\n        // Check if registered group\n        if !self.is_allowed_group(\u0026msg.chat_jid).await? {\n            debug!(\"Message from unregistered group: {}\", msg.chat_jid);\n            return Ok(None);\n        }\n\n        let (_, content) = match self.extract_trigger(\u0026msg.content).await {\n            Some((_, c)) =\u003e (String::new(), c),\n            None =\u003e return Ok(None),\n        };\n\n        info!(\n            \"Received message from {}: {}\",\n            msg.sender_name,\n            truncate(\u0026content, 50)\n        );\n\n        let group_folder =\n            self.get_group_folder(\u0026msg.chat_jid)\n                .await\n                .ok_or_else(|| NuClawError::Telegram {\n                    message: format!(\"Group not found: {}\", msg.chat_jid),\n                })?;\n\n        let session_id = format!(\"telegram_{}\", msg.id);\n        let input = ContainerInput {\n            prompt: content,\n            session_id: Some(session_id.clone()),\n            group_folder,\n            chat_jid: msg.chat_jid.clone(),\n            is_main: true,\n            is_scheduled_task: false,\n        };\n\n        let result = timeout(Duration::from_secs(300), run_container(input)).await;\n\n        match result {\n            Ok(Ok(output)) =\u003e {\n                if let Some(response) = output.result {\n                    let chat_id = self.extract_chat_id(\u0026msg.chat_jid)?;\n                    self.send_message(\u0026chat_id.to_string(), \u0026response).await?;\n                    return Ok(Some(response));\n                }\n            }\n            Ok(Err(e)) =\u003e {\n                error!(\"Container error: {}\", e);\n                let chat_id = self.extract_chat_id(\u0026msg.chat_jid)?;\n                self.send_message(\u0026chat_id.to_string(), \u0026format!(\"Error: {}\", e))\n                    .await?;\n            }\n            Err(_) =\u003e {\n                error!(\"Container timeout\");\n                let chat_id = self.extract_chat_id(\u0026msg.chat_jid)?;\n                self.send_message(\u0026chat_id.to_string(), \"Sorry, the request timed out.\")\n                    .await?;\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Send a message to a chat\n    pub async fn send_message(\u0026self, chat_id: \u0026str, text: \u0026str) -\u003e Result\u003c()\u003e {\n        let cid: i64 = chat_id.parse().map_err(|_| NuClawError::Telegram {\n            message: format!(\"Invalid chat_id: {}\", chat_id),\n        })?;\n\n        let chunks = self.chunk_text(text);\n\n        for chunk in chunks {\n            let payload = serde_json::json!({\n                \"chat_id\": cid,\n                \"text\": chunk,\n                \"parse_mode\": \"HTML\"\n            });\n\n            let response = reqwest::Client::new()\n                .post(\u0026format!(\"{}/sendMessage\", self.api_url))\n                .json(\u0026payload)\n                .timeout(Duration::from_secs(30))\n                .send()\n                .await\n                .map_err(|e| NuClawError::Telegram {\n                    message: format!(\"Failed to send message: {}\", e),\n                })?;\n\n            if !response.status().is_success() {\n                let error = response.text().await.unwrap_or_default();\n                return Err(NuClawError::Telegram {\n                    message: format!(\"Failed to send message: {}\", error),\n                });\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Chunk text into smaller pieces\n    fn chunk_text(\u0026self, text: \u0026str) -\u003e Vec\u003cString\u003e {\n        if text.len() \u003c= self.text_chunk_limit {\n            return vec![text.to_string()];\n        }\n\n        let mut chunks = Vec::new();\n        let mut current = String::new();\n\n        for paragraph in text.split(\"\\n\\n\") {\n            if current.len() + paragraph.len() + 2 \u003e self.text_chunk_limit {\n                if !current.is_empty() {\n                    chunks.push(current);\n                }\n                current = paragraph.to_string();\n            } else {\n                if !current.is_empty() {\n                    current.push_str(\"\\n\\n\");\n                }\n                current.push_str(paragraph);\n            }\n        }\n\n        if !current.is_empty() {\n            chunks.push(current);\n        }\n\n        chunks\n    }\n\n    /// Check DM policy\n    async fn check_dm_policy(\u0026self, _user_id: \u0026str) -\u003e Result\u003cbool\u003e {\n        match self.dm_policy {\n            DMPolicy::Disabled =\u003e Ok(false),\n            DMPolicy::Open =\u003e Ok(true),\n            DMPolicy::Allowlist | DMPolicy::Pairing =\u003e {\n                // Allow for now (can be extended with database check)\n                Ok(true)\n            }\n        }\n    }\n\n    /// Check if group is allowed\n    async fn is_allowed_group(\u0026self, chat_jid: \u0026str) -\u003e Result\u003cbool\u003e {\n        match self.group_policy {\n            GroupPolicy::Disabled =\u003e Ok(false),\n            GroupPolicy::Open =\u003e Ok(true),\n            GroupPolicy::Allowlist =\u003e {\n                // Extract chat_id from jid\n                if let Some(chat_id) = chat_jid.strip_prefix(\"telegram:group:\") {\n                    let result = self\n                        .allowed_groups\n                        .iter()\n                        .any(|g| g == chat_id || g == \u0026format!(\"-{}\", chat_id));\n                    Ok(result)\n                } else {\n                    Ok(false)\n                }\n            }\n        }\n    }\n\n    /// Get group folder for a chat JID\n    async fn get_group_folder(\u0026self, jid: \u0026str) -\u003e Option\u003cString\u003e {\n        self.registered_groups.get(jid).map(|g| g.folder.clone())\n    }\n\n    /// Extract chat ID from jid\n    fn extract_chat_id(\u0026self, jid: \u0026str) -\u003e Result\u003cString\u003e {\n        jid.strip_prefix(\"telegram:group:\")\n            .map(|s| s.to_string())\n            .ok_or_else(|| NuClawError::Telegram {\n                message: format!(\"Invalid telegram jid format: {}\", jid),\n            })\n    }\n\n    /// Check if message is duplicate\n    async fn is_duplicate_message(\u0026self, msg: \u0026NewMessage) -\u003e bool {\n        let last_timestamp = \u0026self.router_state.last_timestamp;\n        let last_agent = self.router_state.last_agent_timestamp.get(\u0026msg.chat_jid);\n\n        if last_timestamp == \u0026msg.timestamp {\n            return true;\n        }\n\n        if let Some(agent_ts) = last_agent {\n            if agent_ts == \u0026msg.timestamp {\n                return true;\n            }\n        }\n\n        false\n    }\n\n    /// Update router state after processing\n    async fn update_router_state(\u0026mut self, msg: \u0026NewMessage) {\n        self.router_state.last_timestamp = msg.timestamp.clone();\n        self.router_state\n            .last_agent_timestamp\n            .insert(msg.chat_jid.clone(), msg.timestamp.clone());\n\n        let state_path = data_dir().join(\"router_state.json\");\n        let _ = save_json(\u0026state_path, \u0026self.router_state);\n    }\n\n    /// Store message in database\n    async fn store_message(\u0026self, msg: \u0026NewMessage) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"INSERT OR REPLACE INTO messages (id, chat_jid, sender, sender_name, content, timestamp, is_from_me)\n             VALUES (?, ?, ?, ?, ?, ?, ?)\",\n            rusqlite::params![\n                msg.id,\n                msg.chat_jid,\n                msg.sender,\n                msg.sender_name,\n                msg.content,\n                msg.timestamp,\n                if msg.id.starts_with(\"self\") { 1 } else { 0 },\n            ],\n        ).map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to store message: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Extract trigger and content from message\n    async fn extract_trigger(\u0026self, content: \u0026str) -\u003e Option\u003c(String, String)\u003e {\n        let trigger_pattern = format!(\"@{}\", self.assistant_name);\n\n        if let Some(idx) = content.find(\u0026trigger_pattern) {\n            let after = \u0026content[idx + trigger_pattern.len()..];\n            let c = after.trim().to_string();\n            return Some((trigger_pattern, c));\n        }\n\n        None\n    }\n}\n\n// Webhook handler\nasync fn handle_telegram_webhook(\n    client: axum::extract::State\u003cArc\u003cMutex\u003cTelegramClient\u003e\u003e\u003e,\n    Json(update): Json\u003cTelegramUpdate\u003e,\n) -\u003e \u0026'static str {\n    let mut client = client.lock().await;\n    if let Err(e) = client.handle_update(\u0026update).await {\n        error!(\"Failed to handle telegram update: {}\", e);\n    }\n    \"OK\"\n}\n\nasync fn health_check() -\u003e \u0026'static str {\n    \"OK\"\n}\n\n// Helper functions\n\n/// Load router state from file\npub fn load_router_state() -\u003e RouterState {\n    let state_path = data_dir().join(\"router_state.json\");\n    load_json(\n        \u0026state_path,\n        RouterState {\n            last_timestamp: String::new(),\n            last_agent_timestamp: HashMap::new(),\n        },\n    )\n}\n\n/// Load registered groups from file\npub fn load_registered_groups() -\u003e HashMap\u003cString, RegisteredGroup\u003e {\n    let path = data_dir().join(\"registered_groups.json\");\n    load_json(\u0026path, HashMap::new())\n}\n\n/// Helper to truncate strings\nfn truncate(s: \u0026str, max_len: usize) -\u003e String {\n    if s.len() \u003c= max_len {\n        s.to_string()\n    } else {\n        format!(\"{}...\", \u0026s[..max_len - 3])\n    }\n}\n\n// Trait implementations for enums\n\nimpl DMPolicy {\n    pub fn from_str(s: \u0026str) -\u003e Self {\n        match s.to_lowercase().as_str() {\n            \"pairing\" =\u003e DMPolicy::Pairing,\n            \"allowlist\" =\u003e DMPolicy::Allowlist,\n            \"open\" =\u003e DMPolicy::Open,\n            \"disabled\" =\u003e DMPolicy::Disabled,\n            _ =\u003e DMPolicy::Pairing,\n        }\n    }\n}\n\nimpl GroupPolicy {\n    pub fn from_str(s: \u0026str) -\u003e Self {\n        match s.to_lowercase().as_str() {\n            \"open\" =\u003e GroupPolicy::Open,\n            \"allowlist\" =\u003e GroupPolicy::Allowlist,\n            \"disabled\" =\u003e GroupPolicy::Disabled,\n            _ =\u003e GroupPolicy::Allowlist,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_telegram_update() {\n        let json = r#\"{\n            \"update_id\": 123,\n            \"message\": {\n                \"message_id\": 456,\n                \"from\": {\"id\": 789, \"is_bot\": false, \"first_name\": \"Test\"},\n                \"chat\": {\"id\": -100123, \"type\": \"supergroup\", \"title\": \"Test Group\"},\n                \"date\": 1234567890,\n                \"text\": \"@Andy hello\"\n            }\n        }\"#;\n\n        let update: TelegramUpdate = serde_json::from_str(json).unwrap();\n        assert_eq!(update.update_id, 123);\n        assert!(update.message.is_some());\n    }\n\n    #[test]\n    fn test_extract_trigger_telegram() {\n        let client = TelegramClient {\n            api_url: \"https://api.telegram.org/bottest\".to_string(),\n            webhook_path: \"webhook\".to_string(),\n            dm_policy: DMPolicy::Pairing,\n            group_policy: GroupPolicy::Allowlist,\n            text_chunk_limit: 4000,\n            allowed_groups: vec![],\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let result = std::thread::spawn(move || {\n            let rt = tokio::runtime::Runtime::new().unwrap();\n            rt.block_on(client.extract_trigger(\"@Andy hello world\"))\n        })\n        .join()\n        .unwrap();\n\n        assert!(result.is_some());\n        let (trigger, content) = result.unwrap();\n        assert_eq!(trigger, \"@Andy\");\n        assert_eq!(content, \"hello world\");\n    }\n\n    #[test]\n    fn test_dm_policy_from_str() {\n        assert_eq!(DMPolicy::from_str(\"pairing\"), DMPolicy::Pairing);\n        assert_eq!(DMPolicy::from_str(\"allowlist\"), DMPolicy::Allowlist);\n        assert_eq!(DMPolicy::from_str(\"open\"), DMPolicy::Open);\n        assert_eq!(DMPolicy::from_str(\"disabled\"), DMPolicy::Disabled);\n        assert_eq!(DMPolicy::from_str(\"unknown\"), DMPolicy::Pairing);\n    }\n\n    #[test]\n    fn test_group_policy_from_str() {\n        assert_eq!(GroupPolicy::from_str(\"open\"), GroupPolicy::Open);\n        assert_eq!(GroupPolicy::from_str(\"allowlist\"), GroupPolicy::Allowlist);\n        assert_eq!(GroupPolicy::from_str(\"disabled\"), GroupPolicy::Disabled);\n        assert_eq!(GroupPolicy::from_str(\"unknown\"), GroupPolicy::Allowlist);\n    }\n\n    #[test]\n    fn test_text_chunking_short() {\n        let client = TelegramClient {\n            api_url: \"https://api.telegram.org/bottest\".to_string(),\n            webhook_path: \"webhook\".to_string(),\n            dm_policy: DMPolicy::Open,\n            group_policy: GroupPolicy::Open,\n            text_chunk_limit: 4000,\n            allowed_groups: vec![],\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let chunks = client.chunk_text(\"short text\");\n        assert_eq!(chunks.len(), 1);\n        assert_eq!(chunks[0], \"short text\");\n    }\n\n    #[test]\n    fn test_text_chunking_long() {\n        let client = TelegramClient {\n            api_url: \"https://api.telegram.org/bottest\".to_string(),\n            webhook_path: \"webhook\".to_string(),\n            dm_policy: DMPolicy::Open,\n            group_policy: GroupPolicy::Open,\n            text_chunk_limit: 50,\n            allowed_groups: vec![],\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        // Create a text longer than 50 characters with multiple paragraphs\n        let long_text = \"This is paragraph one that is longer than fifty characters.\\n\\nThis is paragraph two that is also quite long and should create multiple chunks.\\n\\nThis is the third paragraph to ensure we have enough content.\";\n        let chunks = client.chunk_text(long_text);\n        assert!(\n            chunks.len() \u003e 1,\n            \"Expected multiple chunks but got {:?}\",\n            chunks\n        );\n    }\n}\n","traces":[{"line":113,"address":[12361409,12359440,12361529],"length":1,"stats":{"Line":0}},{"line":114,"address":[12168445,12168350,12168246],"length":1,"stats":{"Line":0}},{"line":115,"address":[12344658],"length":1,"stats":{"Line":0}},{"line":118,"address":[12168601,12168533],"length":1,"stats":{"Line":0}},{"line":120,"address":[14077037],"length":1,"stats":{"Line":0}},{"line":121,"address":[12168701],"length":1,"stats":{"Line":0}},{"line":122,"address":[12168733],"length":1,"stats":{"Line":0}},{"line":123,"address":[11813664,11813680],"length":1,"stats":{"Line":0}},{"line":124,"address":[12360255],"length":1,"stats":{"Line":0}},{"line":125,"address":[14292112,14292128],"length":1,"stats":{"Line":0}},{"line":127,"address":[12360414],"length":1,"stats":{"Line":0}},{"line":128,"address":[14076398],"length":1,"stats":{"Line":0}},{"line":130,"address":[12360429],"length":1,"stats":{"Line":0}},{"line":131,"address":[12169212],"length":1,"stats":{"Line":0}},{"line":132,"address":[11813993,11813984],"length":1,"stats":{"Line":0}},{"line":133,"address":[12360526],"length":1,"stats":{"Line":0}},{"line":134,"address":[12360546],"length":1,"stats":{"Line":0}},{"line":135,"address":[12360577],"length":1,"stats":{"Line":0}},{"line":136,"address":[12169368],"length":1,"stats":{"Line":0}},{"line":137,"address":[12360631],"length":1,"stats":{"Line":0}},{"line":138,"address":[14076786],"length":1,"stats":{"Line":0}},{"line":139,"address":[12169465],"length":1,"stats":{"Line":0}},{"line":140,"address":[14076914],"length":1,"stats":{"Line":0}},{"line":141,"address":[12169565],"length":1,"stats":{"Line":0}},{"line":146,"address":[11819145,11814670,11817464,11814721,11814512,11814574],"length":1,"stats":{"Line":0}},{"line":147,"address":[11815177,11814770,11814642],"length":1,"stats":{"Line":0}},{"line":150,"address":[14293264,14294100],"length":1,"stats":{"Line":0}},{"line":152,"address":[12346387],"length":1,"stats":{"Line":0}},{"line":153,"address":[12236457],"length":1,"stats":{"Line":0}},{"line":154,"address":[14295974,14296396],"length":1,"stats":{"Line":0}},{"line":156,"address":[11816294,11816684,11816086],"length":1,"stats":{"Line":0}},{"line":159,"address":[12347060],"length":1,"stats":{"Line":0}},{"line":163,"address":[12358770,12358752],"length":1,"stats":{"Line":0}},{"line":164,"address":[12296096,12296256],"length":1,"stats":{"Line":0}},{"line":165,"address":[14244147,14245043,14245312,14245364,14245451,14244247],"length":1,"stats":{"Line":0}},{"line":166,"address":[11767214,11767139],"length":1,"stats":{"Line":0}},{"line":167,"address":[14244474,14245079,14244563,14244637],"length":1,"stats":{"Line":0}},{"line":169,"address":[11695343],"length":1,"stats":{"Line":0}},{"line":170,"address":[12299008,12299257,12299251,12297593,12299193],"length":1,"stats":{"Line":0}},{"line":171,"address":[11769611,11769675],"length":1,"stats":{"Line":0}},{"line":174,"address":[11768550],"length":1,"stats":{"Line":0}},{"line":175,"address":[14246594],"length":1,"stats":{"Line":0}},{"line":176,"address":[12298660],"length":1,"stats":{"Line":0}},{"line":178,"address":[11695362],"length":1,"stats":{"Line":0}},{"line":183,"address":[12298039],"length":1,"stats":{"Line":0}},{"line":187,"address":[14283223,14283244,14284093,14282976,14288549,14283023,14283180],"length":1,"stats":{"Line":0}},{"line":188,"address":[14283146,14283355,14283558,14283484],"length":1,"stats":{"Line":0}},{"line":189,"address":[14283313,14289360,14289376],"length":1,"stats":{"Line":0}},{"line":191,"address":[11810576,11805578,11810630],"length":1,"stats":{"Line":0}},{"line":192,"address":[12341541],"length":1,"stats":{"Line":0}},{"line":195,"address":[14283692],"length":1,"stats":{"Line":0}},{"line":196,"address":[14284133,14283847,14283210,14283932],"length":1,"stats":{"Line":0}},{"line":198,"address":[11807289,11807358,11806653,11806978,11807032,11806571,11807186,11807112],"length":1,"stats":{"Line":0}},{"line":199,"address":[12337100,12339222,12339248,12336808,12337224,12337274,12339287,12336883],"length":1,"stats":{"Line":0}},{"line":200,"address":[11807064,11807128,11806594,11809017,11807071,11807194,11808904,11808956],"length":1,"stats":{"Line":0}},{"line":201,"address":[12337452,12339238,12339203,12339303,12339145,12336824,12337565,12337611,12337478],"length":1,"stats":{"Line":0}},{"line":203,"address":[14285437,14285882],"length":1,"stats":{"Line":0}},{"line":205,"address":[12339586,12339478,12338102,12340057,12339673,12339086],"length":1,"stats":{"Line":0}},{"line":207,"address":[12339119,12339051,12335487,12339321,12339526],"length":1,"stats":{"Line":0}},{"line":208,"address":[12341169,12339552,12341233,12340928,12341227],"length":1,"stats":{"Line":0}},{"line":209,"address":[14288783,14288702],"length":1,"stats":{"Line":0}},{"line":212,"address":[11810095,11809702,11810028,11809953,11809519,11810303],"length":1,"stats":{"Line":0}},{"line":213,"address":[14287844,14287709,14283252,14287778,14288032],"length":1,"stats":{"Line":0}},{"line":214,"address":[11811177,11810992,11811241,11810005,11811235],"length":1,"stats":{"Line":0}},{"line":215,"address":[12341343,12341275],"length":1,"stats":{"Line":0}},{"line":218,"address":[11810136],"length":1,"stats":{"Line":0}},{"line":222,"address":[12358877,12358864],"length":1,"stats":{"Line":0}},{"line":223,"address":[12304343],"length":1,"stats":{"Line":0}},{"line":224,"address":[11774953],"length":1,"stats":{"Line":0}},{"line":226,"address":[14252317,14252773,14252235],"length":1,"stats":{"Line":0}},{"line":227,"address":[12304939],"length":1,"stats":{"Line":0}},{"line":231,"address":[12304407,12305845,12304465,12305978,12306576],"length":1,"stats":{"Line":0}},{"line":232,"address":[11696910],"length":1,"stats":{"Line":0}},{"line":236,"address":[14075536,14075549],"length":1,"stats":{"Line":0}},{"line":237,"address":[11811828],"length":1,"stats":{"Line":0}},{"line":240,"address":[12343712,12343728,12342279],"length":1,"stats":{"Line":0}},{"line":242,"address":[11811965],"length":1,"stats":{"Line":0}},{"line":245,"address":[12343808,12342403],"length":1,"stats":{"Line":0}},{"line":246,"address":[14291575],"length":1,"stats":{"Line":0}},{"line":247,"address":[11813459],"length":1,"stats":{"Line":0}},{"line":249,"address":[11813476],"length":1,"stats":{"Line":0}},{"line":252,"address":[11813292,11812050,11813280],"length":1,"stats":{"Line":0}},{"line":254,"address":[14290290,14290210],"length":1,"stats":{"Line":0}},{"line":256,"address":[11812358,11812283,11813328,11813340],"length":1,"stats":{"Line":0}},{"line":258,"address":[11812694],"length":1,"stats":{"Line":0}},{"line":259,"address":[11812401],"length":1,"stats":{"Line":0}},{"line":260,"address":[14290597],"length":1,"stats":{"Line":0}},{"line":261,"address":[11812513],"length":1,"stats":{"Line":0}},{"line":262,"address":[11812547],"length":1,"stats":{"Line":0}},{"line":263,"address":[12342964],"length":1,"stats":{"Line":0}},{"line":264,"address":[12343004],"length":1,"stats":{"Line":0}},{"line":269,"address":[12311408,12309155,12309302,12309239,12309260,12309134,12309091,12308955,12309508,12309218,12308848,12309323,12309176,12309197,12309352,12309281],"length":1,"stats":{"Line":0}},{"line":270,"address":[11779469,11779882,11779413,11779758],"length":1,"stats":{"Line":0}},{"line":271,"address":[11780269,11780125,11780725],"length":1,"stats":{"Line":0}},{"line":272,"address":[11780635],"length":1,"stats":{"Line":0}},{"line":275,"address":[11780169,11781734,11780102,11779490],"length":1,"stats":{"Line":0}},{"line":276,"address":[14354676],"length":1,"stats":{"Line":0}},{"line":279,"address":[12312106,12312302],"length":1,"stats":{"Line":0}},{"line":280,"address":[14259987,14260328,14260167,14262273,14256928],"length":1,"stats":{"Line":0}},{"line":281,"address":[12313436,12312945],"length":1,"stats":{"Line":0}},{"line":282,"address":[11783582],"length":1,"stats":{"Line":0}},{"line":287,"address":[11698118],"length":1,"stats":{"Line":0}},{"line":288,"address":[11785644,11785099,11785188],"length":1,"stats":{"Line":0}},{"line":289,"address":[12315354],"length":1,"stats":{"Line":0}},{"line":292,"address":[14354751],"length":1,"stats":{"Line":0}},{"line":293,"address":[14264744,14264614],"length":1,"stats":{"Line":0}},{"line":294,"address":[12316917],"length":1,"stats":{"Line":0}},{"line":297,"address":[12318753,12318307],"length":1,"stats":{"Line":0}},{"line":303,"address":[11791111,11789391,11789938,11789871,11789774,11789429,11787949],"length":1,"stats":{"Line":0}},{"line":305,"address":[14354776],"length":1,"stats":{"Line":0}},{"line":306,"address":[14278416,14278560,14267436],"length":1,"stats":{"Line":0}},{"line":307,"address":[12330697],"length":1,"stats":{"Line":0}},{"line":310,"address":[12320005,12319926],"length":1,"stats":{"Line":0}},{"line":313,"address":[14267976,14267898],"length":1,"stats":{"Line":0}},{"line":315,"address":[14268047],"length":1,"stats":{"Line":0}},{"line":320,"address":[11698181],"length":1,"stats":{"Line":0}},{"line":322,"address":[14269159,14269230],"length":1,"stats":{"Line":0}},{"line":323,"address":[11791683],"length":1,"stats":{"Line":0}},{"line":324,"address":[12321615],"length":1,"stats":{"Line":0}},{"line":325,"address":[12321838,12322454,12321694],"length":1,"stats":{"Line":0}},{"line":326,"address":[12423546,12423962],"length":1,"stats":{"Line":0}},{"line":327,"address":[14274966],"length":1,"stats":{"Line":0}},{"line":330,"address":[11791622],"length":1,"stats":{"Line":0}},{"line":331,"address":[12323311,12322884,12321548],"length":1,"stats":{"Line":0}},{"line":332,"address":[12323258,12324254,12325070],"length":1,"stats":{"Line":0}},{"line":333,"address":[14275757,14272310,14272698,14272221,14272752,14275707,14275844,14272428],"length":1,"stats":{"Line":0}},{"line":334,"address":[14355919,14354851,14355979],"length":1,"stats":{"Line":0}},{"line":337,"address":[11795124,11791543,11795551],"length":1,"stats":{"Line":0}},{"line":338,"address":[14273226,14274539,14274018],"length":1,"stats":{"Line":0}},{"line":339,"address":[11796666,11796725,11796497,11798480,11798418,11796579,11798547],"length":1,"stats":{"Line":0}},{"line":340,"address":[11698244,11699541],"length":1,"stats":{"Line":0}},{"line":344,"address":[12322707],"length":1,"stats":{"Line":0}},{"line":348,"address":[11769856,11770623,11773413,11770168,11769918,11770096,11770139],"length":1,"stats":{"Line":0}},{"line":349,"address":[14247390,14247241,14247723,14251760,14247508,14251904],"length":1,"stats":{"Line":0}},{"line":350,"address":[12304049],"length":1,"stats":{"Line":0}},{"line":353,"address":[11770405],"length":1,"stats":{"Line":0}},{"line":355,"address":[12299958,12301253,12299868],"length":1,"stats":{"Line":0}},{"line":356,"address":[12302043,12301376,12302952,12301716,12301790,12301414,12301488,12301974,12301333],"length":1,"stats":{"Line":0}},{"line":362,"address":[11770867,11772768,11772848,11773255,11770985,11771052,11773372],"length":1,"stats":{"Line":0}},{"line":363,"address":[12302358,12302424],"length":1,"stats":{"Line":0}},{"line":364,"address":[12302613,12302679],"length":1,"stats":{"Line":0}},{"line":365,"address":[11772897,11772795,11773208,11773391,11773263,11773074,11773192,11773144],"length":1,"stats":{"Line":0}},{"line":367,"address":[11770126,11770687,11770877,11773386,11773337,11770657],"length":1,"stats":{"Line":0}},{"line":368,"address":[12303987,12300394,12303929,12303993,12303744],"length":1,"stats":{"Line":0}},{"line":369,"address":[12303839,12303771],"length":1,"stats":{"Line":0}},{"line":372,"address":[12300785],"length":1,"stats":{"Line":0}},{"line":373,"address":[11771394,11773642,11770147,11771504],"length":1,"stats":{"Line":0}},{"line":374,"address":[11774052],"length":1,"stats":{"Line":0}},{"line":375,"address":[11773952,11773881],"length":1,"stats":{"Line":0}},{"line":380,"address":[11771891],"length":1,"stats":{"Line":0}},{"line":384,"address":[14073360,14074650,14074644],"length":1,"stats":{"Line":1}},{"line":385,"address":[12166104],"length":1,"stats":{"Line":1}},{"line":386,"address":[14073517,14074682],"length":1,"stats":{"Line":1}},{"line":389,"address":[14073467],"length":1,"stats":{"Line":1}},{"line":390,"address":[12166172],"length":1,"stats":{"Line":1}},{"line":392,"address":[12357563,12357485],"length":1,"stats":{"Line":2}},{"line":393,"address":[12358387,12357752,12357985],"length":1,"stats":{"Line":3}},{"line":394,"address":[12358217,12358133],"length":1,"stats":{"Line":2}},{"line":395,"address":[14074447,14074351],"length":1,"stats":{"Line":2}},{"line":397,"address":[12358392,12358300,12358411,12358321],"length":1,"stats":{"Line":3}},{"line":399,"address":[14074276,14074242],"length":1,"stats":{"Line":0}},{"line":400,"address":[14074282,14074334],"length":1,"stats":{"Line":0}},{"line":402,"address":[12166987,12166996],"length":1,"stats":{"Line":0}},{"line":406,"address":[14073903],"length":1,"stats":{"Line":1}},{"line":407,"address":[12357923,12357796],"length":1,"stats":{"Line":2}},{"line":410,"address":[12357868],"length":1,"stats":{"Line":1}},{"line":414,"address":[11801326,11801104,11801133],"length":1,"stats":{"Line":0}},{"line":415,"address":[14279010],"length":1,"stats":{"Line":0}},{"line":416,"address":[12331333],"length":1,"stats":{"Line":0}},{"line":417,"address":[14279061],"length":1,"stats":{"Line":0}},{"line":420,"address":[11801221],"length":1,"stats":{"Line":0}},{"line":426,"address":[12168016,12168034],"length":1,"stats":{"Line":0}},{"line":427,"address":[14280794],"length":1,"stats":{"Line":0}},{"line":428,"address":[14280918],"length":1,"stats":{"Line":0}},{"line":429,"address":[12333106],"length":1,"stats":{"Line":0}},{"line":432,"address":[11803456,11803210,11803026,11803330],"length":1,"stats":{"Line":0}},{"line":433,"address":[12333397,12333488,12333539],"length":1,"stats":{"Line":0}},{"line":436,"address":[14281248,14281385,14281360],"length":1,"stats":{"Line":0}},{"line":437,"address":[11803435],"length":1,"stats":{"Line":0}},{"line":439,"address":[11803310],"length":1,"stats":{"Line":0}},{"line":446,"address":[12359184,12359202],"length":1,"stats":{"Line":0}},{"line":447,"address":[12332774,12332697,12332896,12332880],"length":1,"stats":{"Line":0}},{"line":451,"address":[14075152],"length":1,"stats":{"Line":0}},{"line":452,"address":[14075181],"length":1,"stats":{"Line":0}},{"line":453,"address":[12359084],"length":1,"stats":{"Line":0}},{"line":454,"address":[14075228],"length":1,"stats":{"Line":0}},{"line":455,"address":[14279241],"length":1,"stats":{"Line":0}},{"line":460,"address":[12335196,12334832,12334973,12334946,12334854],"length":1,"stats":{"Line":0}},{"line":461,"address":[12334910],"length":1,"stats":{"Line":0}},{"line":462,"address":[14282666,14282760],"length":1,"stats":{"Line":0}},{"line":464,"address":[11804873],"length":1,"stats":{"Line":0}},{"line":465,"address":[14282839],"length":1,"stats":{"Line":0}},{"line":468,"address":[11804959,11804917],"length":1,"stats":{"Line":0}},{"line":469,"address":[11805014,11804969],"length":1,"stats":{"Line":0}},{"line":470,"address":[11805020],"length":1,"stats":{"Line":0}},{"line":474,"address":[14282895],"length":1,"stats":{"Line":0}},{"line":478,"address":[12334792,12334059,12333936,12334086,12334764,12333964],"length":1,"stats":{"Line":0}},{"line":479,"address":[14281894,14281783,14281874],"length":1,"stats":{"Line":0}},{"line":480,"address":[14281973,14282119],"length":1,"stats":{"Line":0}},{"line":482,"address":[14282005,14282127,14282076,14282514,14281982],"length":1,"stats":{"Line":0}},{"line":484,"address":[14282183],"length":1,"stats":{"Line":0}},{"line":485,"address":[12334640],"length":1,"stats":{"Line":0}},{"line":489,"address":[12358896,12358909],"length":1,"stats":{"Line":0}},{"line":490,"address":[12307341,12307460,12307549,12308390],"length":1,"stats":{"Line":0}},{"line":493,"address":[12308778,12308704,12307433,12308828],"length":1,"stats":{"Line":0}},{"line":494,"address":[12308722],"length":1,"stats":{"Line":0}},{"line":497,"address":[11778587,11778066,11778520,11778440],"length":1,"stats":{"Line":0}},{"line":500,"address":[14255658,14255475],"length":1,"stats":{"Line":0}},{"line":507,"address":[14255535],"length":1,"stats":{"Line":0}},{"line":510,"address":[14256266,14256198],"length":1,"stats":{"Line":0}},{"line":513,"address":[14256001],"length":1,"stats":{"Line":0}},{"line":517,"address":[12332561,12331842,12331815,12331664,12331702],"length":1,"stats":{"Line":4}},{"line":518,"address":[11801801,11801701],"length":1,"stats":{"Line":2}},{"line":520,"address":[12331991,12332074],"length":1,"stats":{"Line":2}},{"line":521,"address":[12332133,12332195],"length":1,"stats":{"Line":2}},{"line":522,"address":[11802216],"length":1,"stats":{"Line":1}},{"line":523,"address":[11802262],"length":1,"stats":{"Line":1}},{"line":526,"address":[14279899],"length":1,"stats":{"Line":0}},{"line":531,"address":[12362416],"length":1,"stats":{"Line":0}},{"line":535,"address":[12419235],"length":1,"stats":{"Line":0}},{"line":536,"address":[11693873],"length":1,"stats":{"Line":0}},{"line":537,"address":[14300375,14299864,14299980],"length":1,"stats":{"Line":0}},{"line":542,"address":[12295874,12295856,12295916],"length":1,"stats":{"Line":0}},{"line":549,"address":[14077728,14078181,14078187],"length":1,"stats":{"Line":0}},{"line":550,"address":[12361617],"length":1,"stats":{"Line":0}},{"line":552,"address":[12170500],"length":1,"stats":{"Line":0}},{"line":553,"address":[14078058],"length":1,"stats":{"Line":0}},{"line":554,"address":[12361845],"length":1,"stats":{"Line":0}},{"line":555,"address":[12361852],"length":1,"stats":{"Line":0}},{"line":561,"address":[12362386,12362392,12362080],"length":1,"stats":{"Line":0}},{"line":562,"address":[12362097],"length":1,"stats":{"Line":0}},{"line":563,"address":[12170964],"length":1,"stats":{"Line":0}},{"line":567,"address":[14078992],"length":1,"stats":{"Line":0}},{"line":568,"address":[12362936],"length":1,"stats":{"Line":0}},{"line":569,"address":[12362994],"length":1,"stats":{"Line":0}},{"line":571,"address":[12363019,12362956],"length":1,"stats":{"Line":0}},{"line":578,"address":[12362839,12362496,12362833],"length":1,"stats":{"Line":1}},{"line":579,"address":[12362602,12362516],"length":1,"stats":{"Line":2}},{"line":580,"address":[12171356,12171290],"length":1,"stats":{"Line":2}},{"line":581,"address":[12362695,12362734,12362661],"length":1,"stats":{"Line":3}},{"line":582,"address":[12171383,12171417,12171456],"length":1,"stats":{"Line":3}},{"line":583,"address":[12171480,12171433,12171467],"length":1,"stats":{"Line":3}},{"line":584,"address":[12171473],"length":1,"stats":{"Line":1}},{"line":590,"address":[12357205,12357199,12356912],"length":1,"stats":{"Line":1}},{"line":591,"address":[12356932,12357018],"length":1,"stats":{"Line":2}},{"line":592,"address":[12357034,12357100],"length":1,"stats":{"Line":2}},{"line":593,"address":[12357150,12357111,12357077],"length":1,"stats":{"Line":3}},{"line":594,"address":[12357174,12357127,12357161],"length":1,"stats":{"Line":3}},{"line":595,"address":[12357167],"length":1,"stats":{"Line":1}}],"covered":32,"coverable":249},{"path":["/","root","code","nuclaw","src","types.rs"],"content":"//! Core types for NuClaw\n\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RegisteredGroup {\n    pub name: String,\n    pub folder: String,\n    pub trigger: String,\n    pub added_at: String,\n}\n\n#[derive(Debug, Clone, Default, Serialize, Deserialize)]\npub struct Session(HashMap\u003cString, String\u003e);\n\nimpl Session {\n    pub fn new() -\u003e Self {\n        Self(HashMap::new())\n    }\n\n    pub fn len(\u0026self) -\u003e usize {\n        self.0.len()\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ScheduledTask {\n    pub id: String,\n    pub group_folder: String,\n    pub chat_jid: String,\n    pub prompt: String,\n    pub schedule_type: String,\n    pub schedule_value: String,\n    pub context_mode: String,\n    pub next_run: Option\u003cString\u003e,\n    pub last_run: Option\u003cString\u003e,\n    pub last_result: Option\u003cString\u003e,\n    pub status: String,\n    pub created_at: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TaskRunLog {\n    pub task_id: String,\n    pub run_at: String,\n    pub duration_ms: i64,\n    pub status: String,\n    pub result: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct NewMessage {\n    pub id: String,\n    pub chat_jid: String,\n    pub sender: String,\n    pub sender_name: String,\n    pub content: String,\n    pub timestamp: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ChatInfo {\n    pub jid: String,\n    pub name: String,\n    pub last_message_time: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ContainerInput {\n    pub prompt: String,\n    pub session_id: Option\u003cString\u003e,\n    pub group_folder: String,\n    pub chat_jid: String,\n    pub is_main: bool,\n    pub is_scheduled_task: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ContainerOutput {\n    pub status: String,\n    pub result: Option\u003cString\u003e,\n    pub new_session_id: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct RouterState {\n    pub last_timestamp: String,\n    pub last_agent_timestamp: HashMap\u003cString, String\u003e,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_registered_group() {\n        let group = RegisteredGroup {\n            name: \"Test Group\".to_string(),\n            folder: \"test_group\".to_string(),\n            trigger: \"@Andy\".to_string(),\n            added_at: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(group.name, \"Test Group\");\n        assert_eq!(group.folder, \"test_group\");\n    }\n\n    #[test]\n    fn test_session() {\n        let mut session = Session::new();\n        session.0.insert(\"key1\".to_string(), \"value1\".to_string());\n        assert_eq!(session.len(), 1);\n    }\n\n    #[test]\n    fn test_scheduled_task() {\n        let task = ScheduledTask {\n            id: \"task_1\".to_string(),\n            group_folder: \"group_1\".to_string(),\n            chat_jid: \"chat_1\".to_string(),\n            prompt: \"test prompt\".to_string(),\n            schedule_type: \"cron\".to_string(),\n            schedule_value: \"0 0 9 * * *\".to_string(),\n            context_mode: \"isolated\".to_string(),\n            next_run: Some(\"2025-01-01T09:00:00Z\".to_string()),\n            last_run: None,\n            last_result: None,\n            status: \"active\".to_string(),\n            created_at: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(task.schedule_type, \"cron\");\n        assert_eq!(task.status, \"active\");\n    }\n\n    #[test]\n    fn test_container_input() {\n        let input = ContainerInput {\n            prompt: \"test\".to_string(),\n            session_id: Some(\"sess_123\".to_string()),\n            group_folder: \"group_1\".to_string(),\n            chat_jid: \"chat_1\".to_string(),\n            is_main: true,\n            is_scheduled_task: false,\n        };\n        assert!(input.session_id.is_some());\n        assert!(input.is_main);\n    }\n\n    #[test]\n    fn test_container_output() {\n        let output = ContainerOutput {\n            status: \"success\".to_string(),\n            result: Some(\"result\".to_string()),\n            new_session_id: Some(\"new_sess\".to_string()),\n            error: None,\n        };\n        assert_eq!(output.status, \"success\");\n        assert!(output.result.is_some());\n        assert!(output.error.is_none());\n    }\n\n    #[test]\n    fn test_router_state() {\n        let mut state = RouterState::default();\n        state.last_timestamp = \"2025-01-01T00:00:00Z\".to_string();\n        state\n            .last_agent_timestamp\n            .insert(\"chat_1\".to_string(), \"2025-01-01T00:00:00Z\".to_string());\n        assert_eq!(state.last_agent_timestamp.len(), 1);\n    }\n\n    #[test]\n    fn test_new_message() {\n        let msg = NewMessage {\n            id: \"msg_1\".to_string(),\n            chat_jid: \"chat_1\".to_string(),\n            sender: \"user_1\".to_string(),\n            sender_name: \"Test User\".to_string(),\n            content: \"Hello\".to_string(),\n            timestamp: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(msg.content, \"Hello\");\n    }\n\n    #[test]\n    fn test_task_run_log() {\n        let log = TaskRunLog {\n            task_id: \"task_1\".to_string(),\n            run_at: \"2025-01-01T00:00:00Z\".to_string(),\n            duration_ms: 1000,\n            status: \"success\".to_string(),\n            result: Some(\"ok\".to_string()),\n            error: None,\n        };\n        assert_eq!(log.duration_ms, 1000);\n    }\n\n    #[test]\n    fn test_chat_info() {\n        let info = ChatInfo {\n            jid: \"chat_1\".to_string(),\n            name: \"Test Chat\".to_string(),\n            last_message_time: \"2025-01-01T00:00:00Z\".to_string(),\n        };\n        assert_eq!(info.name, \"Test Chat\");\n    }\n}\n","traces":[{"line":18,"address":[12225344],"length":1,"stats":{"Line":0}},{"line":19,"address":[12225358],"length":1,"stats":{"Line":0}},{"line":22,"address":[12225328],"length":1,"stats":{"Line":0}},{"line":23,"address":[12225333],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","root","code","nuclaw","src","utils.rs"],"content":"//! Utilities for NuClaw\n\nuse serde::{Deserialize, Serialize};\nuse std::fs::{File, OpenOptions};\nuse std::io::{Read, Write};\nuse std::path::Path;\n\npub mod json {\n    use super::*;\n\n    pub fn load_json\u003cT\u003e(path: \u0026Path, default: T) -\u003e T\n    where\n        T: for\u003c'de\u003e Deserialize\u003c'de\u003e + Default,\n    {\n        if !path.exists() {\n            return default;\n        }\n\n        match File::open(path) {\n            Ok(mut file) =\u003e {\n                let mut contents = String::new();\n                if file.read_to_string(\u0026mut contents).is_ok() {\n                    serde_json::from_str(\u0026contents).unwrap_or(default)\n                } else {\n                    default\n                }\n            }\n            Err(_) =\u003e default,\n        }\n    }\n\n    pub fn save_json\u003cT\u003e(path: \u0026Path, data: \u0026T) -\u003e std::io::Result\u003c()\u003e\n    where\n        T: Serialize,\n    {\n        if let Some(parent) = path.parent() {\n            std::fs::create_dir_all(parent)?;\n        }\n\n        let json = serde_json::to_string_pretty(data)?;\n        let mut file = OpenOptions::new()\n            .write(true)\n            .create(true)\n            .truncate(true)\n            .open(path)?;\n        file.write_all(json.as_bytes())?;\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::json::{load_json, save_json};\n    use std::fs;\n    use std::path::PathBuf;\n    use tempfile::tempdir;\n\n    #[derive(Debug, Default, serde::Deserialize, serde::Serialize, Clone)]\n    struct TestData {\n        name: String,\n        value: i32,\n    }\n\n    fn test_dir() -\u003e PathBuf {\n        tempdir().unwrap().into_path()\n    }\n\n    fn cleanup(path: \u0026PathBuf) {\n        let _ = fs::remove_file(path);\n    }\n\n    #[test]\n    fn test_save_json() {\n        let dir = test_dir();\n        let path = dir.join(\"test.json\");\n\n        let data = TestData {\n            name: \"test\".to_string(),\n            value: 42,\n        };\n\n        let result = save_json(\u0026path, \u0026data);\n        assert!(result.is_ok());\n        assert!(path.exists());\n\n        cleanup(\u0026path);\n    }\n\n    #[test]\n    fn test_load_json_existing() {\n        let dir = test_dir();\n        let path = dir.join(\"test.json\");\n\n        let data = TestData {\n            name: \"test\".to_string(),\n            value: 42,\n        };\n        save_json(\u0026path, \u0026data).unwrap();\n\n        let loaded: TestData = load_json(\u0026path, TestData::default());\n        assert_eq!(loaded.name, \"test\");\n        assert_eq!(loaded.value, 42);\n\n        cleanup(\u0026path);\n    }\n\n    #[test]\n    fn test_load_json_nonexistent() {\n        let dir = test_dir();\n        let path = dir.join(\"nonexistent.json\");\n\n        let default = TestData {\n            name: \"default\".to_string(),\n            value: 0,\n        };\n\n        let loaded: TestData = load_json(\u0026path, default.clone());\n        assert_eq!(loaded.name, \"default\");\n        assert_eq!(loaded.value, 0);\n    }\n\n    #[test]\n    fn test_load_json_invalid() {\n        let dir = test_dir();\n        let path = dir.join(\"invalid.json\");\n\n        fs::write(\u0026path, \"not valid json\").unwrap();\n\n        let default = TestData {\n            name: \"default\".to_string(),\n            value: 0,\n        };\n\n        let loaded: TestData = load_json(\u0026path, default.clone());\n        assert_eq!(loaded.name, \"default\");\n        assert_eq!(loaded.value, 0);\n\n        cleanup(\u0026path);\n    }\n\n    #[test]\n    fn test_save_json_creates_parent() {\n        let dir = test_dir();\n        let path = dir.join(\"subdir\").join(\"nested.json\");\n\n        let data = TestData {\n            name: \"nested\".to_string(),\n            value: 100,\n        };\n\n        let result = save_json(\u0026path, \u0026data);\n        assert!(result.is_ok());\n        assert!(path.exists());\n\n        let _ = fs::remove_dir_all(dir);\n    }\n}\n","traces":[{"line":11,"address":[12365024,12365926,12364224,12365104,12365882,12365068],"length":1,"stats":{"Line":0}},{"line":15,"address":[12364288,12365168,12365240,12364360],"length":1,"stats":{"Line":0}},{"line":16,"address":[12365256,12364376],"length":1,"stats":{"Line":0}},{"line":19,"address":[12001542,12002406,12002435,12001571],"length":1,"stats":{"Line":0}},{"line":20,"address":[12365360,12364480],"length":1,"stats":{"Line":0}},{"line":21,"address":[12002493,12001629],"length":1,"stats":{"Line":0}},{"line":22,"address":[14162540,14161581,14161660,14162461],"length":1,"stats":{"Line":0}},{"line":23,"address":[12364800,12365680],"length":1,"stats":{"Line":0}},{"line":25,"address":[12001890,12002754],"length":1,"stats":{"Line":0}},{"line":28,"address":[12002457,12001593],"length":1,"stats":{"Line":0}},{"line":32,"address":[12003072,12004019,12004037],"length":1,"stats":{"Line":0}},{"line":36,"address":[12003118],"length":1,"stats":{"Line":0}},{"line":37,"address":[12003188,12003313],"length":1,"stats":{"Line":0}},{"line":40,"address":[12366256,12366137],"length":1,"stats":{"Line":0}},{"line":41,"address":[12366364,12366576,12366518,12366934],"length":1,"stats":{"Line":0}},{"line":45,"address":[12366499,12366560],"length":1,"stats":{"Line":0}},{"line":46,"address":[12366702,12366880,12366631],"length":1,"stats":{"Line":0}},{"line":47,"address":[12366829],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":18},{"path":["/","root","code","nuclaw","src","whatsapp.rs"],"content":"//! WhatsApp Integration for NuClaw\n//!\n//! Provides WhatsApp connectivity via external WhatsApp MCP Server or HTTP API.\n\nuse crate::config::{assistant_name, data_dir, store_dir};\nuse crate::container_runner::run_container;\nuse crate::db::Database;\nuse crate::error::{NuClawError, Result};\nuse crate::types::{ContainerInput, NewMessage, RegisteredGroup, RouterState};\nuse crate::utils::json::{load_json, save_json};\nuse std::collections::HashMap;\nuse tokio::time::{timeout, Duration};\nuse tracing::{debug, error, info};\n\n/// Default WhatsApp poll interval: 2 seconds\nconst DEFAULT_WHATSAPP_POLL_INTERVAL_MS: u64 = 2000;\n\n/// WhatsApp client state\npub struct WhatsAppClient {\n    /// Connection status\n    pub connected: bool,\n    /// Last QR code for authentication\n    pub last_qr: Option\u003cString\u003e,\n    /// Reference to registered groups\n    registered_groups: HashMap\u003cString, RegisteredGroup\u003e,\n    /// Router state for message deduplication\n    router_state: RouterState,\n    /// Database connection\n    db: Database,\n    /// Assistant name for trigger detection\n    assistant_name: String,\n}\n\nimpl WhatsAppClient {\n    /// Create a new WhatsApp client\n    pub fn new(db: Database) -\u003e Self {\n        Self {\n            connected: false,\n            last_qr: None,\n            registered_groups: load_registered_groups(),\n            router_state: load_router_state(),\n            db,\n            assistant_name: assistant_name(),\n        }\n    }\n\n    /// Connect to WhatsApp\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to WhatsApp...\");\n\n        // Check if we need authentication\n        if self.needs_authentication().await? {\n            info!(\"Authentication required, generating QR code...\");\n            self.request_qr_code().await?;\n        } else {\n            info!(\"Using cached authentication\");\n            self.connected = true;\n        }\n\n        Ok(())\n    }\n\n    /// Check if authentication is needed\n    async fn needs_authentication(\u0026self) -\u003e Result\u003cbool\u003e {\n        let creds_path = store_dir().join(\"auth\").join(\"creds.json\");\n\n        // If creds file exists and is valid, no auth needed\n        if creds_path.exists() {\n            if let Ok(metadata) = std::fs::metadata(\u0026creds_path) {\n                let modified = metadata\n                    .modified()\n                    .unwrap_or(std::time::SystemTime::UNIX_EPOCH);\n                let duration = modified.elapsed().unwrap_or(std::time::Duration::ZERO);\n                if duration.as_secs() \u003c 24 * 60 * 60 {\n                    return Ok(false);\n                }\n            }\n        }\n\n        Ok(true)\n    }\n\n    /// Request QR code for authentication\n    async fn request_qr_code(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let mcp_url = get_mcp_url()?;\n\n        let response = reqwest::Client::new()\n            .post(\u0026format!(\"{}/auth/qr\", mcp_url))\n            .timeout(Duration::from_secs(30))\n            .send()\n            .await\n            .map_err(|e| NuClawError::WhatsApp {\n                message: format!(\"Failed to request QR code: {}\", e),\n            })?;\n\n        if response.status() == 200 {\n            let qr_data: serde_json::Value =\n                response.json().await.map_err(|e| NuClawError::WhatsApp {\n                    message: format!(\"Failed to parse QR response: {}\", e),\n                })?;\n\n            if let Some(qr) = qr_data.get(\"qr\").and_then(|v| v.as_str()) {\n                self.last_qr = Some(qr.to_string());\n                info!(\"QR code received (display in terminal)\");\n                info!(\"Scan with WhatsApp to authenticate\");\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Start listening for messages\n    pub async fn start_message_listener(\u0026mut self) {\n        let mut interval =\n            tokio::time::interval(Duration::from_millis(DEFAULT_WHATSAPP_POLL_INTERVAL_MS));\n\n        info!(\"Starting message listener...\");\n\n        loop {\n            interval.tick().await;\n\n            if let Err(e) = self.poll_messages().await {\n                error!(\"Error polling messages: {}\", e);\n            }\n        }\n    }\n\n    /// Poll for new messages\n    async fn poll_messages(\u0026mut self) -\u003e Result\u003c()\u003e {\n        let mcp_url = get_mcp_url()?;\n\n        let response = reqwest::Client::new()\n            .get(\u0026format!(\"{}/messages\", mcp_url))\n            .timeout(Duration::from_secs(30))\n            .send()\n            .await\n            .map_err(|e| NuClawError::WhatsApp {\n                message: format!(\"Failed to poll messages: {}\", e),\n            })?;\n\n        if response.status() == 200 {\n            let messages: Vec\u003cNewMessage\u003e =\n                response.json().await.map_err(|e| NuClawError::WhatsApp {\n                    message: format!(\"Failed to parse messages: {}\", e),\n                })?;\n\n            for msg in messages {\n                self.handle_message(\u0026msg).await?;\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Handle a single message\n    pub async fn handle_message(\u0026mut self, msg: \u0026NewMessage) -\u003e Result\u003cOption\u003cString\u003e\u003e {\n        if self.is_duplicate_message(msg).await {\n            debug!(\"Skipping duplicate message: {}\", msg.id);\n            return Ok(None);\n        }\n\n        self.update_router_state(msg).await;\n        self.store_message(msg).await?;\n\n        if !self.is_registered_group(\u0026msg.chat_jid).await {\n            debug!(\"Message from unregistered group: {}\", msg.chat_jid);\n            return Ok(None);\n        }\n\n        let (_, content) = match self.extract_trigger(\u0026msg.content).await {\n            Some((_, c)) =\u003e (String::new(), c),\n            None =\u003e return Ok(None),\n        };\n\n        info!(\n            \"Received message from {}: {}\",\n            msg.sender,\n            truncate(\u0026content, 50)\n        );\n\n        let group_folder =\n            self.get_group_folder(\u0026msg.chat_jid)\n                .await\n                .ok_or_else(|| NuClawError::WhatsApp {\n                    message: format!(\"Group not found: {}\", msg.chat_jid),\n                })?;\n\n        let session_id = format!(\"whatsapp_{}\", msg.id);\n        let input = ContainerInput {\n            prompt: content,\n            session_id: Some(session_id.clone()),\n            group_folder,\n            chat_jid: msg.chat_jid.clone(),\n            is_main: msg.chat_jid.ends_with(\"@s.whatsapp.net\"),\n            is_scheduled_task: false,\n        };\n\n        let result = timeout(Duration::from_secs(300), run_container(input)).await;\n\n        match result {\n            Ok(Ok(output)) =\u003e {\n                if let Some(response) = output.result {\n                    self.send_message(\u0026msg.chat_jid, \u0026response).await?;\n                    return Ok(Some(response));\n                }\n            }\n            Ok(Err(e)) =\u003e {\n                error!(\"Container error: {}\", e);\n                self.send_message(\u0026msg.chat_jid, \u0026format!(\"Error: {}\", e))\n                    .await?;\n            }\n            Err(_) =\u003e {\n                error!(\"Container timeout\");\n                self.send_message(\u0026msg.chat_jid, \"Sorry, the request timed out.\")\n                    .await?;\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Send a message\n    pub async fn send_message(\u0026self, jid: \u0026str, content: \u0026str) -\u003e Result\u003c()\u003e {\n        let mcp_url = get_mcp_url()?;\n\n        let payload = serde_json::json!({\n            \"jid\": jid,\n            \"message\": content,\n        });\n\n        let response = reqwest::Client::new()\n            .post(\u0026format!(\"{}/messages/send\", mcp_url))\n            .json(\u0026payload)\n            .timeout(Duration::from_secs(30))\n            .send()\n            .await\n            .map_err(|e| NuClawError::WhatsApp {\n                message: format!(\"Failed to send message: {}\", e),\n            })?;\n\n        if !response.status().is_success() {\n            return Err(NuClawError::WhatsApp {\n                message: format!(\"Failed to send message: status {}\", response.status()),\n            });\n        }\n\n        Ok(())\n    }\n\n    /// Check if message is duplicate\n    async fn is_duplicate_message(\u0026self, msg: \u0026NewMessage) -\u003e bool {\n        let last_timestamp = \u0026self.router_state.last_timestamp;\n        let last_agent = self.router_state.last_agent_timestamp.get(\u0026msg.chat_jid);\n\n        if last_timestamp == \u0026msg.timestamp {\n            return true;\n        }\n\n        if let Some(agent_ts) = last_agent {\n            if agent_ts == \u0026msg.timestamp {\n                return true;\n            }\n        }\n\n        false\n    }\n\n    /// Update router state after processing\n    async fn update_router_state(\u0026mut self, msg: \u0026NewMessage) {\n        self.router_state.last_timestamp = msg.timestamp.clone();\n        self.router_state\n            .last_agent_timestamp\n            .insert(msg.chat_jid.clone(), msg.timestamp.clone());\n\n        let state_path = data_dir().join(\"router_state.json\");\n        let _ = save_json(\u0026state_path, \u0026self.router_state);\n    }\n\n    /// Store message in database\n    async fn store_message(\u0026self, msg: \u0026NewMessage) -\u003e Result\u003c()\u003e {\n        let conn = self\n            .db\n            .get_connection()\n            .map_err(|e| NuClawError::Database {\n                message: e.to_string(),\n            })?;\n\n        conn.execute(\n            \"INSERT OR REPLACE INTO messages (id, chat_jid, sender, sender_name, content, timestamp, is_from_me)\n             VALUES (?, ?, ?, ?, ?, ?, ?)\",\n            rusqlite::params![\n                msg.id,\n                msg.chat_jid,\n                msg.sender,\n                msg.sender_name,\n                msg.content,\n                msg.timestamp,\n                if msg.id.starts_with(\"self\") { 1 } else { 0 },\n            ],\n        ).map_err(|e| NuClawError::Database {\n            message: format!(\"Failed to store message: {}\", e),\n        })?;\n\n        Ok(())\n    }\n\n    /// Check if a chat is a registered group\n    async fn is_registered_group(\u0026self, jid: \u0026str) -\u003e bool {\n        self.registered_groups.contains_key(jid)\n    }\n\n    /// Get group folder for a chat JID\n    async fn get_group_folder(\u0026self, jid: \u0026str) -\u003e Option\u003cString\u003e {\n        self.registered_groups.get(jid).map(|g| g.folder.clone())\n    }\n\n    /// Extract trigger and content from message\n    async fn extract_trigger(\u0026self, content: \u0026str) -\u003e Option\u003c(String, String)\u003e {\n        let trigger_pattern = format!(\"@{}\", self.assistant_name);\n\n        if let Some(idx) = content.find(\u0026trigger_pattern) {\n            let after = \u0026content[idx + trigger_pattern.len()..];\n            let c = after.trim().to_string();\n            return Some((trigger_pattern, c));\n        }\n\n        None\n    }\n}\n\n// Helper functions\n\n/// Get WhatsApp MCP URL from environment\nfn get_mcp_url() -\u003e Result\u003cString\u003e {\n    std::env::var(\"WHATSAPP_MCP_URL\").map_err(|_| NuClawError::Config {\n        message: \"WHATSAPP_MCP_URL not set\".to_string(),\n    })\n}\n\n/// Load router state from file\npub fn load_router_state() -\u003e RouterState {\n    let state_path = data_dir().join(\"router_state.json\");\n    load_json(\n        \u0026state_path,\n        RouterState {\n            last_timestamp: String::new(),\n            last_agent_timestamp: HashMap::new(),\n        },\n    )\n}\n\n/// Load registered groups from file\npub fn load_registered_groups() -\u003e HashMap\u003cString, RegisteredGroup\u003e {\n    let path = data_dir().join(\"registered_groups.json\");\n    load_json(\u0026path, HashMap::new())\n}\n\n/// Start the authentication flow\npub async fn start_auth_flow() {\n    let auth_path = store_dir().join(\"auth\");\n    std::fs::create_dir_all(\u0026auth_path).ok();\n    info!(\"Use WHATSAPP_MCP_URL to configure WhatsApp connection\");\n}\n\n/// Helper to truncate strings\nfn truncate(s: \u0026str, max_len: usize) -\u003e String {\n    if s.len() \u003c= max_len {\n        s.to_string()\n    } else {\n        format!(\"{}...\", \u0026s[..max_len - 3])\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_truncate_short() {\n        assert_eq!(truncate(\"hello\", 10), \"hello\");\n    }\n\n    #[test]\n    fn test_truncate_long() {\n        assert_eq!(truncate(\"hello world\", 8), \"hello...\");\n    }\n\n    #[test]\n    fn test_extract_trigger_with_at() {\n        let client = WhatsAppClient {\n            connected: false,\n            last_qr: None,\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let result = tokio::runtime::Runtime::new()\n            .unwrap()\n            .block_on(client.extract_trigger(\"@Andy hello world\"));\n\n        assert!(result.is_some());\n        let (trigger, content) = result.unwrap();\n        assert_eq!(trigger, \"@Andy\");\n        assert_eq!(content, \"hello world\");\n    }\n\n    #[test]\n    fn test_extract_trigger_without_at() {\n        let client = WhatsAppClient {\n            connected: false,\n            last_qr: None,\n            registered_groups: HashMap::new(),\n            router_state: RouterState::default(),\n            db: Database::new().unwrap(),\n            assistant_name: \"Andy\".to_string(),\n        };\n\n        let result = tokio::runtime::Runtime::new()\n            .unwrap()\n            .block_on(client.extract_trigger(\"hello world\"));\n\n        assert!(result.is_none());\n    }\n}\n","traces":[{"line":36,"address":[12236288,12235856,12236319],"length":1,"stats":{"Line":0}},{"line":40,"address":[12940325],"length":1,"stats":{"Line":0}},{"line":41,"address":[14871662],"length":1,"stats":{"Line":0}},{"line":43,"address":[12236064],"length":1,"stats":{"Line":0}},{"line":48,"address":[14648383,14648507,14649866,14648464,14648336,14652799,14648536],"length":1,"stats":{"Line":0}},{"line":49,"address":[14648989,14648582,14648436],"length":1,"stats":{"Line":0}},{"line":52,"address":[12236737],"length":1,"stats":{"Line":0}},{"line":53,"address":[14650276,14651522,14651929],"length":1,"stats":{"Line":0}},{"line":54,"address":[12721533,12721857,12717235,12720616,12721346],"length":1,"stats":{"Line":0}},{"line":56,"address":[12719431,12718968,12719034],"length":1,"stats":{"Line":0}},{"line":57,"address":[14650688],"length":1,"stats":{"Line":0}},{"line":60,"address":[12654226],"length":1,"stats":{"Line":0}},{"line":64,"address":[12235824,12235832],"length":1,"stats":{"Line":0}},{"line":65,"address":[12711621,12711717],"length":1,"stats":{"Line":0}},{"line":68,"address":[14643336],"length":1,"stats":{"Line":0}},{"line":69,"address":[12712271,12712146],"length":1,"stats":{"Line":0}},{"line":70,"address":[12646511],"length":1,"stats":{"Line":0}},{"line":72,"address":[14643621],"length":1,"stats":{"Line":0}},{"line":73,"address":[12712397],"length":1,"stats":{"Line":0}},{"line":74,"address":[14643768],"length":1,"stats":{"Line":0}},{"line":75,"address":[12646731],"length":1,"stats":{"Line":0}},{"line":80,"address":[12712104],"length":1,"stats":{"Line":0}},{"line":84,"address":[12704086,12703162,12703090,12703006,12703133,12704230,12702944],"length":1,"stats":{"Line":0}},{"line":85,"address":[12704145,12703201,12703071],"length":1,"stats":{"Line":0}},{"line":87,"address":[12704438,12704022,12704490,12703389,12703829,12703479,12704577],"length":1,"stats":{"Line":0}},{"line":88,"address":[12637757,12637823,12637997],"length":1,"stats":{"Line":0}},{"line":89,"address":[12638032,12638312,12638093,12638010,12637788,12637680,12637962],"length":1,"stats":{"Line":0}},{"line":91,"address":[11701743],"length":1,"stats":{"Line":0}},{"line":92,"address":[12643557,12638727,12643493,12643551,12643312],"length":1,"stats":{"Line":0}},{"line":93,"address":[12708891,12708959],"length":1,"stats":{"Line":0}},{"line":96,"address":[12639090],"length":1,"stats":{"Line":0}},{"line":97,"address":[12642656,12637409,12642927,12642933,12642688,12639780,12642869,12639494,12639210],"length":1,"stats":{"Line":0}},{"line":99,"address":[12642779,12642715],"length":1,"stats":{"Line":0}},{"line":102,"address":[12639964,12642969,12639877,12642960],"length":1,"stats":{"Line":0}},{"line":103,"address":[12640192,12640082,12640131],"length":1,"stats":{"Line":0}},{"line":104,"address":[14637835,14637396],"length":1,"stats":{"Line":0}},{"line":105,"address":[12707349,12706517],"length":1,"stats":{"Line":0}},{"line":109,"address":[12639175],"length":1,"stats":{"Line":0}},{"line":113,"address":[12940256,12940264],"length":1,"stats":{"Line":0}},{"line":114,"address":[12712920,12713065],"length":1,"stats":{"Line":0}},{"line":117,"address":[14644450,14644367,14644857],"length":1,"stats":{"Line":0}},{"line":120,"address":[12650155,12648493,12647656,12650091,12647073],"length":1,"stats":{"Line":0}},{"line":122,"address":[12714450,12712982,12716322,12714419],"length":1,"stats":{"Line":0}},{"line":123,"address":[12648872,12649263,12648797],"length":1,"stats":{"Line":0}},{"line":129,"address":[14871168,14871176],"length":1,"stats":{"Line":0}},{"line":130,"address":[12613577,12612519,12612680],"length":1,"stats":{"Line":0}},{"line":132,"address":[12612844,12614010,12613278,12613446,12613876,12613943,12612936],"length":1,"stats":{"Line":0}},{"line":133,"address":[12613022,12613202,12612956],"length":1,"stats":{"Line":0}},{"line":134,"address":[12613490,12612877,12613167,12612987,12613231,12613215,12613286],"length":1,"stats":{"Line":0}},{"line":136,"address":[12422484],"length":1,"stats":{"Line":0}},{"line":137,"address":[12616304,12616485,12616549,12616543,12613920],"length":1,"stats":{"Line":0}},{"line":138,"address":[12616395,12616331],"length":1,"stats":{"Line":0}},{"line":141,"address":[12681389,12679500],"length":1,"stats":{"Line":0}},{"line":142,"address":[14353787],"length":1,"stats":{"Line":0}},{"line":144,"address":[12616603,12616667],"length":1,"stats":{"Line":0}},{"line":147,"address":[14611678,14611868,14611800,14612513],"length":1,"stats":{"Line":0}},{"line":148,"address":[14353813,14354146,14354097],"length":1,"stats":{"Line":0}},{"line":152,"address":[12614353],"length":1,"stats":{"Line":0}},{"line":156,"address":[12235549,12235536],"length":1,"stats":{"Line":0}},{"line":157,"address":[14356658],"length":1,"stats":{"Line":0}},{"line":158,"address":[12619858,12619258,12619402],"length":1,"stats":{"Line":0}},{"line":159,"address":[12685196],"length":1,"stats":{"Line":0}},{"line":162,"address":[12425403],"length":1,"stats":{"Line":0}},{"line":163,"address":[11700044],"length":1,"stats":{"Line":0}},{"line":165,"address":[12687211,12684082,12686983],"length":1,"stats":{"Line":0}},{"line":166,"address":[14618715,14619260,14618804],"length":1,"stats":{"Line":0}},{"line":167,"address":[14619170],"length":1,"stats":{"Line":0}},{"line":170,"address":[12687471,12689081,12688925,12684103,12689679],"length":1,"stats":{"Line":0}},{"line":171,"address":[12689401,12689531],"length":1,"stats":{"Line":0}},{"line":172,"address":[12623920],"length":1,"stats":{"Line":0}},{"line":175,"address":[12625381,12624406,12625823,12624833,12624323],"length":1,"stats":{"Line":0}},{"line":181,"address":[12626222,12624780,12626605,12628136,12626769,12626702,12626260],"length":1,"stats":{"Line":0}},{"line":183,"address":[12626444,12626328,12618728,12626637,12626245],"length":1,"stats":{"Line":0}},{"line":184,"address":[12700544,12700688,12692223],"length":1,"stats":{"Line":0}},{"line":185,"address":[12636121],"length":1,"stats":{"Line":0}},{"line":188,"address":[12626960,12626881],"length":1,"stats":{"Line":0}},{"line":191,"address":[14624043,14623965],"length":1,"stats":{"Line":0}},{"line":193,"address":[14624114],"length":1,"stats":{"Line":0}},{"line":194,"address":[12692913,12693004],"length":1,"stats":{"Line":0}},{"line":198,"address":[12425528],"length":1,"stats":{"Line":0}},{"line":200,"address":[14625491,14625420],"length":1,"stats":{"Line":0}},{"line":201,"address":[12694312],"length":1,"stats":{"Line":0}},{"line":202,"address":[14625620],"length":1,"stats":{"Line":0}},{"line":203,"address":[14615446,14625862,14630025,14625699,14629504],"length":1,"stats":{"Line":0}},{"line":204,"address":[12698566],"length":1,"stats":{"Line":0}},{"line":207,"address":[12628647],"length":1,"stats":{"Line":0}},{"line":208,"address":[12695597,12694273,12695170],"length":1,"stats":{"Line":0}},{"line":209,"address":[12695544,12696826,12699340,12699427,12699290,12696556,12696880],"length":1,"stats":{"Line":0}},{"line":210,"address":[11700170,11701090],"length":1,"stats":{"Line":0}},{"line":212,"address":[12634174],"length":1,"stats":{"Line":0}},{"line":213,"address":[12631728,12628568,12631301],"length":1,"stats":{"Line":0}},{"line":214,"address":[14629371,14631015,14631275,14631065,14631152,14628603,14629438],"length":1,"stats":{"Line":0}},{"line":215,"address":[12632483,12634047,12634112,12618812,12633867,12632531],"length":1,"stats":{"Line":0}},{"line":219,"address":[12694993],"length":1,"stats":{"Line":0}},{"line":223,"address":[12674128,12675966,12676144,12674304,12674172,12674352],"length":1,"stats":{"Line":0}},{"line":224,"address":[12674394,12676059,12674285],"length":1,"stats":{"Line":0}},{"line":226,"address":[12610851,12609545,12609455,12609612,12609836,12609507,12609900],"length":1,"stats":{"Line":0}},{"line":231,"address":[14607013,14607768,14606610,14607629,14607179,14607681,14606535],"length":1,"stats":{"Line":0}},{"line":232,"address":[12610263,12610197],"length":1,"stats":{"Line":0}},{"line":233,"address":[14606871,14606937],"length":1,"stats":{"Line":0}},{"line":234,"address":[12610399,12610780,12610228,12610530,12610585,12610514,12610466,12610132],"length":1,"stats":{"Line":0}},{"line":236,"address":[14607198,14607455,14607636,14607143,14605614],"length":1,"stats":{"Line":0}},{"line":237,"address":[14607654,14608745,14608803,14608809,14608560],"length":1,"stats":{"Line":0}},{"line":238,"address":[12612123,12612187],"length":1,"stats":{"Line":0}},{"line":241,"address":[12676732],"length":1,"stats":{"Line":0}},{"line":242,"address":[12676988],"length":1,"stats":{"Line":0}},{"line":243,"address":[12676794,12676845],"length":1,"stats":{"Line":0}},{"line":247,"address":[14608086],"length":1,"stats":{"Line":0}},{"line":251,"address":[14871501,14871488],"length":1,"stats":{"Line":0}},{"line":252,"address":[14642494],"length":1,"stats":{"Line":0}},{"line":253,"address":[14642593,14642499],"length":1,"stats":{"Line":0}},{"line":255,"address":[12645458],"length":1,"stats":{"Line":0}},{"line":256,"address":[12711392],"length":1,"stats":{"Line":0}},{"line":259,"address":[12645544,12645502],"length":1,"stats":{"Line":0}},{"line":260,"address":[12645554,12645599],"length":1,"stats":{"Line":0}},{"line":261,"address":[12645605],"length":1,"stats":{"Line":0}},{"line":265,"address":[14642728],"length":1,"stats":{"Line":0}},{"line":269,"address":[14641564,14641536,14642382,14641686,14642354,14641659],"length":1,"stats":{"Line":0}},{"line":270,"address":[12710359,12710450,12710466],"length":1,"stats":{"Line":0}},{"line":271,"address":[14641969,14641823],"length":1,"stats":{"Line":0}},{"line":273,"address":[12644712,12644806,12644878,12644735,12645228],"length":1,"stats":{"Line":0}},{"line":275,"address":[12710753],"length":1,"stats":{"Line":0}},{"line":276,"address":[12710954],"length":1,"stats":{"Line":0}},{"line":280,"address":[14614605,14614613,14613615,14613456,14613497,14613588],"length":1,"stats":{"Line":0}},{"line":281,"address":[14613681,14613770,14613565,14614611],"length":1,"stats":{"Line":0}},{"line":284,"address":[12682374,12683484,12683434,12683360],"length":1,"stats":{"Line":0}},{"line":285,"address":[12618007],"length":1,"stats":{"Line":0}},{"line":288,"address":[12683148,12682989,12682607,12683061],"length":1,"stats":{"Line":0}},{"line":291,"address":[12617320,12617503],"length":1,"stats":{"Line":0}},{"line":298,"address":[14614012],"length":1,"stats":{"Line":0}},{"line":301,"address":[14614806,14614874],"length":1,"stats":{"Line":0}},{"line":304,"address":[12617830],"length":1,"stats":{"Line":0}},{"line":308,"address":[12235712,12235730],"length":1,"stats":{"Line":0}},{"line":309,"address":[14641407],"length":1,"stats":{"Line":0}},{"line":313,"address":[12235664,12235682],"length":1,"stats":{"Line":0}},{"line":314,"address":[14641296,14641174,14641097,14641280],"length":1,"stats":{"Line":0}},{"line":318,"address":[14871298,14871280],"length":1,"stats":{"Line":4}},{"line":319,"address":[12636502,12636405],"length":1,"stats":{"Line":2}},{"line":321,"address":[12702423,12702340],"length":1,"stats":{"Line":2}},{"line":322,"address":[12702482,12702544],"length":1,"stats":{"Line":2}},{"line":323,"address":[12636917],"length":1,"stats":{"Line":1}},{"line":324,"address":[14633975],"length":1,"stats":{"Line":1}},{"line":327,"address":[14633784],"length":1,"stats":{"Line":1}},{"line":334,"address":[12235344],"length":1,"stats":{"Line":0}},{"line":335,"address":[12608984,12608934,12608848],"length":1,"stats":{"Line":0}},{"line":336,"address":[14605266],"length":1,"stats":{"Line":0}},{"line":341,"address":[12941285,12941291,12940832],"length":1,"stats":{"Line":0}},{"line":342,"address":[12236411],"length":1,"stats":{"Line":0}},{"line":344,"address":[14872312],"length":1,"stats":{"Line":0}},{"line":345,"address":[12236706],"length":1,"stats":{"Line":0}},{"line":346,"address":[12236625],"length":1,"stats":{"Line":0}},{"line":347,"address":[14872364],"length":1,"stats":{"Line":0}},{"line":353,"address":[12941312,12941618,12941624],"length":1,"stats":{"Line":0}},{"line":354,"address":[14872609],"length":1,"stats":{"Line":0}},{"line":355,"address":[12237044],"length":1,"stats":{"Line":0}},{"line":359,"address":[12656880,12656831,12656800,12658292,12656910],"length":1,"stats":{"Line":0}},{"line":360,"address":[14654177,14654272],"length":1,"stats":{"Line":0}},{"line":361,"address":[12657139],"length":1,"stats":{"Line":0}},{"line":362,"address":[12657169,12657587],"length":1,"stats":{"Line":0}},{"line":366,"address":[12941648],"length":1,"stats":{"Line":1}},{"line":367,"address":[12941720],"length":1,"stats":{"Line":1}},{"line":368,"address":[12941778],"length":1,"stats":{"Line":1}},{"line":370,"address":[12941803,12941740],"length":1,"stats":{"Line":2}}],"covered":11,"coverable":163},{"path":["/","root","code","nuclaw","tests","integration_tests.rs"],"content":"//! Integration tests for NuClaw\n//!\n//! These tests verify the interaction between components.\n\nuse nuclaw::config;\nuse nuclaw::error::Result;\nuse std::fs;\n\n/// Test that required directories are created\n#[test]\nfn test_directory_creation() {\n    // Ensure directories exist\n    config::ensure_directories().expect(\"Failed to create directories\");\n\n    // Verify directories were created\n    assert!(config::store_dir().exists(), \"Store directory should exist\");\n    assert!(config::data_dir().exists(), \"Data directory should exist\");\n    assert!(\n        config::groups_dir().exists(),\n        \"Groups directory should exist\"\n    );\n}\n\n/// Test database initialization\n#[test]\nfn test_database_initialization() {\n    use nuclaw::db::Database;\n\n    // Ensure directories exist first\n    config::ensure_directories().expect(\"Failed to create directories\");\n\n    // Initialize database\n    let db = Database::new().expect(\"Failed to create database\");\n\n    // Verify we can get a connection\n    let conn = db.get_connection().expect(\"Failed to get connection\");\n\n    // Verify tables exist by running a simple query\n    let tables: rusqlite::Result\u003cVec\u003cString\u003e\u003e = conn\n        .prepare(\"SELECT name FROM sqlite_master WHERE type='table'\")\n        .expect(\"Failed to prepare statement\")\n        .query_map([], |row| row.get::\u003c_, String\u003e(0))\n        .expect(\"Failed to query tables\")\n        .collect();\n\n    let tables = tables.expect(\"Failed to collect results\");\n\n    assert!(\n        tables.contains(\u0026\"chats\".to_string()),\n        \"chats table should exist\"\n    );\n    assert!(\n        tables.contains(\u0026\"messages\".to_string()),\n        \"messages table should exist\"\n    );\n    assert!(\n        tables.contains(\u0026\"scheduled_tasks\".to_string()),\n        \"scheduled_tasks table should exist\"\n    );\n    assert!(\n        tables.contains(\u0026\"task_run_logs\".to_string()),\n        \"task_run_logs table should exist\"\n    );\n}\n\n/// Test container timeout configuration\n#[test]\nfn test_container_timeout_configuration() {\n    use std::time::Duration;\n\n    // Save original\n    let original = std::env::var(\"CONTAINER_TIMEOUT\").ok();\n\n    // Test default\n    std::env::remove_var(\"CONTAINER_TIMEOUT\");\n    let timeout = nuclaw::container_runner::container_timeout();\n    assert_eq!(timeout, Duration::from_millis(300_000));\n\n    // Test custom value\n    std::env::set_var(\"CONTAINER_TIMEOUT\", \"60000\");\n    let timeout = nuclaw::container_runner::container_timeout();\n    assert_eq!(timeout, Duration::from_millis(60_000));\n\n    // Restore\n    match original {\n        Some(val) =\u003e std::env::set_var(\"CONTAINER_TIMEOUT\", val),\n        None =\u003e std::env::remove_var(\"CONTAINER_TIMEOUT\"),\n    }\n}\n\n/// Test scheduler configuration\n#[test]\nfn test_scheduler_configuration() {\n    use nuclaw::task_scheduler::{poll_interval, task_timeout};\n    use std::time::Duration;\n\n    // Save originals\n    let original_poll = std::env::var(\"SCHEDULER_POLL_INTERVAL\").ok();\n    let original_timeout = std::env::var(\"TASK_TIMEOUT\").ok();\n\n    // Test defaults\n    std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\");\n    std::env::remove_var(\"TASK_TIMEOUT\");\n    assert_eq!(poll_interval(), Duration::from_secs(60));\n    assert_eq!(task_timeout(), Duration::from_secs(600));\n\n    // Test custom values\n    std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", \"30\");\n    std::env::set_var(\"TASK_TIMEOUT\", \"300\");\n    assert_eq!(poll_interval(), Duration::from_secs(30));\n    assert_eq!(task_timeout(), Duration::from_secs(300));\n\n    // Restore\n    match original_poll {\n        Some(val) =\u003e std::env::set_var(\"SCHEDULER_POLL_INTERVAL\", val),\n        None =\u003e std::env::remove_var(\"SCHEDULER_POLL_INTERVAL\"),\n    }\n    match original_timeout {\n        Some(val) =\u003e std::env::set_var(\"TASK_TIMEOUT\", val),\n        None =\u003e std::env::remove_var(\"TASK_TIMEOUT\"),\n    }\n}\n\n/// Test database operations\n#[test]\nfn test_database_operations() {\n    use nuclaw::db::Database;\n    use rusqlite::params;\n\n    config::ensure_directories().expect(\"Failed to create directories\");\n    let db = Database::new().expect(\"Failed to create database\");\n    let conn = db.get_connection().expect(\"Failed to get connection\");\n\n    // Insert a test message\n    conn.execute(\n        \"INSERT OR REPLACE INTO messages (id, chat_jid, sender, sender_name, content, timestamp, is_from_me)\n         VALUES (?, ?, ?, ?, ?, ?, ?)\",\n        params![\n            \"test_msg_1\",\n            \"test@chat\",\n            \"sender1\",\n            \"Test Sender\",\n            \"Test message content\",\n            \"2025-01-01T00:00:00Z\",\n            0,\n        ],\n    ).expect(\"Failed to insert message\");\n\n    // Query the message back\n    let content: String = conn\n        .query_row(\n            \"SELECT content FROM messages WHERE id = ?\",\n            [\"test_msg_1\"],\n            |row| row.get(0),\n        )\n        .expect(\"Failed to query message\");\n\n    assert_eq!(content, \"Test message content\");\n\n    // Clean up\n    conn.execute(\"DELETE FROM messages WHERE id = ?\", [\"test_msg_1\"])\n        .expect(\"Failed to delete test message\");\n}\n\n/// Test group context isolation\n#[test]\nfn test_group_context_isolation() {\n    use nuclaw::container_runner::create_group_ipc_directory;\n\n    config::ensure_directories().expect(\"Failed to create directories\");\n\n    // Create IPC directories for different groups\n    let group1 = create_group_ipc_directory(\"test_group_1\").expect(\"Failed to create group 1\");\n    let group2 = create_group_ipc_directory(\"test_group_2\").expect(\"Failed to create group 2\");\n\n    // Verify they are different paths\n    assert_ne!(group1, group2);\n\n    // Create files in each directory\n    fs::write(group1.join(\"test.txt\"), \"group1\").expect(\"Failed to write to group1\");\n    fs::write(group2.join(\"test.txt\"), \"group2\").expect(\"Failed to write to group2\");\n\n    // Verify isolation\n    let content1 = fs::read_to_string(group1.join(\"test.txt\")).expect(\"Failed to read group1\");\n    let content2 = fs::read_to_string(group2.join(\"test.txt\")).expect(\"Failed to read group2\");\n\n    assert_eq!(content1, \"group1\");\n    assert_eq!(content2, \"group2\");\n\n    // Cleanup\n    let _ = fs::remove_dir_all(\u0026group1);\n    let _ = fs::remove_dir_all(\u0026group2);\n}\n\n/// Test cron expression parsing with various formats\n#[test]\nfn test_cron_expression_variations() {\n    use nuclaw::task_scheduler::parse_cron_expression;\n\n    // Standard 6-field cron (with seconds)\n    assert!(parse_cron_expression(\"0 0 9 * * *\").is_ok());\n    assert!(parse_cron_expression(\"0 0 0 1 * *\").is_ok()); // First day of month\n    assert!(parse_cron_expression(\"0 0 12 * * 1-5\").is_ok()); // Weekdays at noon\n\n    // Invalid expressions\n    assert!(parse_cron_expression(\"\").is_err());\n    assert!(parse_cron_expression(\"invalid\").is_err());\n    assert!(parse_cron_expression(\"* * *\").is_err()); // Too few fields\n}\n\n/// Test error handling for missing database\n#[test]\n#[ignore = \"May interfere with other tests\"]\nfn test_database_error_handling() {\n    // This test is ignored by default as it manipulates environment\n    // It would test error handling when database cannot be opened\n}\n\n/// Test configuration loading from environment\n#[test]\nfn test_environment_configuration() {\n    use nuclaw::config::assistant_name;\n\n    // Save originals\n    let original_name = std::env::var(\"ASSISTANT_NAME\").ok();\n\n    // Test assistant name default\n    std::env::remove_var(\"ASSISTANT_NAME\");\n    assert_eq!(assistant_name(), \"Andy\");\n\n    // Test custom assistant name\n    std::env::set_var(\"ASSISTANT_NAME\", \"Bob\");\n    assert_eq!(assistant_name(), \"Bob\");\n\n    // Restore\n    match original_name {\n        Some(val) =\u003e std::env::set_var(\"ASSISTANT_NAME\", val),\n        None =\u003e std::env::remove_var(\"ASSISTANT_NAME\"),\n    }\n}\n\n/// Test max output size configuration\n#[test]\nfn test_max_output_size_configuration() {\n    use nuclaw::container_runner::max_output_size;\n\n    // Save original\n    let original = std::env::var(\"CONTAINER_MAX_OUTPUT_SIZE\").ok();\n\n    // Test default\n    std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\");\n    let size = max_output_size();\n    assert_eq!(size, 10 * 1024 * 1024); // 10MB default\n\n    // Test custom value\n    std::env::set_var(\"CONTAINER_MAX_OUTPUT_SIZE\", \"5242880\");\n    let size = max_output_size();\n    assert_eq!(size, 5 * 1024 * 1024); // 5MB\n\n    // Restore\n    match original {\n        Some(val) =\u003e std::env::set_var(\"CONTAINER_MAX_OUTPUT_SIZE\", val),\n        None =\u003e std::env::remove_var(\"CONTAINER_MAX_OUTPUT_SIZE\"),\n    }\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>